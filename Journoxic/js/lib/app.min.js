/**
 * @version 4.0 Build 080415 1952
 * @author Anoxic
 */

window.journal={},window.app={},journal.archive={},journal.archive.data={},journal.archive.media=0,journal.archive.map={},app.name="Guest",app.month_array="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),app.year=(new Date).getFullYear(),app.years=[],app.yearQueue={},app.yearChange={},app.resource="resource/",app.lastLoaded=0,app.currentDisplayed=-1,app.displayedNum=0,app.displayedLines=0,app.displayedChars=0,app.displayedTime=0,app.lastQualified=-1,app.pageLoaded=1,app.preloadedTags=[],app.command="",app.isFunction=!0,app.lostMedia=[],app.dataLoaded={},app.version={data:2},app.init=function(){var e=this;showLoginButton(),app.preloadedTags.push("%photo","%video","%music","%voice","%book","%movie","%place","%weblink");for(var a=app.tag().getIconsInName(),t=0;t!=a.length;++t)app.preloadedTags.push("#"+a[t]);$("#query").keyup(function(a){13==a.keyCode&&(app.command=$("#query").val(),$("#query").effect("highlight",{color:"#dddddd"}),e.load(app.command,!0))}).bind("keydown",function(e){e.keyCode===$.ui.keyCode.TAB&&$(this).autocomplete("instance").menu.active&&e.preventDefault()}).autocomplete({minLength:1,autoFocus:!0,source:function(e,a){for(var t=$("#query").val().split(" "),i=app.preloadedTags.sort(),n=0;n<i.length;++n)for(var o=0;o<t.length;++o)if(i[n]==t[o]){t.splice(o,1),i.splice(n,1);break}a($.ui.autocomplete.filter(i,e.term.split(/ \s*/).pop()))},focus:function(){return!1},select:function(e,a){var t=this.value.split(/ \s*/);return t.pop(),t.push(a.item.value),t.push(""),this.value=t.join(" "),!1}}),$(document).delegate("#search-result:not(.stats)","mouseover mouseleave",function(e){"mouseover"===e.type?($("#search-result").hide(),$("#total-time").text(Math.floor(app.displayedTime/60)+":"+app.displayedTime%60),$("#search-result").fadeIn(500)):($("#search-result").hide(),$("#total-time").text(app.displayedTime),$("#search-result").fadeIn(500))}),$("#year").effect("slide",{direction:"up"}),app.getYears(),$.ajaxSetup({timeout:network.timeOut}),$(document).ajaxStart(function(){network.isAjaxActive=!0,network.init()}),$(document).ajaxStop(function(){network.isAjaxActive=!1,0===network.breakpoint&&network.destroy()}),animation.testCacheIcons(),animation.testSub("#add"),$("#drawer").removeClass("hidden")},app.refresh=function(){app.load("")},app.load=function(e,a){if(""==a)return animation.error(log.LOAD_DATA_FAIL+log.NO_CONTENT),void animation.deny("#refresh-media");if(void 0==a){journal.archive.data[app.year]||(journal.archive.data[app.year]=[]),app.yearQueue[app.year]&&(app.yearChange[app.year]=!0,journal.archive.data[app.year].push.apply(journal.archive.data[app.year],app.yearQueue[app.year]),edit.sortArchive(),edit.removeDuplicate(),delete app.yearQueue[app.year]);var t=[];if(journal.archive.data[app.year]=journal.archive.data[app.year].filter(function(e){if(void 0==e)return app.yearChange[app.year]=!0,!1;var a=e.time,i=new Date(a.created).getFullYear(),n=new Date(a.created).getFullYear();return i==app.year||n==app.year?!0:(app.yearQueue[i]||(app.yearQueue[i]=[]),app.yearQueue[i].push(e),app.yearChange[i]=!0,app.yearChange[app.year]=!0,$("#year").addClass("change"),-1===t.indexOf(i)&&t.push(i),!1)}),t.length>0){animation.log(log.DATA_MOVED_TO_OTHER_YEAR+t.join(", ")+log.DATA_MOVED_TO_OTHER_YEAR_END);for(var i=0;i!==t.length;++i)-1===app.years.indexOf(t[i])&&app.years.push(t[i]);app.years.sort()}if(0===journal.archive.data[app.year].length)return animation.warn(log.LOAD_DATA_FAIL+log.NO_ARCHIVE),void animation.deny("#refresh-media")}$("#search-result").hide(),app.detail.prototype.hideDetail(),animation.testCacheIcons(),animation.testSub("#add");var n=function(){$("#total-entry").text(journal.archive.data[app.year].length),new app.list(e),app.dataLoaded[app.year]=!0};app.dataLoaded[app.year]||a&&(animation.debug(log.CONTENTS_NEW+a.length+log.CONTENTS_NEW_END),console.log("app.load(): data.length = "+a.length),app.loadScript(a,n,!1),edit.saveDataCache()),animation.indent=0,animation.debug(log.CONTENTS_RELOADED),console.log("==================Force loaded=================="),$("#list").empty(),app.lastLoaded=0,app.lastQualified=-1,app.displayedChars=0,app.displayedLines=0,app.displayedNum=0,app.displayedTime=0,app.currentDisplayed=-1,app.command=e,$("#query").val(e),$("#total-displayed").text(app.displayedNum),$("#total-char").text(app.displayedChars),$("#total-line").text(app.displayedLines),$("#total-time").text(app.displayedTime),$("#year").effect("slide",{direction:"up"}).html(app.year),app.yearChange[app.year]?$("#year").addClass("change"):$("#year").removeClass("change");for(var o=0,p=journal.archive.data[app.year].length;o!=p;++o)journal.archive.data[app.year][o].processed=0;n(),$("#search-result").fadeIn(500),void 0==e&&(e="")},app.loadScript=function(e,a,t){if(t){var i=document.createElement("script"),n=function(){a()};i.src=e,i.charset="utf-8",i.onload=n,i.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&n()},document.getElementsByTagName("head")[0].appendChild(i)}else console.log("app.loadScript(): data.length = "+e.length),journal.archive.data[app.year]=app.updateData(JSON.parse(e)),a()},app.updateData=function(e){if(e.version||(e.version=1),e.version!==app.version.data)switch(animation.debug(log.CONTENTS_UPGRADING),e.version){case 1:for(var a=0;a!==e.length;++a){var t=e[a].iconTags,i=e[a].textTags;t&&(t=app.tag().getIconsInNameByVal(t).join("|"),i+=i?"|"+t:t),e[a].tags=i}}return e},app.getYears=function(){animation.log(log.GET_YEARS_START),getTokenCallback(function(e){$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:/core:/children?select=name,createdBy&orderby=name&access_token="+e}).done(function(e){var a=e.value;app.years=[];for(var t=0;t!==a.length;++t){var i=a[t].name;parseInt(i)==i&&(i=parseInt(i),app.years.push(i),network.yearFolders.push(i))}app.user=a[0].createdBy.user.displayName,$("#username").html(app.user),-1===app.years.indexOf((new Date).getFullYear())&&app.years.push((new Date).getFullYear()),backupAll(),animation.testYearButton(),animation.log(log.GET_YEARS_END)}).fail(function(e,a,t){animation.error(log.GET_YEARS_FAIL,t),app.getYears()})})},app.yearUpdateTry=function(e){app.year=e,0===app.years.length&&app.years.push(app.year),journal.archive.data[e]?app.yearUpdate(e):downloadFile(void 0,!0)},app.yearUpdate=function(){app.refresh(),animation.testYearButton(),animation.debug(log.YEAR_SWITCHED_TO+app.year)},app.prev=function(e){if(network.isAjaxActive)return void animation.warn(log.NETWORK_WORKING);var a=app.years.indexOf(app.year);return-1===a?void app.yearUpdateTry((new Date).getFullYear()):(e?a=0:--a,void app.yearUpdateTry(app.years[a]))},app.next=function(e){if(network.isAjaxActive)return void animation.warn(log.NETWORK_WORKING);var a=app.years.indexOf(app.year);return-1===a?void app.yearUpdateTry((new Date).getFullYear()):(e?a=app.years.length-1:++a,void app.yearUpdateTry(app.years[a]))},app.list=function(e){var a=this,t=journal.archive.data[app.year];journal.total=t.length;var i=app.cList,n=i.children("ul");!this.contents&&n.length<1&&(i.html('<ul></ul><div class="loadmore"></div>'),this.contents=i.children("ul"),this.loadmore=i.children("div.loadmore"),this.loadmore.on("click",function(){a.load(e)}),this.load(e),i.off("scroll").on("scroll",function(){$(this).scrollTop()>a.contents.height()-i.height()&&0!=$(".loadmore").length&&a.load(app.command)}))},app.list.prototype={load:function(e){var a=this,t=journal.archive.data[app.year],i=app.lastLoaded,n=app.lastQualified;for(app.lastLoaded>=journal.archive.data[app.year].length&&(i=app.lastLoaded=journal.archive.data[app.year].length-1),t[i].index=i;;){if(this.qualify(t[i],e)){var o;if(o=-1==n?0:t[n].time.start||t[n].time.created,a.html(journal.archive.data[app.year][i],o),n=i,++app.displayedNum,app.displayedChars+=t[i].text.chars,app.displayedLines+=t[i].text.lines,t[i].time.end){var p=(t[i].time.end-t[i].time.start)/6e4;isNaN(p)||(app.displayedTime+=p)}if($("#search-result").hide().fadeIn(500),$("#total-displayed").text(app.displayedNum),$("#total-char").text(app.displayedChars),$("#total-line").text(app.displayedLines),$("#total-time").text(app.displayedTime),$("#list").get(0).scrollHeight==$("#list").height()&&++i!=journal.total)continue;break}if(this.htmlEmpty(),++i==journal.total)break}++i>=journal.total&&($(".loadmore").remove(),$("#list").append('<li><p class="separator"><span>EOF</span></p></li>')),app.lastQualified=n,app.lastLoaded=i},qualify:function(e,a){if(!a)return!0;for(;-1!=a.search("  ");)a=a.replace("  "," ");for(var t=a.toLowerCase().split(" "),i=0,n=t.length;n>i;++i){var o=t[i].split("|"),p=!1;console.log("		> Testing "+o);for(var r in o)if(o.hasOwnProperty(r)){var l;if("#"===o[r].charAt(0)){if(e.tags){l=!1;var s=e.tags.split("|");for(tag in s)if(s.hasOwnProperty(tag)&&s[tag]==o[r].substr(1)){l=!0;break}if(l)break}}else if("%"===o[r].charAt(0)){l=!1;for(var d=app.tag().content(e.attachments),u=o[r].substr(1),c=0;c!==d.length;++c)if(u==d[c]){l=!0;break}if(l){p=!0;break}}else if("@"===o[r].charAt(0)){var h=o[r].substr(1);if(this.isInRange(h,e.time.created)){console.log("	- Time match!"),p=!0;break}}else if("+"===o[r].charAt(0)){if(e.text.body.match(new RegExp(o[r].substr(1),"i"))){p=!0;break}}else if(e.title.match(new RegExp(o[r],"i"))){p=!0;break}if(p)break}if(!p)return console.log("Reach end"),!1}return!0},date:function(e,a){var t=new Date(e),i=t.getMonth(),n=t.getDate(),o=t.getHours(),p=t.getMinutes();return p=10>p?"0"+p:p,o=10>o?"0"+o:o,a?o+":"+p:app.month_array[i]+" "+n+" "+o+":"+p},html:function(e,a){switch(e.summary=e.text.ext,e.coverType){default:e.type="text",e.ext="";break;case 1:e.type="photo",e.ext=this.thumb(e,"images");break;case 2:e.type="video",e.ext=this.thumb(e,"video");break;case 3:e.type="music",e.ext=this.thumb(e,"music");break;case 4:e.type="voice",e.ext=this.thumb("dummy");break;case 5:e.type="book",e.ext=this.thumb(e,"book");break;case 6:e.type="movie",e.ext=this.thumb(e,"movie");break;case 7:e.type="place",e.ext=this.thumb("dummy");break;case 8:e.type="weblink",e.ext=this.thumb(e,"weblink")}var t=e.time.start||e.time.created;e.datetime=this.date(t),e.endtime="",e.time.end&&(e.datetime+=" - "+this.date(e.time.end,1)),e.month=this.isInSameMonth(t,a),e.attached=this.attached(e.attachments);var i=$(app.itemView(e));i.find(" > a").on("click",function(e){e.preventDefault(),animation.showMenuOnly("edit"),app.photos&&app.photos.remove(),$("#list ul li:nth-child("+(app.currentDisplayed+1)+") a").removeAttr("style"),$(this).css("background","#aaa").css("color","#fff");var a=app.currentDisplayed==$(this).parent().index();return a||(app.currentDisplayed=$(this).parent().index(),$("#detail").hide().fadeIn(500),app.view=new app.detail),!1}),$(".thumb > img:not([style])",i).on("load",function(){var e=this.naturalWidth||this.width,a=this.naturalHeight||this.height,t=app.util.crop(e,a,160);$(this).css(t)}),$(".thumb > canvas",i).each(function(){var e=$(this).data("src"),a=new Image,t=this.getContext("2d");a.src=e,a.onload=function(){var e=app.util.crop(this.width,this.height,160),i=e.marginLeft||0,n=e.marginTop||0,o=e.width||160,p=e.height||160;t.drawImage(a,i,n,o,p)}});var n=i.addClass(e.type).hide();this.contents.append(n.fadeIn(500))},htmlEmpty:function(){return console.log("not show!"),$("#list ul").append("<li></li>")},thumb:function(e,a){var t,i=e[a];if(i&&i.length>0){var n=i[0],o="";if(!n.fileName)return'<div class="dummy"></div>';if("images"!=a&&"video"!=a){if(!n.thumb)return'<div class="dummy"></div>';n=n.thumb}var p,r=app.util.crop(1024,720,80),l=app.util.style(r);if("images"==a&&(journal.archive.map[n.fileName]&&(p=journal.archive.map[n.fileName].url),void 0==p))return'<div class="dummy"></div>';if("video"==a&&(journal.archive.map[n.fileName+"_thumb.jpg"]&&(p=journal.archive.map[n.fileName+"_thumb.jpg"].url),void 0==p))return'<div class="dummy"></div>';l&&(l=' style="'+l+'"');var s='<img src="'+p+'"'+l+">";Modernizr.canvas&&(s='<canvas width="160" height="160" data-src="'+p+'"></canvas>'),n.urlType>1&&"weblink"==a&&(o='<span class="weblink-video"></span>'),"video"==a&&(o='<span class="video-play"></span>'),t='<div class="thumb">'+s+o+"</div>"}return t||'<div class="dummy"></div>'},attached:function(e){for(var a=[],t=app.tag().content(e),i=0,n=t.length;n>i;++i)a.push('<span class="'+t[i]+'"></span>');return a.join("")},isInRange:function(e,a){console.log("Call app.load.isInRange("+e+","+a+")");var t=e.split(":"),i=new Date(a);if(1==t.length){var n=t[0];if(4==n.length){var o=parseInt(n.substr(0,2)),p=parseInt(n.substr(2,2));return isNaN(o)||isNaN(p)?!1:i.getYear()%100==p&&i.getMonth()+1==o}if(6==n.length){var o=parseInt(n.substr(0,2)),r=parseInt(n.substr(2,2)),p=parseInt(n.substr(4,2));return isNaN(o)||isNaN(r)||isNaN(p)?!1:i.getYear()%100==p&&i.getMonth()+1==o&&i.getDate()==r}return!1}if(2==t.length){var l=t[0],s=t[1];if(4==l.length){var d,u=parseInt(l.substr(0,2)),c=parseInt(l.substr(2,2)),h=parseInt(s.substr(0,2));if(2==s.length)d=c;else{if(4!=s.length)return!1;d=parseInt(s.substr(2,2))}if(isNaN(u)||isNaN(c)||isNaN(h)||isNaN(d))return!1;var o=i.getMonth()+1,p=i.getYear()%100;return o>=u&&h>=o&&p>=c&&d>=p?!0:!1}if(6==l.length){var u=parseInt(l.substr(0,2)),m=parseInt(l.substr(2,2)),c=parseInt(l.substr(4,2)),h=u,v=m,d=c;if(2==s.length)v=parseInt(s);else if(4==s.length)h=parseInt(s.substr(0,2)),v=parseInt(s.substr(2,2));else{if(6!=s.length)return!1;h=parseInt(s.substr(0,2)),v=parseInt(s.substr(2,2)),d=parseInt(s.substr(4,2))}if(isNaN(u)||isNaN(m)||isNaN(c)||isNaN(h)||isNaN(v)||isNaN(s))return!1;var y=new Date(2e3+c,u-1,m),g=new Date(2e3+d,h-1,v,23,59,59);return a>y&&g>a}return!1}},isInSameMonth:function(e,a){var t=new Date(e),i=t.getMonth();if(0===a)return app.month_array[i];var n=new Date(a),o=n.getMonth();return o===i?-1:app.month_array[i]}},app.detail=function(){var e=journal.archive.data[app.year][app.currentDisplayed];if(!e.processed){if(e.chars=e.text.chars+" Chars",e.lines=e.text.lines+" Lines",e.contents=this.text(e.text.body),e.weblink&&this.thumb(e,"weblink",50,50),e.book){this.thumb(e,"book",50,70);for(var a=0;a!==e.book.length;++a)getCoverPhoto("#detail .book:eq("+a+") ",e.book[a].author+" "+e.book[a].title,!1,"book")}if(e.music){this.thumb(e,"music",50,50);for(var a=0;a!==e.music.length;++a)getCoverPhoto("#detail .music:eq("+a+") ",e.music[a].author+" "+e.music[a].title)}if(e.movie){this.thumb(e,"movie",50,70);for(var a=0;a!==e.movie.length;++a)getCoverPhoto("#detail .movie:eq("+a+") ",e.movie[a].author+" "+e.movie[a].title,!1,"movie")}if(e.tags){var t=app.tag().separate(e.tags);e.iconTags=t.iconTags,e.textTags=t.textTags}for(var i="video weblink book music movie images voice place textTags iconTags".split(" "),a=0,n=i.length;n>a;++a)void 0==e[i[a]]&&(e[i[a]]=void 0);e.processed=1}var o=$(app.detailView(e));app.cDetail.css("display","inline-block").html(o),app.app.addClass("detail-view"),e.images||$(".center").hide(),$(".btn-back",app.cDetail).on("click",function(){this.hideDetail()}),$(".center").on("click",function(){var e=journal.archive.data[app.year][app.currentDisplayed];if(e.images)for(var a=0;a!=e.images.length;++a){var t=e.images[a].fileName;journal.archive.map[t]?$(".upper").append('<a href="'+journal.archive.map[t].url+'"><span></span><img src="'+journal.archive.map[t].url+'"></a>'):animation.error(log.FILE_NOT_LOADED+t+log.DOWNLOAD_PROMPT)}$(".center").hide(),$(".upper").css("height","70%").mousewheel(function(e,a){this.scrollLeft-=50*a,e.preventDefault()});var i=$(".upper > a",app.cDetail);i.length>0&&(app.photos=new app.PhotoViewer(i.find(" > img").clone()),i.on("click",function(e){e.preventDefault();var a=$(this).index();return app.photos.open(a),!1}))}),$(".icontags > span").on("click",function(){var e=app.tag().getValueByHtml(this.className);""!=e&&app.load("#"+e)});return $(".lower .video a").each(function(){app.videoPlayer.quit();var e=$(this).attr("class");if(journal.archive.map[e]){var a='app.videoPlayer("#app #video-preview","'+journal.archive.map[e].url+'")';$(this).attr("onclick",a).removeAttr("class")}else animation.error(log.FILE_NOT_LOADED+e+log.DOWNLOAD_PROMPT)}),$(".lower .voice a").each(function(e){app.audioPlayer.quit();var a=$(this).attr("class");if(journal.archive.map[a]){var t='app.audioPlayer("#detail .content .voice:eq('+e+') a","'+journal.archive.map[a].url+'")';$(this).attr("onclick",t).removeAttr("class")}else animation.error(log.FILE_NOT_LOADED+a+log.DOWNLOAD_PROMPT)}),$("#edit-this, #delete").removeClass("hidden"),animation.testCacheIcons(),animation.testSub("#add"),e},app.detail.prototype={text:function(e){return e=this.htmlSpacialChars(e),e=e.replace(/\t\t[*]\t[*]\t[*]/g,"<hr>"),e=e.replace(/\r\n\t\t/g,'</p><p class="t2">'),e=e.replace(/\r\n\t/g,'</p><p class="t1">'),e=e.replace(/\n(|\r)\n(|\r)/gi,"</p></br><p>"),e=e.replace(/\n(|\r)/gi,"</p><p>"),"<p>"+e+"</p>"},htmlSpacialChars:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},thumb:function(e,a,t,i){var n=e[a];if(n&&n.length>0){if(n=n[0],!n)return!1;var o=app.util.crop(1024,720,t,i),p=app.util.style(o),r=app.resource+n.thumb;r.match(/.(jpg|png)$/)||(r+=".jpg"),p&&(p=' style="'+p+'"'),void 0!==n.thumb&&(n.thumb='<img src="'+r+'"'+p+">")}},hideDetail:function(){$("#edit-this, #delete").addClass("hidden"),animation.testSub("#add"),app.cDetail.css("display","none").empty(),app.cList.css("display","inline-block"),app.app.removeClass("detail-view"),app.photos&&app.photos.remove()}},app.layout=function(){var e=$(window),a=function(){var a=e.height()<750?e.height():e.height()-200;app.app.height(a),app.contents.height(a)};a(),e.on("resize",a)},app.util={fit:function(e,a,t,i){var n=e>t?t:e,o=a>i?i:a,p=Math.ceil(e/a*o),r=Math.ceil(n/(e/a)),l={};return e>a?i>r?(l.width=n,l.height=r):(l.width=p,l.height=o):t>p?(l.width=p,l.height=o):(l.width=n,l.height=r),l},crop:function(e,a,t,i){i=i||t;var n=Math.ceil(e/a*i),o=Math.ceil(t/(e/a)),p={};return e>a?i>o?(p.width=n,p.height=i,p.marginLeft=-((n-t)/2)):(p.width=t,p.height=o,p.marginTop=-((o-i)/2)):a>e&&(t>n?(p.width=t,p.height=o,p.marginTop=-((o-i)/2)):(p.width=n,p.height=i,p.marginLeft=-((n-t)/2))),p},style:function(e){var a=[];for(i in e)e.hasOwnProperty(i)&&a.push(i.replace(/([A-Z])/,"-$1").toLowerCase()+":"+("number"==typeof e[i]?e[i]+"px":e[i]));return a.join(";")},runTime:function(e){if(e&&e>0){e/=1e3;var a="0",t="";return e>=60?(a=e/60,t=e-60*a,t=t>=10?Math.ceil(t):"0"+Math.ceil(t)):t=e>=10?Math.ceil(e):"0"+Math.ceil(e),a+":"+t}}},app.tag=function(){var e=[{name:"clear",value:1,html:"w01"},{name:"overcast",value:2,html:"w02"},{name:"raining",value:4,html:"w03"},{name:"snowing",value:8,html:"w04"},{name:"thundering",value:16,html:"w05"},{name:"windy",value:32,html:"w06"},{name:"happy",value:1024,html:"e01"},{name:"notbad",value:2048,html:"e02"},{name:"surprised",value:4096,html:"e03"},{name:"sad",value:8192,html:"e04"},{name:"angry",value:16384,html:"e05"},{name:"journal",value:32768,html:"c01"},{name:"thoughts",value:65536,html:"c02"},{name:"ingress",value:131072,html:"c03"},{name:"minecraft",value:262144,html:"c04"},{name:"dream",value:524288,html:"c05"},{name:"code",value:1048576,html:"c06"},{name:"letter",value:2097152,html:"c07"},{name:"handwriting",value:4194304,html:"c08"},{name:"friendship",value:16777216,html:"c10"},{name:"relationship",value:33554432,html:"s01"},{name:"star",value:67108864,html:"s02"},{name:"food",value:134217728,html:"s03"},{name:"leisure",value:268435456,html:"s04"},{name:"info",value:536870912,html:"s05"},{name:"baby",value:1073741824,html:"s06"},{name:"fun",value:2147483648,html:"s07"},{name:"travel",value:4294967296,html:"s08"},{name:"health",value:8589934592,html:"s09"},{name:"outfit",value:17179869184,html:"s10"},{name:"shopping",value:34359738368,html:"s11"},{name:"pets",value:68719476736,html:"s12"},{name:"work",value:137438953472,html:"s13"},{name:"sports",value:274877906944,html:"s14"},{name:"cook",value:549755813888,html:"s15"},{name:"makeup",value:1099511627776,html:"s16"},{name:"home",value:2199023255552,html:"s17"},{name:"car",value:4398046511104,html:"s18"}],a=1,t=2,i=4,n=8,o=16,p=32,r=64,l=128,s="000000000000000000000000000000000000000000000000000000000000000";return{content:function(e){var s=[];return this.is(e,a)&&s.push("photo"),this.is(e,t)&&s.push("video"),this.is(e,i)&&s.push("music"),this.is(e,n)&&s.push("voice"),this.is(e,o)&&s.push("book"),this.is(e,p)&&s.push("movie"),this.is(e,r)&&s.push("place"),this.is(e,l)&&s.push("weblink"),s},getIconsInHtmlByVal:function(a){for(var t=[],i=0;i!==e.length;++i)this.is(a,e[i].value)&&t.push(e[i].html);return t},getIconsInNameByVal:function(a){for(var t=[],i=0;i!==e.length;++i)this.is(a,e[i].value)&&t.push(e[i].name);return t},getValueByName:function(e){return this.translate(e.toLowerCase(),"name","value")},getHtmlByName:function(e){return this.translate(e.toLowerCase(),"name","html")},getNameByHtml:function(e){return this.translate(e.toLowerCase(),"html","name")},getIconsInHtml:function(){return this.getAll("html")},getIconsInName:function(){return this.getAll("name")},getAll:function(a){for(var t=[],i=0;i!==e.length;++i)e[i][a]&&t.push(e[i][a]);return t},translate:function(a,t,i){for(var n=0;n!==e.length;++n)if(e[n][t]&&e[n][i]&&e[n][t]==a)return e[n][i];return""},separate:function(a){for(var t=[],i=a.split("|"),n=0;n!==e.length;++n){var o=i.indexOf(e[n].name);o>-1&&(t.push(e[n].html),i.splice(o,1))}return{iconTags:t,textTags:i}},or:function(e,a){var t=this.get(e).split("");return t[this.get(a).indexOf("1")]="1",parseInt(t.join(""),2)},andnot:function(e,a){var t=this.get(e).split("");return t[this.get(a).indexOf("1")]="0",parseInt(t.join(""),2)},is:function(e,a){return"1"==this.get(e).charAt(this.get(a).indexOf("1"))},get:function(e){return this.substr(s+e.toString(2))},substr:function(e){var a=e.length;return e.substr(a-64)}}},app.PhotoViewer=function(e,a){return e||"object"==typeof e?(this.list=e,this.callback=a||function(){},this.make(),void this.init()):!1},app.PhotoViewer.prototype={make:function(){var e=this.list;if(e.length>1)var a=$("<ul>");var t=$('<ul class="swipe-wrap">');e.each(function(e){$("<li>").html(this).appendTo(t),a&&$("<li>").html('<a href="#'+e+'">'+e+"</a>").appendTo(a)});var i=$('<div class="wrap swipe">').html(t),n=$('<div class="control">');n.append('<input type="button" value="Close" class="btn-close"/>'),a&&a.css("width",17*e.length).wrap('<div class="pagination"/>').parent().appendTo(n),i.append(n),i.append('<div class="background"></div>');var o=$('<div id="photoviewer">').html(i);o.appendTo("body")},init:function(){this.viewer=$("body > div#photoviewer")},bind:function(){function e(){var e=$(window),t=e.width(),i=e.height();n.each(function(){var e=$(this),n=e.context.naturalWidth||e.context.width,o=e.context.naturalHeight||e.context.height,p=a.fit(n,o,t,i);e.css(p)})}if(this._bind)return this.swipe.setup(),!1;var a=this,t=this.viewer=$("body > div#photoviewer");this.pagination=$("div.pagination>ul>li",this.viewer);var i=t.find(" > div.swipe");this.swipe=new Swipe(i[0],{continuous:!1,callback:a.callback,transitionEnd:function(e){a.paging(e)}}),$("input.btn-close",t).on("click",function(){a.close()});var n=i.find(" > ul > li > img");e(),$(window).on("resize",e);var o=$("div.control",t);n.on("click",function(){o.fadeToggle(200)});var p=i.find(" > ul > li");p.on("click",function(e){this==e.toElement&&a.close()}),this._bind=1},fit:function(e,a,t,i){var n=app.util.fit(e,a,t,i);return $.browser.msie?(n.marginLeft=-(n.width/2),n.marginTop=-(n.height/2)):(n.marginLeft=-(n.width/2+10),n.marginTop=-(n.height/2+10)),n},open:function(e){var e=e||0,a=this,t=this.viewer;t.css({display:"block",opacity:0}),this.bind(),this.go(e),this.paging(e),t.css({opacity:1},200),$(window).on("keyup.photoviewer",function(e){27==e.keyCode?a.close():37==e.keyCode?a.prev():39==e.keyCode&&a.next()})},close:function(){this.viewer.fadeOut(200),$(window).off("keyup.photoviewer")},prev:function(){this.swipe.prev()},next:function(){this.swipe.next()},go:function(e){var e=e||0;this.swipe.slide(e,1)},paging:function(e){this.pagination.filter(".active").removeClass("active"),this.pagination.eq(e).addClass("active")},remove:function(){this.viewer.remove()}},app.audioPlayer=function(e,a){if(!app.isFunction)return void animation.warn(log.MEDIA_ALREADY_DISPLAYED);app.isFunction=!1,animation.log(log.AUDIO_DOWNLOAD_START,1),$("#play-media").html("&#xf04b").removeClass("play").attr("onclick","app.audioPlayer.play()"),$("#stop-media").attr("onclick","app.audioPlayer.quit()");var t='<div id="audioplayer"><audio id="music" preload="true"><source src="'+a+'"></audio><div id="music-position">00:00</div><div id="timeline"><div id="playhead"></div></div><div id="music-length">--:--</div></div>';$(t).appendTo(e),$(e+" p").css("padding-top","3px"),app.audioPlayer.music=document.getElementById("music"),app.audioPlayer.playhead=document.getElementById("playhead"),app.audioPlayer.timeline=document.getElementById("timeline");var i,n=timeline.offsetWidth-playhead.offsetWidth;app.audioPlayer.formatTime=function(e){var a=parseInt(e/60),t=parseInt(e%60);return a=10>a?"0"+a:a,t=10>t?"0"+t:t,a+":"+t},app.audioPlayer.timeUpdate=function(){var e=n*(music.currentTime/i);playhead.style.marginLeft=e+"px",music.currentTime===i?$("#play-media").html("&#xf04b").removeClass("play"):$("#music-position").html(app.audioPlayer.formatTime(music.currentTime))},app.audioPlayer.moveplayHead=function(e){var a=e.pageX-timeline.getBoundingClientRect().left;a>=0&&n>=a&&(playhead.style.marginLeft=a+"px"),0>a&&(playhead.style.marginLeft="0px"),a>n&&(playhead.style.marginLeft=n+"px")},app.audioPlayer.click=function(e){app.audioPlayer.moveplayHead(e);var a=(e.pageX-timeline.getBoundingClientRect().left)/n;music.currentTime=i*a},app.audioPlayer.mouseDown=function(){app.audioPlayer.onplayhead=!0,window.addEventListener("mousemove",app.audioPlayer.moveplayHead,!0),music.removeEventListener("timeupdate",app.audioPlayer.timeUpdate,!1)},app.audioPlayer.mouseUp=function(e){if(app.audioPlayer.onplayhead){app.audioPlayer.moveplayHead(e),window.removeEventListener("mousemove",app.audioPlayer.moveplayHead,!0);var a=(e.pageX-timeline.getBoundingClientRect().left)/n;music.currentTime=i*a,music.addEventListener("timeupdate",app.audioPlayer.timeUpdate,!1)}app.audioPlayer.onplayhead=!1},app.audioPlayer.loadedData=function(){animation.log(AUDIO_DOWNLOAD_END,-1),$("#music-length").html(app.audioPlayer.formatTime(music.duration)),$("#toggle-media").addClass("hidden"),animation.showMenu("media")},app.audioPlayer.music.addEventListener("canplaythrough",function(){i=app.audioPlayer.music.duration},!1),app.audioPlayer.music.addEventListener("timeupdate",app.audioPlayer.timeUpdate,!1),app.audioPlayer.music.addEventListener("loadedmetadata",app.audioPlayer.loadedData),app.audioPlayer.timeline.addEventListener("click",app.audioPlayer.click,!1),app.audioPlayer.playhead.addEventListener("mousedown",app.audioPlayer.mouseDown,!1),window.addEventListener("mouseup",app.audioPlayer.mouseUp,!1)},app.audioPlayer.play=function(){if($("#play-media").hasClass("play"))music.pause(),$("#play-media").html("&#xf04b").removeClass("play");else{if(isNaN(music.duration))return animation.error(log.AUDIO_EXPIRED),!1;music.play(),$("#play-media").html("&#xf04c").addClass("play")}},app.audioPlayer.quit=function(){$("#play-media").html("&#xf04b").removeClass("play"),$("#audioplayer").fadeOut(400,function(){$(this).remove()}),$("#detail .content .voice p").css("padding-top",""),app.isFunction=!0,app.audioPlayer.music&&(app.audioPlayer.music.removeEventListener("timeupdate",app.audioPlayer.timeUpdate),app.audioPlayer.music.removeEventListener("loadedmetadata",app.audioPlayer.loadedData)),app.audioPlayer.timeline&&app.audioPlayer.timeline.removeEventListener("click",app.audioPlayer.click),app.audioPlayer.playhead&&app.audioPlayer.playhead.removeEventListener("mousedown",app.audioPlayer.mouseDown),window.removeEventListener("mouseup",app.audioPlayer.mouseUp),animation.hideMenu("media")},app.videoPlayer=function(e,a){if(!app.isFunction)return void animation.warn(log.MEDIA_ALREADY_DISPLAYED);app.isFunction=!1,animation.log(log.VIDEO_DOWNLOAD_START,1),$(e).fadeIn(),$("#play-media").html("&#xf04b").removeClass("play").attr("onclick","app.videoPlayer.play()"),$("#stop-media").attr("onclick","app.videoPlayer.quit()");var t='<div id="videoplayer"><video id="video" preload="true"><source src="'+a+'"></video><div id="video-position">00:00</div><div id="timeline"><div id="playhead"></div></div><div id="video-length">--:--</div></div>';$(t).appendTo(e),app.videoPlayer.video=document.getElementById("video"),app.videoPlayer.playhead=document.getElementById("playhead"),app.videoPlayer.timeline=document.getElementById("timeline");var i,n;app.videoPlayer.formatTime=function(e){var a=parseInt(e/60),t=parseInt(e%60);return a=10>a?"0"+a:a,t=10>t?"0"+t:t,a+":"+t},app.videoPlayer.timeUpdate=function(){var e=n*(video.currentTime/i);playhead.style.marginLeft=e+"px",video.currentTime===i?$("#play-media").html("&#xf04b").removeClass("play"):$("#video-position").html(app.videoPlayer.formatTime(video.currentTime))},app.videoPlayer.moveplayHead=function(e){var a=e.pageX-timeline.getBoundingClientRect().left;a>=0&&n>=a&&(playhead.style.marginLeft=a+"px"),0>a&&(playhead.style.marginLeft="0px"),a>n&&(playhead.style.marginLeft=n+"px")},app.videoPlayer.click=function(e){app.videoPlayer.moveplayHead(e);var a=(e.pageX-timeline.getBoundingClientRect().left)/n;video.currentTime=i*a},app.videoPlayer.mouseDown=function(){app.videoPlayer.onplayhead=!0,window.addEventListener("mousemove",app.videoPlayer.moveplayHead,!0),video.removeEventListener("timeupdate",app.videoPlayer.timeUpdate,!1)},app.videoPlayer.mouseUp=function(e){if(app.videoPlayer.onplayhead){app.videoPlayer.moveplayHead(e),window.removeEventListener("mousemove",app.videoPlayer.moveplayHead,!0);var a=(e.pageX-timeline.getBoundingClientRect().left)/n;video.currentTime=i*a,video.addEventListener("timeupdate",app.videoPlayer.timeUpdate,!1)}app.videoPlayer.onplayhead=!1},app.videoPlayer.loadedData=function(){animation.log(log.VIDEO_DOWNLOAD_END,-1),void 0!=app.videoPlayer.height?$("#videoplayer").css("height",app.videoPlayer.height):$("#videoplayer").css("height","450px"),$("#video-length").html(app.videoPlayer.formatTime(video.duration)),$("#toggle-media").removeClass("hidden"),animation.showMenu("media"),$("#video-position, #video-length, #timeline").fadeIn().css("display","inline-block"),n=timeline.offsetWidth-playhead.offsetWidth,this.toggle&&(this.toggle.isFullScreen=!1,this.toggle.windowSelector=void 0),$("#toggle-media").html("&#xf065")},app.videoPlayer.video.addEventListener("canplaythrough",function(){i=app.videoPlayer.video.duration},!1),app.videoPlayer.video.addEventListener("timeupdate",app.videoPlayer.timeUpdate,!1),app.videoPlayer.video.addEventListener("loadedmetadata",app.videoPlayer.loadedData),app.videoPlayer.timeline.addEventListener("click",app.videoPlayer.click,!1),app.videoPlayer.playhead.addEventListener("mousedown",app.videoPlayer.mouseDown,!1),window.addEventListener("mouseup",app.videoPlayer.mouseUp,!1)},app.videoPlayer.toggle=function(){this.toggle.isFullScreen?(this.toggle.windowSelector?($("#video-fullscreen").fadeOut(),$(this.toggle.windowSelector).append($("#videoplayer").css("height","450px")),$("#toggle-media").html("&#xf065")):animation.error("Program error: no app.videoPlayer.toggle.windowSelector"),this.toggle.isFullScreen=!1):(this.toggle.windowSelector=$("#videoplayer").parent(),$("#video-fullscreen").fadeIn().append($("#videoplayer").css("height","-webkit-calc(100% - 25px)")),$("#toggle-media").html("&#xf066"),this.toggle.isFullScreen=!0)},app.videoPlayer.play=function(){if($("#play-media").hasClass("play"))video.pause(),$("#play-media").html("&#xf04b").removeClass("play");else{if(isNaN(video.duration))return animation.error(log.VIDEO_EXPIRED),!1;video.play(),$("#play-media").html("&#xf04c").addClass("play")}},app.videoPlayer.quit=function(){$("#play-media").html("&#xf04b").removeClass("play"),$("#videoplayer").fadeOut(400,function(){$(this).remove()
}),app.isFunction=!0,app.videoPlayer.video&&(app.videoPlayer.video.removeEventListener("timeupdate",app.videoPlayer.timeUpdate),app.videoPlayer.video.removeEventListener("loadedmetadata",app.videoPlayer.loadedData)),app.videoPlayer.timeline&&app.videoPlayer.timeline.removeEventListener("click",app.videoPlayer.click),app.videoPlayer.playhead&&app.videoPlayer.playhead.removeEventListener("mousedown",app.videoPlayer.mouseDown),window.removeEventListener("mouseup",app.videoPlayer.mouseUp),animation.hideMenu("media"),$("#toggle-media").html("&#xf065"),$("#video-fullscreen").fadeOut(),this.toggle.isFullScreen=!1,this.toggle.windowSelector=void 0},app.checkResource=function(){if(0===Object.keys(journal.archive.map).length)return void animation.error(log.MEDIA_CLEAN_NOT_FOUND+log.DOWNLOAD_PROMPT);for(var e=Object.keys(journal.archive.map),a=["images","video","voice"],t=0,i=0,n=journal.archive.data[app.year].length;i!==n;++i)for(var o=journal.archive.data[app.year][i],p=0;p!==a.length;++p)if(o[a[p]])for(var r=0;r<o[a[p]].length;++r){var l=e.indexOf(o[a[p]][r].fileName);-1===l?(++t,o[a[p]].splice(r,1),--r):e.splice(l,1)}app.lostMedia=[];for(var i=0;i!==e.length;++i)app.lostMedia.push(e[i]);animation.log(0===app.lostMedia.length?log.MEDIA_CLEAN_NOT_FOUND:app.lostMedia.length+log.MEDIA_CLEAN_FOUND),0===t?animation.log(log.MEDIA_CLEAN_UNDEFINED_NOT_FOUND):(animation.log(t+log.MEDIA_CLEAN_UNDEFINED_FOUND),app.refresh()),animation.showIcon("#return-lost-media")},app.cleanResource=function(){0===app.lostMedia.length?animation.error(log.MEDIA_CLEAN_NO_DATA):(animation.log(log.MEDIA_CLEAN_START),getTokenCallback(function(e){$.ajax({type:"GET",url:getDataUrlHeader()+":/children?select=name&top=500&access_token="+e}).done(function(a){for(var t=a.value,i=[],n=0,o=t.length;n!==o;++n)i.push(t[n].name);for(var p=0,r=0,n=0;n!==lostMedia.length;++n){var l=lostMedia[n].substring(0,6);l=-1===i.indexOf(l)?"queue":"data/"+l,l="/drive/root:/Apps/Journal/"+l;var s,d={parentReference:{path:l}},u=journal.archive.map[lostMedia[n]].id;s=u?"https://api.onedrive.com/v1.0/drive/items/"+u+"?select=id,@content.downloadUrl&access_token="+e:getResourceUrlHeader(!0)+"/"+encodeURI(lostMedia[n])+"/?select=id,@content.downloadUrl&access_token="+e,$.ajax({type:"PATCH",url:s,contentType:"application/json",data:JSON.stringify(d)}).done(function(){}).fail(function(){++r}).always(function(){++p===app.lostMedia.length&&(animation.log(r>0?r+log.MEDIA_CLEAN_FAIL:log.MEDIA_CLEAN_SUCCESS),app.lostMedia=[])})}}).fail(function(e,a,t){animation.error(log.MEDIA_CLEAN_GET_FOLDERS_FAIL,t,-1)})}))},$(document).ready(function(){app.app=$("div#app"),app.contents=app.app.find(" > #contents"),app.cList=app.app.find(" > #contents > #list"),app.cDetail=app.app.find(" > #contents > #detail"),app.itemView=_.template($("#list-view").html()),app.detailView=_.template($("#detail-view").html()),app.layout(),app.init(),archive.itemView=_.template($("#archive-view").html()),archive.detailView=_.template($("#archive-detail-view").html())});