/**
 * @version 4.0 Build 080415 1952
 * @author Anoxic
 */

window.archive={},archive.data=[],archive.displayId="",archive.isDisplayed=!1,archive.lastLoaded=0,archive.currentDisplayed=-1,archive.confirmName="",archive.init=function(e){$(e).addClass("spinr"),archive.contents=void 0,archive.data=[],archive.confirmName="",getTokenCallback(function(a){animation.log(log.ARCHIVE_START,1),$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:/core/"+app.year+":/children?select=id,name,size,createdDateTime,lastModifiedDateTime,@content.downloadUrl&top=500&orderby=lastModifiedDateTime%20desc&access_token="+a}).done(function(e){e["@odata.nextLink"]&&animation.warn(log.ARCHIVE_TOO_MANY),animation.log(log.ARCHIVE_END,-1);for(var a=e.value,i=0,t=a.length;i!==t;++i){var r=a[i].name;if(("data"===r.substring(0,4)||"_data"===r.substring(0,5))&&".js"===r.substring(r.length-3)&&"data.js"!==r){var n={name:r,id:a[i].id,url:a[i]["@content.downloadUrl"],size:a[i].size,created:Date.parse(a[i].createdDateTime),modified:Date.parse(a[i].lastModifiedDateTime),selected:!1,processed:!1,protect:!1};"_"===r.substring(0,1)&&(n.protect=!0),archive.data.push(n)}}app.audioPlayer.quit(),$("#list").empty(),$("#detail").empty(),archive.isDisplayed=!0,archive.lastLoaded=0,animation.showMenuOnly("archive"),$("#search-new, #search-result").fadeOut(),archive.load()}).fail(function(e,a,i){animation.error(log.FILES_NOT_FOUND,i,-1)}).always(function(){$(e).removeClass("spinr")})})},archive.load=function(){$("#search-result").hide(),archive.detail.prototype.hideDetail(),$("#list").empty(),archive.lastLoaded=0,archive.currentDisplayed=-1;for(var e=0,a=archive.data.length;e!==a;++e)archive.data[e].processed=!1;new archive.list,archive.dataLoaded=!0},archive.list=function(){var e=this,a=app.cList,i=a.children("ul");!this.contents&&i.length<1&&(a.html('<ul></ul><div class="loadmore"></div>'),this.contents=a.children("ul"),this.loadmore=a.children("div.loadmore"),this.loadmore.on("click",function(){e.load()}),this.load(),a.off("scroll").on("scroll",function(){$(this).scrollTop()>e.contents.height()-a.height()&&0!==$(".loadmore").length&&e.load()}))},archive.list.prototype={load:function(){var e=archive.data,a=archive.lastLoaded;for(archive.lastLoaded>=archive.data.length&&(a=archive.lastLoaded=archive.data.length-1),e[a].index=a;;){var i=archive.data[a];if(archive.data[a].created=edit.getMyTime(i.created),archive.data[a].modified=edit.getMyTime(i.modified),this.html(i),++a,!($("#list").get(0).scrollHeight==$("#list").height()&&a<archive.data.length))break}++a>=archive.data.length&&($(".loadmore").remove(),$("#list").append('<li><p class="separator"><span>EOF</span></p></li>')),archive.lastLoaded=a},date:function(e,a){var i=new Date(e);if(isNaN(i.getTime()))return e;var t=i.getFullYear(),r=i.getMonth(),n=i.getDate(),c=i.getHours(),l=i.getMinutes();return l=10>l?"0"+l:l,c=10>c?"0"+c:c,a?c+":"+l:app.monthArray[r]+" "+n+", "+t+" "+c+":"+l},html:function(e){var a=$(archive.itemView(e));a.find(" > a").on("click",function(e){e.preventDefault(),$("#list ul li:nth-child("+(archive.currentDisplayed+1)+") a").removeClass("display"),$(this).addClass("display");var a=archive.currentDisplayed==$(this).parent().index();return a||(archive.currentDisplayed=$(this).parent().index(),$("#detail").hide(),archive.view=new archive.detail),!1}).on("contextmenu",function(){return $(this).toggleClass("change"),!1});var i=a.hide();this.contents.append(i.fadeIn(500))}},archive.detail=function(){var e=archive.data[archive.currentDisplayed];if(e.processed)try{var a=$(archive.detailView(e));return app.cDetail.css("display","inline-block").html(a),app.app.addClass("detail-view"),e.images||$(".center").hide(),$("#detail").fadeIn(500),$(".btn-back",app.cDetail).on("click",function(){this.hideDetail()}),e}catch(i){animation.error(log.ARCHIVE_INVALID_JSON)}else{animation.log(log.CONTENTS_DOWNLOAD_START,1);var t=this;$.ajax({type:"GET",url:e.url}).done(function(a,i,r){animation.log(log.CONTENTS_DOWNLOAD_END,-1);for(var n=JSON.parse(r.responseText).slice(0,50),c=0;c!==n.length;++c)n[c].time.created=edit.getMyTime(n[c].time.created),n[c].time.modified=edit.getMyTime(n[c].time.modified);e.contents=n,e.processed=!0;var l=$(archive.detailView(e));return app.cDetail.css("display","inline-block").html(l),app.app.addClass("detail-view"),$("#detail").fadeIn(500),$(".btn-back",app.cDetail).on("click",function(){t.hideDetail()}),e}).fail(function(e,a,i){animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,i,-1)})}},archive.detail.prototype={htmlSpacialChars:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},hideDetail:function(){app.cDetail.css("display","none").empty(),app.cList.css("display","inline-block"),app.app.removeClass("detail-view")}},archive.restore=function(){return archive.currentDisplayed<0?(animation.error(log.ARCHIVE_NO_SELECTED),!1):(archive.quit(),void downloadFile(archive.data[archive.currentDisplayed].url))},archive.apply=function(){archive.protect(function(){archive.remove(function(){archive.init()})})},archive.protect=function(e){getTokenCallback(function(a){for(var i={},t=0,r=0;r!==archive.data.length;++r){var n=archive.data[r];n&&(n.protect?"_"!==n.name.substring(0,1)&&(i[n.id]="_"+n.name):"_"===n.name.substring(0,1)&&(i[n.id]=n.name.substring(1)))}var c=Object.keys(i);if(0===c.length)animation.log(log.ARCHIVE_NO_PROTECT_CHANGE),e();else{animation.log(log.ARCHIVE_PROTECT_START,1);for(var r=0,l=c.length;r!==l;++r){var o=c[r],d="https://api.onedrive.com/v1.0/drive/items/"+o+"?select=id&access_token="+a,s={name:i[o]};$.ajax({type:"PATCH",url:d,contentType:"application/json",data:JSON.stringify(s)}).done(function(e){delete i[e.id]}).fail(function(e,a,t){i[data.id]=t}).always(function(){if(++t>=l){if(0!==Object.keys(i).length)for(var a=0;a!==archive.data.length;++a)i[archive.data[a].id]&&animation.error(log.ARCHIVE_PROTECT_FAIL+archive.data[a].name+log.SERVER_RETURNS_END+log.SERVER_RETURNS+i[data.id]+log.SERVER_RETURNS_END);animation.log(log.ARCHIVE_PROTECT_END,-1),e()}})}}})},archive.remove=function(e){getTokenCallback(function(a){for(var i=0,t=0,r=0,n=0;n!==archive.data.length;++n)archive.data[n]["delete"]&&(archive.data[n].protect?(animation.log(log.ARCHIVE_PROTECT_REMOVE+archive.data[n].name+log.ARCHIVE_PROTECT_REMOVE_END),archive.data[n]["delete"]=!1):++i);if(0===i)animation.log(log.ARCHIVE_NO_SELECTED_REMOVE),e();else{animation.log(log.ARCHIVE_REMOVE_START,1);for(var n=0;n!==archive.data.length;++n)archive.data[n]["delete"]&&$.ajax({type:"DELETE",url:"https://api.onedrive.com/v1.0/drive/items/"+archive.data[n].id+"?access_token="+a}).done(function(){}).fail(function(){++t}).always(function(){++r>=i&&(t>0&&animation.error(log.ARCHIVE_REMOVE_FAIL),animation.log(i-t+log.CONTENTS_DOWNLOAD_MEDIA_OF+i+log.ARCHIVE_REMOVE_END,-1),e())})}})},archive.toggle=function(e){var a=!1;$("#list .archive").each(function(i){$(this).children("a").hasClass("change")&&(a=!0,archive.data[i][e]=$(this).children("a").toggleClass(e).hasClass(e)?!0:!1,$(this).children("a").removeClass("change"))}),a||animation.warn(log.ARCHIVE_NO_SELECTED)},archive.selectBelow=function(){var e=archive.currentDisplayed;-1===e&&animation.log(log.ARCHIVE_SELECT_ALL),++e,$("#list .archive").each(function(a){a>=e&&$(this).children("a").addClass("change")})},archive.reverse=function(){$("#list .archive").each(function(){$(this).children("a").toggleClass("change")})},archive.clear=function(){$("#list .archive").each(function(){$(this).children("a").removeAttr("class")})},archive.quit=function(){archive.isDisplayed&&(archive.isDisplayed=!1,$("#list").empty(),$("#detail").empty(),$("#refresh-media").trigger("click"),$("#search-new, #search-result").fadeIn(),animation.showMenuOnly("menu"))};
