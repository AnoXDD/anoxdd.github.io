/**
 * @version 4.0 Build 080415 1950
 */

window.edit={},edit.time=0,edit.intervalId=-1,edit.confirmVal="",edit.currentEditing=-1,edit.photos=[],edit.voices=[],edit.videos=[],edit.mediaIndex={},edit.isEditing=-1,edit.isFolder=!1,edit.folderDate="",edit.isEditPaneDisplayed=!1,edit.removalList={},edit.localChange=[],edit.isProcessing=!1,edit.init=function(e,t){app.audioPlayer.quit(),app.videoPlayer.quit(),app.videoPlayer.height="-webkit-calc(100% - 32px)",edit.editView=_.template($("#edit-view").html());var a;if(1==localStorage._cache){if(1==e)edit.cleanEditCache(),void 0!=t&&-1!=t&&(a=journal.archive.data[app.year][t],localStorage.created=a.time.created);else if(0==e)localStorage.created&&(t=edit.find(localStorage.created),-1!==t&&(a=journal.archive.data[app.year][t]));else if(void 0==e)return void animation.warn(log.OVERWRITE_CACHE_WARNING)}else void 0!=t&&(a=journal.archive.data[app.year][t]);a=a||edit.newContent(),localStorage._cache=1,edit.mediaIndex={place:-1,music:-1,book:-1,movie:-1,weblink:-1,video:-1,voice:-1},edit.isEditing=-1,edit.isFolder=!1,edit.folderDate="",a=edit.importCache(a),edit.photos=[],edit.videos=[],edit.voices=[];for(var i=["video","voice"],o=0;o!==i.length;++o){var n;if("video"===i[o])n=edit.videos;else{if("voice"!==i[o])break;n=edit.voices}if(a[i[o]])for(var r=0;r!==a[i[o]].length;++r){var d=a[i[o]][r].fileName;journal.archive.map[d]&&n.push({name:d,title:a[i[o]][r].title,size:journal.archive.map[d].size,id:journal.archive.map[d].id,resource:!0,change:!1})}}console.log(Object.keys(a));var l=$(edit.editView(a));$("#search-new, #search-result").fadeOut(),$("#contents").fadeOut(400,function(){$("#edit-pane").html(l).fadeIn(),edit.isEditPaneDisplayed=!0,$("#photo-preview").hide(),$("#entry-header").keyup(function(e){edit.saveTitle(),13==e.keyCode&&$("#entry-body").focus()}).blur(function(){var e,t=$(this).val().substring(0,6);if(!isNaN(parseInt(t))){var a=edit.convertTime(t);e=new Date(a);var i=e.getMonth()+1==t.substring(0,2),o=e.getDate()==t.substring(2,4),n=e.getFullYear()%100==t.substring(4,6)&&e.getFullYear()===app.year;if(i&&o&&n)return}e=(new Date).getTime(),e=new Date(e-144e5),$(this).val(edit.format(e.getMonth()+1)+edit.format(e.getDate())+edit.format(e.getFullYear()%100)+" "+$(this).val())}),$("#entry-tag").keyup(function(e){13==e.keyCode&&(edit.addTag(),$("#entry-tag").val(""))}),$("#attach-area .texttags .other p").click(function(){edit.removeTag($(this).text().substring(1))});for(var e=["music","book","movie"],t=0;t!=e.length;++t)for(var i=e[t],o=0;o!=$("#attach-area ."+i).length;++o){var n=edit.getSelectorHeader(i,o),r=$(n+".title").val()+"%20"+$(n+".desc").val();getCoverPhoto(n,r,!1,i)}if(localStorage.title&&$("#entry-header").val(localStorage.title),localStorage.body&&$("#entry-body").text(localStorage.body),localStorage.coverType){var d=-1;switch(parseInt(localStorage.coverType)){case 128:++d;case 16:++d;case 32:++d;case 4:++d;case 8:++d;case 64:++d;case 2:++d;case 1:++d}edit.coverSet(d)}for(var c=app.tag().getIconsInHtml(),s=app.tag().getIconsInName(),g=app.tag().separate(localStorage.tags).iconTags,t=0;t!==c.length;++t){var p="#attach-area .icontags";p+="w"==c[t].charAt(0)?" .weather":"e"==c[t].charAt(0)?" .emotion":" .other",$(p).append("<p class='icons "+c[t]+"' title="+s[t].capitalize()+" onclick=edit.toggleTag('"+s[t]+"',true)></p>")}for(var t=0;t!==c.length;++t)-1!==g.indexOf(c[t])&&edit.toggleIcon(s[t]);$("#entry-body").bind("keyup","return",function(){localStorage.body=$("#entry-body").val();for(var e=$("#entry-body").val().split(/\r*\n/),t=0;t<e.length;++t){var i,o=e[t],n=!1;"Begin @"===o.substring(0,7)?(i=edit.convertTime(o.substring(8)),new Date(i).getFullYear()===app.year?(a.time.start=i,animation.log(log.START_TIME_CHANGED_TO+app.list.prototype.date(i))):animation.error(log.TIME_NOT_IN_RANGE),n=!0):"End @"===o.substring(0,5)?(a.time.end=edit.convertTime(o.substring(6)),animation.log(log.END_TIME_CHANGED_TO+app.list.prototype.date(a.time.end)),n=!0):"Created @"===o.substring(0,9)?(i=edit.convertTime(o.substring(10)),new Date(i).getFullYear()===app.year?(a.time.created=i,animation.log(log.CREATED_TIME_CHANGED_TO+app.list.prototype.date(i))):animation.error(log.TIME_NOT_IN_RANGE),n=!0):o.length>2&&"#"===o.charAt(0)&&(edit.addTag(o.substring(1)),n=!0),n&&e.splice(t--,1)}var r=e.join("\r\n");$("#entry-body").val(r)}).bind("keyup","space",function(){edit.refreshSummary()}).bind("keyup","ctrl+shift+f",function(){edit.toggleTag("friendship")}).bind("keyup","alt+ctrl+r",function(){edit.toggleTag("relationship")}).bind("keyup","alt+ctrl+i",function(){edit.toggleTag("ingress")}).bind("keyup","alt+ctrl+t",function(){edit.toggleTag("thoughts")}).bind("keyup","alt+ctrl+j",function(){edit.toggleTag("journal")}).bind("keyup","alt+ctrl+m",function(){edit.toggleTag("minecraft")}),$("#edit-pane #attach-area .icontags .other, #edit-pane #attach-area .texttags .other, #edit-pane #attach-area .images").mousewheel(function(e,t){this.scrollLeft-=50*t,e.preventDefault()}),edit.playableSetToggle(),edit.refreshSummary()}),animation.showMenuOnly("add"),edit.intervalId=setInterval(edit.refreshTime,1e3)},edit.quit=function(e,t){return network.isAjaxActive?void animation.warning(log.NETWORK_WORKING):(clearInterval(edit.intervalId),edit.time=0,edit.mediaIndex={},edit.localChange=[],t?edit.save(e):animation.debug(log.EDIT_PANE_QUIT),edit.photos=[],edit.removalList={},edit.cleanupMediaEdit(),$("#search-new, #search-result").fadeIn(),$("#edit-pane").fadeOut(400,function(){edit.isEditPaneDisplayed=!1,$("#edit-pane").html(""),$("#contents").fadeIn(),app.refresh(),animation.showMenuOnly("edit")}),edit.cleanEditCache(),animation.testCacheIcons(),void(app.videoPlayer.height=void 0))},edit.save=function(e){if(network.isAjaxActive)return void animation.warning(log.NETWORK_WORKING);var t,a;animation.log(log.EDIT_PANE_SAVE_START,1),network.init(3),animation.isShown("#action-remove-confirm")&&(animation.debug(log.EDIT_PANE_SAVE_PENDING_ATTACHMENTS),edit.confirm()),e&&(a=$(e).html(),$(e).html("&#xf1ce").removeAttr("onclick").removeAttr("href"),t=animation.blink(e)),edit.processRemovalList(),edit.photoSave(function(){network.init(),edit.playableSave(1,function(){network.init(),edit.playableSave(3,function(){network.init(),clearInterval(t);var i=edit.find(localStorage.created);edit.exportCache(i),edit.sortArchive(),edit.removeDuplicate(),journal.archive.data[app.year]=edit.minData(),edit.saveDataCache(),$(e).html(a).removeClass("spin").attr({onclick:"edit.save('"+e+"')",href:"#"}),animation.finished(e),animation.log(log.EDIT_PANE_SAVE_END,-1),network.destroy(),uploadSingleFile()})})})},edit.processRemovalList=function(){for(var e=0;e<edit.removalList.length;++e)if(localStorage[e]){for(var t=JSON.parse(localStorage[e]),a=0;a<edit.removalList[e].length;++a)t.splice(edit.removalList[e][a],1);localStorage[e]=JSON.stringify(t)}},edit.importCache=function(e){localStorage.title?e.title=localStorage.title:e.title&&(localStorage.title=e.title),localStorage.body?(e.text||(e.text={}),e.text.body=localStorage.body):e.text&&e.text.body&&(localStorage.body=e.text.body),localStorage.created=e.time.created,localStorage.tags?e.tags=localStorage.tags:localStorage.tags=e.tags?e.tags:"";for(var t=["images","video","voice","place","music","book","movie","weblink"],a=0;a!==t.length;++a){var i=t[a];localStorage[i]?e[i]=JSON.parse(localStorage[i]):localStorage[i]=e[i]?JSON.stringify(e[i]):"[]"}return localStorage.coverType=e.coverType||0,e},edit.exportCache=function(e){var t=journal.archive.data[app.year][e]||{};t=edit.exportCacheBody(t),t.processed=0,t.title=localStorage.title||"Untitled",t.coverType=parseInt(localStorage.coverType),t.coverType<=0&&(t.coverType=edit.coverAuto()),t.attachments||(t.attachments=0),t.tags=localStorage.tags||"";for(var a,i=["images","video","music","voice","book","movie","place","weblink"],o=0,n=0;n<i.length;++n){a=localStorage[i[n]]?JSON.parse(localStorage[i[n]]):[];for(var r=0;r<a.length;++r)a[r]&&""!=a[r].title||a.splice(r--,1);t[i[n]]=0==a.length?void 0:a,0==a.length?t[i[n]]=void 0:(o|=Math.pow(2,n),t[i[n]]=a)}t.attachments=o,0>e?journal.archive.data[app.year].push(t):(journal.archive.data[app.year][e]=t,app.currentDisplayed=-1)},edit.exportCacheBody=function(e){e.time||(e.time={}),e.time.created=parseInt(localStorage.created),e.text||(e.text={});var t=localStorage.body;return t=t||"",e.text.body=t,e.text.chars=t.length,e.text.lines=t.split(/\r*\n/).length,e.text.ext=t.substring(0,50),e},edit.cleanEditCache=function(){localStorage._cache=0;for(var e=["title","body","created","currentEditing","tags","place","music","movie","book","images","weblink","video","voice"],t=0;t!=e.length;++t)delete localStorage[e[t]];edit.photos=[],edit.voices=[],edit.videos=[]},edit.saveDataCache=function(){localStorage.archive=JSON.stringify(journal.archive.data[(new Date).getFullYear()])},edit.removeDataCache=function(){delete localStorage.archive},edit.tryReadCache=function(){localStorage.archive&&(journal.archive.data[(new Date).getFullYear()]=JSON.parse(localStorage.archive),app.refresh())},edit.find=function(e){for(var t=0,a=journal.archive.data[app.year].length;t!=a;++t)if(journal.archive.data[app.year][t]&&journal.archive.data[app.year][t].time&&journal.archive.data[app.year][t].time.created==e)return t;return-1},edit.newContent=function(){var e={};e.time={},e.time.created=(new Date).getTime(),e.tags="";for(var t=["images","video","voice","place","music","book","movie","weblink","iconTags","textTags"],a=0;a!==t.length;++a)e[t[a]]=void 0;return e},edit.minData=function(){for(var e=journal.archive.data[app.year].filter(function(e){return void 0!=e}),t=0,a=e.length;t!=a;++t){delete e[t].attached,delete e[t].contents,delete e[t].datetime,delete e[t].endtime,delete e[t].ext,delete e[t].index,delete e[t].lines,delete e[t].month,delete e[t].processed,delete e[t].summary,delete e[t].type;for(var i=0;i<e[t].length;++i)(void 0==e[t][i]||"undefined"==e[t][i])&&e[t].splice(i--,1)}return e},edit.sortArchive=function(){journal.archive.data[app.year].sort(function(e,t){return t.time.created-e.time.created})},edit.removeDuplicate=function(){for(var e=0;e<journal.archive.data[app.year].length-1;++e)journal.archive.data[app.year][e].time.created===journal.archive.data[app.year][e+1].time.created&&(app.yearChange[app.year]=!0,journal.archive.data[app.year].splice(e--,1))},edit.undo=function(){},edit.change=function(){},edit.removeEntry=function(){if(-1==app.currentDisplayed)return animation.error(log.NO_ENTRY_SELECTED),void animation.deny("#delete");app.yearChange[app.year]=!0,$("#year-change").addClass("change"),--app.displayedNum;var e=journal.archive.data[app.year][app.currentDisplayed];app.displayedChars-=e.text.chars,app.displayedLines-=e.text.lines,app.displayedTime-=(e.time.end-e.time.start)/6e4,delete journal.archive.data[app.year][app.currentDisplayed];var t=$("#list ul li:nth-child("+(app.currentDisplayed+1)+")");0===t.next().length||0!==t.next.has("p.separator").length?t.fadeOut(500,function(){$(this).empty()}):t.children("a").fadeOut(500,function(){$(this).remove()}),app.detail.prototype.hideDetail(),$(".loadmore").trigger("click"),edit.saveDataCache(),animation.showMenuOnly("edit")},edit.addMedia=function(e,t){var a,i="#attach-area ."+edit.mediaName(Math.abs(e)),o=$(i).length;switch(e){case 0:return void edit.photo();case 1:edit.videoSearch();break;case-1:a='<div class="video data change"><a class=\''+t.fileName+"' onclick=\"edit.video("+o+",'"+t.url+'\')" title="View"><div class="thumb"><span></span></div><input disabled class="title" value="'+t.title+'" /></a></div>';break;case 2:a='<div class="place"><a title="Edit" onclick="edit.location('+o+')" href="#"><div class="thumb"></div><input disabled title="Place" class="title place-search" autocomplete="off"/><input disabled title="Latitude" class="desc latitude" autocomplete="off" /><p>,</p><input disabled title="Longitude" class="desc longitude" autocomplete="off" /></a></div>';break;case 3:edit.voiceSearch();break;case-3:a='<div class="voice data change"><a class=\''+t.fileName+"' onclick=\"edit.voice("+o+",'"+t.url+'\')" title="View"><div class="thumb"><span></span></div><input disabled class="title" value="'+t.title+'" /></a></div>';break;case 4:a='<div class="music"><a title="Edit" onclick="edit.music('+o+')" href="#"><img class="thumb"><span></span><input disabled class="title" placeholder="Track name" autocomplete="off" /><input disabled class="desc" placeholder="Artist" autocomplete="off" /></a></div>';break;case 5:a='<div class="movie"><a title="Edit" onclick="edit.movie('+o+')" href="#"><img class="thumb"><span></span><input disabled class="title" placeholder="Movie title" autocomplete="off" onclick="this.select()" /><input disabled class="desc" placeholder="Director" autocomplete="off" onclick="this.select()" /></a></div>';break;case 6:a='<div class="book"><a title="Edit" onclick="edit.book('+o+')" href="#"><img class="thumb"><span></span><input disabled class="title" placeholder="Book title" autocomplete="off" onclick="this.select()" /><input disabled class="desc" placeholder="Author" autocomplete="off" onclick="this.select()" /></a></div>';break;case 7:a='<div class="weblink"><a title="Edit" onclick="edit.weblink('+o+')" href="#"><div class="thumb"><span></span></div><input disabled class="title" placeholder="Title" /><input disabled class="desc" placeholder="http://" /></a></div>';break;default:return}o>0?$(a).insertAfter($(i+":eq("+(o-1)+")")):$(a).appendTo("#attach-area"),e>0&&$(i+":eq("+o+") a").trigger("click")},edit.removeMedia=function(e){var t=edit.mediaName(e);switch(edit.coverTest(t),e){case 1:case 3:break;default:edit.addToRemovalList(t)}edit.cleanupMediaEdit()},edit.addMediaFromQueue=function(){$("#return-lost-media").removeAttr("onclick"),animation.log(log.QUEUE_START,1),network.init(1),edit.photo(!0,function(){network.next(),getTokenCallback(function(e){var t="https://api.onedrive.com/v1.0/drive/special/approot:/queue:/children?select=id,name,size,@content.downloadUrl&access_token="+e;$.ajax({type:"GET",url:t}).done(function(e){for(var t=0,a=e.value,i=0,o=0,n=0,r=a.length;n!==r;++n){var d=a[n].id,l=a[n].size,c=a[n].name,s=a[n]["@content.downloadUrl"],g=c.substring(c.length-4).toLowerCase(),p={id:d,name:c,title:c.substring(0,c.length-4),url:s,size:l,resource:!1,change:!0},u=!0;if(".mp4"===g){for(t=0;t!==edit.videos.length;++t)if(edit.videos[t].size===l){u=!1;break}if(!u)continue;++o,edit.videos.push(p),edit.addMedia(-1,{fileName:c,url:s,title:c.substring(0,c.length-4)})}else if(".mp3"===g||".wav"===g){for(t=0;t!==edit.voices.length;++t)if(edit.voices[t].size===l){u=!1;break}if(!u)continue;++i,edit.voices.push(p),edit.addMedia(-3,{fileName:c,url:s,title:c.substring(0,c.length-4)})}}edit.playableSetToggle(),o>0&&animation.debug(o+log.QUEUE_FOUND_VIDEOS),i>0&&animation.debug(i+log.QUEUE_FOUND_VOICES)}).fail(function(e,t,a){animation.error(log.QUEUE_FAILED,a)}).always(function(){$("#return-lost-media").attr("onclick","app.cleanResource()"),animation.log(log.QUEUE_END,-1)})})})},edit.addToRemovalList=function(e,t){edit.removalList[e]||(edit.removalList[e]=[]),void 0==t&&(t=edit.mediaIndex[e]);var a=edit.getSelectorHeader(e,t);$(a).fadeOut(),-1!==edit.removalList[e].indexOf(t)&&edit.removalList[e].push(t)},edit.mediaName=function(e){switch(e){case 0:return"photo";case 1:return"video";case 2:return"place";case 3:return"voice";case 4:return"music";case 5:return"movie";case 6:return"book";case 7:return"weblink";default:return""}},edit.mediaValue=function(e){return"photo"===e?0:"video"===e?1:"place"===e?2:"voice"===e?3:"music"===e?4:"movie"===e?5:"book"===e?6:"weblink"===e?7:-1},edit.setRemove=function(e){edit.confirmVal=e,2===e&&$("#pin-point").removeClass("hidden"),$("#action-remove-confirm").removeClass("hidden")},edit.cleanupMediaEdit=function(){switch($("#edit-pane").off("keyup"),edit.isEditing){case 1:edit.videoHide();break;case 2:edit.locationHide();break;case 3:edit.voiceHide();break;case 4:edit.musicHide();break;case 5:edit.movieHide();break;case 6:edit.bookHide();break;case 7:edit.weblinkHide()}},edit.getSelectorHeader=function(e,t){return void 0==t?"#attach-area ."+e+":eq("+edit.mediaIndex[e]+") ":"#attach-area ."+e+":eq("+t+") "},edit.toggleLight=function(){$("#text-area").toggleClass("dark").children().toggleClass("dark")},edit.fullScreen=function(){edit.cleanupMediaEdit(),$(window).off("resize"),animation.showMenuOnly("fullscreen"),$(".header").fadeOut(400,function(){$("#app").animate({top:"2%",height:"95%"})}),$("#attach-area").fadeOut(400,function(){$("#text-area").animate({width:"100%"})}),$("#text-area").children().toggleClass("fullscreen"),$("#text-area p").toggleClass("fullscreen")},edit.windowMode=function(){$("#text-area").removeClass("dark").children().removeClass("dark"),animation.showMenuOnly("add"),$("#app").animate({top:"8%",height:"76%"}),$(".header").fadeIn(400,function(){$("#text-area p").toggleClass("fullscreen"),$("#text-area").animate({width:"64%"},function(){$("#attach-area").fadeIn(),app.layout()}).children().toggleClass("fullscreen")})},edit.saveTitle=function(){localStorage.title=$("#entry-header").val()},edit.refreshSummary=function(){var e=$("#entry-body").val(),t=e.length;$("#entry-char").text(t),$("#entry-line").text(e.split(/\r*\n/).length)},edit.refreshTime=function(){++edit.time;var e=new Date,t=edit.format(e.getMonth()+1)+edit.format(e.getDate())+edit.format(e.getFullYear()%100)+" "+edit.format(e.getHours())+edit.format(e.getMinutes());$("#entry-time").text(t),$("#entry-elapsed").text(parseInt(edit.time/60)+":"+edit.format(edit.time%60))},edit.format=function(e){return 10>e?"0"+e:e},edit.convertTime=function(e){var t=parseInt(e.substring(0,2)),a=parseInt(e.substring(2,4)),i=parseInt(e.substring(4,6)),o=parseInt(e.substring(7,9)),n=parseInt(e.substring(9,11)),r=new Date(2e3+i,t-1,a,o,n);return r.getTime()},edit.getDate=function(e){var t;if(localStorage.title&&(t=parseInt(localStorage.title),isNaN(t)||(t=t.toString(),5===t.length&&(t="0"+t),6!==t.length&&(t=""))),!t){var a;localStorage.created?a=new Date(parseInt(localStorage.created)):(a=(new Date).getTime(),a=new Date(a-144e5)),t=""+edit.format(a.getMonth()+1)+edit.format(a.getDate())+edit.format(a.getFullYear()%100)}return t!=edit.folderDate?createDateFolder(t,e):e(t),t},edit.getMyTime=function(e){var t=new Date(e);return isNaN(t.getTime())?e:""+edit.format(t.getMonth()+1)+edit.format(t.getDate())+edit.format(t.getFullYear()%100)+" "+edit.format(t.getHours())+edit.format(t.getMinutes())},edit.addTag=function(e,t){if(e=e||$("#entry-tag").val().toLowerCase().replace(/\|/g,""),-1!==localStorage.tags.split("|").indexOf(e))animation.warn(log.TAG_ADD_HEADER+e+log.TAG_ADDED_ALREADY),$("#entry-tag").effect("highlight",{color:"#000"},400);else{var a=!1,i=!1;$("#attach-area .icontags p").each(function(){if($(this).attr("title").toLowerCase()===e){a=!0;var o=$(this).parent().attr("class");if(("weather"===o||"emotion"===o)&&"0px"===$(this).css("height"))return animation.warn(log.TAG_ICON_ADD_HEADER+e+log.TAG_ADDED_FAILED),void $("#entry-tag").effect("highlight",{color:"#000"},400);$(this).hasClass("highlight")?(animation.warn(log.TAG_ICON_ADD_HEADER+e+log.TAG_ADDED_ALREADY),$("#entry-tag").effect("highlight",{color:"#000"},400)):(t||animation.log(log.TAG_ICON_ADD_HEADER+e+log.TAG_ADDED),edit.toggleIcon(e),i=!0)}}),a||($("#entry-tag").effect("highlight",{color:"#dadada"},400),$("#attach-area .texttags .other").append("<p title='Click to remove' onclick=edit.removeTag('"+e+"')>#"+e+"</p>"),i=!0),i&&(localStorage.tags?localStorage.tags+="|"+e:localStorage.tags=e)}},edit.removeTag=function(e,t){for(var a=localStorage.tags.split("|"),i=0;i!==a.length;++i)if(a[i]===e){var o=!1;return $("#attach-area .texttags p").each(function(){$(this).text()==="#"+e&&$(this).animate({width:"0"},function(){$(this).remove(),o=!0})}),o||$("#attach-area .icontags p").each(function(){$(this).attr("title").toLowerCase()===e&&(t||animation.log(log.TAG_ICON_ADD_HEADER+e+log.TAG_REMOVED),edit.toggleIcon(e))}),a.splice(i,1),void(localStorage.tags=a.join("|"))}},edit.toggleTag=function(e,t){-1!==localStorage.tags.split("|").indexOf(e)?edit.removeTag(e,t):edit.addTag(e,t)},edit.toggleIcon=function(e){var t=app.tag().getHtmlByName(e),a="#attach-area .icontags p."+t,i=$(a).parent().attr("class");$(a).toggleClass("highlight").hasClass("highlight")?("weather"==i||"emotion"==i)&&$("#attach-area .icontags ."+i+" p:not(."+t+")").css("height","0"):("weather"==i||"emotion"==i)&&$("#attach-area .icontags ."+i+" p:not(."+t+")").removeAttr("style")},edit.coverSet=function(e,t){var a,i=e;switch("string"==typeof e&&(i=edit.mediaValue(e)),i){case 0:a=1;break;case 1:a=2;break;case 2:a=64;break;case 3:a=8;break;case 4:a=4;break;case 5:a=32;break;case 6:a=16;break;case 7:a=128;break;default:a=0}if($(".types p").removeClass("hidden selected"),t&&localStorage.coverType==a)localStorage.coverType=a=-1;else{localStorage.coverType=a;var o=edit.mediaName(i);$(".types p:not(#"+edit.mediaName(i)+"-cover)").addClass("hidden"),o?$(".types #"+edit.mediaName(i)+"-cover").addClass("selected"):$(".types #no-cover").addClass("selected")}return a},edit.coverAuto=function(e){var t=["images","music","book","movie","video","voice","weblink","place"];e=e||edit.coverRefresh();for(var a=0;a!==t.length;++a)if(-1!==e.indexOf(t[a]))return edit.coverSet(t[a]);edit.coverSet(-1),animation.log(log.COVERTYPE_AUTO_CHOSEN)},edit.coverRefresh=function(){for(var e=["images","video","voice","place","music","book","movie","weblink"],t=[],a=0;a!==e.length;++a)if(e[a]in localStorage&&0!==localStorage[e[a]].length)try{0!==Object.keys(JSON.parse(localStorage[e[a]])).length&&t.push(e[a])}catch(i){}return t},edit.coverTest=function(e){var t=!1;$("#attach-area ."+e).each(function(){"none"!==$(this).css("display")&&(t=!0)}),t||$("#attach-area .types #"+e+"-cover").trigger("click")},edit.photo=function(e,t){if(0!==edit.photos.length&&!e)return void animation.error(log.EDIT_PANE_IMAGES_ALREADY_LOADED);var a=JSON.parse(localStorage.images);if(a&&0===Object.keys(journal.archive.map).length)return animation.error(log.EDIT_PANE_IMAGES_FAIL+log.DOWNLOAD_PROMPT),void animation.deny("#add-photo");var i=!1;"100px"!==$("#attach-area .images").css("height")&&e&&(i=!0,e=!1),$("#attach-area .images").css({height:"100px"}).hover(function(){edit.cleanupMediaEdit(),$("#photo-preview").css("opacity","initial").show({effect:"fade",duration:200})},function(){$("#photo-preview").hide({effect:"fade",duration:200})}).sortable({containment:"#attach-area .images",cursor:"crosshair",revert:!0}).disableSelection();var o=function(a){getTokenCallback(function(o){var n;n=e?"https://api.onedrive.com/v1.0/drive/special/approot:/queue:/children?select=id,name,size,@content.downloadUrl&access_token="+o:getDataUrlHeader()+"/"+a+":/children?select=id,name,size,@content.downloadUrl&access_token="+o,$.ajax({type:"GET",url:n}).done(function(t){t["@odata.nextLink"]&&!e&&animation.warn(log.EDIT_PANE_TOO_MANY_RESULTS);for(var a=t.value,i=0,o=0,n=a.length;o!==n;++o){var r=a[o].size,d=a[o].id,l=a[o].name,c=l.substring(l.length-4).toLowerCase(),s=!1;if(".jpg"===c||".png"===c){for(var g=0,p=edit.photos;g!==p.length;++g)if(p[g].size==r){s=!0;break}if(!s){var u={name:l,id:d,url:a[o]["@content.downloadUrl"],size:r,resource:!1,change:!1};++i,edit.photos.push(u)}}}var g;for(g=e?edit.photos.length-i:0;g!==edit.photos.length;++g){var h;h=e?'<div class="queue">':edit.photos[g].resource?'<div class="resource">':'<div class="data">',h+='<span></span><img src="'+edit.photos[g].url+'"/></div>',$("#attach-area .images").append(h)}$("#add-photo").html("&#xf03e").removeClass("spin").attr({onclick:"edit.addMedia(0)",href:"#"}).fadeIn(),$("#attach-area .images div").each(function(){$(this).off("contextmenu"),$(this).on("contextmenu",function(){return $(this).toggleClass("change"),!1})}),$("#attach-area .images img").each(function(){$(this).unbind("mouseenter mouseleave").hover(function(){$("#photo-preview img").animate({opacity:1},200).attr("src",$(this).attr("src"))},function(){$("#photo-preview img").animate({opacity:0},0)})}),e?animation.debug(i+log.QUEUE_FOUND_IMAGES):(edit.setRemove(0),0===edit.photos.length?animation.log(log.EDIT_PANE_IMAGES_END_NO_RESULT,-1):animation.log(log.EDIT_PANE_IMAGES_END,-1),animation.finished("#add-photo"))}).fail(function(t,o,n){e||($("#add-photo").html("&#xf03e").removeClass("spin").attr({onclick:"edit.addMedia(0)",href:"#"}),"Not Found"!==n||i?--animation.indent:(animation.error(log.EDIT_PANE_IMAGES_FAIL+log.EDIT_PANE_IMAGES_FIND_FAIL+a,n,-1),animation.deny("#add-photo")))}).always(function(){i?edit.photo(!0,t):t()})})};if(e)$("#attach-area .images .queue").each(function(){for(var e=0;e!==edit.photos.length;++e){var t=$(this).children("img").attr("src");if(edit.photos[e].url===t){edit.photos.splice(e,1);break}}$(this).remove()}),o();else{$("#add-photo").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"),edit.photos=[];for(var n=0;n<a.length;++n){var r=a[n].fileName;if(journal.archive.map[r]){var d={name:r,id:journal.archive.map[r].id,size:journal.archive.map[r].size,url:journal.archive.map[r].url,resource:!0,change:!1};edit.photos.push(d)}else a.splice(n--,1),localStorage.images=JSON.stringify(a)}edit.getDate(function(e){animation.log(log.EDIT_PANE_IMAGES_START+e+log.EDIT_PANE_IMAGES_START_END,1),o(e)})}},edit.photoSave=function(e){if(0==edit.photos.length)return void e();var t=[],a=[];edit.getDate(function(i){$("#attach-area .images div").each(function(){for(var e=0;e!==edit.photos.length;++e)if($(this).children("img").attr("src")===edit.photos[e].url){edit.photos[e].change=$(this).hasClass("change");break}});for(var o=0;o!==edit.photos.length;++o){var n=edit.photos[o].name,r=edit.photos[o].id,d=edit.photos[o].resource;edit.photos[o].change&&(edit.photos[o].change=!1,t.push({name:n,id:r,resource:!d}))}var l="/drive/root:/Apps/Journal/resource/"+app.year,c="/drive/root:/Apps/Journal/data/"+app.year+"/"+i,s=0;0!==t.length?getTokenCallback(function(o){animation.log(log.EDIT_PANE_IMAGES_SAVE_START,1);for(var n=0;n!==t.length;++n){var r,d,g=t[n].name,p=t[n].id,u=t[n].resource,h="https://api.onedrive.com/v1.0/drive/items/"+p+"?select=id,name,size,@content.downloadUrl&access_token="+o;u?(d=i+((new Date).getTime()+n)+g.substring(g.length-4),r={name:d,parentReference:{path:l}}):(d=g,r={parentReference:{path:c}}),$.ajax({type:"PATCH",url:h,contentType:"application/json",data:JSON.stringify(r)}).done(function(e){for(var a=e.id,i=e.name,o=0;o!==edit.photos.length;++o)edit.photos[o].id==a&&(edit.photos[o].success=!0,edit.photos[o].name=i,journal.archive.map[e.name]={url:e["@content.downloadUrl"],size:e.size,id:e.id});animation.debug(++s+log.EDIT_PANE_IMAGES_OF+t.length+log.EDIT_PANE_IMAGES_TRASNFERRED)}).fail(function(e,t,a){++s,animation.error(log.EDIT_PANE_TRANSFERRED_FAILED+log.SERVER_RETURNS+a+log.SERVER_RETURNS_END),animation.warning("#add-photo")}).always(function(){var i;if(s===t.length){for($("#attach-area .images div").each(function(){for($(this).removeClass("change"),i=0;i!==edit.photos.length;++i)if($(this).children("img").attr("src")===edit.photos[i].url){edit.photos[i].success&&(edit.photos[i].resource?($(this).addClass("data").removeClass("resource"),delete journal.archive.map[edit.photos[i].name]):$(this).addClass("resource").removeClass("queue data"),edit.photos[i].resource=!edit.photos[i].resource);break}}),i=0;i!==edit.photos.length;++i)edit.photos[i].change=!1,edit.photos[i].success=!1,edit.photos[i].resource&&a.push({fileName:edit.photos[i].name});localStorage.images=JSON.stringify(a),animation.log(log.EDIT_PANE_FINISHED_TRANSFER+edit.mediaName(0)+log.EDIT_PANE_FINISHED_TRANSFER_END,-1),e()}})}}):e()})},edit.photoHide=function(){$("#attach-area .images").animate({height:"0"}).fadeOut().html("")},edit.video=function(e,t){if(e!=edit.mediaIndex.video&&void 0!=e){edit.cleanupMediaEdit(),edit.mediaIndex.video=e;var a=edit.getSelectorHeader("video");edit.setRemove(1),edit.func=$(a+"a").attr("onclick"),$(a+"a").removeAttr("onclick"),$(a+"input").prop("disabled",!1),$("#edit-pane").keyup(function(e){27===e.keyCode&&edit.videoHide()}),edit.isEditing=1;var i;if(t)i=t,$("#text-area #video-preview").fadeIn(),app.videoPlayer("#text-area #video-preview",i);else{var o=$(a+"a").attr("class");if(journal.archive.map[o]){if(i=journal.archive.map[o].url,void 0==i)return void animation.error(log.FILE_NOT_FOUND+$(a+".title").val());$("#text-area #video-preview").fadeIn(),app.videoPlayer("#text-area #video-preview",i)}else animation.error(log.FILE_NOT_LOADED+$(a+".title")+log.DOWNLOAD_PROMPT)}edit.setRemove(1)}},edit.videoHide=function(){if(!(edit.mediaIndex.video<0)){$("#text-area #video-preview").fadeOut(),app.videoPlayer.quit();var e=edit.getSelectorHeader("video");$(e+"input").prop("disabled",!0).off("keyup"),edit.func?($(e+"a").attr("onclick",edit.func),edit.func=void 0):$(e+"a").attr("onclick","edit.video("+edit.mediaIndex.video+")"),edit.videoSave(edit.mediaIndex.video),$("#edit-pane").off("keyup"),animation.hideHiddenIcons(),edit.mediaIndex.video=-1,edit.isEditing=-1}},edit.videoSave=function(e){var t=localStorage.video,a=edit.getSelectorHeader("video",e),i=$(a+".title").val();t=t?JSON.parse(t):[];var o={title:i,fileName:$(a+"a").attr("class")};t[e]=o,localStorage.video=JSON.stringify(t)},edit.videoSearch=function(){edit.playableSearch(1)},edit.location=function(e){if(e!=edit.mediaIndex.place&&void 0!=e){edit.cleanupMediaEdit(),edit.setRemove(2),edit.mediaIndex.place=e,$("#map-holder").fadeIn(),$("#pin-point").removeClass("hidden");var t=edit.getSelectorHeader("place",e);navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var a=parseFloat($(t+".latitude").val())||e.coords.latitude,i=parseFloat($(t+".longitude").val())||e.coords.longitude;pos=new google.maps.LatLng(a,i),mapOptions={zoom:15,center:pos},map=new google.maps.Map(document.getElementById("map-selector"),mapOptions),searchBox=new google.maps.places.Autocomplete(document.getElementsByClassName("place-search")[edit.mediaIndex.place],{types:["geocode"]}),markers=[],google.maps.event.clearListeners(searchBox,"place_changed"),google.maps.event.addListener(searchBox,"place_changed",function(){{var e=searchBox.getPlace();new google.maps.LatLngBounds}e?(markers[0]&&(markers[0].setMap(null),markers=[]),marker=new google.maps.Marker({map:map,title:e.name,position:e.geometry.location}),marker.setMap(map),markers.push(marker),map.setZoom(16),map.setCenter(e.geometry.location),$(t+".latitude").val(e.geometry.location.lat()),$(t+".longitude").val(e.geometry.location.lng())):animation.invalid(t+".place-search")}),google.maps.event.addListener(map,"bounds_changed",function(){var e=map.getBounds();searchBox.setBounds(e)}),$("#attach-area .place .desc").keyup(function(e){if(13==e.keyCode){var a=parseFloat($(t+".latitude").val()),i=parseFloat($(t+".longitude").val());if(isNaN(a))return void animation.invalid(t+".latitude");if(isNaN(i))return void animation.invalid(t+".longitude");pos=new google.maps.LatLng(a,i),edit.locationGeocode(pos)}})},function(){animation.error(log.LOCATION_PIN_FAIL)}):animation.error(log.LOCATION_PIN_FAIL),edit.isEditing=2,$(t+"input").prop("disabled",!1),$(t+"a").removeAttr("onclick"),$("#edit-pane").keyup(function(e){27==e.keyCode&&edit.locationHide()})}},edit.locationHide=function(){if(!(edit.mediaIndex.place<0)){var e=edit.getSelectorHeader("place");$(e+"input").prop("disabled",!0),$(e+"a").attr("onclick","edit.location("+edit.mediaIndex.place+")"),edit.locationSave(edit.mediaIndex.place),$("#map-holder").fadeOut().html('<div id="map-selector"></div>'),$("#pin-point").addClass("hidden"),$("#edit-pane").off("keyup"),animation.hideHiddenIcons(),edit.mediaIndex.place=-1,edit.isEditing=""}},edit.locationSave=function(e){var t=localStorage.place,a=edit.getSelectorHeader("place",e),i=parseFloat($(a+".latitude").val()),o=parseFloat($(a+".longitude").val()),n={};t=t?JSON.parse(t):[],n.title=$(a+".title").val(),isNaN(i)||isNaN(o)||(n.latitude=i,n.longitude=o),t[e]=n,localStorage.place=JSON.stringify(t)
},edit.locationPin=function(){var e=edit.getSelectorHeader("place");navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){var a=t.coords.latitude,i=t.coords.longitude,o=new google.maps.LatLng(a,i);$(e+".latitude").val(a),$(e+".longitude").val(i),edit.locationGeocode(o),edit.locationWeather(o)},function(){animation.error(log.LOCATION_PIN_FAIL)}):animation.error(log.LOCATION_PIN_FAIL)},edit.locationGeocode=function(e){var t={zoom:16,center:e},a=new google.maps.Map(document.getElementById("map-selector"),t),i=(new google.maps.Marker({map:a,position:e}),edit.getSelectorHeader("place"));a.setCenter(e);var o=new google.maps.Geocoder;o.geocode({latLng:e},function(e,t){t==google.maps.GeocoderStatus.OK?e[0]?$(i+".title").val(e[0].formatted_address):animation.error(log.LOCATION_NO_RESULTS):animation.error(log.LOCATION_NO_ADDRESS+log.SERVER_RETURNS+t+log.SERVER_RETURNS_END)})},edit.locationWeather=function(e){var t=!1;if($("#attach-area .icontags .weather p").each(function(){$(this).hasClass("highlight")&&(t=!0)}),!t){animation.debug(log.EDIT_PANE_WEATHER_START,1);var a="6f1ee423e253fba5e40e3276ff3e6d33",i="https://api.forecast.io/forecast/"+a+"/"+e.lat()+","+e.lng()+","+parseInt((new Date).getTime()/1e3)+"?units=si";$.ajax({type:"GET",url:i,dataType:"jsonp"}).done(function(e){var t=e.currently,a=t.icon;animation.log(log.EDIT_PANE_WEATHER_RESULT+t.temperature+log.EDIT_PANE_WEATHER_RESULT_END);var i;"clear-day"===a||"clear-night"===a?i="w01":"cloudy"===a||"partly-cloudy-day"===a||"partly-cloudy-night"===a?i="w02":"rain"===a?i="w03":"snow"===a||"sleet"===a?i="w04":"wind"===a&&(i="w06"),i?(animation.log(log.EDIT_PANE_WEATHER_END,-1),$("#attach-area .icontags ."+i).trigger("click")):animation.log(log.EDIT_PANE_WEATHER_END_FAIL+e.summary+log.EDIT_PANE_WEATHER_END_FAIL_END,-1)})}},edit.voice=function(e,t){if(e!=edit.mediaIndex.voice&&void 0!=e){edit.cleanupMediaEdit(),edit.mediaIndex.voice=e;var a=edit.getSelectorHeader("voice");edit.func=$(a+"a").attr("onclick"),$(a+"a").removeAttr("onclick"),$(a+"input").prop("disabled",!1),$("#edit-pane").keyup(function(e){27===e.keyCode&&edit.voiceHide()}),edit.isEditing=3;var i;if(t)i=t,app.audioPlayer(a+"a",i);else{var o=$(a+"a").attr("class");if(journal.archive.map[o]){if(i=journal.archive.map[o].url,void 0==i)return void animation.error(log.FILE_NOT_FOUND+$(a+".title").val());app.audioPlayer(a+"a",i)}else animation.error(log.FILE_NOT_LOADED+$(a+".title")+log.DOWNLOAD_PROMPT)}edit.setRemove(3)}},edit.voiceHide=function(){if(!(edit.mediaIndex.voice<0)){app.videoPlayer.quit();var e=edit.getSelectorHeader("voice");$(e+"input").prop("disabled",!0).off("keyup"),edit.func?($(e+"a").attr("onclick",edit.func),edit.func=void 0):$(e+"a").attr("onclick","edit.voice("+edit.mediaIndex.voice+")"),edit.voiceSave(edit.mediaIndex.voice),$("#edit-pane").off("keyup"),animation.hideHiddenIcons(),edit.mediaIndex.voice=-1,edit.isEditing=-1}},edit.voiceSave=function(e){var t=localStorage.voice,a=edit.getSelectorHeader("voice",e),i=$(a+".title").val();t=t?JSON.parse(t):[];var o={title:i,fileName:$(a+"a").attr("class")};t[e]=o,localStorage.voice=JSON.stringify(t)},edit.voiceSearch=function(){edit.playableSearch(3)},edit.voiceNew=function(){},edit.music=function(e){edit.itunes(e,4)},edit.musicHide=function(){edit.itunesHide(4)},edit.musicSave=function(e){edit.itunesSave(e,4)},edit.movie=function(e){edit.itunes(e,5)},edit.movieHide=function(){edit.itunesHide(5)},edit.movieSave=function(e){edit.itunesSave(e,5)},edit.book=function(e){edit.itunes(e,6)},edit.bookHide=function(){edit.itunesHide(6)},edit.bookSave=function(e){edit.itunesHide(e,6)},edit.weblink=function(e){if(e!=edit.mediaIndex.weblink&&void 0!=e){edit.cleanupMediaEdit(),edit.mediaIndex.weblink=e;var t=edit.getSelectorHeader("weblink");edit.setRemove(7),$(t+"a").removeAttr("onclick"),$(t+"input").prop("disabled",!1),$("#edit-pane").keyup(function(e){27==e.keyCode&&edit.weblinkHide(7)}),edit.isEditing=7}},edit.weblinkHide=function(){if(!(edit.mediaIndex.weblink<0)){var e=edit.getSelectorHeader("weblink");$(e+"input").prop("disabled",!0).off("keyup"),$(e+"a").attr("onclick","edit.weblink("+edit.mediaIndex.weblink+")"),edit.weblinkSave(edit.mediaIndex.weblink,7),$("#edit-pane").off("keyup"),animation.hideHiddenIcons(),edit.mediaIndex.weblink=-1,edit.isEditing=-1}},edit.weblinkSave=function(e){var t=localStorage.weblink,a=edit.getSelectorHeader("weblink",e),i=$(a+".title").val(),o=$(a+".desc").val();t=t?JSON.parse(t):[];var n={title:i,url:o};t[e]=n,localStorage.weblink=JSON.stringify(t)},edit.itunes=function(e,t){var a=edit.mediaName(t);if(e!=edit.mediaIndex[a]&&void 0!=e){edit.cleanupMediaEdit(),edit.mediaIndex[a]=e;var i=edit.getSelectorHeader(a);edit.setRemove(t),$(i+"a").removeAttr("onclick"),$(i+"input").prop("disabled",!1).keyup(function(e){if(13==e.keyCode){var a=$(i+".title").val()+"%20"+$(i+".desc").val();getCoverPhoto(i,a,!0,t)}}),$("#edit-pane").keyup(function(e){27==e.keyCode&&edit.itunesHide(t)}),edit.isEditing=t}},edit.itunesHide=function(e){var t=edit.mediaName(e);if(!(edit.mediaIndex[t]<0)){var a=edit.getSelectorHeader(t);$(a+"input").prop("disabled",!0).off("keyup"),$(a+"a").attr("onclick","edit."+t+"("+edit.mediaIndex[t]+")"),edit.itunesSave(edit.mediaIndex[t],e),$("#edit-pane").off("keyup"),animation.hideHiddenIcons(),edit.mediaIndex[t]=-1,edit.isEditing=-1}},edit.itunesSave=function(e,t){var a=edit.mediaName(t),i=localStorage[a],o=edit.getSelectorHeader(a,e),n=$(o+".title").val(),r=$(o+".desc").val();i=i?JSON.parse(i):[];var d={title:n,author:r};i[e]=d,localStorage[a]=JSON.stringify(i)},edit.playableSearch=function(e){getTokenCallback(function(t){edit.getDate(function(a){var i=getDataUrlHeader()+"/"+a+":/children?select=id,name,size,@content.downloadUrl&access_token="+t;animation.log(log.EDIT_PANE_PLAYABLE_SEARCH_START,1),$.ajax({type:"GET",url:i}).done(function(t){t["@odata.nextLink"]&&animation.warn(log.EDIT_PANE_TOO_MANY_RESULTS);var a,i=t.value;switch(e){case 1:a=edit.videos;break;case 3:a=edit.voices;break;default:return void console.log("edit.playableSearch()	Invalid call")}for(var o=0,n=i.length;o!==n;++o){var r=i[o].id,d=i[o].size,l=i[o].name,c=i[o]["@content.downloadUrl"],s=l.substring(l.length-4).toLowerCase(),g={id:r,name:l,title:l.substring(0,l.length-4),url:c,size:d,resource:!1,change:!0};switch(e){case 1:if(".mp4"!==s)continue;break;case 3:if(".mp3"!==s&&".wav"!==s)continue}for(var p=!0,u=0;u!==a.length;++u)if(a[u].size===d){p=!1;break}if(p)switch(a.push(g),animation.log(edit.mediaName(e).capitalize()+log.EDIT_PANE_PLAYABLE_FILE+l+log.EDIT_PANE_PLAYABLE_FILE_ADDED),e){case 1:edit.addMedia(-1,{fileName:l,url:c,title:l.substring(0,l.length-4)});break;case 3:edit.addMedia(-3,{fileName:l,url:c,title:l.substring(0,l.length-4)})}}edit.playableSetToggle(),animation.log(log.EDIT_PANE_PLAYABLE_SEARCH_END,-1)}).fail(function(t,a,i){switch(animation.error(log.EDIT_PANE_PLAYABLE_SEARCH_FAILED,i,-1),e){case 1:animation.warning("#add-video");break;case 3:animation.warning("#add-voice")}})})})},edit.playableSetToggle=function(){$("#edit-pane .video, #edit-pane .voice").each(function(){$(this).off("contextmenu"),$(this).on("contextmenu",function(){return $(this).toggleClass("change"),!1})})},edit.playableSave=function(e,t){edit.getDate(function(a){var i,o,n="/drive/root:/Apps/Journal/resource/"+app.year,r="/drive/root:/Apps/Journal/data/"+app.year+"/"+a,d=0;switch(e){case 1:i=edit.videos,o=JSON.parse(localStorage.video);break;case 3:i=edit.voices,o=JSON.parse(localStorage.voice);break;default:return}$("#attach-area ."+edit.mediaName(e)).each(function(){for(var e=0;e!==i.length;++e)if($(this).children("a").hasClass(i[e].name)){var t=i[e].resource&&$(this).hasClass("resource")||!i[e].resource&&$(this).hasClass("data");if(t){i[e].change=$(this).hasClass("change");break}}});for(var l=0;l!==o.length;++l)for(var c=0;c!==i.length;++c)if(o[l]&&o[l].fileName===i[c].name){i[c].title=o[l].title;break}for(var l=0;l!==i.length;++l)i[l].change&&++d;0===d?($("#attach-area ."+edit.mediaName(e)).each(function(){$(this).hasClass("data")&&$(this).addClass("ignore").empty().fadeOut()}),t()):getTokenCallback(function(l){animation.log(log.EDIT_PANE_PLAYABLE_SAVE_START+edit.mediaName(e)+log.EDIT_PANE_PLAYABLE_SAVE_START_END,1);for(var c=0;c!==i.length;++c)if(i[c].change){var s,g=i[c].name,p=i[c].title,u=i[c].id,h=a+((new Date).getTime()+c)+g.substring(g.length-4);if(i[c].success=!1,i[c].resource){for(var v=0;v!==o.length;++v)if(o[v].fileName===g){h=p+g.substring(g.length-4);break}s=r}else s=n;var m,f={name:h,parentReference:{path:s}};u?m="https://api.onedrive.com/v1.0/drive/items/"+u+"?select=id,name,size,@content.downloadUrl&access_token="+l:(s=s===n?r:n,m="https://api.onedrive.com/v1.0"+s+"/"+encodeURI(g)+"?select=name,size,@content.downloadUrl&access_token="+l),$.ajax({type:"PATCH",url:m,contentType:"application/json",data:JSON.stringify(f)}).done(function(t){--d;for(var a="",o=0;o!==i.length;++o)if(i[o].id===t.id){if(a=i[o].title,i[o].success=!0,delete journal.archive.map[i[o].name],!i[o].resource){var n=t.name;i[o].newName=n,journal.archive.map[n]={id:t.id,size:t.size,url:t["@content.downloadUrl"]}}break}animation.log(edit.mediaName(e).capitalize()+log.EDIT_PANE_PLAYABLE_FILE+a+log.EDIT_PANE_PLAYABLE_FILE_SAVED)}).fail(function(t,a,i){--d,animation.warn(log.EDIT_PANE_TRANSFERRED_FAILED,i,!1),animation.warning("#add-"+edit.mediaName(e))}).always(function(){if(0>=d){$("#attach-area ."+edit.mediaName(e)).each(function(){$(this).removeClass("change");for(var e=0;e!==i.length;++e)if(!$(this).hasClass("ignore")&&$(this).children("a").hasClass(i[e].name)){var t=i[e].resource&&$(this).hasClass("resource")||!i[e].resource&&$(this).hasClass("data");if(t){i[e].success&&(i[e].success=!1,i[e].resource=!i[e].resource,$(this).hasClass("resource")?$(this).removeClass("resource").addClass("data"):$(this).hasClass("data")&&$(this).removeClass("data").addClass("resource"),i[e].newName&&(i[e].name=i[e].newName,$(this).children("a").attr("class",i[e].newName),delete i[e].newName));break}}$(this).hasClass("data")&&$(this).addClass("ignore").empty().fadeOut()});for(var a=[],o=0;o!==i.length;++o)i[o].change=!1,i[o].resource?a.push({fileName:i[o].newName||i[o].name,title:i[o].title}):(i.splice(o,1),--o);localStorage[edit.mediaName(e)]=JSON.stringify(a),animation.log(log.EDIT_PANE_FINISHED_TRANSFER+edit.mediaName(e)+log.EDIT_PANE_FINISHED_TRANSFER_END,-1),t()}})}})})},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};