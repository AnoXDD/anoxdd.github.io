/*Version4.2.0Build082015.1936ByAnoxic*/function getResourceUrlHeader(e,t){return t=t||app.year,e?"https://api.onedrive.com/v1.0/drive/special/approot:/resource/"+t:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource/"+t}function getDataUrlHeader(e,t){return t=t||app.year,e?"https://api.onedrive.com/v1.0/drive/special/approot:/data/"+t:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data/"+t}function getCoreDataUrlHeader(e,t){return t=t||app.year,e?"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core/"+t+"/data.js":"https://api.onedrive.com/v1.0/drive/special/approot:/core/"+t+"/data.js"}function downloadFile(e,t){animation.log(log.CONTENTS_DOWNLOAD_START,1),getTokenCallback(function(a){-1===network.yearFolders.indexOf(app.year)?createFolders(function(){app.refresh()},3):($("#download").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"),e=e||getCoreDataUrlHeader(!0)+":/content?access_token="+a,$.ajax({type:"GET",url:e}).done(function(e,o,n){window.app.dataLoaded[app.year]=!1,window.app.load("",n.responseText),animation.log(log.CONTENTS_DOWNLOAD_TEXT),delete app.yearChange[app.year],$("#year").removeClass("change"),app.updateLastUpdated(),app.yearUpdate(),t?($("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download")):$.ajax({type:"GET",url:getResourceUrlHeader()+":?select=folder&access_token="+a}).done(function(e){journal.archive.media=e.folder.childCount,app.refresh(),animation.log(log.CONTENTS_DOWNLOAD_MEDIA_START,1),network.init(journal.archive.media),downloadMedia()}).fail(function(e,t,a){animation.error(log.CONTENTS_DOWNLOAD_MEDIA_FAIL,a,-1)})}).fail(function(e,t,a){return $("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download"),404==e.status&&app.yearQueue[app.year]?(app.yearUpdate(),void app.refresh()):(animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,a,-1),void(app.year=parseInt($("#year").html())))}).always(function(){animation.log(log.CONTENTS_DOWNLOAD_END,-1)}))})}function downloadMedia(e){if(void 0==e){var t=getTokenFromCookie();journal.archive.map={},e=getResourceUrlHeader()+":/children?select=id,name,size,@content.downloadUrl&top=500&access_token="+t}$.ajax({type:"GET",url:e}).done(function(e){if(e["@odata.nextLink"]){for(var t=e["@odata.nextLink"],a=t.split("&"),o=0;o!==a.length;++o)if(a[o].startsWith("$select")){a[o]="$select=id,name,size,@content.downloadUrl";break}t=a.join("&"),downloadMedia(t)}for(var n=e.value,r=0,i=n.length;r!=i;++r){var l={id:n[r].id,url:n[r]["@content.downloadUrl"],size:n[r].size};journal.archive.map[n[r].name]=l,network.next()}var d=_.size(journal.archive.map);animation.log(log.CONTENTS_DOWNLOAD_MEDIA_LOADED+d+log.CONTENTS_DOWNLOAD_MEDIA_OF+journal.archive.media),d==journal.archive.media&&(animation.log(log.CONTENTS_DOWNLOAD_MEDIA_END,-1),network.destroy(),$("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download"))}).fail(function(){network.destroy()})}function backupAll(e){getTokenCallback(function(t){animation.log(log.CONTENTS_BACKUP_START),e=e||app.years,network.init(e.length-1);for(var a=0;a!==e.length;++a){var o=new Date,n=o.getMonth()+1,r=o.getDate(),i=o.getFullYear()%100,l=o.getHours(),d=o.getMinutes(),p=o.getSeconds(),s=e[a];n=10>n?"0"+n:n,r=10>r?"0"+r:r,i=10>i?"0"+i:i,l=10>l?"0"+l:l,d=10>d?"0"+d:d,p=10>p?"0"+p:p;var c="data_"+n+r+i+"_"+l+d+p+".js",u={name:c};$.ajax({type:"POST",url:getCoreDataUrlHeader(!1,s)+":/action.copy?access_token="+t,contentType:"application/json",data:JSON.stringify(u),headers:{Prefer:"respond-async"}}).done(function(){animation.debug(log.CONTENTS_UPLOAD_BACKUP)}).fail(function(e,t,a){"Bad Request"!==a&&(animation.error(log.CONTENTS_UPLOAD_BACKUP_FAIL,a,-1),network.destroy())}).always(function(){network.next()})}})}function uploadFile(e){e=parseInt(e)||app.year,$("#upload").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"),getTokenCallback(function(t){var a=function(){var a=app.version[e]||"";a+=JSON.stringify(edit.minData()),$.ajax({type:"PUT",url:getCoreDataUrlHeader(!0,e)+":/content?access_token="+t,contentType:"text/plain",data:a}).done(function(){app.yearChange[app.year]=!1,$("#year").removeClass("change"),app.updateLastUpdated(),animation.log(log.CONTENTS_UPLOAD_END+e,-1)}).fail(function(e,t,a){animation.error(log.CONTENTS_UPLOAD_FAIL,a,-1)}).always(function(){network.next(),$("#upload").html("&#xf0ee").removeClass("spin").css("background","").attr({onclick:"uploadSingleFile()",href:"#"})})};-1===network.yearFolders.indexOf(app.year)?createFolders(a,5):a()})}function uploadSingleFile(){animation.log(log.CONTENTS_UPLOAD_START,1),uploadFile()}function uploadAllFiles(){if(animation.log(log.CONTENTS_UPLOAD_START,1),0===app.yearChange.length)uploadFile();else for(var e=Object.keys(app.yearChange),t=0;t!==e.length;++t){var a=e[t];app.yearChange[a]&&uploadFile(e[t])}}function getCoverPhoto(e,t,a,o){var n="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=music&entity=song,album,musicArtist&term=";"number"==typeof o&&(o=edit.mediaName(o)),"movie"==o?n="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=movie&entity=movieArtist,movie&term=":"book"==o&&(n="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=ebook&entity=ebook&term="),$.ajax({url:n+t,dataType:"jsonp",success:function(t){var o=t.results[0];if(void 0==o)animation.warn(log.COVER_PHOTO_FAIL),animation.invalid(e+"input");else{animation.debug(log.COVER_PHOTO_FOUND);var n=o.artistName,r=o.trackName,i=o.artworkUrl100;a&&($(e+".title").val(r),$(e+".desc").val(n)),$(e+".thumb").attr("src",i)}}})}function createDateFolder(e,t){getTokenCallback(function(a){var o={name:e,folder:{}};$.ajax({type:"POST",url:getDataUrlHeader(!0)+":/children?access_token="+a,contentType:"application/json",data:JSON.stringify(o),statusCode:{409:function(){edit.isFolder=!0,edit.folderDate=e}}}).done(function(){edit.isFolder=!0,edit.folderDate=e,animation.debug(log.FOLDER_CREATED)}).always(function(){t(e)})})}function createFolders(e,t){getTokenCallback(function(a){var o=0,n=!1,r=["https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource:/"],i={name:app.year.toString(),folder:{}};network.init(t);for(var l=0;l!==r.length;++l)$.ajax({type:"POST",url:r[l]+"children?access_token="+a,contentType:"application/json",data:JSON.stringify(i)}).done(function(){network.next(),++o===r.length&&(network.yearFolders.push(app.year),e(a))}).fail(function(t){409==t.status?(network.next(),++o===r.length&&(network.yearFolders.push(app.year),e(a))):(network.destroy(),n||animation.error(log.CONTENTS_UPLOAD_REGISTER_FAIL),n=!0)})})}window.network={},network.percent=0,network.current=0,network.breakpoint=0,network.interval=0,network.yearFolders=[],network.isAjaxActive=!1,network.timeOut=15e3,network.init=function(e){$("#network-bar").remove(),$(".header").append('<div id="network-bar" ><div id="network-progress"><div id="network-followup"></div></div></div>'),(!e||0>e)&&(e=0),network.current=0,network.breakpoint=e||0,network.setPercent(0),clearInterval(network.interval);var t=!1;network.interval=setInterval(function(){return t?void network.destroy():(network.percent<(network.current+.5)/(network.breakpoint+1)&&(network.percent+=.05),network.percent>=1&&(network.percent=1,t=!0),void $("#network-progress").css("width",100*network.percent+"%"))},1e3)},network.setPercent=function(e){network.percent=e},network.setStatus=function(){},network.next=function(){network.setPercent(++network.current/(network.breakpoint+1))},network.destroy=function(){network.percent<1?network.percent=2:(clearInterval(network.interval),$("#network-bar").remove())};