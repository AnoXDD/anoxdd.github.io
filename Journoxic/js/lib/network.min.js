/**
 * @version 4.0 Build 080415 1952
 */

function getResourceUrlHeader(e,t){return t=t||app.year,e?"https://api.onedrive.com/v1.0/drive/special/approot:/resource/"+t:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource/"+t}function getDataUrlHeader(e,t){return t=t||app.year,e?"https://api.onedrive.com/v1.0/drive/special/approot:/data/"+t:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data/"+t}function getCoreDataUrlHeader(e,t){return t=t||app.year,e?"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core/"+t+"/data.js":"https://api.onedrive.com/v1.0/drive/special/approot:/core/"+t+"/data.js"}function downloadFile(e,t){animation.log(log.CONTENTS_DOWNLOAD_START,1),$("#download").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"),getTokenCallback(function(o){-1===network.yearFolders.indexOf(app.year)?createFolders(function(){app.refresh()},3):(e=e||getCoreDataUrlHeader(!0)+":/content?access_token="+o,$.ajax({type:"GET",url:e}).done(function(e,n,a){window.app.dataLoaded[app.year]=!1,window.app.load("",a.responseText),animation.log(log.CONTENTS_DOWNLOAD_TEXT),delete app.yearChange[app.year],$("#year").removeClass("change"),app.yearUpdate(),t?($("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download")):$.ajax({type:"GET",url:getResourceUrlHeader()+":?select=folder&access_token="+o}).done(function(e){journal.archive.media=e.folder.childCount,app.refresh(),animation.log(log.CONTENTS_DOWNLOAD_MEDIA_START,1),network.init(journal.archive.media),downloadMedia()}).fail(function(e,t,o){animation.error(log.CONTENTS_DOWNLOAD_MEDIA_FAIL,o,-1)})}).fail(function(e,t,o){return $("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download"),404==e.status&&app.yearQueue[app.year]?(app.yearUpdate(),void app.refresh()):(animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,o,-1),void(app.year=parseInt($("#year").html())))}).always(function(){animation.log(log.CONTENTS_DOWNLOAD_END,-1)}))})}function downloadMedia(e){if(void 0==e){var t=getTokenFromCookie();journal.archive.map={},e=getResourceUrlHeader()+":/children?select=id,name,size,@content.downloadUrl&top=500&access_token="+t}$.ajax({type:"GET",url:e}).done(function(e){if(e["@odata.nextLink"]){for(var t=e["@odata.nextLink"],o=t.split("&"),n=0;n!==o.length;++n)if(o[n].startsWith("$select")){o[n]="$select=id,name,size,@content.downloadUrl";break}t=o.join("&"),downloadMedia(t)}for(var a=e.value,r=0,i=a.length;r!=i;++r){var l={id:a[r].id,url:a[r]["@content.downloadUrl"],size:a[r].size};journal.archive.map[a[r].name]=l,network.next()}var d=_.size(journal.archive.map);animation.log(log.CONTENTS_DOWNLOAD_MEDIA_LOADED+d+log.CONTENTS_DOWNLOAD_MEDIA_OF+journal.archive.media),d==journal.archive.media&&(animation.log(log.CONTENTS_DOWNLOAD_MEDIA_END,-1),network.destroy(),$("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download"))}).fail(function(){network.destroy()})}function backupAll(e){getTokenCallback(function(t){animation.log(log.CONTENTS_BACKUP_START),e=e||app.years,network.init(e.length-1);for(var o=0;o!==e.length;++o){var n=new Date,a=n.getMonth()+1,r=n.getDate(),i=n.getFullYear()%100,l=n.getHours(),d=n.getMinutes(),p=n.getSeconds(),s=e[o];a=10>a?"0"+a:a,r=10>r?"0"+r:r,i=10>i?"0"+i:i,l=10>l?"0"+l:l,d=10>d?"0"+d:d,p=10>p?"0"+p:p;var c="data_"+a+r+i+"_"+l+d+p+".js",u={name:c};$.ajax({type:"POST",url:getCoreDataUrlHeader(!1,s)+":/action.copy?access_token="+t,contentType:"application/json",data:JSON.stringify(u),headers:{Prefer:"respond-async"}}).done(function(){animation.debug(log.CONTENTS_UPLOAD_BACKUP)}).fail(function(e,t,o){"Bad Request"!==o&&(animation.error(log.CONTENTS_UPLOAD_BACKUP_FAIL,o,-1),network.destroy())}).always(function(){network.next()})}})}function uploadFile(e){e=parseInt(e)||app.year,$("#upload").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"),getTokenCallback(function(t){var o=function(){var o=edit.minData();$.ajax({type:"PUT",url:getCoreDataUrlHeader(!0,e)+":/content?access_token="+t,contentType:"text/plain",data:JSON.stringify(o)}).done(function(){app.yearChange[app.year]=!1,$("#year").removeClass("change"),animation.log(log.CONTENTS_UPLOAD_END+e,-1)}).fail(function(e,t,o){animation.error(log.CONTENTS_UPLOAD_FAIL,o,-1)}).always(function(){network.next(),$("#upload").html("&#xf0ee").removeClass("spin").css("background","").attr({onclick:"uploadSingleFile()",href:"#"})})};-1===network.yearFolders.indexOf(app.year)?createFolders(o,5):o()})}function uploadSingleFile(){animation.log(log.CONTENTS_UPLOAD_START,1),uploadFile()}function uploadAllFiles(){if(animation.log(log.CONTENTS_UPLOAD_START,1),0===app.yearChange.length)uploadFile();else for(var e=Object.keys(app.yearChange),t=0;t!==e.length;++t){var o=e[t];app.yearChange[o]&&uploadFile(e[t])}}function getCoverPhoto(e,t,o,n){var a="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=music&entity=song,album,musicArtist&term=";"number"==typeof n&&(n=edit.mediaName(n)),"movie"==n?a="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=movie&entity=movieArtist,movie&term=":"book"==n&&(a="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=ebook&entity=ebook&term="),$.ajax({url:a+t,dataType:"jsonp",success:function(t){var n=t.results[0];if(void 0==n)animation.warn(log.COVER_PHOTO_FAIL),animation.invalid(e+"input");else{animation.debug(log.COVER_PHOTO_FOUND);var a=n.artistName,r=n.trackName,i=n.artworkUrl100;o&&($(e+".title").val(r),$(e+".desc").val(a)),$(e+".thumb").attr("src",i)}}})}function createDateFolder(e,t){getTokenCallback(function(o){var n={name:e,folder:{}};$.ajax({type:"POST",url:getDataUrlHeader(!0)+":/children?access_token="+o,contentType:"application/json",data:JSON.stringify(n),statusCode:{409:function(){edit.isFolder=!0,edit.folderDate=e}}}).done(function(){edit.isFolder=!0,edit.folderDate=e,animation.debug(log.FOLDER_CREATED)}).always(function(){t(e)})})}function createFolders(e,t){getTokenCallback(function(o){var n=0,a=!1,r=["https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource:/"],i={name:app.year.toString(),folder:{}};network.init(t);for(var l=0;l!==r.length;++l)$.ajax({type:"POST",url:r[l]+"children?access_token="+o,contentType:"application/json",data:JSON.stringify(i)}).done(function(){network.next(),++n===r.length&&(network.yearFolders.push(app.year),e(o))}).fail(function(t){409==t.status?(network.next(),++n===r.length&&(network.yearFolders.push(app.year),e(o))):(network.destroy(),a||animation.error(log.CONTENTS_UPLOAD_REGISTER_FAIL),a=!0)})})}window.network={},network.percent=0,network.current=0,network.breakpoint=0,network.interval=0,network.yearFolders=[],network.isAjaxActive=!1,network.timeOut=15e3,network.init=function(e){$("#network-bar").remove(),$(".header").append('<div id="network-bar" ><div id="network-progress"><div id="network-followup"></div></div></div>'),(!e||0>e)&&(e=0),network.current=0,network.breakpoint=e||0,network.setPercent(0),clearInterval(network.interval);var t=!1;network.interval=setInterval(function(){return t?void network.destroy():(network.percent<(network.current+.5)/(network.breakpoint+1)&&(network.percent+=.05),network.percent>=1&&(network.percent=1,t=!0),void $("#network-progress").css("width",100*network.percent+"%"))},1e3)},network.setPercent=function(e){network.percent=e},network.setStatus=function(){},network.next=function(){network.setPercent(++network.current/(network.breakpoint+1))},network.destroy=function(){network.percent<1?network.percent=2:(clearInterval(network.interval),$("#network-bar").remove())};