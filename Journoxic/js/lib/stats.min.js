/**
 * @version 4.0 Build 080415 1952
 * @author Anoxic
 */

window.stats={},stats.oldValue="",stats.entries={},stats.options={startDay:0,endDay:366,isIncludingTitles:!0,isIncludingTags:!1,viewAsMonth:!1},stats.eachDay=[],stats.monthVal=[],stats.isLeapYear=!1,stats.isEditing=-1,stats.isGraphDisplayed=!1,stats.init=function(){var t;for(stats.result=[],stats.isLeapYear=1===new Date(app.year,1,29).getMonth(),stats.isGraphDisplayed=!1,stats.oldValue="",stats.monthVal=stats.isLeapYear?[31,29,31,30,31,30,31,31,30,31,30,31]:[31,28,31,30,31,30,31,31,30,31,30,31],t=1;;++t){var e=new Date(app.year,0,t);if(e.getFullYear()!==app.year)break;var a=app.monthArray[e.getMonth()],s=e.getDate();stats.eachDay.push(a+" "+s)}$("#query").fadeOut(),$("#stats-query").fadeIn(),$("#stats-query").val(""),$("#stats-query").unbind("keyup").bind("keyup","return",function(){var t=$(this).val();return t=stats.simplifyEntry(t),0===t.length?($(this).effect("highlight",{color:"#000"}),void animation.debug(log.STATS_ENTRY_EMPTY_STRING)):(stats.entries[t]?($(this).effect("highlight",{color:"#000"}),animation.debug(log.STATS_ENTRY_ALREADY_EXIST)):($(this).effect("highlight",{color:"#ddd"}),stats.addEntry(t),$(this).val(""),$(this).focus()),void $(this).select())}),stats.initTable(),animation.showMenuOnly("stats"),$("#stats-options li.checkbox").each(function(){$(this).click(function(){$(this).toggleClass("checked");var t=$(this).attr("encode");stats.options[t]=!stats.options[t]})}),$("#stats-table").delegate("td","mouseover mouseleave contextmenu",function(t){if("mouseover"===t.type)$(this).parent().addClass("hover"),$("tr td:nth-child("+($(this).index()+1)+")").addClass("hover");else{if("mouseleave"!==t.type){var e=stats.oldValue||$(this).parent().children("td").children("input").val();return $(this).parent().slideUp(200,function(){$(this).remove()}),delete stats.entries[e],!1}$(this).parent().removeClass("hover"),$("tr td:nth-child("+($(this).index()+1)+")").removeClass("hover")}}).delegate("input","focusin focusout keyup",function(t){if("focusin"===t.type)stats.oldValue=$(this).val();else if("focusout"===t.type)$(this).val(stats.oldValue),stats.oldValue="";else if(13===t.keyCode){var e=$(this).val();if(e=stats.simplifyEntry(e),0===e.length)return $(this).effect("highlight",{color:"#000"}),animation.error(log.STATS_ENTRY_EMPTY_STRING),void $(this).val(stats.oldValue);if(stats.entries[e])return $(this).effect("highlight",{color:"#000"}),animation.error(log.STATS_ENTRY_ALREADY_EXIST),void $(this).val(stats.oldValue);$(this).parent().parent().effect("highlight",{color:"#ddd"});var a=$(this).parent().parent().index()+1;delete stats.entries[stats.oldValue],stats.addEntry(e,a),stats.oldValue=e,this.blur()}else 27===t.keyCode&&this.blur()}).delegate("th","click",function(){if(0!==$("tbody tr").length){var e=$(this).hasClass("desc"),a=$(this).index(),s=[];for($("tbody tr").each(function(){var t,e;$(this).children("td").each(function(s){0===s&&(t=$(this).children("input").val()),s===a&&(e=0===s?t:$(this).html())}),s.push({key:t,value:e})}),stats.initTable(),e?($("th").eq(a).addClass("asce"),s.sort(0===a?function(t,e){return t.value.localeCompare(e.value)}:function(t,e){return t.value-e.value})):($("th").eq(a).addClass("desc"),s.sort(0===a?function(t,e){return e.value.localeCompare(t.value)}:function(t,e){return e.value-t.value})),t=0;t!==Object.keys(s).length;++t)stats.addEntry(s[t].key)}}),$("#contents").fadeOut(400,function(){$("#search-result").addClass("stats"),stats.getYearSum(),$("#stats-pane").fadeIn()})},stats.initTable=function(){stats.oldValue="",stats.removeAll(),$("#stats-table").html("<thead><tr><th>Index</th><th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>Mar</th><th>Jun</th><th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th><th>Total</th></tr></thead><tbody></tbody>"),$("tbody").addClass("fadein")},stats.quit=function(){stats.removeAll(),$("#query").fadeIn(),$("#stats-query").fadeOut().unbind("keyup"),$("#stats-options li.checkbox").each(function(){$(this).unbind("click")}),$("#search-result").removeClass("stats"),$("#stats-table").undelegate("td","mouseover mouseleave contextmenu").undelegate("input","focusin focusout keyup").delegate("th","contextmenu"),$("#stats-pane").fadeOut(400,function(){$("#contents").fadeIn(),animation.showMenuOnly(),app.refresh()})},stats.addEntry=function(t,e){var a,s=stats.getResult(t);stats.entries[t]=s;var i=new Array(12),n=0,r=0;for(a=0;a!==stats.monthVal.length;++a){i[a]=0;for(var o=0;o!==stats.monthVal[a];++o,++n)s[n]&&(i[a]+=s[n]);r+=i[a]}var l="<td><input type='text' class='edit' autocomplete='off' onclick='this.select()' value='"+t+"' /></td>";for(a=0;a!==i.length;++a)l+="<td>"+i[a]+"</td>";l+="<td>"+r+"</td>",e?$("tbody tr:nth-child("+e+") input").parent().parent().html(l).addClass("fadein"):(l="<tr>"+l+"</tr>",$(l).appendTo("tbody").addClass("fadein")),stats.hideGraph()},stats.simplifyEntry=function(t){for(var e=t.split("|"),a=[],s=0;s!==e.length;++s)e[s].length>0&&a.push(e[s]);return a.join("|")},stats.getYearSum=function(){for(var t=0,e=0,a=0,s=0,i=0,n=0,r=0;r!==journal.archive.data[app.year].length;++r){var o=journal.archive.data[app.year][r];if(stats.isInTimeRange(o.time.created)){if(t+=o.text.chars,e+=o.text.lines,o.time.end){var l=(o.time.end-o.time.start)/6e4;isNaN(l)||(a+=l)}o.images&&(s+=o.images.length),o.video&&(i+=o.video.length),o.voice&&(n+=o.voice.length)}}$("#total-char").text(t),$("#total-line").text(e);var h=a%60;10>h&&(h="0"+h),$("#total-time").text(Math.floor(a/60)+":"+h),$("#total-image").text(s),$("#total-video").text(i),$("#total-voice").text(n)},stats.getResult=function(t){var e,a=t.split("|");e=new Array(stats.isLeapYear?366:365);for(var s=0;s!==journal.archive.data[app.year].length;++s){var i=[],n=journal.archive.data[app.year][s],r=n.time.created;if(stats.isInTimeRange(r)){var o=stats.getDayNumber(r);i.push(n.text.body),this.options.isIncludingTags&&i.push(n.tags),this.options.isIncludingTitles&&i.push(n.title);for(var l=0;l!==i.length;++l){var h=i[l];if(h)for(var d=0;d!==a.length;++d){var u=a[d];e[o]||(e[o]=0),e[o]+=(h.match(new RegExp(u,"gi"))||[]).length}}}}return e},stats.getDayNumber=function(t){var e=new Date(t),a=new Date(app.year,0,1);return Math.floor((new Date(e)-a)/864e5)},stats.isInTimeRange=function(t){var e=stats.getDayNumber(t);return e>=stats.options.startDay&&e<=stats.options.endDay},stats.removeAll=function(){$("#stats-table").html("").fadeIn().css("display","inline-table"),stats.entries={},stats.hideGraph()},stats.toggleGraph=function(){stats.isGraphDisplayed?stats.hideGraph():stats.showGraph()},stats.showGraph=function(t){stats.isGraphDisplayed=!0;var e,a=[],s=[];if(t)s=app.monthArray,$("#stats-table tbody tr").each(function(){var t=[];$(this).children("td").each(function(a){0===a?e=$(this).children("input").val():13>a&&t.push($(this).html())}),a.push({name:e,data:t})});else for(var i=0,n=Object.keys(stats.entries);i!==n.length;++i)if(e=n[i],a.push({name:n[i],data:stats.entries[e]}),0===i)for(var r=stats.entries[e],o=0;o!==r.length;++o)void 0!=r[o]&&s.push(stats.eachDay[o]);var l={chart:{backgroundColor:"#f3f3f3"},title:{text:"Stats for this year",x:-20},subtitle:{text:"Collected from "+$("#total-char").html()+" chars in "+$("#total-entry").html()+" entries",x:-20},xAxis:{categories:s},yAxis:{min:0,plotLines:[{value:0,width:1,color:"#808080"}],title:{text:"Times"}},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0},series:a,exporting:{enabled:!1,filename:"Journal Analysis "+app.year}};$("#graph").fadeIn().highcharts(l),$("#action-stats hidden").removeClass("hidden"),animation.testSub("#action-stats")},stats.hideGraph=function(){stats.isGraphDisplayed=!1,$("#graph").fadeOut(function(){$(this).html("")}),$("#action-stats hidden-icon").addClass("hidden"),animation.testSub("#action-stats")},stats.toggleYearView=function(){stats.hideGraph(),stats.options.viewAsMonth=!stats.options.viewAsMonth,stats.showGraph(stats.options.viewAsMonth)};
