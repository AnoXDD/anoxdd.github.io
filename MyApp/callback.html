<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title></title>
</head>
<body>
	<script src="odauth.js"></script>
	<script>
		function onAuthCallback() {
			var authInfo = getAuthInfoFromUrl();
			var token = authInfo["access_token"];
			var expiry = parseInt(authInfo["expires_in"]);
			setCookie(token, expiry);
			console.log("Gonna call onAuthenticated");
			window.opener.onAuthenticated(token, window);
		}

		function setCookie(token, expiresInSeconds) {
			var expiration = new Date();
			expiration.setTime(expiration.getTime() + expiresInSeconds * 1000);
			var cookie = "odauth=" + token + "; path=/; expires=" + expiration.toUTCString();

			if (document.location.protocol.toLowerCase() == "https") {
				cookie = cookie + ";secure";
			}

			document.cookie = cookie;
		}

		function getAuthInfoFromUrl() {
			if (window.location.hash) {
				var authResponse = window.location.hash.substring(1);
				var authInfo = JSON.parse(
				  '{"' + authResponse.replace(/&/g, '","').replace(/=/g, '":"') + '"}',
				  function(key, value) { return key === "" ? value : decodeURIComponent(value); });
				return authInfo;
			}
			else {
				alert("failed to receive auth token");
			}
		}

		onAuthCallback();
	</script>
</body>
</html>