var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var d=$jscomp.checkStringArgs(this,a,"startsWith");a+="";for(var e=d.length,f=a.length,g=Math.max(0,Math.min(c|0,d.length)),h=0;h<f&&g<e;)if(d[g++]!=a[h++])return!1;return h>=f}},"es6-impl","es3");
$jscomp.polyfill("String.prototype.endsWith",function(a){return a?a:function(a,c){var d=$jscomp.checkStringArgs(this,a,"endsWith");a+="";void 0===c&&(c=d.length);for(var e=Math.max(0,Math.min(c|0,d.length)),f=a.length;0<f&&0<e;)if(d[--e]!=a[--f])return!1;return 0>=f}},"es6-impl","es3");$jscomp.polyfill("Array.prototype.entries",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,c){return[a,c]})}},"es6-impl","es3");animation.isDebug=!0;window.animation={};
window.log={FILE_NOT_FOUND:"Cannot find the file ",FILES_NOT_FOUND:"Cannot find the list of files",FILE_NOT_LOADED:"Cannot load the file ",DOWNLOAD_PROMPT:". Please make sure it has been downloaded",LOCATION_PIN_FAIL:"Cannot find the current location. Please make sure you have enabled it or the browser does not support geocode",LOCATION_NO_RESULTS:"No results found",LOCATION_NO_ADDRESS:"Cannot read the address",NO_ENTRY_SELECTED:"No entry is selected",LOAD_DATA_FAIL:"Cannot load the data",NO_CONTENT:": no new content is specified",
NO_ARCHIVE:": no archive data is found",FOLDER_CREATED:"Folder for this date created",MEDIA_CLEAN_START:"Start returning lost media ...",MEDIA_CLEAN_NO_DATA:"No media found. Please press the button on the right to check the resource before returning lost media",MEDIA_CLEAN_NO_FILES:"No media found",MEDIA_CLEAN_GET_FOLDERS_FAIL:"Cannot get download available folder list",MEDIA_CLEAN_FOUND:" lost media found",MEDIA_CLEAN_UNDEFINED_FOUND:" undefined media found and cleaned",MEDIA_CLEAN_NOT_FOUND:"No lost media found",
MEDIA_CLEAN_UNDEFINED_NOT_FOUND:"No undefined media found",MEDIA_CLEAN_FAIL:" media failed to be moved. Please try again",MEDIA_CLEAN_SUCCESS:"All lost media moved to their original folder",ARCHIVE_START:"Loading archive list ...",ARCHIVE_TOO_MANY:"Too many archive files. Only the latest 500 files will be displayed",ARCHIVE_END:"Archive list loaded",ARCHIVE_INVALID_JSON:"This archive is corrupted",ARCHIVE_SELECT_ALL:"No archive is selected. All archives will be selected",ARCHIVE_NO_SELECTED:"No archive is selected",
ARCHIVE_NO_SELECTED_REMOVE:"No archive is selected to be removed",ARCHIVE_NO_PROTECT_CHANGE:"No archive's protection state changed",ARCHIVE_REMOVE_START:"Removing selected archive file(s) ...",ARCHIVE_REMOVE_END:" archive file(s) removed. To recover the files, visit OneDrive immediately and find them in the trash",ARCHIVE_REMOVE_FAIL:"Cannot remove some files. Please try again",ARCHIVE_PROTECT_REMOVE:'Removal for protected file "',ARCHIVE_PROTECT_REMOVE_END:'" skipped',ARCHIVE_PROTECT_START:"Toggling archive protection for selected files ...",
ARCHIVE_PROTECT_CHANGE:'Archive file "',ARCHIVE_PROTECT_CHANGE_PROTECTED:'" protected',ARCHIVE_PROTECT_CHANGE_UNPROTECTED:'" unprotected',ARCHIVE_PROTECT_FAIL:'Cannot toggle archive protection of file "',ARCHIVE_PROTECT_END:"Archive protection toggle finished",CONTENTS_NEW:"Found new content with ",CONTENTS_NEW_END:" chars",CONTENTS_RELOADED:"Data reloaded",CONTENTS_DOWNLOAD_START:"Loading archive data ...",CONTENTS_DOWNLOAD_TEXT:"Text data loaded",CONTENTS_DOWNLOAD_TEXT_FAIL:"Cannot load the text data",
CONTENTS_DOWNLOAD_MEDIA_START:"Loading media data ...",CONTENTS_DOWNLOAD_MEDIA_LOADED:"Loaded ",CONTENTS_DOWNLOAD_MEDIA_OF:" of ",CONTENTS_DOWNLOAD_MEDIA_FAIL:"Cannot load the media data",CONTENTS_DOWNLOAD_MEDIA_END:"Media data loaded",CONTENTS_DOWNLOAD_END:"Data download finished",CONTENTS_UPLOAD_START:"Start uploading archive data ...",CONTENTS_BACKUP_START:"Start creating backups ...",CONTENTS_UPLOAD_BACKUP:"Data backup finished",CONTENTS_UPLOAD_BACKUP_FAIL:"Cannot backup archive data. Please see if there is any name conflict",
CONTENTS_UPLOAD_REGISTER_FAIL:"Cannot register folder for this year. Please try again later",CONTENTS_UPLOAD_END:"Data upload finished for ",CONTENTS_UPLOAD_FAIL:"Cannot upload data",CONTENTS_UPGRADING:"Upgrading content data to latest version ...",COVER_PHOTO_FOUND:"Found cover photo ",COVER_PHOTO_FAIL:"Cannot find matched result for cover photo",AUDIO_DOWNLOAD_START:"Loading audio files ...",AUDIO_DOWNLOAD_END:"Audio files loaded",AUDIO_EXPIRED:"Audio file expired. Please re-download the media",
VIDEO_DOWNLOAD_START:"Loading video files ...",VIDEO_DOWNLOAD_END:"Video files loaded",VIDEO_EXPIRED:"Video file expired. Please re-download the media",MEDIA_ALREADY_DISPLAYED:"Another media is playing. Close that to continue",EDIT_PANE_QUIT:"Data discarded",EDIT_PANE_SAVE_START:"Saving data ...",EDIT_PANE_SAVE_PENDING_ATTACHMENTS:"Pending changes saved",EDIT_PANE_SAVE_END:"Finished saving data",TAG_ADD_HEADER:'Tag "',TAG_ICON_ADD_HEADER:'Icon "',TAG_ADDED_ALREADY:'" is already added',TAG_ADDED:'" added',
TAG_ADDED_FAILED:'" cannot be added',TAG_REMOVED:'" removed',EDIT_PANE_NOT_SWITCHABLE:"Save or quit editing this entry to switch to another panel",EDIT_PANE_IMAGES_ALREADY_LOADED:"Images have already been loaded",EDIT_PANE_IMAGES_FAIL:"Cannot load images",EDIT_PANE_IMAGES_START:"Start loading images under data/",EDIT_PANE_IMAGES_START_END:" ...",EDIT_PANE_IMAGES_END:"Images loaded",EDIT_PANE_IMAGES_END_NO_RESULT:"No attached images found",EDIT_PANE_IMAGES_FIND_FAIL:" under data/",EDIT_PANE_IMAGES_SAVE_START:"Start transferring images ...",
EDIT_PANE_IMAGES_OF:" of ",EDIT_PANE_IMAGES_TRASNFERRED:" image transferred",EDIT_PANE_FINISHED_TRANSFER:"Finished ",EDIT_PANE_FINISHED_TRANSFER_END:" transfer",EDIT_PANE_TRANSFERRED_FAILED:"One transfer failed. No transfer was made",EDIT_PANE_TOO_MANY_RESULTS:"There seems to be so many items. Not all the items will be displayed",EDIT_PANE_WEATHER_START:"Loading weather info ...",EDIT_PANE_WEATHER_RESULT:"Weather data loaded. It is ",EDIT_PANE_WEATHER_RESULT_END:" degrees. Have a good one",EDIT_PANE_WEATHER_END:"Weather data updated",
EDIT_PANE_WEATHER_END_FAIL:'Cannot find the matched icon info. Is it "',EDIT_PANE_WEATHER_END_FAIL_END:'" now?',EDIT_PANE_PLAYABLE_SEARCH_START:"Loading resource ...",EDIT_PANE_PLAYABLE_FILE:' file "',EDIT_PANE_PLAYABLE_FILE_ADDED:'" added',EDIT_PANE_PLAYABLE_FILE_SAVED:'" transferred',EDIT_PANE_PLAYABLE_SEARCH_END:"Resource loaded",EDIT_PANE_PLAYABLE_SEARCH_FAILED:"Cannot load the resource",EDIT_PANE_PLAYABLE_SAVE_START:"Start transferring ",EDIT_PANE_PLAYABLE_SAVE_START_END:"s ...",COVERTYPE_AUTO_CHOSEN:"Cover for this entry automatically chosen",
QUEUE_START:"Loading queue resources ...",QUEUE_NO_RESULT:"No applicable queue resources found",QUEUE_IMAGES_NOT_LOADED:"Queue images not loaded because local photos were not shown",QUEUE_FOUND_TEXT:"Text data found",QUEUE_FOUND_IMAGES:" image(s) added",QUEUE_FOUND_VIDEOS:" video(s) added",QUEUE_FOUND_VOICES:" voice(s) added",QUEUE_FAILED:"Cannot find queue resources",QUEUE_END:"Queue resources loaded",NETWORK_WORKING:"Please wait until all network activities stop",OVERWRITE_CACHE_WARNING:"You have saved entry data. Either press confirm to overwrite or read it",
GET_YEARS_START:"Loading year list ...",GET_YEARS_FAIL:"Cannot load year list. Trying again ..",GET_YEARS_END:"Year list loaded",YEAR_SWITCHED_TO:"Year switched to ",DATA_MOVED_TO_OTHER_YEAR:"Some data migrated to year ",DATA_MOVED_TO_OTHER_YEAR_END:". Upload those data or they will be lost",CREATED_TIME_CHANGED_TO:"Created time for this entry changed to ",START_TIME_CHANGED_TO:"Start time for this entry changed to ",END_TIME_CHANGED_TO:"End time for this entry changed to ",TIME_NOT_IN_RANGE:"Time does not fit in this year",
TIME_INVALID:"Invalid time format",STATS_ENTRY_ALREADY_EXIST:"This entry is already added",STATS_ENTRY_EMPTY_STRING:"Invalid entry input",SERVER_RETURNS:" [Error ",SERVER_RETURNS_END:"]",AUTH_REFRESH_ACCESS_START:"Refreshing access token ...",AUTH_REFRESH_ACCESS_END:"Access token refreshed",AUTH_REFRESH_ACCESS_FAILED:"Cannot refresh access token. Please make sure CORS is enabled",AUTH_REFRESH_AUTO_ON:"The access token will now be refreshed every 30 minute",AUTH_REFRESH_AUTO_OFF:"The access token will now stop refreshing",
AUTH_REFRESH_EXPIRED:"Previous session expired",BULB_STILL_BUSY:"Still processing the bulbs",BULB_NO_CONTENT_AVAILABLE:"No bulbs available",BULB_FETCH_START:"Loading bulbs ...",BULB_FETCH_END:"Bulbs loaded. Failed: ",BULB_FETCH_CONTENT_START:"Fetching bulb contents ...",BULB_PROCESSED_LEFT:" bulbs processed. Left: ",BULB_REMOVE_MERGED_START:"Cleaning data on OneDrive ...",BULB_FETCH_FINAL_END:"Done integrating bulbs",BULB_IMAGE_MERGE_FAILED:"Unable to merge image associated with "};
animation.degree=0;animation.duration=300;animation.indent=0;animation.showIcon=function(a,b){$(a).fadeIn(animation.duration,b).css({top:"10px",display:"inline-block"})};animation.hideIcon=function(a,b){var c=$(a).length-1;$(a).each(function(a){a!==c?$(this).fadeOut(animation.duration):$(this).fadeOut(animation.duration,b)})};animation.isShown=function(a){return"10px"===$(a).css("top")&&"none"!==$(a).css("display")};
animation.toggleIcon=function(a,b){b=b||function(){};animation.isShown(a)?animation.hideIcon(a,b):animation.showIcon(a,b)};animation.hideMenu=function(a){$("#action-"+a).removeClass("fadein-inline");animation.hideHiddenIcons()};animation.hideAllMenus=function(){$(".actions > div").each(function(){$(this).removeClass("fadein-inline")})};animation.hideHiddenIcons=function(){$(".actions .hidden-icon").each(function(){$(this).addClass("hidden")})};
animation.showMenu=function(a){a="#action-"+a;0===$(a).length&&(a="#action-menu");$(a).addClass("fadein-inline")};animation.showMenuOnly=function(a){animation.hideAllMenus();animation.showMenu(a)};animation.testCacheIcons=function(){localStorage._cache?($("#reread").removeClass("hidden"),$(".li-add-entry-sub").each(function(){$(this).addClass("has-sub")})):($("#reread").addClass("hidden"),$(".li-add-entry-sub").each(function(){$(this).removeClass("has-sub")}))};
animation.testSub=function(a){var b=!1;$(a).siblings("ul").children("li").children("a").each(function(){$(this).hasClass("hidden")||(b=!0)});b?$(a).parent().addClass("has-sub"):$(a).parent().removeClass("has-sub")};
animation.testYearButton=function(){var a=app.years.indexOf(app.year);-1===a?app.yearUpdateTry((new Date).getFullYear()):(0===a?($("#prev-year").addClass("hidden"),$("#next-year").removeClass("hidden")):a===app.years.length-1?($("#next-year").addClass("hidden"),$("#prev-year").removeClass("hidden")):$("#next-year, #prev-year").removeClass("hidden"),animation.testSub("#this-year"))};
animation.testAllSubs=function(){animation.testCacheIcons();animation.testSub("#add");animation.testSub("#action-stats");animation.testYearButton()};animation.blink=function(a){if(animation.isShown(a)){var b=setInterval(function(){$(a).fadeOut();$(a).fadeIn()},1800);console.log("animation.blink()\t"+a+": id="+b);return b}};
animation.finished=function(a){if(animation.isShown(a)){var b=$(a).html();$(a).fadeOut(300,function(){$(this).html("&#xf00c").css({background:"#fff","font-size":"inherit"})}).fadeIn(300).delay(500).fadeOut(300,function(){$(this).html(b).css({background:"","font-size":""})}).fadeIn(300)}};animation.warning=function(a){if(animation.isShown(a)){var b=$(a).html();$(a).fadeOut(300,function(){$(this).html("&#xf071").css({background:"#fff"})}).fadeIn(300).delay(500).fadeOut(300,function(){$(this).html(b).css({background:""})}).fadeIn(300)}};
animation.deny=function(a){if(animation.isShown(a)){var b=$(a).html();$(a).fadeOut(300,function(){$(this).html("&#xf05e").css({color:"#000",background:"#fff"})}).fadeIn(300).delay(500).fadeOut(300,function(){$(this).html(b).css({background:"",color:""})}).fadeIn(300)}};animation.invalid=function(a){$(a).effect("highlight",{color:"#8d8d8d"})};
animation.log=function(a,b,c){var d=(new Date).getTime(),e;e="";1===b?e="start ":-1===b&&(0>--animation.indent&&(animation.indent=0),e="end ");0<animation.indent&&(e+="indent-"+animation.indent);c=c||0;switch(c){case 0:e='<p class="'+e+'" id='+d+">"+a+"</p>";break;case 1:e='<p class="'+e+' error" id='+d+">"+a+"</p>";break;case 2:e='<p class="'+e+' warning" id='+d+">"+a+"</p>";break;default:e='<p class="'+e+'" id='+d+">"+a+"</p>"}$("#feedback").empty();$(e).prependTo("#feedback").on("contextmenu",
function(){$("#feedback").fadeOut(200,function(){$(this).empty();$(this).fadeIn(0)});return!1}).mousedown(function(){$(this).fadeOut(200,function(){$(this).remove()})});switch(c){case 1:a="[ERR] "+a;break;case 2:a="[!!!] "+a}setTimeout(function(){$("#"+d).trigger("mousedown")},1E4);console.log("From user log: \t"+new Date+": "+a);1===b&&++animation.indent};
animation.error=function(a,b,c){void 0!=b?(""===b&&(b="unknown"),animation.log(a+log.SERVER_RETURNS+b+log.SERVER_RETURNS_END,c,1)):animation.log(a,c,1)};animation.warn=function(a,b,c){void 0!=b?animation.log(a+log.SERVER_RETURNS+b+log.SERVER_RETURNS_END,c,2):animation.log(a,c,2)};animation.debug=function(a,b){animation.isDebug?animation.log("[DEBUG] "+a,b):animation.indent+=b};
animation["switch"]=function(a){if(edit.isEditPaneDisplayed)animation.error(log.EDIT_PANE_NOT_SWITCHABLE);else{var b;$("#drawer li").each(function(a){$(this).hasClass("display")&&(b=$(this).attr("id"),$(this).removeClass("display"))});-1===b.indexOf(a)&&("drawer-archive"===b?archive.quit():"drawer-stats"===b&&stats.quit(),"archive"===a?archive.init():"stats"===a&&stats.init(),$("#drawer-"+a).addClass("display"))}};window.edit={};edit.time=0;edit.intervalId=-1;edit.confirmVal="";
edit.currentEditing=-1;edit.photos=[];edit.voices=[];edit.videos=[];edit.mediaIndex={};edit.isEditing=-1;edit.isFolder=!1;edit.folderDate="";edit.isEditPaneDisplayed=!1;edit.autoCorrectTags={thought:"thoughts",mc:"minecraft",pool:"snooker"};edit.removalList={};edit.localChange=[];edit.mediaList="images music book movie video voice weblink place".split(" ");edit.isProcessing=!1;
edit.init=function(a,b){var c;app.audioPlayer.quit();app.videoPlayer.quit();app.videoPlayer.height="-webkit-calc(100% - 32px)";edit.editView=_.template($("#edit-view").html());var d;if(localStorage._cache)if(!0===a)edit.cleanEditCache(),void 0!=b&&-1!==b&&(d=journal.archive.data[app.year][b],d.time&&(d.time.created&&(localStorage.created=d.time.created),d.time.start&&(localStorage.start=d.time.start)));else if(!1===a)localStorage.created&&(b=edit.find(localStorage.created),-1!==b&&(d=journal.archive.data[app.year][b]));
else{if(void 0==a){animation.warn(log.OVERWRITE_CACHE_WARNING);animation.testAllSubs();return}}else void 0!=b&&(d=journal.archive.data[app.year][b]);d=edit.data=d||edit.newContent();if(localStorage.start||localStorage.created)localStorage.start=localStorage.start||localStorage.created;localStorage._cache=1;edit.mediaIndex={place:-1,music:-1,book:-1,movie:-1,weblink:-1,video:-1,voice:-1};edit.isEditing=-1;edit.isFolder=!1;edit.folderDate="";d=edit.importCache(d);edit.photos=[];edit.videos=[];edit.voices=
[];for(var e=["video","voice"],f=0;f!==e.length;++f){var g;if("video"===e[f])g=edit.videos;else if("voice"===e[f])g=edit.voices;else break;if(d[e[f]])for(c=0;c!==d[e[f]].length;++c){var h=d[e[f]][c].fileName;journal.archive.map[h]&&g.push({name:h,title:d[e[f]][c].title,size:journal.archive.map[h].size,id:journal.archive.map[h].id,resource:!0,change:!1})}}console.log(Object.keys(d));var k=$(edit.editView(d));$("#search-new, #search-result").fadeOut();$("#contents").fadeOut(400,function(){var a;app.$editPane.html(k).fadeIn();
edit.isEditPaneDisplayed=!0;$("#photo-preview").hide();$("#entry-header").bind("keyup","return",function(){edit.saveTitle();$("#entry-body").focus()}).bind("keyup","ctrl+return",function(){edit.saveTitle();edit.notAddHeader=!0;$("#entry-body").focus()}).blur(function(){if(edit.notAddHeader)edit.notAddHeader=!1;else{var a=$(this).val().substring(0,6),b;if(!isNaN(parseInt(a))){var c=edit.convertTime(a);b=new Date(c);var c=b.getMonth()+1==a.substring(0,2),d=b.getDate()==a.substring(2,4),a=b.getFullYear()%
100==a.substring(4,6)||b.getFullYear()===app.year;if(c&&d&&a)return}b=(new Date).getTime();b=new Date(b-144E5);$(this).val(edit.format(b.getMonth()+1)+edit.format(b.getDate())+edit.format(b.getFullYear()%100)+" "+$(this).val())}});$("#entry-tag").keyup(function(a){13===a.keyCode&&(edit.addTag(),$("#entry-tag").val(""))});$("#attach-area").find(".texttags .other p").click(function(){edit.removeTag($(this).text().substring(1))});$("#entry-time-wrap").mouseover(function(){var a=parseInt(localStorage.created)||
d.time.created,b=parseInt(localStorage.start)||d.time.start,c=parseInt(localStorage.end)||d.time.end,e=function(a){a=new Date(a);return isNaN(a.getTime())?"-":edit.format(a.getMonth()+1)+edit.format(a.getDate())+edit.format(a.getFullYear()%100)+" "+edit.format(a.getHours())+edit.format(a.getMinutes())};$("#entry-time-created").html(e(a));$("#entry-time-start").html(e(b));$("#entry-time-end").html(e(c))});var b=["music","book","movie"];for(a=0;a!==b.length;++a)for(var c=b[a],e=0;e!==$("#attach-area ."+
c).length;++e){var f=edit.getSelectorHeader(c,e),g=$(f+".title").val()+"%20"+$(f+".desc").val();getCoverPhoto(f,g,!1,c)}localStorage.title&&$("#entry-header").val(localStorage.title);localStorage.body&&$("#entry-body").text(localStorage.body);if(localStorage.coverType){b=-1;switch(parseInt(localStorage.coverType)){case 128:++b;case 16:++b;case 32:++b;case 4:++b;case 8:++b;case 64:++b;case 2:++b;case 1:++b}edit.coverSet(b)}b=app.tag().getIconsInHtml();c=app.tag().getIconsInName();e=app.tag().separate(localStorage.tags).iconTags;
for(a=0;a!==b.length;++a)f="#attach-area .icontags",f="w"===b[a].charAt(0)?f+" .weather":"e"===b[a].charAt(0)?f+" .emotion":f+" .unselected",$(f).append("<span class='icons "+b[a]+"' title="+c[a].capitalize()+" onclick=edit.toggleTag('"+c[a]+"',true)></span>");for(a=0;a!==b.length;++a)-1!==e.indexOf(b[a])&&edit.toggleIcon(c[a]);$("#entry-body").bind("keyup","return",function(){var b=$(this).get(0).selectionStart,c=$(this).get(0).selectionEnd,d=$(this).val(),e=d.lastIndexOf("\n",b-2),f=d.lastIndexOf("\t",
b-2);if(e<f){var g;if(f===b-2)g=d.substring(0,e+1),b=e;else for(g=d.substring(0,b),a=e+1;a!==f+1&&"\t"===d[a];++a)g+="\t";g+=d.substring(c);$(this).val(g);$(this).get(0).selectionStart=$(this).get(0).selectionEnd=b+1}edit.processBody()}).bind("keyup","space",function(){edit.refreshSummary()}).bind("keydown","tab",function(a){a.preventDefault();a=$(this).get(0).selectionStart;var b=$(this).get(0).selectionEnd;$(this).val($(this).val().substring(0,a)+"\t"+$(this).val().substring(b));$(this).get(0).selectionStart=
$(this).get(0).selectionEnd=a+1}).bind("keyup","ctrl+shift+f",function(){edit.toggleTag("friendship")}).bind("keyup","alt+ctrl+r",function(){edit.toggleTag("relationship")}).bind("keyup","alt+ctrl+i",function(){edit.toggleTag("ingress")}).bind("keyup","alt+ctrl+t",function(){edit.toggleTag("thoughts")}).bind("keyup","alt+ctrl+j",function(){edit.toggleTag("journal")}).bind("keyup","alt+ctrl+m",function(){edit.toggleTag("minecraft")});$("#edit-pane #attach-area .icontags .other, #edit-pane #attach-area .texttags .other, #edit-pane #attach-area .images").mousewheel(function(a,
b){this.scrollLeft-=50*b;a.preventDefault()});edit.playableSetToggle();edit.refreshSummary()});animation.showMenuOnly("add");edit.intervalId=setInterval(edit.refreshTime,1E3)};
edit.quit=function(a,b){network.isAjaxActive?animation.warning(log.NETWORK_WORKING):(clearInterval(edit.intervalId),edit.time=0,edit.mediaIndex={},edit.localChange=[],b?edit.save(a):animation.debug(log.EDIT_PANE_QUIT),edit.photos=[],edit.removalList={},edit.cleanupMediaEdit(),$("#search-new, #search-result").fadeIn(),app.$editPane.fadeOut(400,function(){edit.isEditPaneDisplayed=!1;app.$editPane.html("");$("#contents").fadeIn();app.refresh();animation.showMenuOnly("edit")}),edit.cleanEditCache(),animation.testCacheIcons(),
app.videoPlayer.height=void 0,delete localStorage._cache)};
edit.save=function(){network.isAjaxActive?animation.warn(log.NETWORK_WORKING):(animation.log(log.EDIT_PANE_SAVE_START,1),network.init(3),animation.isShown("#action-remove-confirm")&&(animation.debug(log.EDIT_PANE_SAVE_PENDING_ATTACHMENTS),edit.confirm()),edit.processRemovalList(),edit.photoSave(function(){network.init();edit.playableSave(1,function(){network.init();edit.playableSave(3,function(){network.init();clearInterval(void 0);var a=edit.find(localStorage.created);edit.saveTitle();edit.processBody();
edit.exportCache(a);edit.sortArchive();edit.removeDuplicate();journal.archive.data[app.year]=edit.minData();edit.saveDataCache();$("#add-save-local").html("&#xf0c7").attr({onclick:"edit.save()",href:"#"});animation.finished("#add-save-local");animation.log(log.EDIT_PANE_SAVE_END,-1);network.destroy();uploadSingleFile()})})}))};
edit.processRemovalList=function(){for(var a=0;a<edit.removalList.length;++a)if(localStorage[a]){for(var b=JSON.parse(localStorage[a]),c=0;c<edit.removalList[a].length;++c)b.splice(edit.removalList[a][c],1);localStorage[a]=JSON.stringify(b)}};
edit.importCache=function(a){localStorage.title?a.title=localStorage.title:a.title&&(localStorage.title=a.title);localStorage.body?(a.text||(a.text={}),a.text.body=localStorage.body):a.text&&a.text.body&&(localStorage.body=a.text.body);localStorage.created=a.time.created;localStorage.tags?a.tags=localStorage.tags:localStorage.tags=a.tags?a.tags:"";for(var b=edit.mediaList,c=0;c!==b.length;++c){var d=b[c];localStorage[d]?a[d]=JSON.parse(localStorage[d]):localStorage[d]=a[d]?JSON.stringify(a[d]):"[]"}localStorage.coverType=
a.coverType||0;return a};
edit.exportCache=function(a){var b=journal.archive.data[app.year][a]||{},b=edit.exportCacheBody(b);b.processed=0;b.title=localStorage.title||"Untitled";b.tags=localStorage.tags||"";b.coverType=parseInt(localStorage.coverType);0>=b.coverType&&(b.coverType=edit.coverAuto());b.attachments||(b.attachments=0);for(var c,d=edit.mediaList,e=0,f=0;f<d.length;++f){c=localStorage[d[f]]?JSON.parse(localStorage[d[f]]):[];for(var g=0;g<c.length;++g)c[g]&&""!=c[g].title||c.splice(g--,1);b[d[f]]=0==c.length?void 0:
c;0==c.length?b[d[f]]=void 0:(e|=Math.pow(2,f),b[d[f]]=c)}b.attachments=e;0>a?journal.archive.data[app.year].push(b):(journal.archive.data[app.year][a]=b,app.currentDisplayed=-1)};
edit.exportCacheBody=function(a){a.time||(a.time={});a.time.created=parseInt(localStorage.created);for(var b=["cretaed","start","end"],c=0;c!==b.length;++c)"undefined"===localStorage[b[c]]&&delete localStorage[b[c]];edit.data&&localStorage&&(a.time.created=parseInt(localStorage.created)||a.time.created,a.time.start=parseInt(localStorage.start)||a.time.start,a.time.end=parseInt(localStorage.end)||a.time.end);a.text||(a.text={});for(b=(b=localStorage.body)||"";"\n"===b[b.length-1];)b=b.substr(0,b.length-
1);a.text.body=b;a.text.chars=b.length;a.text.lines=b.split(/\r*\n/).length;a.text.ext=b.substring(0,50);return a};edit.cleanEditCache=function(){delete localStorage._cache;for(var a="title body created currentEditing tags place music movie book images weblink video voice start end".split(" "),b=0;b!==a.length;++b)delete localStorage[a[b]];edit.photos=[];edit.voices=[];edit.videos=[]};
edit.saveDataCache=function(){app.year===(new Date).getFullYear()&&(localStorage.archive=JSON.stringify(journal.archive.data[app.year]),localStorage.lastUpdated=(new Date).getTime())};edit.removeDataCache=function(){delete localStorage.archive};edit.tryReadCache=function(){localStorage.archive&&(journal.archive.data[(new Date).getFullYear()]=JSON.parse(localStorage.archive),app.refresh())};
edit.find=function(a){for(var b=0,c=journal.archive.data[app.year].length;b!=c;++b)if(journal.archive.data[app.year][b]&&journal.archive.data[app.year][b].time&&journal.archive.data[app.year][b].time.created==a)return b;return-1};edit.newContent=function(){var a={time:{}};a.time.created=(new Date).getTime();a.tags="";for(var b="images video voice place music book movie weblink iconTags textTags".split(" "),c=0;c!==b.length;++c)a[b[c]]=void 0;return a};
edit.minData=function(){for(var a=journal.archive.data[app.year].filter(function(a){return void 0!=a}),b=0,c=a.length;b!==c;++b){delete a[b].attached;delete a[b].contents;delete a[b].chars;delete a[b].datetime;delete a[b].endtime;delete a[b].ext;delete a[b].index;delete a[b].iconTags;delete a[b].isBulb;delete a[b].lines;delete a[b].month;delete a[b].processed;delete a[b].summary;delete a[b].textTags;delete a[b].type;var d;for(d=0;d<a[b].length;++d)void 0!=a[b][d]&&"undefined"!=a[b][d]||a[b].splice(d--,
1);var e=["movie","music"];for(d=0;d!==e.length;++d)if(a[b][e[d]])for(var f=Object.keys(a[b][e[d]]),g=0;g!==f.length;++g)delete a[b][e[d]][f[g]].thumb;a[b].text.body=a[b].text.body.replace(/\r\n/g,"\n")}return a};edit.sortArchive=function(){journal.archive.data[app.year].sort(function(a,b){var c=b.time.created-a.time.created;return c?c:!!b.contentType-!!a.contentType})};
edit.removeDuplicate=function(){for(var a=0;a<Object.keys(journal.archive.data[app.year]).length-1;++a){var b=journal.archive.data[app.year][a],c=journal.archive.data[app.year][a+1];b.time.created===c.time.created&&b.contentType===c.contentType&&(app.yearChange[app.year]=!0,journal.archive.data[app.year].splice(a--,1))}};
edit.enableWidthAdjust=function(){var a=!1,b=0,c=$(window).width(),d=app.$ruler.outerWidth(),e=function(a){a=c-2*(a+d);a=app.$app.width(a).width();app.$ruler.css("right",(c-a)/2-d+"px")};e(parseInt(localStorage.rulerRight||0));app.$ruler.off("mousedown mousemove mouseup").mousedown(function(d){a=!0;c=$(window).width();var e=$(this).offset().left;b=d.pageX-e;console.log(b)}).mousemove(function(f){a&&e(Math.max(c-d-f.pageX+b,0))}).mouseup(function(b){a=!1;localStorage.rulerRight=$(this).css("right")})};
edit.undo=function(){};edit.change=function(a,b){};
edit.removeEntry=function(){if(-1==app.currentDisplayed)animation.error(log.NO_ENTRY_SELECTED),animation.deny("#delete");else{app.yearChange[app.year]=!0;$("#year-change").addClass("change");--app.displayedNum;var a=journal.archive.data[app.year][app.currentDisplayed];app.displayedChars-=a.text.chars||0;app.displayedLines-=a.text.lines||0;app.displayedTime-=(a.time.end-a.time.start)/6E4;delete journal.archive.data[app.year][app.currentDisplayed];a=app.$list.find("ul").find("li:nth-child("+(app.currentDisplayed+
1)+")");0===a.next().length||0!==a.next().has("p.separator").length?a.fadeOut(500,function(){$(this).empty()}):a.children("a").fadeOut(500,function(){$(this).remove()});app.detail.prototype.hideDetail();$(".loadmore").trigger("click");edit.saveDataCache();animation.showMenuOnly("edit")}};
edit.addMedia=function(a,b){var c="#attach-area ."+edit.mediaName(Math.abs(a)),d=$(c).length,e;switch(a){case 0:edit.photo();return;case 1:edit.videoSearch();break;case -1:e='<div class="video data change"><a class=\''+b.fileName+"' onclick=\"edit.video("+d+",'"+b.url+'\')" title="View"><div class="thumb"><span></span></div><input disabled class="title" value="'+b.title+'" /></a></div>';break;case 2:e='<div class="place"><a title="Edit" onclick="edit.location('+d+')" href="#"><div class="thumb"></div><input disabled title="Place" class="title place-search" autocomplete="off"/><input disabled title="Latitude" class="desc latitude" autocomplete="off" /><p>,</p><input disabled title="Longitude" class="desc longitude" autocomplete="off" /></a></div>';
break;case 3:edit.voiceSearch();break;case -3:e='<div class="voice data change"><a class=\''+b.fileName+"' onclick=\"edit.voice("+d+",'"+b.url+'\')" title="View"><div class="thumb"><span></span></div><input disabled class="title" value="'+b.title+'" /></a></div>';break;case 4:e='<div class="music"><a title="Edit" onclick="edit.music('+d+')" href="#"><img class="thumb"><span></span><input disabled class="title" placeholder="Track name" autocomplete="off" /><input disabled class="desc" placeholder="Artist" autocomplete="off" /></a></div>';
break;case 5:e='<div class="movie"><a title="Edit" onclick="edit.movie('+d+')" href="#"><img class="thumb"><span></span><input disabled class="title" placeholder="Movie title" autocomplete="off" onclick="this.select()" /><input disabled class="desc" placeholder="Director" autocomplete="off" onclick="this.select()" /></a></div>';break;case 6:e='<div class="book"><a title="Edit" onclick="edit.book('+d+')" href="#"><img class="thumb"><span></span><input disabled class="title" placeholder="Book title" autocomplete="off" onclick="this.select()" /><input disabled class="desc" placeholder="Author" autocomplete="off" onclick="this.select()" /></a></div>';
break;case 7:e='<div class="weblink"><a title="Edit" onclick="edit.weblink('+d+')" href="#"><div class="thumb"><span></span></div><input disabled class="title" placeholder="Title" /><input disabled class="desc" placeholder="http://" /></a></div>';break;default:return}0<d?$(e).insertAfter($(c+":eq("+(d-1)+")")):$(e).appendTo("#attach-area");0<a&&$(c+":eq("+d+") a").trigger("click")};edit.removeMedia=function(a){var b=edit.mediaName(a);edit.coverTest(b);switch(a){case 1:case 3:break;default:edit.addToRemovalList(b)}edit.cleanupMediaEdit()};
edit.addMediaFromQueue=function(){$("#return-lost-media").removeAttr("onclick");animation.log(log.QUEUE_START,1);network.init(1);edit.photo(!0,function(){network.next();getTokenCallback(function(a){$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/queue:/children?select=id,name,size,@content.downloadUrl&access_token="+a}).done(function(a,c,d){var e;a=a.value;for(var f=d=c=0,g=a.length;f!==g;++f){var h=a[f].id,k=a[f].size,l=a[f].name,m=a[f]["@content.downloadUrl"];e=l.substring(l.length-
4).toLowerCase();var h={id:h,name:l,title:l.substring(0,l.length-4),url:m,size:k,resource:!1,change:!0},p=!0;if(".mp4"===e){for(e=0;e!==edit.videos.length;++e)if(edit.videos[e].size===k){p=!1;break}p&&(++d,edit.videos.push(h),edit.addMedia(-1,{fileName:l,url:m,title:l.substring(0,l.length-4)}))}else if(".mp3"===e||".wav"===e){for(e=0;e!==edit.voices.length;++e)if(edit.voices[e].size===k){p=!1;break}p&&(++c,edit.voices.push(h),edit.addMedia(-3,{fileName:l,url:m,title:l.substring(0,l.length-4)}))}}edit.playableSetToggle();
0<d&&animation.debug(d+log.QUEUE_FOUND_VIDEOS);0<c&&animation.debug(c+log.QUEUE_FOUND_VOICES)}).fail(function(a,c,d){animation.error(log.QUEUE_FAILED,d)}).always(function(){$("#return-lost-media").attr("onclick","app.cleanResource()");animation.log(log.QUEUE_END,-1)})})})};edit.addToRemovalList=function(a,b){edit.removalList[a]||(edit.removalList[a]=[]);void 0==b&&(b=edit.mediaIndex[a]);var c=edit.getSelectorHeader(a,b);$(c).fadeOut();-1!==edit.removalList[a].indexOf(b)&&edit.removalList[a].push(b)};
edit.mediaName=function(a){switch(a){case 0:return"photo";case 1:return"video";case 2:return"place";case 3:return"voice";case 4:return"music";case 5:return"movie";case 6:return"book";case 7:return"weblink";default:return""}};edit.mediaValue=function(a){return"photo"===a?0:"video"===a?1:"place"===a?2:"voice"===a?3:"music"===a?4:"movie"===a?5:"book"===a?6:"weblink"===a?7:-1};edit.setRemove=function(a){edit.confirmVal=a;2===a&&$("#pin-point").removeClass("hidden");$("#action-remove-confirm").removeClass("hidden")};
edit.cleanupMediaEdit=function(){app.$editPane.off("keyup");switch(edit.isEditing){case 1:edit.videoHide();break;case 2:edit.locationHide();break;case 3:edit.voiceHide();break;case 4:edit.musicHide();break;case 5:edit.movieHide();break;case 6:edit.bookHide();break;case 7:edit.weblinkHide()}};edit.getSelectorHeader=function(a,b){return void 0==b?"#attach-area ."+a+":eq("+edit.mediaIndex[a]+") ":"#attach-area ."+a+":eq("+b+") "};edit.toggleLight=function(){$("#text-area").toggleClass("dark")};
edit.fullScreen=function(){edit.cleanupMediaEdit();$(window).off("resize");$("#app").css("height","");animation.showMenuOnly("fullscreen");$("body").addClass("fullscreen");document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
edit.enableWidthAdjust()};edit.windowMode=function(){$("#text-area").removeClass("dark");animation.showMenuOnly("add");$("body").removeClass("fullscreen");app.layout();document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()};edit.saveTitle=function(){localStorage.title=$("#entry-header").val()};
edit.refreshSummary=function(){var a=$("#entry-body").val(),b=a.length;$("#entry-char").text(b);$("#entry-line").text(a.split(/\r*\n/).length)};edit.refreshTime=function(){++edit.time;var a=new Date,a=edit.format(a.getMonth()+1)+edit.format(a.getDate())+edit.format(a.getFullYear()%100)+" "+edit.format(a.getHours())+edit.format(a.getMinutes());$("#entry-time").text(a);$("#entry-elapsed").text(parseInt(edit.time/60)+":"+edit.format(edit.time%60))};edit.format=function(a){return 10>a?"0"+a:""+a};
edit.convertTime=function(a){var b=parseInt(a.substring(0,2)),c=parseInt(a.substring(2,4)),d=parseInt(a.substring(4,6)),e=0,f=0;6<a.length&&(e=parseInt(a.substring(7,9)),f=parseInt(a.substring(9,11)));return(new Date(2E3+d,b-1,c,e,f)).getTime()};
edit.getDate=function(a){var b;localStorage.title&&(b=parseInt(localStorage.title),isNaN(b)||(b=b.toString(),5===b.length&&(b="0"+b),6!==b.length&&(b="")));b||(localStorage.created?b=new Date(parseInt(localStorage.created)):(b=(new Date).getTime(),b=new Date(b-144E5)),b=""+edit.format(b.getMonth()+1)+edit.format(b.getDate())+edit.format(b.getFullYear()%100));b!=edit.folderDate?createDateFolder(b,a):a(b);return b};
edit.getMyTime=function(a){var b=new Date(a);return isNaN(b.getTime())?a:""+edit.format(b.getMonth()+1)+edit.format(b.getDate())+edit.format(b.getFullYear()%100)+" "+edit.format(b.getHours())+edit.format(b.getMinutes())};
edit.processBody=function(){for(var a=$("#entry-body").val().split(/\r*\n/),b=0;b<a.length;++b){var c=a[b],d=!1;"Begin @"===c.substring(0,7)?((c=edit.convertTime(c.substring(8)))&&(new Date(c)).getFullYear()===app.year?(localStorage.start=c,animation.log(log.START_TIME_CHANGED_TO+app.list.prototype.date(c))):animation.error(log.TIME_NOT_IN_RANGE),d=!0):"End @"===c.substring(0,5)?((c=edit.convertTime(c.substring(6)))?(localStorage.end=c,animation.log(log.END_TIME_CHANGED_TO+app.list.prototype.date(c))):
animation.error(log.TIME_INVALID),d=!0):"Created @"===c.substring(0,9)?(c=edit.convertTime(c.substring(10)),(new Date(c)).getFullYear()===app.year?(localStorage.created=c,animation.log(log.CREATED_TIME_CHANGED_TO+app.list.prototype.date(c))):animation.error(log.TIME_NOT_IN_RANGE),d=!0):2<c.length&&"#"===c.charAt(0)&&(edit.addTag(c.substring(1).toLowerCase()),d=!0);d&&a.splice(b--,1)}a=a.join("\r\n");$("#entry-body").val(a);localStorage.body=a};
edit.addTag=function(a,b){a=(a=edit.autoCorrectTags[a]||a)||$("#entry-tag").val().toLowerCase().replace(/\|/g,"");a=a.replace(/ /g,"");if(-1!==localStorage.tags.split("|").indexOf(a))animation.warn(log.TAG_ADD_HEADER+a+log.TAG_ADDED_ALREADY),$("#entry-tag").effect("highlight",{color:"#000"},400);else{var c=!1,d=!1;$("#attach-area .icontags span").each(function(){if($(this).attr("title").toLowerCase()===a){c=!0;var e=$(this).parent().attr("class");"weather"!==e&&"emotion"!==e||!$(this).hasClass("hidden")?
$(this).hasClass("highlight")?(animation.warn(log.TAG_ICON_ADD_HEADER+a+log.TAG_ADDED_ALREADY),""!==$("#entry-tag").val()&&$("#entry-tag").effect("highlight",{color:"#000"},400)):(b||animation.log(log.TAG_ICON_ADD_HEADER+a+log.TAG_ADDED),edit.toggleIcon(a),d=!0):(animation.warn(log.TAG_ICON_ADD_HEADER+a+log.TAG_ADDED_FAILED),""!==$("#entry-tag").val()&&$("#entry-tag").effect("highlight",{color:"#000"},400))}});if(!c){$("#entry-tag").effect("highlight",{color:"#dadada"},400);var e="onclick=edit.removeTag('"+
a+"')";$("#attach-area .texttags .other").append("<p title='Click to remove' "+e+">#"+a+"</p>");d=!0}d&&(localStorage.tags=localStorage.tags?localStorage.tags+("|"+a):a)}};
edit.removeTag=function(a,b){for(var c=localStorage.tags.split("|"),d=0;d!==c.length;++d)if(c[d]===a){var e=!1;$("#attach-area .texttags p").each(function(){$(this).text()==="#"+a&&$(this).animate({width:"0"},function(){$(this).remove();e=!0})});if(!e){var f=!1;$("#attach-area .icontags .highlight").each(function(){f||$(this).attr("title").toLowerCase()!==a||(b||animation.log(log.TAG_ICON_ADD_HEADER+a+log.TAG_REMOVED),edit.toggleIcon(a),f=!0)})}c.splice(d,1);localStorage.tags=c.join("|");break}};
edit.toggleTag=function(a,b){-1!==localStorage.tags.split("|").indexOf(a)?edit.removeTag(a,b):edit.addTag(a,b)};
edit.toggleIcon=function(a){var b=app.tag().getHtmlByName(a);a="#attach-area .icontags span."+b;var c=$(a).parent().attr("class");$(a).toggleClass("highlight").hasClass("highlight")?"weather"===c||"emotion"===c?$("#attach-area").find(".icontags").find("."+c+" span:not(."+b+")").addClass("hidden"):$("#attach-area").find(".icontags").find(".selected").append($(a).addClass("highlight").clone()):"weather"===c||"emotion"===c?$("#attach-area").find(".icontags").find("."+c).find("span").removeClass("hidden"):
setTimeout(function(){$("#attach-area .icontags .selected ."+b).remove()},400)};
edit.coverSet=function(a,b){var c,d=a;"string"==typeof a&&(d=edit.mediaValue(a));switch(d){case 0:c=1;break;case 1:c=2;break;case 2:c=64;break;case 3:c=8;break;case 4:c=4;break;case 5:c=32;break;case 6:c=16;break;case 7:c=128;break;default:c=0}$(".types p").removeClass("hidden selected");if(b&&localStorage.coverType==c)localStorage.coverType=c=-1;else{localStorage.coverType=c;var e=edit.mediaName(d);$(".types p:not(#"+edit.mediaName(d)+"-cover)").addClass("hidden");e?$(".types #"+edit.mediaName(d)+
"-cover").addClass("selected"):$(".types #no-cover").addClass("selected")}return c};edit.coverAuto=function(a){var b=edit.mediaList;a=a||edit.coverRefresh();for(var c=0;c!==b.length;++c)if(-1!==a.indexOf(b[c]))return edit.coverSet(b[c]);edit.coverSet(-1);animation.log(log.COVERTYPE_AUTO_CHOSEN)};edit.coverRefresh=function(){for(var a=edit.mediaList,b=[],c=0;c!==a.length;++c)if(a[c]in localStorage&&0!==localStorage[a[c]].length)try{0!==Object.keys(JSON.parse(localStorage[a[c]])).length&&b.push(a[c])}catch(d){}return b};
edit.coverTest=function(a){var b=!1;$("#attach-area ."+a).each(function(){"none"!==$(this).css("display")&&(b=!0)});b||$("#attach-area").find(".types #"+a+"-cover").trigger("click")};
edit.photo=function(a,b){"function"!=typeof b&&(b=function(){});if(0===edit.photos.length||a){var c=JSON.parse(localStorage.images);if(c.length&&0===Object.keys(journal.archive.map).length)animation.error(log.EDIT_PANE_IMAGES_FAIL+log.DOWNLOAD_PROMPT),animation.deny("#add-photo");else{var d=!1;"100px"!==$("#attach-area").find(".images").css("height")&&a&&(d=!0,a=!1);$("#attach-area").find(".images").css({height:"100px"}).hover(function(){edit.cleanupMediaEdit();$("#photo-preview").css("opacity","initial").show({effect:"fade",
duration:200})},function(){$("#photo-preview").hide({effect:"fade",duration:200})}).sortable({containment:"#attach-area .images",cursor:"crosshair",revert:!0}).disableSelection();var e=function(c){getTokenCallback(function(e){e=a?"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/queue:/children?select=id,name,size,@content.downloadUrl&access_token="+e:getDataUrlHeader()+"/"+c+":/children?select=id,name,size,@content.downloadUrl&access_token="+e;$.ajax({type:"GET",url:e}).done(function(b){b["@odata.nextLink"]&&
!a&&animation.warn(log.EDIT_PANE_TOO_MANY_RESULTS);for(var c=b.value,d=b=0,e=c.length;d!==e;++d){var f=c[d].size,g=c[d].id,k=c[d].name,h=k.substring(k.length-4).toLowerCase(),v=!1;if(".jpg"===h||".png"===h){for(var h=0,w=edit.photos;h!==w.length;++h)if(w[h].size==f){v=!0;break}v||(f={name:k,id:g,url:c[d]["@content.downloadUrl"],size:f,resource:!1,change:!1},++b,edit.photos.push(f))}}for(h=a?edit.photos.length-b:0;h!==edit.photos.length;++h)c=a?'<div class="queue">':edit.photos[h].resource?'<div class="resource">':
'<div class="data">',c+='<span></span><img src="'+edit.photos[h].url+'"/></div>',$("#attach-area").find(".images").append(c);$("#add-photo").html("&#xf03e").attr({onclick:"edit.addMedia(0)",href:"#"}).fadeIn();$("#attach-area").find(".images").find("div").each(function(){$(this).off("contextmenu");$(this).on("contextmenu",function(){$(this).toggleClass("change");return!1})});$("#attach-area").find(".images").find("img").each(function(){$(this).unbind("mouseenter mouseleave").hover(function(){$("#photo-preview").find("img").animate({opacity:1},
200).attr("src",$(this).attr("src"))},function(){$("#photo-preview").find("img").animate({opacity:0},0)})});a?animation.debug(b+log.QUEUE_FOUND_IMAGES):(edit.setRemove(0),0===edit.photos.length?animation.log(log.EDIT_PANE_IMAGES_END_NO_RESULT,-1):animation.log(log.EDIT_PANE_IMAGES_END,-1),animation.finished("#add-photo"))}).fail(function(b,e,f){a||($("#add-photo").html("&#xf03e").attr({onclick:"edit.addMedia(0)",href:"#"}),"Not Found"!==f||d?--animation.indent:(animation.error(log.EDIT_PANE_IMAGES_FAIL+
log.EDIT_PANE_IMAGES_FIND_FAIL+c,f,-1),animation.deny("#add-photo")))}).always(function(){d?edit.photo(!0,b):(b(),network.destroy())})})};if(a)$("#attach-area").find(".images .queue").each(function(){for(var a=0;a!==edit.photos.length;++a){var b=$(this).children("img").attr("src");if(edit.photos[a].url===b){edit.photos.splice(a,1);break}}$(this).remove()}),e();else{$("#add-photo").removeAttr("onclick").removeAttr("href");edit.photos=[];for(var f=0;f<c.length;++f){var g=c[f].fileName;journal.archive.map[g]?
edit.photos.push({name:g,id:journal.archive.map[g].id,size:journal.archive.map[g].size,url:journal.archive.map[g].url,resource:!0,change:!1}):(c.splice(f--,1),localStorage.images=JSON.stringify(c))}edit.getDate(function(a){animation.log(log.EDIT_PANE_IMAGES_START+a+log.EDIT_PANE_IMAGES_START_END,1);e(a)})}}}else animation.error(log.EDIT_PANE_IMAGES_ALREADY_LOADED)};
edit.photoSave=function(a){if(0==edit.photos.length)a();else{var b=[],c=[];edit.getDate(function(d){$("#attach-area").find(".images div").each(function(){for(var a=0;a!==edit.photos.length;++a)if($(this).children("img").attr("src")===edit.photos[a].url){edit.photos[a].change=$(this).hasClass("change");break}});for(var e=0;e!==edit.photos.length;++e){var f=edit.photos[e].name,g=edit.photos[e].id,h=edit.photos[e].resource;edit.photos[e].change&&(edit.photos[e].change=!1,b.push({name:f,id:g,resource:!h}))}var k=
"/drive/root:/Apps/Journal/resource/"+app.year,l="/drive/root:/Apps/Journal/data/"+app.year+"/"+d,m=0;0!==b.length?getTokenCallback(function(e){animation.log(log.EDIT_PANE_IMAGES_SAVE_START,1);for(var f=0;f!==b.length;++f){var g;g=b[f].name;var h="https://api.onedrive.com/v1.0/drive/items/"+b[f].id+"?select=id,name,size,@content.downloadUrl&access_token="+e;b[f].resource?(g=d+((new Date).getTime()+f)+g.substring(g.length-4),g={name:g,parentReference:{path:k}}):g={parentReference:{path:l}};$.ajax({type:"PATCH",
url:h,contentType:"application/json",data:JSON.stringify(g)}).done(function(a,c,d){c=a.id;d=a.name;for(var e=0;e!==edit.photos.length;++e)edit.photos[e].id==c&&(edit.photos[e].success=!0,edit.photos[e].name=d,journal.archive.map[a.name]={url:a["@content.downloadUrl"],size:a.size,id:a.id});animation.debug(++m+log.EDIT_PANE_IMAGES_OF+b.length+log.EDIT_PANE_IMAGES_TRASNFERRED)}).fail(function(a,b,c){++m;animation.error(log.EDIT_PANE_TRANSFERRED_FAILED+log.SERVER_RETURNS+c+log.SERVER_RETURNS_END);animation.warning("#add-photo")}).always(function(d,
e,f){var g;if(m===b.length){$("#attach-area").find(".images div").each(function(){$(this).removeClass("change");for(g=0;g!==edit.photos.length;++g)if($(this).children("img").attr("src")===edit.photos[g].url){edit.photos[g].success&&(edit.photos[g].resource?($(this).addClass("data").removeClass("resource"),delete journal.archive.map[edit.photos[g].name]):$(this).addClass("resource").removeClass("queue data"),edit.photos[g].resource=!edit.photos[g].resource);break}});for(g=0;g!==edit.photos.length;++g)edit.photos[g].change=
!1,edit.photos[g].success=!1;$("#attach-area").find(".images img").each(function(){for(g=0;g!==edit.photos.length;++g)edit.photos[g].url===$(this).attr("src")&&edit.photos[g].resource&&c.push({fileName:edit.photos[g].name})});localStorage.images=JSON.stringify(c);animation.log(log.EDIT_PANE_FINISHED_TRANSFER+edit.mediaName(0)+log.EDIT_PANE_FINISHED_TRANSFER_END,-1);a()}})}}):($("#attach-area").find(".images img").each(function(){for(j=0;j!==edit.photos.length;++j)edit.photos[j].url===$(this).attr("src")&&
edit.photos[j].resource&&c.push({fileName:edit.photos[j].name})}),localStorage.images=JSON.stringify(c),a())})}};edit.photoHide=function(){$("#attach-area").find(".images").animate({height:"0"}).fadeOut().html("")};
edit.video=function(a,b){if(a!=edit.mediaIndex.video&&void 0!=a){edit.cleanupMediaEdit();edit.mediaIndex.video=a;var c=edit.getSelectorHeader("video");edit.setRemove(1);edit.func=$(c+"a").attr("onclick");$(c+"a").removeAttr("onclick");$(c+"input").prop("disabled",!1);app.$editPane.keyup(function(a){27===a.keyCode&&edit.videoHide()});edit.isEditing=1;var d;if(b)d=b,$("#text-area").find("#video-preview").fadeIn(),app.videoPlayer("#text-area #video-preview",d);else if(d=$(c+"a").attr("class"),journal.archive.map[d]){d=
journal.archive.map[d].url;if(void 0==d){animation.error(log.FILE_NOT_FOUND+$(c+".title").val());return}$("#text-area").find("#video-preview").fadeIn();app.videoPlayer("#text-area #video-preview",d)}else animation.error(log.FILE_NOT_LOADED+$(c+".title")+log.DOWNLOAD_PROMPT);edit.setRemove(1)}};
edit.videoHide=function(){if(!(0>edit.mediaIndex.video)){$("#text-area #video-preview").fadeOut();app.videoPlayer.quit();var a=edit.getSelectorHeader("video");$(a+"input").prop("disabled",!0).off("keyup");edit.func?($(a+"a").attr("onclick",edit.func),edit.func=void 0):$(a+"a").attr("onclick","edit.video("+edit.mediaIndex.video+")");edit.videoSave(edit.mediaIndex.video);app.$editPane.off("keyup");animation.hideHiddenIcons();edit.mediaIndex.video=-1;edit.isEditing=-1}};
edit.videoSave=function(a){var b=localStorage.video,c=edit.getSelectorHeader("video",a),d=$(c+".title").val(),b=b?JSON.parse(b):[],c={title:d,fileName:$(c+"a").attr("class")};b[a]=c;localStorage.video=JSON.stringify(b)};edit.videoSearch=function(){edit.playableSearch(1)};
edit.location=function(a){if(a!=edit.mediaIndex.place&&void 0!=a){edit.cleanupMediaEdit();edit.setRemove(2);edit.mediaIndex.place=a;$("#map-holder").fadeIn();$("#pin-point").removeClass("hidden");var b=edit.getSelectorHeader("place",a);navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){var d=parseFloat($(b+".latitude").val())||a.coords.latitude;a=parseFloat($(b+".longitude").val())||a.coords.longitude;pos=new google.maps.LatLng(d,a);mapOptions={zoom:15,center:pos};map=new google.maps.Map(document.getElementById("map-selector"),
mapOptions);searchBox=new google.maps.places.Autocomplete(document.getElementsByClassName("place-search")[edit.mediaIndex.place],{types:["geocode"]});markers=[];google.maps.event.clearListeners(searchBox,"place_changed");google.maps.event.addListener(searchBox,"place_changed",function(){var a=searchBox.getPlace();new google.maps.LatLngBounds;a?(markers[0]&&(markers[0].setMap(null),markers=[]),marker=new google.maps.Marker({map:map,title:a.name,position:a.geometry.location}),marker.setMap(map),markers.push(marker),
map.setZoom(16),map.setCenter(a.geometry.location),$(b+".latitude").val(a.geometry.location.lat()),$(b+".longitude").val(a.geometry.location.lng())):animation.invalid(b+".place-search")});google.maps.event.addListener(map,"bounds_changed",function(){var a=map.getBounds();searchBox.setBounds(a)});$("#attach-area .place .desc").keyup(function(a){if(13==a.keyCode){a=parseFloat($(b+".latitude").val());var c=parseFloat($(b+".longitude").val());isNaN(a)?animation.invalid(b+".latitude"):isNaN(c)?animation.invalid(b+
".longitude"):(pos=new google.maps.LatLng(a,c),edit.locationGeocode(pos))}})},function(){animation.error(log.LOCATION_PIN_FAIL)}):animation.error(log.LOCATION_PIN_FAIL);edit.isEditing=2;$(b+"input").prop("disabled",!1);$(b+"a").removeAttr("onclick");app.$editPane.keyup(function(a){27===a.keyCode&&edit.locationHide()})}};
edit.locationHide=function(){if(!(0>edit.mediaIndex.place)){var a=edit.getSelectorHeader("place");$(a+"input").prop("disabled",!0);$(a+"a").attr("onclick","edit.location("+edit.mediaIndex.place+")");edit.locationSave(edit.mediaIndex.place);$("#map-holder").fadeOut().html('<div id="map-selector"></div>');$("#pin-point").addClass("hidden");app.$editPane.off("keyup");animation.hideHiddenIcons();edit.mediaIndex.place=-1;edit.isEditing=""}};
edit.locationSave=function(a){var b=localStorage.place,c=edit.getSelectorHeader("place",a),d=parseFloat($(c+".latitude").val()),e=parseFloat($(c+".longitude").val()),f={},b=b?JSON.parse(b):[];f.title=$(c+".title").val();isNaN(d)||isNaN(e)||(f.latitude=d,f.longitude=e);b[a]=f;localStorage.place=JSON.stringify(b)};
edit.locationPin=function(){var a=edit.getSelectorHeader("place");navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){var c=b.coords.latitude;b=b.coords.longitude;var d=new google.maps.LatLng(c,b);$(a+".latitude").val(c);$(a+".longitude").val(b);edit.locationGeocode(d);edit.locationWeather(d)},function(){animation.error(log.LOCATION_PIN_FAIL)}):animation.error(log.LOCATION_PIN_FAIL)};
edit.locationGeocode=function(a){var b={zoom:16,center:a},b=new google.maps.Map(document.getElementById("map-selector"),b);new google.maps.Marker({map:b,position:a});var c=edit.getSelectorHeader("place");b.setCenter(a);(new google.maps.Geocoder).geocode({latLng:a},function(a,b){b==google.maps.GeocoderStatus.OK?a[0]?$(c+".title").val(a[0].formatted_address):animation.error(log.LOCATION_NO_RESULTS):animation.error(log.LOCATION_NO_ADDRESS+log.SERVER_RETURNS+b+log.SERVER_RETURNS_END)})};
edit.locationWeather=function(a){var b=!1;$("#attach-area").find(".icontags .weather p").each(function(){$(this).hasClass("highlight")&&(b=!0)});b||(animation.debug(log.EDIT_PANE_WEATHER_START,1),a="https://api.forecast.io/forecast/6f1ee423e253fba5e40e3276ff3e6d33/"+a.lat()+","+a.lng()+","+parseInt((new Date).getTime()/1E3)+"?units=si",$.ajax({type:"GET",url:a,dataType:"jsonp"}).done(function(a,b,e){b=a.currently;e=b.icon;animation.log(log.EDIT_PANE_WEATHER_RESULT+b.temperature+log.EDIT_PANE_WEATHER_RESULT_END);
var f;"clear-day"===e||"clear-night"===e?f="w01":"cloudy"===e||"partly-cloudy-day"===e||"partly-cloudy-night"===e?f="w02":"rain"===e?f="w03":"snow"===e||"sleet"===e?f="w04":"wind"===e&&(f="w06");f?(animation.log(log.EDIT_PANE_WEATHER_END,-1),$("#attach-area").find(".icontags ."+f).trigger("click")):animation.log(log.EDIT_PANE_WEATHER_END_FAIL+a.summary+log.EDIT_PANE_WEATHER_END_FAIL_END,-1)}))};
edit.voice=function(a,b){if(a!=edit.mediaIndex.voice&&void 0!=a){edit.cleanupMediaEdit();edit.mediaIndex.voice=a;var c=edit.getSelectorHeader("voice");edit.func=$(c+"a").attr("onclick");$(c+"a").removeAttr("onclick");$(c+"input").prop("disabled",!1);app.$editPane.keyup(function(a){27===a.keyCode&&edit.voiceHide()});edit.isEditing=3;var d;if(b)app.audioPlayer(c+"a",b);else if(d=$(c+"a").attr("class"),journal.archive.map[d]){d=journal.archive.map[d].url;if(void 0==d){animation.error(log.FILE_NOT_FOUND+
$(c+".title").val());return}app.audioPlayer(c+"a",d)}else animation.error(log.FILE_NOT_LOADED+$(c+".title")+log.DOWNLOAD_PROMPT);edit.setRemove(3)}};
edit.voiceHide=function(){if(!(0>edit.mediaIndex.voice)){app.videoPlayer.quit();var a=edit.getSelectorHeader("voice");$(a+"input").prop("disabled",!0).off("keyup");edit.func?($(a+"a").attr("onclick",edit.func),edit.func=void 0):$(a+"a").attr("onclick","edit.voice("+edit.mediaIndex.voice+")");edit.voiceSave(edit.mediaIndex.voice);app.$editPane.off("keyup");animation.hideHiddenIcons();edit.mediaIndex.voice=-1;edit.isEditing=-1}};
edit.voiceSave=function(a){var b=localStorage.voice,c=edit.getSelectorHeader("voice",a),d=$(c+".title").val(),b=b?JSON.parse(b):[],c={title:d,fileName:$(c+"a").attr("class")};b[a]=c;localStorage.voice=JSON.stringify(b)};edit.voiceSearch=function(){edit.playableSearch(3)};edit.voiceNew=function(){};edit.music=function(a){edit.itunes(a,4)};edit.musicHide=function(){edit.itunesHide(4)};edit.musicSave=function(a){edit.itunesSave(a,4)};edit.movie=function(a){edit.itunes(a,5)};edit.movieHide=function(){edit.itunesHide(5)};
edit.movieSave=function(a){edit.itunesSave(a,5)};edit.book=function(a){edit.itunes(a,6)};edit.bookHide=function(){edit.itunesHide(6)};edit.bookSave=function(a){edit.itunesHide(a,6)};edit.weblink=function(a){a!=edit.mediaIndex.weblink&&void 0!=a&&(edit.cleanupMediaEdit(),edit.mediaIndex.weblink=a,a=edit.getSelectorHeader("weblink"),edit.setRemove(7),$(a+"a").removeAttr("onclick"),$(a+"input").prop("disabled",!1),app.$editPane.keyup(function(a){27==a.keyCode&&edit.weblinkHide(7)}),edit.isEditing=7)};
edit.weblinkHide=function(){if(!(0>edit.mediaIndex.weblink)){var a=edit.getSelectorHeader("weblink");$(a+"input").prop("disabled",!0).off("keyup");$(a+"a").attr("onclick","edit.weblink("+edit.mediaIndex.weblink+")");edit.weblinkSave(edit.mediaIndex.weblink,7);app.$editPane.off("keyup");animation.hideHiddenIcons();edit.mediaIndex.weblink=-1;edit.isEditing=-1}};
edit.weblinkSave=function(a){var b=localStorage.weblink,c=edit.getSelectorHeader("weblink",a),d=$(c+".title").val(),c=$(c+".desc").val(),b=b?JSON.parse(b):[];b[a]={title:d,url:c};localStorage.weblink=JSON.stringify(b)};
edit.itunes=function(a,b){var c=edit.mediaName(b);if(a!=edit.mediaIndex[c]&&void 0!=a){edit.cleanupMediaEdit();edit.mediaIndex[c]=a;var d=edit.getSelectorHeader(c);edit.setRemove(b);$(d+"a").removeAttr("onclick");$(d+"input").prop("disabled",!1).keyup(function(a){13==a.keyCode&&(a=$(d+".title").val()+"%20"+$(d+".desc").val(),getCoverPhoto(d,a,!0,b))});app.$editPane.keyup(function(a){27==a.keyCode&&edit.itunesHide(b)});edit.isEditing=b}};
edit.itunesHide=function(a){var b=edit.mediaName(a);if(!(0>edit.mediaIndex[b])){var c=edit.getSelectorHeader(b);$(c+"input").prop("disabled",!0).off("keyup");$(c+"a").attr("onclick","edit."+b+"("+edit.mediaIndex[b]+")");edit.itunesSave(edit.mediaIndex[b],a);app.$editPane.off("keyup");animation.hideHiddenIcons();edit.mediaIndex[b]=-1;edit.isEditing=-1}};
edit.itunesSave=function(a,b){var c=edit.mediaName(b),d=localStorage[c],e=edit.getSelectorHeader(c,a),f=$(e+".title").val(),e=$(e+".desc").val(),d=d?JSON.parse(d):[];d[a]={title:f,author:e};localStorage[c]=JSON.stringify(d)};
edit.playableSearch=function(a){getTokenCallback(function(b){edit.getDate(function(c){c=getDataUrlHeader()+"/"+c+":/children?select=id,name,size,@content.downloadUrl&access_token="+b;animation.log(log.EDIT_PANE_PLAYABLE_SEARCH_START,1);$.ajax({type:"GET",url:c}).done(function(b,c,f){b["@odata.nextLink"]&&animation.warn(log.EDIT_PANE_TOO_MANY_RESULTS);b=b.value;switch(a){case 1:c=edit.videos;break;case 3:c=edit.voices;break;default:console.log("edit.playableSearch()\tInvalid call");return}f=0;for(var g=
b.length;f!==g;++f){var h=b[f].id,k=b[f].size,l=b[f].name,m=b[f]["@content.downloadUrl"],p=l.substring(l.length-4).toLowerCase(),h={id:h,name:l,title:l.substring(0,l.length-4),url:m,size:k,resource:!1,change:!0};switch(a){case 1:if(".mp4"!==p)continue;break;case 3:if(".mp3"!==p&&".wav"!==p)continue}for(var p=!0,q=0;q!==c.length;++q)if(c[q].size===k){p=!1;break}if(p)switch(c.push(h),animation.log(edit.mediaName(a).capitalize()+log.EDIT_PANE_PLAYABLE_FILE+l+log.EDIT_PANE_PLAYABLE_FILE_ADDED),a){case 1:edit.addMedia(-1,
{fileName:l,url:m,title:l.substring(0,l.length-4)});break;case 3:edit.addMedia(-3,{fileName:l,url:m,title:l.substring(0,l.length-4)})}}edit.playableSetToggle();animation.log(log.EDIT_PANE_PLAYABLE_SEARCH_END,-1)}).fail(function(b,c,f){animation.error(log.EDIT_PANE_PLAYABLE_SEARCH_FAILED,f,-1);switch(a){case 1:animation.warning("#add-video");break;case 3:animation.warning("#add-voice")}})})})};
edit.playableSetToggle=function(){$("#edit-pane .video, #edit-pane .voice").each(function(){$(this).off("contextmenu");$(this).on("contextmenu",function(){$(this).toggleClass("change");return!1})})};
edit.playableSave=function(a,b){edit.getDate(function(c){var d="/drive/root:/Apps/Journal/resource/"+app.year,e="/drive/root:/Apps/Journal/data/"+app.year+"/"+c,f,g,h=0;switch(a){case 1:f=edit.videos;g=JSON.parse(localStorage.video);break;case 3:f=edit.voices;g=JSON.parse(localStorage.voice);break;default:return}$("#attach-area ."+edit.mediaName(a)).each(function(){for(var a=0;a!==f.length;++a)if($(this).children("a").hasClass(f[a].name)&&(f[a].resource&&$(this).hasClass("resource")||!f[a].resource&&
$(this).hasClass("data"))){f[a].change=$(this).hasClass("change");break}});for(var k=0;k!==g.length;++k)for(var l=0;l!==f.length;++l)if(g[k]&&g[k].fileName===f[l].name){f[l].title=g[k].title;break}for(k=0;k!==f.length;++k)f[k].change&&++h;0===h?($("#attach-area ."+edit.mediaName(a)).each(function(){$(this).hasClass("data")&&$(this).addClass("ignore").empty().fadeOut()}),b()):getTokenCallback(function(l){animation.log(log.EDIT_PANE_PLAYABLE_SAVE_START+edit.mediaName(a)+log.EDIT_PANE_PLAYABLE_SAVE_START_END,
1);for(var k=0;k!==f.length;++k)if(f[k].change){var q=f[k].name,n=f[k].title,t=f[k].id,r=c+((new Date).getTime()+k)+q.substring(q.length-4);f[k].success=!1;if(f[k].resource){for(var u=0;u!==g.length;++u)if(g[u].fileName===q){r=n+q.substring(q.length-4);break}n=e}else n=d;r={name:r,parentReference:{path:n}};t?q="https://api.onedrive.com/v1.0/drive/items/"+t+"?select=id,name,size,@content.downloadUrl&access_token="+l:(n=n===d?e:d,q="https://api.onedrive.com/v1.0"+n+"/"+encodeURI(q)+"?select=name,size,@content.downloadUrl&access_token="+
l);$.ajax({type:"PATCH",url:q,contentType:"application/json",data:JSON.stringify(r)}).done(function(b){--h;for(var c="",d=0;d!==f.length;++d)if(f[d].id===b.id){c=f[d].title;f[d].success=!0;delete journal.archive.map[f[d].name];if(!f[d].resource){var e=b.name;f[d].newName=e;journal.archive.map[e]={id:b.id,size:b.size,url:b["@content.downloadUrl"]}}break}animation.log(edit.mediaName(a).capitalize()+log.EDIT_PANE_PLAYABLE_FILE+c+log.EDIT_PANE_PLAYABLE_FILE_SAVED)}).fail(function(b,c,d){--h;animation.warn(log.EDIT_PANE_TRANSFERRED_FAILED,
d,!1);animation.warning("#add-"+edit.mediaName(a))}).always(function(){if(0>=h){$("#attach-area ."+edit.mediaName(a)).each(function(){$(this).removeClass("change");for(var a=0;a!==f.length;++a)if(!$(this).hasClass("ignore")&&$(this).children("a").hasClass(f[a].name)&&(f[a].resource&&$(this).hasClass("resource")||!f[a].resource&&$(this).hasClass("data"))){f[a].success&&(f[a].success=!1,f[a].resource=!f[a].resource,$(this).hasClass("resource")?$(this).removeClass("resource").addClass("data"):$(this).hasClass("data")&&
$(this).removeClass("data").addClass("resource"),f[a].newName&&(f[a].name=f[a].newName,$(this).children("a").attr("class",f[a].newName),delete f[a].newName));break}$(this).hasClass("data")&&$(this).addClass("ignore").empty().fadeOut()});for(var c=[],d=0;d!==f.length;++d)f[d].change=!1,f[d].resource?c.push({fileName:f[d].newName||f[d].name,title:f[d].title}):(f.splice(d,1),--d);localStorage[edit.mediaName(a)]=JSON.stringify(c);animation.log(log.EDIT_PANE_FINISHED_TRANSFER+edit.mediaName(a)+log.EDIT_PANE_FINISHED_TRANSFER_END,
-1);b()}})}})})};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};window.journal={};journal.archive={};journal.archive.data={};journal.archive.media=0;journal.archive.map={};
window.app=function(){var a=function(a){var b=$("#query");b.keyup(function(a){13==a.keyCode&&(app.command=b.val(),b.effect("highlight",{color:"#dddddd"}),app.addLoadDataWithFilter(app.command))}).bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).autocomplete("instance").menu.active&&a.preventDefault()}).autocomplete({minLength:1,autoFocus:!0,source:function(a,b){for(var c=$("#query").val().split(" "),d=app.preloadedTags.sort(),e=0;e<d.length;++e)for(var f=0;f<c.length;++f)if(d[e]==
c[f]){c.splice(f,1);d.splice(e,1);break}b($.ui.autocomplete.filter(d,a.term.split(/ \s*/).pop()))},focus:function(){return!1},select:function(a,b){var c=this.value.split(/ \s*/);c.pop();c.push(b.item.value);c.push("");this.value=c.join(" ");return!1}})},b=function(){$(document).delegate("#search-result:not(.stats)","mouseover mouseleave",function(a){var b=$("#search-result"),c=$("#total-time");"mouseover"===a.type?(b.hide(),c.text(Math.floor(app.displayedTime/60)+":"+app.displayedTime%60)):(b.hide(),
c.text(app.displayedTime));b.fadeIn(500)})},c=function(){$("#header-info").mouseover(function(){app.readLastUpdated();var a=parseInt(localStorage.expiration),b;if(a){var c=(new Date).getTime();a>c&&(b=archive.list.prototype.date(c-(a-c)))}b=b||"Expired";$("#token-expires-in").html(b)})},d=function(){$.ajaxSetup({timeout:network.timeOut});$(document).ajaxStart(function(){network.isAjaxActive=!0;network.init()});$(document).ajaxStop(function(){network.isAjaxActive=!1;0===network.breakpoint&&network.destroy()})},
e=function(){var a=[];journal.archive.data[app.year]=journal.archive.data[app.year].filter(function(b){if(void 0==b)return app.yearChange[app.year]=!0,!1;var c=b.time,d=(new Date(c.created)).getFullYear(),c=(new Date(c.created)).getFullYear();if(d==app.year||c==app.year)return!0;app.yearQueue[d]||(app.yearQueue[d]=[]);app.yearQueue[d].push(b);app.yearChange[d]=!0;app.yearChange[app.year]=!0;$("#year").addClass("change");$("#last-updated").addClass("change");-1===a.indexOf(d)&&a.push(d);return!1});
return a},f=function(a){animation.indent=0;animation.debug(log.CONTENTS_RELOADED);animation.testAllSubs();console.log("==================Force loaded==================");app.$list.empty();app.lastLoaded=0;app.lastQualified=-1;app.displayedChars=0;app.displayedLines=0;app.displayedNum=0;app.displayedTime=0;app.currentDisplayed=-1;app.command=a;app.highlightWords=[];app.qualifiedEntry=[];$("#query").val(a);$("#total-displayed").text(app.displayedNum);$("#total-char").text(app.displayedChars);$("#total-line").text(app.displayedLines);
$("#total-time").text(app.displayedTime);$("#year").effect("slide",{direction:"up"}).html(app.year);app.yearChange[app.year]?($("#year").addClass("change"),$("#last-updated").addClass("change")):$("#year").removeClass("change");a=0;for(var b=journal.archive.data[app.year].length;a!=b;++a)journal.archive.data[app.year][a].processed=0;calendar.showContent()},g=function(){app.yearQueue[app.year]&&(app.yearChange[app.year]=!0,journal.archive.data[app.year].push.apply(journal.archive.data[app.year],app.yearQueue[app.year]),
edit.sortArchive(),edit.removeDuplicate(),delete app.yearQueue[app.year]);var a=e();if(0<a.length){animation.log(log.DATA_MOVED_TO_OTHER_YEAR+a.join(", ")+log.DATA_MOVED_TO_OTHER_YEAR_END);for(var b=0;b!==a.length;++b)-1===app.years.indexOf(a[b])&&app.years.push(a[b]);app.years.sort()}},h=function(a,b){console.log("app.loadScript(): data.length = "+a.length);var c="",d;for(d=0;d!==a.length&&"["!=a[d];++d)c+=a[d];(c=parseInt(c))&&(app.version[app.year]=c);journal.archive.data[app.year]=app.updateData(JSON.parse(a.substr(d)));
b()},k=function(a){$("#total-entry").text(journal.archive.data[app.year].length);new app.list(a);app.dataLoaded[app.year]=!0};return{resource:"resource/",monthArray:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),weekArray:"Sun Mon Tue Wed Thu Fri Sat".split(" "),year:(new Date).getFullYear(),years:[],yearQueue:{},yearChange:{},lastLoaded:0,currentDisplayed:-1,displayedNum:0,displayedLines:0,displayedChars:0,displayedTime:0,lastQualified:-1,pageLoaded:1,preloadedTags:[],command:"",highlightWords:[],
isFunction:!0,lostMedia:[],entryLoadLimit:10,qualifiedEntry:[],dataLoaded:{},lastUpdated:{},version:{data:2},contentType:{BULB:1},initializeApp:function(){showLoginButton();app.preloadedTags.push("%photo","%video","%music","%voice","%book","%movie","%place","%weblink");for(var e=app.tag().getIconsInName(),f=0;f!=e.length;++f)app.preloadedTags.push("#"+e[f]);a(this);b();c();$("#year").effect("slide",{direction:"up"});app.getYears();d();animation.testCacheIcons();animation.testAllSubs();calendar.initView()},
addLoadDataWithFilter:function(a,b){if(""==b)animation.error(log.LOAD_DATA_FAIL+log.NO_CONTENT),animation.deny("#refresh-media");else{if(void 0==b&&(journal.archive.data[app.year]||(journal.archive.data[app.year]=[]),g(),0===journal.archive.data[app.year].length)){animation.warn(log.LOAD_DATA_FAIL+log.NO_ARCHIVE);animation.deny("#refresh-media");return}var c=$("#search-result");c.hide();app.detail.prototype.hideDetail();animation.testAllSubs();!app.dataLoaded[app.year]&&b&&(animation.debug(log.CONTENTS_NEW+
b.length+log.CONTENTS_NEW_END),console.log("addLoadDataWithFilter(): data.length = "+b.length),h(b,function(){k(a)}),edit.saveDataCache());f(a);k(a);map.show();c.fadeIn(500)}},refresh:function(){app.addLoadDataWithFilter("")},updateData:function(a){app.version[app.year]||(app.version[app.year]=1);if(app.version[app.year]!==app.version.data)switch(animation.debug(log.CONTENTS_UPGRADING),app.version[app.year]){case 1:for(var b=0;b!==a.length;++b){var c=a[b].iconTags;c&&app.tag().getIconsInNameByVal(c).join("|");
delete a[b].icontags;delete a[b].textTags}app.version[app.year]=2}app.version[app.year]>app.version.data&&(app.version[app.year]=app.version.data);return a},getYears:function(){animation.log(log.GET_YEARS_START);getTokenCallback(function(a){$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core:/children?select=name,createdBy&orderby=name&access_token="+a}).done(function(a){a=a.value;app.years=[];for(var b=0;b!==a.length;++b){var c=a[b].name;parseInt(c)==c&&(c=parseInt(c),
app.years.push(c),network.yearFolders.push(c))}app.user=a[0].createdBy.user.displayName;$("#username").html(app.user);-1===app.years.indexOf((new Date).getFullYear())&&app.years.push((new Date).getFullYear());backupAll();animation.testYearButton();animation.log(log.GET_YEARS_END)}).fail(function(a,b,c){animation.error(log.GET_YEARS_FAIL,c);app.getYears()})})},yearUpdateTry:function(a){app.year=a;0===app.years.length&&app.years.push(app.year);journal.archive.data[a]?app.yearUpdate(a):downloadFile(void 0,
!0)},yearUpdate:function(){app.refresh();animation.testYearButton();animation.debug(log.YEAR_SWITCHED_TO+app.year)},prev:function(a){if(network.isAjaxActive)animation.warn(log.NETWORK_WORKING);else{var b=app.years.indexOf(app.year);-1===b?app.yearUpdateTry((new Date).getFullYear()):(a?b=0:--b,app.yearUpdateTry(app.years[b]))}},next:function(a){if(network.isAjaxActive)animation.warn(log.NETWORK_WORKING);else{var b=app.years.indexOf(app.year);-1===b?app.yearUpdateTry((new Date).getFullYear()):(a?b=
app.years.length-1:++b,app.yearUpdateTry(app.years[b]))}},updateLastUpdated:function(a){a=parseInt(a)||(new Date).getTime();app.lastUpdated[app.year]=a;app.year===(new Date).getFullYear()&&(localStorage.lastUpdated=(new Date).getTime());app.readLastUpdated()},readLastUpdated:function(){var a=app.lastUpdated[app.year];a?a=archive.list.prototype.date(a):app.year===(new Date).getFullYear()?localStorage.lastUpdated?(a=parseInt(localStorage.lastUpdated),app.lastUpdated[app.year]=a,a=archive.list.prototype.date(a)):
a="N/A":a="N/A";$("#last-updated").html(a)},isBulbExist:function(a){},addBulb:function(a,b){var c=a.content||a.contentRaw,c={contentType:app.contentType.BULB,time:{created:b},text:{body:c,chars:c.length}};a.location&&(c.place={latitude:a.location.lat,longitude:a.location["long"]},c.place.title=a.location.name||"");a.website&&(c.weblink={url:a.website});a.image&&(c.images=[{fileName:a.image}]);journal.archive.data[app.year].push(c);$("#year").addClass("change");bulb.setIsMerged(b)},finishMergingBulbs:function(){animation.log(log.BULB_FETCH_END+
(bulb.getTotalAvailableBulbs()-bulb.getMergedBulbCounter()));edit.removeDuplicate();edit.sortArchive();app.refresh();bulb.isProcessing=!1;uploadFile(void 0,function(){animation.log(log.BULB_REMOVE_MERGED_START);bulb.removeUploadedBulbs()})}}}();
app.list=function(a){var b=this;journal.total=journal.archive.data[app.year].length;var c=app.$list,d=c.children("ul");this.processQualifiedEntry(a);!this.contents&&1>d.length&&(c.html('<ul></ul><div class="loadmore"></div>'),this.contents=c.children("ul"),this.loadmore=c.children("div.loadmore"),this.loadmore.on("click",function(){b.load()}),this.load(),c.off("scroll").on("scroll",function(){$(this).scrollTop()>b.contents.height()-c.height()&&0!=$(".loadmore").length&&b.load()}))};
app.list.prototype={queryCache:{},load:function(){var a=journal.archive.data[app.year],b=app.lastLoaded,c=app.lastQualified;app.lastLoaded>=journal.archive.data[app.year].length&&(b=app.lastLoaded=journal.archive.data[app.year].length-1);a[b].index=b;for(var d=0;d<app.entryLoadLimit&&b<journal.total;++d,++b){if(app.qualifiedEntry[d]){if(this.html(journal.archive.data[app.year][b]),c=b,++app.displayedNum,app.displayedChars+=a[b].text.chars||0,app.displayedLines+=a[b].text.lines||0,a[b].time.end){var e=
parseInt((a[b].time.end-a[b].time.start)/6E4);isNaN(e)||(app.displayedTime+=e)}}else this.htmlEmpty();app.$list.get(0).scrollHeight==app.$list.height()&&(d=0)}--b;$("#search-result").hide().fadeIn(500);$("#total-displayed").text(app.displayedNum);$("#total-char").text(app.displayedChars);$("#total-line").text(app.displayedLines);$("#total-time").text(app.displayedTime);++b>=journal.total&&($(".loadmore").remove(),app.$list.append('<li><p class="separator"><span>EOF</span></p></li>'));app.lastQualified=
c;app.lastLoaded=b},processQualifiedEntry:function(a){var b=this;a=this.processFilter(a);app.qualifiedEntry=[];_.each(journal.archive.data[app.year],function(c,d){app.qualifiedEntry.push(b.qualify(c,a))})},processFilter:function(a){if(!a)return[];for(;-1!=a.search("  ");)a=a.replace("  "," ");var b=[];a=a.toLowerCase().split(" ");for(var c=0,d=a.length;c<d;++c){for(var e=a[c].split("|"),f={tags:[],attachments:[],keywords:[]},g=0,h=e.length;g<h;++g){var k=e[g];"#"===k[0]?f.tags.push(k.substr(1)):"%"===
k[0]?f.attachments.push(k.substr(1)):"@"===k[0]?f.timeRange=k.substr(1):(f.keywords.push(k),app.highlightWords.push(k))}b.push(f)}return b},qualify:function(a,b){for(var c=function(a,b){for(var c=0;c<a.length;++c)if(-1!==b.indexOf(a[c]))return!0;return!1},d=(a.tags||"").split("|"),e=app.tag().content(a.attachments||0),f=a.time.created,g=0;g<b.length;++g){var h=b[g];if(!(this.isInRange(h.timeRange||"",f)||c(d,h.tags)||c(e,h.attachments))){for(var k=0;k<h.keywords.length&&!(a.title&&a.title.match(new RegExp(h.keywords[k],
"i"))||a.text.body.match(new RegExp(h.keywords[k],"i")));++k);if(k===h.keywords.length)return!1}}return!0},date:function(a,b){var c=new Date(a),d=c.getHours(),e=c.getMinutes(),e=10>e?"0"+e:e,d=10>d?"0"+d:d;if(b)return d+":"+e;var f=c.getFullYear(),g=new Date,h=g.getFullYear(),k=c.getMonth(),l=c.getDate();if(f===h)if(h=new Date(f,0,1),f=Math.floor((c-h)/864E5),g=Math.floor((g-h)/864E5),f===g)g="Today";else if(f+1===g)g="Yesterday";else switch(h=h.getDay(),f=Math.floor((f-h)/7),h=Math.floor((g-h)/7),
g="",h-f){case 1:g="Last ";case 0:g+=app.weekArray[c.getDay()];break;default:g=app.monthArray[k]+" "+l}else g=app.monthArray[k]+" "+l;return g+" "+d+":"+e},html:function(a,b){a.summary=a.text.ext||a.text.body.substr(0,50);a.isBulb=0;if(a.contentType)a.contentType===app.contentType.BULB&&(a.ext="",a.isBulb=1);else{switch(!b&&a.attachments&1?1:a.coverType){default:a.type="text";a.ext="";break;case 1:a.type="photo";a.ext=this.thumb(a,"images");break;case 2:a.type="video";a.ext=this.thumb(a,"video");
break;case 3:a.type="music";a.ext=this.thumb(a,"music");break;case 4:a.type="voice";a.ext=this.thumb("dummy");break;case 5:a.type="book";a.ext=this.thumb(a,"book");break;case 6:a.type="movie";a.ext=this.thumb(a,"movie");break;case 7:a.type="place";a.ext=this.thumb("dummy");break;case 8:a.type="weblink",a.ext=this.thumb(a,"weblink")}a.attached=this.attached(a.attachments)}var c=a.time.start||a.time.created;a.datetime=this.date(c);a.endtime="";a.time.end&&(a.datetime+=" - "+this.date(a.time.end,1));
var d=$(app.itemView(a));d.find(" > a").click(function(a){a.preventDefault();a=$(this);app.$list.find(".display").removeClass("display");a.addClass("display");a=$(this).parent();if(a.hasClass("bulb")){var b=map.getMarker(c);if(b)return app.$detail.hide(),app.currentDisplayed=a.index(),google.maps.event.trigger(b,"mouseover"),!1}animation.showMenuOnly("edit");app.photos&&app.photos.remove();app.currentDisplayed!==a.index()&&(app.currentDisplayed=a.index(),app.$detail.hide().fadeIn(500),app.view=new app.detail);
return!1});d=d.addClass(a.type).hide();this.contents.append(d.fadeIn(500))},htmlEmpty:function(){return $("#list ul").append("<li></li>")},thumb:function(a,b){var c=a[b],d;if(c&&0<c.length){c=c[0];d="";if(!c.fileName)return'<div class="dummy"></div>';if("images"!=b&&"video"!=b)if(c.thumb)c=c.thumb;else return'<div class="dummy"></div>';var e=app.util.crop(1024,720,80),e=app.util.style(e),f;if("images"==b&&(journal.archive.map[c.fileName]&&(f=journal.archive.map[c.fileName].url),void 0==f)||"video"==
b&&(journal.archive.map[c.fileName+"_thumb.jpg"]&&(f=journal.archive.map[c.fileName+"_thumb.jpg"].url),void 0==f))return'<div class="dummy"></div>';e&&(e=' style="'+e+'"');e='<img src="'+f+'"'+e+">";Modernizr.canvas&&(e="<canvas style=\"background-image: url('"+f+"')\"></canvas>");1<c.urlType&&"weblink"==b&&(d='<span class="weblink-video"></span>');"video"==b&&(d='<span class="video-play"></span>');d='<div class="thumb">'+e+""+d+"</div>"}return d||'<div class="dummy"></div>'},attached:function(a){var b=
[];a=app.tag().content(a);for(var c=0,d=a.length;c<d;++c)b.push('<span class="'+a[c]+'"></span>');return b.join("")},isInRange:function(a,b){var c=this.queryCache[a];if(!c){var c=[0,0],d=a.split(":");1==d.length?c=this.getTimeRange(d[0]):(c[0]=this.getTimeRange(d[0])[0],c[1]=this.getTimeRange(d[1])[1]);this.queryCache[a]=c}return b>=c[0]&&b<=c[1]},getTimeRange:function(a){var b=[0,0];if(4==a.length){var c=parseInt(a.substr(0,2));a=parseInt(a.substr(2))+2E3;isNaN(c)||isNaN(a)||(b[0]=(new Date(a,c-
1)).getTime(),b[1]=(new Date(a,c)).getTime()-1)}else if(6==a.length){var c=parseInt(a.substr(0,2)),d=parseInt(a.substr(2,2));a=parseInt(a.substr(4))+2E3;isNaN(a)||isNaN(c)||isNaN(d)||(b[0]=(new Date(a,c-1,d)).getTime(),b[1]=b[0]+86399999)}return b},isInSameMonth:function(a,b){var c=(new Date(a)).getMonth();return 0===b?app.monthArray[c]:(new Date(b)).getMonth()===c?-1:app.monthArray[c]}};
app.detail=function(){var a=journal.archive.data[app.year][app.currentDisplayed],b=this.text(a.text.body);if(app.highlightWords)for(var c=0;c<app.highlightWords.length;++c)b=b.replace(new RegExp(app.highlightWords[c],"g"),"<span class='highlight'>"+app.highlightWords[c]+"</span>");a.contents=b;a.chars=a.text.chars+" Chars";if(!a.processed){if(a.contentType===app.contentType.BULB)a.title="",a.weblink=a.weblink||void 0,a.place=a.place||void 0;else{a.lines=a.text.lines+" Lines";a.weblink&&this.thumb(a,
"weblink",50,50);if(a.book)for(this.thumb(a,"book",50,70),c=0;c!==a.book.length;++c)getCoverPhoto("#detail .book:eq("+c+") ",a.book[c].author+" "+a.book[c].title,!1,"book");if(a.music)for(this.thumb(a,"music",50,50),c=0;c!==a.music.length;++c)getCoverPhoto("#detail .music:eq("+c+") ",a.music[c].author+" "+a.music[c].title);if(a.movie)for(this.thumb(a,"movie",50,70),c=0;c!==a.movie.length;++c)getCoverPhoto("#detail .movie:eq("+c+") ",a.movie[c].author+" "+a.movie[c].title,!1,"movie");a.tags?(c=app.tag().separate(a.tags),
a.iconTags=c.iconTags||[],a.textTags=c.textTags||[]):(a.iconTags=[],a.textTags=[]);for(var b="video weblink book music movie images voice place textTags iconTags".split(" "),c=0,d=b.length;c<d;++c)void 0==a[b[c]]&&(a[b[c]]=void 0)}a.processed=1}c=$(app.detailView(a));app.$detail.css("display","inline-block").html(c);app.$app.addClass("detail-view");$(".content.loading").removeClass("loading");a.images?$("#menu-show-images").removeClass("hidden"):$("#menu-show-images").addClass("hidden");$(".icontags > span").on("click",
function(){var a=app.tag().getNameByHtml(this.className);""!=a&&addLoadDataWithFilter("#"+a)});$(".lower .video a").each(function(a){app.videoPlayer.quit();a=$(this).attr("class");journal.archive.map[a]?(a='app.videoPlayer("#app #video-preview","'+journal.archive.map[a].url+'")',$(this).attr("onclick",a).removeAttr("class")):animation.error(log.FILE_NOT_LOADED+a+log.DOWNLOAD_PROMPT)});$(".lower .voice a").each(function(a){app.audioPlayer.quit();var b=$(this).attr("class");journal.archive.map[b]?(a=
'app.audioPlayer("#detail .content .voice:eq('+a+') a","'+journal.archive.map[b].url+'")',$(this).attr("onclick",a).removeAttr("class")):animation.error(log.FILE_NOT_LOADED+b+log.DOWNLOAD_PROMPT)});$("#edit-this, #delete").removeClass("hidden");animation.testAllSubs();return a};
app.detail.prototype={text:function(a){a=this.htmlSpacialChars(a);a=a.replace(/\t\t[*]\t[*]\t[*]/g,"<hr>");a=a.replace(/\r\n/g,"\n");a=a.replace(/\n\t\t/g,'</p><p class="t2">');a=a.replace(/\n\t/g,'</p><p class="t1">');a=a.replace(/\n\n/ig,"</p></br><p>");a=a.replace(/\n/ig,"</p><p>");return"<p>"+a+"</p>"},htmlSpacialChars:function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},thumb:function(a,b,c,d){if((a=a[b])&&0<a.length){a=
a[0];if(!a)return!1;c=app.util.crop(1024,720,c,d);c=app.util.style(c);d=app.resource+a.thumb;d.match(/.(jpg|png)$/)||(d+=".jpg");c&&(c=' style="'+c+'"');void 0!==a.thumb&&(a.thumb='<img src="'+d+'"'+c+">")}},hideDetail:function(){$("#edit-this, #delete").addClass("hidden");animation.testAllSubs();app.$detail.css("display","none").empty();app.$app.removeClass("detail-view");app.photos&&app.photos.remove()}};
app.layout=function(){var a=$(window),b=function(){var b=a.height()-110;app.$app.height(b);app.contents.height(b)};app.$app.css("width","");b();a.off("resize").on("resize",b)};
app.util={fit:function(a,b,c,d){var e=c<a?c:a,f=d<b?d:b,g=Math.ceil(a/b*f),h=Math.ceil(e/(a/b)),k={};a>b?d>h?(k.width=e,k.height=h):(k.width=g,k.height=f):c>g?(k.width=g,k.height=f):(k.width=e,k.height=h);return k},crop:function(a,b,c,d){d=d||c;var e=Math.ceil(a/b*d),f=Math.ceil(c/(a/b)),g={};a>b?d>f?(g.width=e,g.height=d,g.marginLeft=-((e-c)/2)):(g.width=c,g.height=f,g.marginTop=-((f-d)/2)):a<b&&(c>e?(g.width=c,g.height=f,g.marginTop=-((f-d)/2)):(g.width=e,g.height=d,g.marginLeft=-((e-c)/2)));return g},
style:function(a){var b=[];for(i in a)a.hasOwnProperty(i)&&b.push(i.replace(/([A-Z])/,"-$1").toLowerCase()+":"+("number"==typeof a[i]?a[i]+"px":a[i]));return b.join(";")},runTime:function(a){if(a&&0<a){a/=1E3;var b="0";60<=a&&(b=a/60,a-=60*b);a=10<=a?Math.ceil(a):"0"+Math.ceil(a);return b+":"+a}}};
app.tag=function(){var a=[{name:"clear",value:1,html:"w01"},{name:"overcast",value:2,html:"w02"},{name:"raining",value:4,html:"w03"},{name:"snowing",value:8,html:"w04"},{name:"thundering",value:16,html:"w05"},{name:"windy",value:32,html:"w06"},{name:"happy",value:1024,html:"e01"},{name:"notbad",value:2048,html:"e02"},{name:"surprised",value:4096,html:"e03"},{name:"sad",value:8192,html:"e04"},{name:"angry",value:16384,html:"e05"},{name:"journal",value:32768,html:"c01"},{name:"thoughts",value:65536,
html:"c02"},{name:"ingress",value:131072,html:"c03"},{name:"minecraft",value:262144,html:"c04"},{name:"dream",value:524288,html:"c05"},{name:"code",value:1048576,html:"c06"},{name:"letter",value:2097152,html:"c07"},{name:"handwriting",value:4194304,html:"c08"},{name:"wechat",value:8388608,html:"c09"},{name:"friendship",value:16777216,html:"c10"},{name:"snooker",value:-1,html:"c11"},{name:"skateboard",value:-1,html:"c12"},{name:"relationship",value:33554432,html:"s01"},{name:"star",value:67108864,
html:"s02"},{name:"food",value:134217728,html:"s03"},{name:"leisure",value:268435456,html:"s04"},{name:"info",value:536870912,html:"s05"},{name:"baby",value:1073741824,html:"s06"},{name:"fun",value:2147483648,html:"s07"},{name:"travel",value:4294967296,html:"s08"},{name:"health",value:8589934592,html:"s09"},{name:"outfit",value:17179869184,html:"s10"},{name:"shopping",value:34359738368,html:"s11"},{name:"pets",value:68719476736,html:"s12"},{name:"work",value:137438953472,html:"s13"},{name:"sports",
value:274877906944,html:"s14"},{name:"cook",value:549755813888,html:"s15"},{name:"makeup",value:1099511627776,html:"s16"},{name:"home",value:2199023255552,html:"s17"},{name:"car",value:4398046511104,html:"s18"}];return{content:function(a){var c=[];this.is(a,1)&&c.push("photo");this.is(a,2)&&c.push("video");this.is(a,4)&&c.push("music");this.is(a,8)&&c.push("voice");this.is(a,16)&&c.push("book");this.is(a,32)&&c.push("movie");this.is(a,64)&&c.push("place");this.is(a,128)&&c.push("weblink");return c},
getIconsInHtmlByVal:function(b){for(var c=[],d=0;d!==a.length;++d)this.is(b,a[d].value)&&c.push(a[d].html);return c},getIconsInNameByVal:function(b){for(var c=[],d=0;d!==a.length;++d)this.is(b,a[d].value)&&c.push(a[d].name);return c},getValueByName:function(a){return this.translate(a.toLowerCase(),"name","value")},getValueByHtml:function(a){return this.translate(a.toLowerCase(),"html","value")},getHtmlByName:function(a){return this.translate(a.toLowerCase(),"name","html")},getNameByHtml:function(a){return this.translate(a.toLowerCase(),
"html","name")},getIconsInHtml:function(){return this.getAll("html")},getIconsInName:function(){return this.getAll("name")},getAll:function(b){for(var c=[],d=0;d!==a.length;++d)a[d][b]&&c.push(a[d][b]);return c},translate:function(b,c,d){for(var e=0;e!==a.length;++e)if(a[e][c]&&a[e][d]&&a[e][c]==b)return a[e][d];return""},separate:function(b){for(;-1!==b.indexOf("||");)b=b.replace(/||/g,"|");for(;b.length&&"|"==b[0];)b=b.substr(1);for(;b.length&&"|"==b[b.length-1];)b=b.substr(0,b.length-1);var c=
[];b=b.split("|");for(var d=0;d!==a.length;++d){var e=b.indexOf(a[d].name);-1<e&&(c.push(a[d].html),b.splice(e,1))}return{iconTags:c,textTags:b}},or:function(a,c){var d=this.get(a).split("");d[this.get(c).indexOf("1")]="1";return parseInt(d.join(""),2)},andnot:function(a,c){var d=this.get(a).split("");d[this.get(c).indexOf("1")]="0";return parseInt(d.join(""),2)},is:function(a,c){return"1"==this.get(a).charAt(this.get(c).indexOf("1"))},get:function(a){return this.substr("000000000000000000000000000000000000000000000000000000000000000"+
a.toString(2))},substr:function(a){return a.substr(a.length-64)}}};
app.showEntryImages=function(){var a=journal.archive.data[app.year][app.currentDisplayed];if(a.images)for(var b=0;b!=a.images.length;++b){var c=a.images[b].fileName;journal.archive.map[c]?$(".upper").append('<a href="'+journal.archive.map[c].url+'"><span></span><img src="'+journal.archive.map[c].url+'"></a>'):animation.error(log.FILE_NOT_LOADED+c+log.DOWNLOAD_PROMPT)}$("#menu-show-images").addClass("hidden");$(".upper").addClass("expand").mousewheel(function(a,b){this.scrollLeft-=50*b;a.preventDefault()});
a=$(".upper > a",app.$detail);0<a.length&&(app.photos=new app.PhotoViewer(a.find(" > img").clone()),a.on("click",function(a){a.preventDefault();a=$(this).index();app.photos.open(a);return!1}))};app.PhotoViewer=function(a,b){if(!a&&"object"!=typeof a)return!1;this.list=a;this.callback=b||function(){};this.make();this.init()};
app.PhotoViewer.prototype={make:function(){var a=this.list;if(1<a.length)var b=$("<ul>");var c=$('<ul class="swipe-wrap">');a.each(function(a){$("<li>").html(this).appendTo(c);b&&$("<li>").html('<a href="#'+a+'">'+a+"</a>").appendTo(b)});var d=$('<div class="wrap swipe">').html(c),e=$('<div class="control">');e.append('<input type="button" value="Close" class="btn-close"/>');b&&b.css("width",17*a.length).wrap('<div class="pagination"/>').parent().appendTo(e);d.append(e);d.append('<div class="background"></div>');
$('<div id="photoviewer">').html(d).appendTo("body")},init:function(){this.viewer=$("body > div#photoviewer")},bind:function(){function a(a){a=$(window);var c=a.width(),d=a.height();e.each(function(){var a=$(this),e=b.fit(a.context.naturalWidth||a.context.width,a.context.naturalHeight||a.context.height,c,d);a.css(e)})}if(this._bind)return this.swipe.setup(),!1;var b=this,c=this.viewer=$("body > div#photoviewer");this.pagination=$("div.pagination>ul>li",this.viewer);var d=c.find(" > div.swipe");this.swipe=
new Swipe(d[0],{continuous:!1,callback:b.callback,transitionEnd:function(a){b.paging(a)}});$("input.btn-close",c).on("click",function(){b.close()});var e=d.find(" > ul > li > img");a();$(window).on("resize",a);var f=$("div.control",c);e.on("click",function(){f.fadeToggle(200)});d.find(" > ul > li").on("click",function(a){this==a.toElement&&b.close()});this._bind=1},fit:function(a,b,c,d){a=app.util.fit(a,b,c,d);$.browser.msie?(a.marginLeft=-(a.width/2),a.marginTop=-(a.height/2)):(a.marginLeft=-(a.width/
2+10),a.marginTop=-(a.height/2+10));return a},open:function(a){a=a||0;var b=this,c=this.viewer;c.css({display:"block",opacity:0});this.bind();this.go(a);this.paging(a);c.css({opacity:1},200);$(window).on("keyup.photoviewer",function(a){27==a.keyCode?b.close():37==a.keyCode?b.prev():39==a.keyCode&&b.next()})},close:function(){this.viewer.fadeOut(200);$(window).off("keyup.photoviewer")},prev:function(){this.swipe.prev()},next:function(){this.swipe.next()},go:function(a){this.swipe.slide(a||0,1)},paging:function(a){this.pagination.filter(".active").removeClass("active");
this.pagination.eq(a).addClass("active")},remove:function(){this.viewer.remove()}};
app.audioPlayer=function(a,b){if(app.isFunction){app.isFunction=!1;animation.log(log.AUDIO_DOWNLOAD_START,1);$("#play-media").html("&#xf04b").removeClass("play").attr("onclick","app.audioPlayer.play()");$("#stop-media").attr("onclick","app.audioPlayer.quit()");$('<div id="audioplayer"><audio id="music" preload="true"><source src="'+b+'"></audio><div id="music-position">00:00</div><div id="timeline"><div id="playhead"></div></div><div id="music-length">--:--</div></div>').appendTo(a);$(a+" p").css("padding-top",
"3px");app.audioPlayer.music=document.getElementById("music");app.audioPlayer.playhead=document.getElementById("playhead");app.audioPlayer.timeline=document.getElementById("timeline");var c,d=timeline.offsetWidth-playhead.offsetWidth;app.audioPlayer.formatTime=function(a){var b=parseInt(a/60);a=parseInt(a%60);return(10>b?"0"+b:b)+":"+(10>a?"0"+a:a)};app.audioPlayer.timeUpdate=function(){playhead.style.marginLeft=music.currentTime/c*d+"px";music.currentTime===c?$("#play-media").html("&#xf04b").removeClass("play"):
$("#music-position").html(app.audioPlayer.formatTime(music.currentTime))};app.audioPlayer.moveplayHead=function(a){a=a.pageX-timeline.getBoundingClientRect().left;0<=a&&a<=d&&(playhead.style.marginLeft=a+"px");0>a&&(playhead.style.marginLeft="0px");a>d&&(playhead.style.marginLeft=d+"px")};app.audioPlayer.click=function(a){app.audioPlayer.moveplayHead(a);a=(a.pageX-timeline.getBoundingClientRect().left)/d;music.currentTime=c*a};app.audioPlayer.mouseDown=function(){app.audioPlayer.onplayhead=!0;window.addEventListener("mousemove",
app.audioPlayer.moveplayHead,!0);music.removeEventListener("timeupdate",app.audioPlayer.timeUpdate,!1)};app.audioPlayer.mouseUp=function(a){app.audioPlayer.onplayhead&&(app.audioPlayer.moveplayHead(a),window.removeEventListener("mousemove",app.audioPlayer.moveplayHead,!0),a=(a.pageX-timeline.getBoundingClientRect().left)/d,music.currentTime=c*a,music.addEventListener("timeupdate",app.audioPlayer.timeUpdate,!1));app.audioPlayer.onplayhead=!1};app.audioPlayer.loadedData=function(){animation.log(AUDIO_DOWNLOAD_END,
-1);$("#music-length").html(app.audioPlayer.formatTime(music.duration));$("#toggle-media").addClass("hidden");animation.showMenu("media")};app.audioPlayer.music.addEventListener("canplaythrough",function(){c=app.audioPlayer.music.duration},!1);app.audioPlayer.music.addEventListener("timeupdate",app.audioPlayer.timeUpdate,!1);app.audioPlayer.music.addEventListener("loadedmetadata",app.audioPlayer.loadedData);app.audioPlayer.timeline.addEventListener("click",app.audioPlayer.click,!1);app.audioPlayer.playhead.addEventListener("mousedown",
app.audioPlayer.mouseDown,!1);window.addEventListener("mouseup",app.audioPlayer.mouseUp,!1)}else animation.warn(log.MEDIA_ALREADY_DISPLAYED)};app.audioPlayer.play=function(){if($("#play-media").hasClass("play"))music.pause(),$("#play-media").html("&#xf04b").removeClass("play");else{if(isNaN(music.duration))return animation.error(log.AUDIO_EXPIRED),!1;music.play();$("#play-media").html("&#xf04c").addClass("play")}};
app.audioPlayer.quit=function(){$("#play-media").html("&#xf04b").removeClass("play");$("#audioplayer").fadeOut(400,function(){$(this).remove()});$("#detail .content .voice p").css("padding-top","");app.isFunction=!0;app.audioPlayer.music&&(app.audioPlayer.music.removeEventListener("timeupdate",app.audioPlayer.timeUpdate),app.audioPlayer.music.removeEventListener("loadedmetadata",app.audioPlayer.loadedData));app.audioPlayer.timeline&&app.audioPlayer.timeline.removeEventListener("click",app.audioPlayer.click);
app.audioPlayer.playhead&&app.audioPlayer.playhead.removeEventListener("mousedown",app.audioPlayer.mouseDown);window.removeEventListener("mouseup",app.audioPlayer.mouseUp);animation.hideMenu("media")};
app.videoPlayer=function(a,b){if(app.isFunction){app.isFunction=!1;animation.log(log.VIDEO_DOWNLOAD_START,1);$(a).fadeIn();$("#play-media").html("&#xf04b").removeClass("play").attr("onclick","app.videoPlayer.play()");$("#stop-media").attr("onclick","app.videoPlayer.quit()");$('<div id="videoplayer"><video id="video" preload="true"><source src="'+b+'"></video><div id="video-position">00:00</div><div id="timeline"><div id="playhead"></div></div><div id="video-length">--:--</div></div>').appendTo(a);
app.videoPlayer.video=document.getElementById("video");app.videoPlayer.playhead=document.getElementById("playhead");app.videoPlayer.timeline=document.getElementById("timeline");var c,d;app.videoPlayer.formatTime=function(a){var b=parseInt(a/60);a=parseInt(a%60);return(10>b?"0"+b:b)+":"+(10>a?"0"+a:a)};app.videoPlayer.timeUpdate=function(){playhead.style.marginLeft=video.currentTime/c*d+"px";video.currentTime===c?$("#play-media").html("&#xf04b").removeClass("play"):$("#video-position").html(app.videoPlayer.formatTime(video.currentTime))};
app.videoPlayer.moveplayHead=function(a){a=a.pageX-timeline.getBoundingClientRect().left;0<=a&&a<=d&&(playhead.style.marginLeft=a+"px");0>a&&(playhead.style.marginLeft="0px");a>d&&(playhead.style.marginLeft=d+"px")};app.videoPlayer.click=function(a){app.videoPlayer.moveplayHead(a);a=(a.pageX-timeline.getBoundingClientRect().left)/d;video.currentTime=c*a};app.videoPlayer.mouseDown=function(){app.videoPlayer.onplayhead=!0;window.addEventListener("mousemove",app.videoPlayer.moveplayHead,!0);video.removeEventListener("timeupdate",
app.videoPlayer.timeUpdate,!1)};app.videoPlayer.mouseUp=function(a){app.videoPlayer.onplayhead&&(app.videoPlayer.moveplayHead(a),window.removeEventListener("mousemove",app.videoPlayer.moveplayHead,!0),a=(a.pageX-timeline.getBoundingClientRect().left)/d,video.currentTime=c*a,video.addEventListener("timeupdate",app.videoPlayer.timeUpdate,!1));app.videoPlayer.onplayhead=!1};app.videoPlayer.loadedData=function(){animation.log(log.VIDEO_DOWNLOAD_END,-1);void 0!=app.videoPlayer.height?$("#videoplayer").css("height",
app.videoPlayer.height):$("#videoplayer").css("height","450px");$("#video-length").html(app.videoPlayer.formatTime(video.duration));$("#toggle-media").removeClass("hidden");animation.showMenu("media");$("#video-position, #video-length, #timeline").fadeIn().css("display","inline-block");d=timeline.offsetWidth-playhead.offsetWidth;this.toggle&&(this.toggle.isFullScreen=!1,this.toggle.windowSelector=void 0);$("#toggle-media").html("&#xf065")};app.videoPlayer.video.addEventListener("canplaythrough",function(){c=
app.videoPlayer.video.duration},!1);app.videoPlayer.video.addEventListener("timeupdate",app.videoPlayer.timeUpdate,!1);app.videoPlayer.video.addEventListener("loadedmetadata",app.videoPlayer.loadedData);app.videoPlayer.timeline.addEventListener("click",app.videoPlayer.click,!1);app.videoPlayer.playhead.addEventListener("mousedown",app.videoPlayer.mouseDown,!1);window.addEventListener("mouseup",app.videoPlayer.mouseUp,!1)}else animation.warn(log.MEDIA_ALREADY_DISPLAYED)};
app.videoPlayer.toggle=function(){this.toggle.isFullScreen?(this.toggle.windowSelector?($("#video-fullscreen").fadeOut(),$(this.toggle.windowSelector).append($("#videoplayer").css("height","450px")),$("#toggle-media").html("&#xf065")):animation.error("Program error: no app.videoPlayer.toggle.windowSelector"),this.toggle.isFullScreen=!1):(this.toggle.windowSelector=$("#videoplayer").parent(),$("#video-fullscreen").fadeIn().append($("#videoplayer").css("height","-webkit-calc(100% - 25px)")),$("#toggle-media").html("&#xf066"),
this.toggle.isFullScreen=!0)};app.videoPlayer.play=function(){if($("#play-media").hasClass("play"))video.pause(),$("#play-media").html("&#xf04b").removeClass("play");else{if(isNaN(video.duration))return animation.error(log.VIDEO_EXPIRED),!1;video.play();$("#play-media").html("&#xf04c").addClass("play")}};
app.videoPlayer.quit=function(){$("#play-media").html("&#xf04b").removeClass("play");$("#videoplayer").fadeOut(400,function(){$(this).remove()});app.isFunction=!0;app.videoPlayer.video&&(app.videoPlayer.video.removeEventListener("timeupdate",app.videoPlayer.timeUpdate),app.videoPlayer.video.removeEventListener("loadedmetadata",app.videoPlayer.loadedData));app.videoPlayer.timeline&&app.videoPlayer.timeline.removeEventListener("click",app.videoPlayer.click);app.videoPlayer.playhead&&app.videoPlayer.playhead.removeEventListener("mousedown",
app.videoPlayer.mouseDown);window.removeEventListener("mouseup",app.videoPlayer.mouseUp);animation.hideMenu("media");$("#toggle-media").html("&#xf065");$("#video-fullscreen").fadeOut();this.toggle.isFullScreen=!1;this.toggle.windowSelector=void 0};
app.checkResource=function(){if(0===Object.keys(journal.archive.map).length)animation.error(log.MEDIA_CLEAN_NOT_FOUND+log.DOWNLOAD_PROMPT);else{for(var a=Object.keys(journal.archive.map),b=["images","video","voice"],c=0,d=0,e=journal.archive.data[app.year].length;d!==e;++d)for(var f=journal.archive.data[app.year][d],g=0;g!==b.length;++g)if(f[b[g]])for(var h=0;h<f[b[g]].length;++h){var k=a.indexOf(f[b[g]][h].fileName);-1===k?(++c,f[b[g]].splice(h,1),--h):a.splice(k,1)}app.lostMedia=[];for(d=0;d!==
a.length;++d)app.lostMedia.push(a[d]);0===app.lostMedia.length?animation.log(log.MEDIA_CLEAN_NOT_FOUND):animation.log(app.lostMedia.length+log.MEDIA_CLEAN_FOUND);0===c?animation.log(log.MEDIA_CLEAN_UNDEFINED_NOT_FOUND):(animation.log(c+log.MEDIA_CLEAN_UNDEFINED_FOUND),app.refresh());animation.showIcon("#return-lost-media")}};
app.cleanResource=function(){0===app.lostMedia.length?animation.error(log.MEDIA_CLEAN_NO_DATA):(animation.log(log.MEDIA_CLEAN_START),getTokenCallback(function(a){$.ajax({type:"GET",url:getDataUrlHeader()+":/children?select=name&top=500&access_token="+a}).done(function(b){var c=b.value;b=[];for(var d=0,e=c.length;d!==e;++d)b.push(c[d].name);for(var f=0,g=0,d=0;d!==lostMedia.length;++d)c=lostMedia[d].substring(0,6),c=-1===b.indexOf(c)?"queue":"data/"+c,c="/drive/root:/Apps/Journal/"+c,c={parentReference:{path:c}},
e=(e=journal.archive.map[lostMedia[d]].id)?"https://api.onedrive.com/v1.0/drive/items/"+e+"?select=id,@content.downloadUrl&access_token="+a:getResourceUrlHeader(!0)+"/"+encodeURI(lostMedia[d])+"/?select=id,@content.downloadUrl&access_token="+a,$.ajax({type:"PATCH",url:e,contentType:"application/json",data:JSON.stringify(c)}).done(function(){}).fail(function(){++g}).always(function(){++f===app.lostMedia.length&&(0<g?animation.log(g+log.MEDIA_CLEAN_FAIL):animation.log(log.MEDIA_CLEAN_SUCCESS),app.lostMedia=
[])})}).fail(function(a,c,d){animation.error(log.MEDIA_CLEAN_GET_FOLDERS_FAIL,d,-1)})}))};
$(document).ready(function(){app.$app=$("#app");app.contents=app.$app.find(" > #contents");app.$list=$("#list");app.$detail=$("#detail");app.$editPane=$("#edit-pane");app.$ruler=$("#ruler");app.itemView=_.template($("#list-view").html());app.detailView=_.template($("#detail-view").html());app.bulbView=_.template($("#bulb-view").html());calendar.viewTemplate=_.template($("#calendar-view").html());app.layout();app.initializeApp();archive.itemView=_.template($("#archive-view").html());archive.detailView=
_.template($("#archive-detail-view").html())});window.archive={};archive.data=[];archive.displayId="";archive.isDisplayed=!1;archive.lastLoaded=0;archive.currentDisplayed=-1;archive.confirmName="";
archive.init=function(a){$(a).addClass("spinr");archive.contents=void 0;archive.data=[];archive.confirmName="";getTokenCallback(function(b){animation.log(log.ARCHIVE_START,1);$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:/core/"+app.year+":/children?select=id,name,size,createdDateTime,lastModifiedDateTime,@content.downloadUrl&top=500&orderby=lastModifiedDateTime%20desc&access_token="+b}).done(function(a,b,e){a["@odata.nextLink"]&&animation.warn(log.ARCHIVE_TOO_MANY);
animation.log(log.ARCHIVE_END,-1);a=a.value;b=0;for(e=a.length;b!==e;++b){var f=a[b].name;if(("data"===f.substring(0,4)||"_data"===f.substring(0,5))&&".js"===f.substring(f.length-3)&&"data.js"!==f){var g={name:f,id:a[b].id,url:a[b]["@content.downloadUrl"],size:a[b].size,created:Date.parse(a[b].createdDateTime),modified:Date.parse(a[b].lastModifiedDateTime),selected:!1,processed:!1,protect:!1};"_"===f.substring(0,1)&&(g.protect=!0);archive.data.push(g)}}app.audioPlayer.quit();app.$list.empty();app.$detail.empty();
archive.isDisplayed=!0;archive.lastLoaded=0;animation.showMenuOnly("archive");$("#search-new, #search-result").fadeOut();archive.load()}).fail(function(a,b,e){animation.error(log.FILES_NOT_FOUND,e,-1)}).always(function(){$(a).removeClass("spinr")})})};
archive.load=function(){$("#search-result").hide();archive.detail.prototype.hideDetail();app.$list.empty();archive.lastLoaded=0;archive.currentDisplayed=-1;for(var a=0,b=archive.data.length;a!==b;++a)archive.data[a].processed=!1;new archive.list;archive.dataLoaded=!0};
archive.list=function(){var a=this,b=app.$list,c=b.children("ul");!this.contents&&1>c.length&&(b.html('<ul></ul><div class="loadmore"></div>'),this.contents=b.children("ul"),this.loadmore=b.children("div.loadmore"),this.loadmore.on("click",function(){a.load()}),this.load(),b.off("scroll").on("scroll",function(){$(this).scrollTop()>a.contents.height()-b.height()&&0!==$(".loadmore").length&&a.load()}))};
archive.list.prototype={load:function(){var a=archive.data,b=archive.lastLoaded;archive.lastLoaded>=archive.data.length&&(b=archive.lastLoaded=archive.data.length-1);for(a[b].index=b;a=archive.data[b],archive.data[b].created=this.date(a.created),archive.data[b].modified=this.date(a.modified),this.html(a),++b,app.$list.get(0).scrollHeight==app.$list.height()&&b<archive.data.length;);++b>=archive.data.length&&($(".loadmore").remove(),app.$list.append('<li><p class="separator"><span>EOF</span></p></li>'));
archive.lastLoaded=b},date:function(a){if("number"!==typeof a)return"";a=new Date(a);var b=a.getHours(),c=a.getMinutes(),d=a.getFullYear(),e=new Date,f=e.getFullYear(),g=a.getMonth(),h=a.getDate();if(d===f){var k=new Date(d,0,1),f=Math.floor((a-k)/864E5),d=Math.floor((e-k)/864E5);if(f===d)return a=Math.floor((e-a)/6E4),0===a?"Just now":60>a?a+" min":Math.floor(a/60)+" hr";if(f+1===d)d="Yesterday";else switch(k=k.getDay(),e=Math.floor((f-k)/7),f=Math.floor((d-k)/7),d="",f-e){case 1:d="Last ";case 0:d+=
app.weekArray[a.getDay()];break;default:d=app.monthArray[g]+" "+h}}else d=app.monthArray[g]+" "+h;return d+" "+(10>b?"0"+b:b)+":"+(10>c?"0"+c:c)},html:function(a){a=$(archive.itemView(a));a.find(" > a").on("click",function(a){a.preventDefault();animation.hideHiddenIcons();app.$list.find("ul").find("li:nth-child("+(archive.currentDisplayed+1)+")").find("a").removeClass("display");$(this).addClass("display");archive.currentDisplayed!=$(this).parent().index()&&(archive.currentDisplayed=$(this).parent().index(),
app.$detail.hide(),archive.view=new archive.detail);return!1}).on("contextmenu",function(){$(this).toggleClass("change");return!1});a=a.hide();this.contents.append(a.fadeIn(500))}};
archive.detail=function(){var a=archive.data[archive.currentDisplayed];if(a.processed)try{var b=$(archive.detailView(a));app.$detail.html(b);app.$app.addClass("detail-view");a.images||$(".center").hide();app.$detail.fadeIn(500);$(".btn-back",app.$detail).on("click",function(){this.hideDetail()});return a}catch(d){animation.error(log.ARCHIVE_INVALID_JSON)}else{animation.log(log.CONTENTS_DOWNLOAD_START,1);app.$list.addClass("loading");var c=this;$.ajax({type:"GET",url:a.url}).done(function(b,e,f){animation.log(log.CONTENTS_DOWNLOAD_END,
-1);app.$list.removeClass("loading");b=JSON.parse(f.responseText.substring(f.responseText.indexOf("["))).slice(0,50);for(e=0;e!==b.length;++e)b[e].time.created=edit.getMyTime(b[e].time.created),b[e].time.modified=edit.getMyTime(b[e].time.modified);a.contents=b;a.processed=!0;b=$(archive.detailView(a));app.$detail.css("display","inline-block").html(b);app.$app.addClass("detail-view");app.$detail.fadeIn(500);$(".btn-back",app.$detail).on("click",function(){c.hideDetail()});$("#archive-restore").removeClass("hidden");
return a}).fail(function(a,b,f){animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,f,-1);c.hideDetail()})}};archive.detail.prototype={htmlSpacialChars:function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},hideDetail:function(){app.$detail.css("display","none").empty();app.$list.css("display","inline-block");app.$app.removeClass("detail-view");animation.hideHiddenIcons()}};
archive.restore=function(){if(0>archive.currentDisplayed)return animation.error(log.ARCHIVE_NO_SELECTED),!1;archive.quit();downloadFile(archive.data[archive.currentDisplayed].url)};archive.apply=function(){archive.protect(function(){archive.remove(function(){archive.init()})})};
archive.protect=function(a){getTokenCallback(function(b){for(var c={},d=0,e=0;e!==archive.data.length;++e){var f=archive.data[e];f&&(f.protect?"_"!==f.name.substring(0,1)&&(c[f.id]="_"+f.name):"_"===f.name.substring(0,1)&&(c[f.id]=f.name.substring(1)))}f=Object.keys(c);if(0===f.length)animation.log(log.ARCHIVE_NO_PROTECT_CHANGE),a();else{animation.log(log.ARCHIVE_PROTECT_START,1);for(var e=0,g=f.length;e!==g;++e){var h=f[e];$.ajax({type:"PATCH",url:"https://api.onedrive.com/v1.0/drive/items/"+h+"?select=id&access_token="+
b,contentType:"application/json",data:JSON.stringify({name:c[h]})}).done(function(a){delete c[a.id]}).fail(function(a,b,d){c[data.id]=d}).always(function(){if(++d>=g){if(0!==Object.keys(c).length)for(var b=0;b!==archive.data.length;++b)c[archive.data[b].id]&&animation.error(log.ARCHIVE_PROTECT_FAIL+archive.data[b].name+log.SERVER_RETURNS_END+log.SERVER_RETURNS+c[data.id]+log.SERVER_RETURNS_END);animation.log(log.ARCHIVE_PROTECT_END,-1);a()}})}}})};
archive.remove=function(a){getTokenCallback(function(b){for(var c=0,d=0,e=0,f=0;f!==archive.data.length;++f)archive.data[f]["delete"]&&(archive.data[f].protect?(animation.log(log.ARCHIVE_PROTECT_REMOVE+archive.data[f].name+log.ARCHIVE_PROTECT_REMOVE_END),archive.data[f]["delete"]=!1):++c);if(0===c)animation.log(log.ARCHIVE_NO_SELECTED_REMOVE),a();else for(animation.log(log.ARCHIVE_REMOVE_START,1),f=0;f!==archive.data.length;++f)archive.data[f]["delete"]&&$.ajax({type:"DELETE",url:"https://api.onedrive.com/v1.0/drive/items/"+
archive.data[f].id+"?access_token="+b}).done(function(){}).fail(function(){++d}).always(function(){++e>=c&&(0<d&&animation.error(log.ARCHIVE_REMOVE_FAIL),animation.log(c-d+log.CONTENTS_DOWNLOAD_MEDIA_OF+c+log.ARCHIVE_REMOVE_END,-1),a())})})};
archive.toggle=function(a){var b=!1;app.$list.find(".archive").each(function(c){$(this).children("a").hasClass("change")&&(b=!0,$(this).children("a").toggleClass(a).hasClass(a)?archive.data[c][a]=!0:archive.data[c][a]=!1,$(this).children("a").removeClass("change"))});b||animation.warn(log.ARCHIVE_NO_SELECTED)};archive.selectBelow=function(){var a=archive.currentDisplayed;-1===a&&animation.log(log.ARCHIVE_SELECT_ALL);++a;app.$list.find(".archive").each(function(b){b>=a&&$(this).children("a").addClass("change")})};
archive.reverse=function(){app.$list.find(".archive").each(function(){$(this).children("a").toggleClass("change")})};archive.clear=function(){app.$list.find(".archive").each(function(){$(this).children("a").removeAttr("class")})};archive.quit=function(){archive.isDisplayed&&(archive.isDisplayed=!1,app.$list.empty(),app.$detail.empty(),$("#refresh-media").trigger("click"),$("#search-new, #search-result").fadeIn(),animation.showMenuOnly("menu"))};window.network={};network.percent=0;
network.current=0;network.breakpoint=0;network.interval=0;network.yearFolders=[];network.isAjaxActive=!1;network.timeOut=15E3;
network.init=function(a){$("#network-bar").remove();$(".header").append('<div id="network-bar" ><div id="network-progress"><div id="network-followup"></div></div></div>');if(!a||0>a)a=0;network.current=0;network.breakpoint=a||0;network.setPercent(0);clearInterval(network.interval);var b=!1;network.interval=setInterval(function(){b?network.destroy():(network.percent<(network.current+.5)/(network.breakpoint+1)&&(network.percent+=.05),1<=network.percent&&(network.percent=1,b=!0),$("#network-progress").css("width",
100*network.percent+"%"))},1E3)};network.setPercent=function(a){network.percent=a};network.setStatus=function(a){};network.next=function(){network.setPercent(++network.current/(network.breakpoint+1))};network.destroy=function(){1>network.percent?network.percent=2:(clearInterval(network.interval),$("#network-bar").remove())};function getResourceUrlHeader(a,b){b=b||app.year;return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource/"+b}
function getDataUrlHeader(a,b){b=b||app.year;return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data/"+b}function getCoreDataUrlHeader(a,b){b=b||app.year;return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core/"+b+"/data.js"}function getBulbUrlHeader(){return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/bulb/"}
function downloadFile(a,b,c){animation.log(log.CONTENTS_DOWNLOAD_START,1);"function"!=typeof c&&(c=function(){});getTokenCallback(function(d){-1===network.yearFolders.indexOf(app.year)?createFolders(function(){app.refresh();c()},3):($("#download").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"),a=a||getCoreDataUrlHeader(!0)+":/content?access_token="+d,$.ajax({type:"GET",url:a}).done(function(a,f,g){window.app.dataLoaded[app.year]=!1;app.addLoadDataWithFilter("",g.responseText);
animation.log(log.CONTENTS_DOWNLOAD_TEXT);delete app.yearChange[app.year];$("#year").removeClass("change");app.updateLastUpdated();app.yearUpdate();b&&($("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download"));$.ajax({type:"GET",url:getResourceUrlHeader()+":?select=folder&access_token="+d}).done(function(a,b,c){journal.archive.media=a.folder.childCount;app.refresh();animation.log(log.CONTENTS_DOWNLOAD_MEDIA_START,1);network.init(journal.archive.media);
downloadMedia()}).fail(function(a,b,c){animation.error(log.CONTENTS_DOWNLOAD_MEDIA_FAIL,c,-1)});c()}).fail(function(a,b,c){$("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"});animation.finished("#download");404==a.status&&app.yearQueue[app.year]?(app.yearUpdate(),app.refresh()):(animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,c,-1),app.year=parseInt($("#year").html()))}).always(function(){animation.log(log.CONTENTS_DOWNLOAD_END,-1)}))})}
function downloadMedia(a){void 0==a&&(a=getTokenFromCookie(),journal.archive.map={},a=getResourceUrlHeader()+":/children?select=id,name,size,@content.downloadUrl&top=500&access_token="+a);$.ajax({type:"GET",url:a}).done(function(a,c,d){if(a["@odata.nextLink"]){c=a["@odata.nextLink"];c=c.split("&");for(d=0;d!==c.length;++d)if(c[d].startsWith("$select")){c[d]="$select=id,name,size,@content.downloadUrl";break}c=c.join("&");downloadMedia(c)}a=a.value;c=0;for(d=a.length;c!=d;++c)journal.archive.map[a[c].name]=
{id:a[c].id,url:a[c]["@content.downloadUrl"],size:a[c].size},network.next();a=_.size(journal.archive.map);animation.log(log.CONTENTS_DOWNLOAD_MEDIA_LOADED+a+log.CONTENTS_DOWNLOAD_MEDIA_OF+journal.archive.media);a==journal.archive.media&&(animation.log(log.CONTENTS_DOWNLOAD_MEDIA_END,-1),network.destroy(),$("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"}),animation.finished("#download"))}).fail(function(){network.destroy()})}
function backupAll(a){getTokenCallback(function(b){animation.log(log.CONTENTS_BACKUP_START);a=a||app.years;network.init(a.length-1);for(var c=0;c!==a.length;++c){var d=new Date,e=d.getMonth()+1,f=d.getDate(),g=d.getFullYear()%100,h=d.getHours(),k=d.getMinutes(),l=d.getSeconds(),d=a[c],e=10>e?"0"+e:e,f=10>f?"0"+f:f,g=10>g?"0"+g:g,h=10>h?"0"+h:h,k=10>k?"0"+k:k,l=10>l?"0"+l:l,e={name:"data_"+e+f+g+"_"+h+k+l+".js"};$.ajax({type:"POST",url:getCoreDataUrlHeader(!1,d)+":/action.copy?access_token="+b,contentType:"application/json",
data:JSON.stringify(e),headers:{Prefer:"respond-async"}}).done(function(){animation.debug(log.CONTENTS_UPLOAD_BACKUP)}).fail(function(a,b,c){"Bad Request"!==c&&(animation.error(log.CONTENTS_UPLOAD_BACKUP_FAIL,c,-1),network.destroy())}).always(function(a,b,c){network.next()})}})}
function uploadFile(a,b){a=parseInt(a)||app.year;$("#upload").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href");getTokenCallback(function(c){var d=function(){var d=app.version[a]||"",d=d+JSON.stringify(edit.minData());$.ajax({type:"PUT",url:getCoreDataUrlHeader(!0,a)+":/content?access_token="+c,contentType:"text/plain",data:d}).done(function(){app.yearChange[app.year]=!1;$("#year").removeClass("change");app.updateLastUpdated();animation.log(log.CONTENTS_UPLOAD_END+a,-1);"function"===
typeof b?b():(edit.sortArchive(),edit.removeDuplicate(),journal.archive.data[app.year]=edit.minData(),edit.saveDataCache())}).fail(function(a,b,c){animation.error(log.CONTENTS_UPLOAD_FAIL,c,-1)}).always(function(){network.next();$("#upload").html("&#xf0ee").removeClass("spin").css("background","").attr({onclick:"uploadSingleFile()",href:"#"})})};-1===network.yearFolders.indexOf(app.year)?createFolders(d,5):d()})}function uploadSingleFile(){animation.log(log.CONTENTS_UPLOAD_START,1);uploadFile()}
function uploadAllFiles(){animation.log(log.CONTENTS_UPLOAD_START,1);if(0===app.yearChange.length)uploadFile();else for(var a=Object.keys(app.yearChange),b=0;b!==a.length;++b)app.yearChange[a[b]]&&uploadFile(a[b])}
function getCoverPhoto(a,b,c,d){var e="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=music&entity=song,album,musicArtist&term=";"number"==typeof d&&(d=edit.mediaName(d));"movie"==d?e="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=movie&entity=movieArtist,movie&term=":"book"==d&&(e="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=ebook&entity=ebook&term=");$.ajax({url:e+b,dataType:"jsonp",success:function(b){var d=b.results[0];if(void 0==d)animation.warn(log.COVER_PHOTO_FAIL),
animation.invalid(a+"input");else{animation.debug(log.COVER_PHOTO_FOUND);b=d.artistName;var e=d.trackName,d=d.artworkUrl100;c&&($(a+".title").val(e),$(a+".desc").val(b));$(a+".thumb").attr("src",d)}}})}
function createDateFolder(a,b){getTokenCallback(function(c){var d={name:a,folder:{}};$.ajax({type:"POST",url:getDataUrlHeader(!0)+":/children?access_token="+c,contentType:"application/json",data:JSON.stringify(d),statusCode:{409:function(){edit.isFolder=!0;edit.folderDate=a}}}).done(function(){edit.isFolder=!0;edit.folderDate=a;animation.debug(log.FOLDER_CREATED)}).always(function(){b(a)})})}
function createFolders(a,b){getTokenCallback(function(c){var d=0,e=!1,f=["https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource:/"],g={name:app.year.toString(),folder:{}};network.init(b);for(var h=0;h!==f.length;++h)$.ajax({type:"POST",url:f[h]+"children?access_token="+c,contentType:"application/json",data:JSON.stringify(g)}).done(function(){network.next();++d===
f.length&&(network.yearFolders.push(app.year),a(c))}).fail(function(b){409==b.status?(network.next(),++d===f.length&&(network.yearFolders.push(app.year),a(c))):(network.destroy(),e||animation.error(log.CONTENTS_UPLOAD_REGISTER_FAIL),e=!0)})})}
function removeFileById(a,b,c,d){getTokenCallback(function(e){$.ajax({type:"DELETE",url:"https://api.onedrive.com/v1.0/drive/items/"+a+"?access_token="+e}).done(function(){"function"===typeof b&&b()}).fail(function(){"function"===typeof c&&c()}).always(function(){"function"===typeof d&&d()})})}
window.bulb=function(){function a(a,b,c){b=b.replace(/\r*\n/g," ");c&&bulb.setImageContent(a,c);bulb.setRawContent(a,b);bulb.extractRawContent(a);bulb.mergeIntoArchive(a);animation.log(++h+log.BULB_PROCESSED_LEFT+f)}function b(){bulb.decrementTotalBulbs();0>=f&&app.finishMergingBulbs()}function c(c){getTokenCallback(function(d){var e=bulb.getBulbID(c);$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/items/"+e+"/content?access_token="+d}).done(function(e,f,g){var h=g.responseText;(e=bulb.getImageID(c))?
$.ajax({type:"PATCH",url:"https://api.onedrive.com/v1.0/drive/items/"+e+"?select=id,name,size,@content.downloadUrl&access_token="+d,contentType:"application/json",data:JSON.stringify({parentReference:{path:"/drive/root:/Apps/Journal/resource/"+app.year}})}).done(function(b){journal.archive.map[b.name]={url:b["@content.downloadUrl"],size:b.size,id:b.id};a(c,h,b.name)}).fail(function(){animation.log(log.BULB_IMAGE_MERGE_FAILED+c)}).always(function(){b()}):(a(c,h),b())}).fail(function(){b()})})}var d=
{},e={},f=0,g=0,h=0;return{isProcessing:!1,initFetchData:function(a){bulb.isProcessing?animation.error(log.BULB_STILL_BUSY):downloadFile(void 0,void 0,function(){animation.log(log.BULB_FETCH_START);bulb.isProcessing=!0;if(void 0==a){var b=getTokenFromCookie();a=getBulbUrlHeader()+":/children?select=id,name,size,@content.downloadUrl&top=500&access_token="+b;bulb.totalBulbs=0}$.ajax({type:"GET",url:a}).done(function(a){a=a.value;bulb.clearAllData();0===a.length?(animation.log(log.BULB_NO_CONTENT_AVAILABLE),
bulb.isProcessing=!1):(_.each(a,function(a){var b=a.name;if(b.endsWith(".jpg")||b.endsWith(".png"))b=bulb.getTimeFromEpoch(b.substr(0,b.length-4)),bulb.setImageData(b,a.id)}),a=_.filter(a,function(a){return-1===a.name.indexOf(".")}),bulb.setTotalBulbs(a.length),animation.log(log.BULB_FETCH_CONTENT_START),_.each(a,function(a){var b={id:a.id,url:a["@content.downloadUrl"]};a=bulb.getTimeFromEpoch(a.name);bulb.setBulbData(a,b);c(a)}))}).fail(function(){bulb.isProcessing=!1})})},setdata:function(a,b){d[a]=
b},getTimeFromEpoch:function(a){var b=parseInt(a.substr(0,2)),c=parseInt(a.substr(2,2)),d=2E3+parseInt(a.substr(4,2)),e=parseInt(a.substr(7,2)),f=parseInt(a.substr(9,2));a=parseInt(a.substr(11,2));return(new Date(d,b-1,c,e,f,a)).getTime()},extractRawContent:function(a){var b=/(.+)@(https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*))(.*)/g.exec(d[a].contentRaw);b&&(d[a].website=b[2],d[a].content=b[1]+b[b.length-1]);var c=/(.+)#\[(-?[0-9]+\.[0-9]+),(-?[0-9]+\.[0-9]+)\](.*)/,
b=d[a].contentRaw;if(c=c.exec(b))d[a].location={name:c[2]+","+c[3],lat:c[2],"long":c[3]},d[a].content=c[1]+c[c.length-1];else if(c=/(.+)#\[(.+),(-?[0-9]+\.[0-9]+),(-?[0-9]+\.[0-9]+)\](.*)/g,c=c.exec(b))d[a].location={name:c[2],lat:c[3],"long":c[4]},d[a].content=c[1]+c[c.length-1]},mergeIntoArchive:function(a){app.isBulbExist(a)?(d[a].isMerged=!0,d[a].isUploaded=!0):app.addBulb(d[a],a)},setIsMerged:function(a){d[a].isMerged=!0},setTotalBulbs:function(a){g=f=a},decrementTotalBulbs:function(){--f},getTotalBulbs:function(){return f},
getTotalAvailableBulbs:function(){return g},getMergedBulbCounter:function(){return h},setImageData:function(a,b){e[a]=b},setBulbData:function(a,b){d[a]=b},clearAllData:function(){d={};e={}},removeUploadedBulbs:function(){for(var a in d)d.hasOwnProperty(a)&&d[a].isMerged&&removeFileById(d[a].id,void 0,void 0,function(){0===--h&&(bulb.isProcessing=!1,animation.log(log.BULB_FETCH_FINAL_END))})},getBulbData:function(){return d},getBulbID:function(a){return d[a].id},getImageID:function(a){return e[a]},
setRawContent:function(a,b){d[a].contentRaw=b},setImageContent:function(a,b){d[a].image=b}}}();window.stats={};stats.oldValue="";stats.entries={};stats.options={startDay:0,endDay:366,isIncludingTitles:!0,isIncludingTags:!1,viewAsMonth:!1};stats.eachDay=[];stats.monthVal=[];stats.isLeapYear=!1;stats.isEditing=-1;stats.isGraphDisplayed=!1;
stats.init=function(){var a;stats.result=[];stats.isLeapYear=1===(new Date(app.year,1,29)).getMonth();stats.isGraphDisplayed=!1;stats.oldValue="";stats.monthVal=stats.isLeapYear?[31,29,31,30,31,30,31,31,30,31,30,31]:[31,28,31,30,31,30,31,31,30,31,30,31];for(a=1;;++a){var b=new Date(app.year,0,a);if(b.getFullYear()!==app.year)break;else{var c=app.monthArray[b.getMonth()],b=b.getDate();stats.eachDay.push(c+" "+b)}}$("#query").fadeOut();$("#stats-query").fadeIn();$("#stats-query").val("");$("#stats-query").unbind("keyup").bind("keyup",
"return",function(){var a=$(this).val(),a=stats.simplifyEntry(a);0===a.length?($(this).effect("highlight",{color:"#000"}),animation.debug(log.STATS_ENTRY_EMPTY_STRING)):(stats.entries[a]?($(this).effect("highlight",{color:"#000"}),animation.debug(log.STATS_ENTRY_ALREADY_EXIST)):($(this).effect("highlight",{color:"#ddd"}),stats.addEntry(a),$(this).val(""),$(this).focus()),$(this).select())});stats.initTable();animation.showMenuOnly("stats");$("#stats-options").find("li.checkbox").each(function(){$(this).click(function(){$(this).toggleClass("checked");
var a=$(this).attr("encode");stats.options[a]=!stats.options[a]})});$("#stats-table").delegate("td","mouseover mouseleave contextmenu",function(a){if("mouseover"===a.type)$(this).parent().addClass("hover"),$("tr td:nth-child("+($(this).index()+1)+")").addClass("hover");else if("mouseleave"===a.type)$(this).parent().removeClass("hover"),$("tr td:nth-child("+($(this).index()+1)+")").removeClass("hover");else return a=stats.oldValue||$(this).parent().children("td").children("input").val(),$(this).parent().slideUp(200,
function(){$(this).remove()}),delete stats.entries[a],!1}).delegate("input","focusin focusout keyup",function(a){if("focusin"===a.type)stats.oldValue=$(this).val();else if("focusout"===a.type)$(this).val(stats.oldValue),stats.oldValue="";else if(13===a.keyCode)if(a=$(this).val(),a=stats.simplifyEntry(a),0===a.length)$(this).effect("highlight",{color:"#000"}),animation.error(log.STATS_ENTRY_EMPTY_STRING),$(this).val(stats.oldValue);else if(stats.entries[a])$(this).effect("highlight",{color:"#000"}),
animation.error(log.STATS_ENTRY_ALREADY_EXIST),$(this).val(stats.oldValue);else{$(this).parent().parent().effect("highlight",{color:"#ddd"});var b=$(this).parent().parent().index()+1;delete stats.entries[stats.oldValue];stats.addEntry(a,b);stats.oldValue=a;this.blur()}else 27===a.keyCode&&this.blur()}).delegate("th","click",function(){if(0!==$("tbody tr").length){var b=$(this).hasClass("desc"),c=$(this).index(),f=[];$("tbody tr").each(function(){var a,b;$(this).children("td").each(function(d){0===
d&&(a=$(this).children("input").val());d===c&&(b=0===d?a:$(this).html())});f.push({key:a,value:b})});stats.initTable();b?($("th").eq(c).addClass("asce"),0===c?f.sort(function(a,b){return a.value.localeCompare(b.value)}):f.sort(function(a,b){return a.value-b.value})):($("th").eq(c).addClass("desc"),0===c?f.sort(function(a,b){return b.value.localeCompare(a.value)}):f.sort(function(a,b){return b.value-a.value}));for(a=0;a!==Object.keys(f).length;++a)stats.addEntry(f[a].key)}});$("#contents").fadeOut(400,
function(){$("#search-result").addClass("stats");$(".response").addClass("stats");stats.getYearSum();$("#stats-pane").fadeIn()})};stats.initTable=function(){stats.oldValue="";stats.removeAll();for(var a="<thead><tr><th>Index</th>",b=0;b!==app.monthArray.length;++b)a+="<th>"+app.monthArray[b]+"</th>";a+="<th>Total</th></tr></thead><tbody></tbody>";$("#stats-table").html(a);$("tbody").addClass("fadein")};
stats.quit=function(){stats.removeAll();$("#query").fadeIn();$("#stats-query").fadeOut().unbind("keyup");$("#stats-options").find("li.checkbox").each(function(){$(this).unbind("click")});$(".stats").removeClass("stats");$("#stats-table").undelegate("td","mouseover mouseleave contextmenu").undelegate("input","focusin focusout keyup").delegate("th","contextmenu");$("#stats-pane").fadeOut(400,function(){$("#contents").fadeIn();animation.showMenuOnly();app.refresh()})};
stats.addEntry=function(a,b){var c,d=stats.getResult(a);stats.entries[a]=d;var e=Array(12),f=0,g=0;for(c=0;c!==stats.monthVal.length;++c){for(var h=e[c]=0;h!==stats.monthVal[c];++h,++f)d[f]&&(e[c]+=d[f]);g+=e[c]}d="<td><input type='text' class='edit' autocomplete='off' onclick='this.select()' value='"+a+"' /></td>";for(c=0;c!==e.length;++c)d+="<td>"+e[c]+"</td>";d+="<td>"+g+"</td>";b?$("tbody tr:nth-child("+b+") input").parent().parent().html(d).addClass("fadein"):$("<tr>"+d+"</tr>").appendTo("tbody").addClass("fadein");
stats.hideGraph()};stats.simplifyEntry=function(a){a=a.split("|");for(var b=[],c=0;c!==a.length;++c)0<a[c].length&&b.push(a[c]);return b.join("|")};
stats.getYearSum=function(){for(var a=0,b=0,c=0,d=0,e=0,f=0,g=0;g!==journal.archive.data[app.year].length;++g){var h=journal.archive.data[app.year][g];if(stats.isInTimeRange(h.time.created)){a+=h.text.chars||0;b+=h.text.lines||0;if(h.time.end){var k=(h.time.end-h.time.start)/6E4;isNaN(k)||(c+=k)}h.images&&(d+=h.images.length);h.video&&(e+=h.video.length);h.voice&&(f+=h.voice.length)}}$("#total-char").text(a);$("#total-line").text(b);a=c%60;10>a&&(a="0"+a);$("#total-time").text(Math.floor(c/60)+":"+
a);$("#total-image").text(d);$("#total-video").text(e);$("#total-voice").text(f)};
stats.getResult=function(a){a=a.split("|");var b;b=stats.isLeapYear?Array(366):Array(365);for(var c=0;c!==journal.archive.data[app.year].length;++c){var d=[],e=journal.archive.data[app.year][c],f=e.time.created;if(stats.isInTimeRange(f))for(f=stats.getDayNumber(f),d.push(e.text.body),this.options.isIncludingTags&&d.push(e.tags),this.options.isIncludingTitles&&d.push(e.title),e=0;e!==d.length;++e){var g=d[e];if(g)for(var h=0;h!==a.length;++h){var k=a[h];b[f]||(b[f]=0);b[f]+=(g.match(new RegExp(k,"gi"))||
[]).length}}}return b};stats.getDayNumber=function(a){return Math.floor((new Date(new Date(a))-new Date(app.year,0,1))/864E5)};stats.isInTimeRange=function(a){a=stats.getDayNumber(a);return a>=stats.options.startDay&&a<=stats.options.endDay};stats.removeAll=function(){$("#stats-table").html("").fadeIn().css("display","inline-table");stats.entries={};stats.hideGraph()};stats.toggleGraph=function(){stats.isGraphDisplayed?stats.hideGraph():stats.showGraph()};
stats.showGraph=function(a){var b;stats.isGraphDisplayed=!0;var c=[],d=[],e;if(a)d=app.monthArray,$("#stats-table").find("tbody tr").each(function(){var a=[];$(this).children("td").each(function(b){0===b?e=$(this).children("input").val():13>b&&a.push($(this).html())});c.push({name:e,data:a})});else{var f;a=0;for(f=Object.keys(stats.entries);a!==f.length;++a)if(e=f[a],c.push({name:f[a],data:stats.entries[e]}),0===a){var g=stats.entries[e];for(b=0;b!==g.length;++b)void 0!=g[b]&&d.push(stats.eachDay[b])}}for(a=
0;a!==Object.keys(c).length;++a){f=c[a].data;g=[];for(b=0;b!==f.length;++b)void 0!=f[b]&&g.push(f[b]);c[a].data=g}d={chart:{backgroundColor:"#f3f3f3"},title:{text:"Stats for this year",x:-20},subtitle:{text:"Collected from "+$("#total-char").html()+" chars in "+$("#total-entry").html()+" entries",x:-20},xAxis:{categories:d},yAxis:{min:0,plotLines:[{value:0,width:1,color:"#808080"}],title:{text:"Times"}},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0},series:c,exporting:{enabled:!1,
filename:"Journal Analysis "+app.year}};$("#graph").fadeIn().highcharts(d);$("#action-stats").find(".hidden").removeClass("hidden");animation.testAllSubs()};stats.hideGraph=function(){stats.isGraphDisplayed=!1;$("#graph").fadeOut(function(){$(this).html("")});$("#action-stats").find(".hidden-icon").addClass("hidden");animation.testAllSubs()};stats.toggleYearView=function(){stats.hideGraph();stats.options.viewAsMonth=!stats.options.viewAsMonth;stats.showGraph(stats.options.viewAsMonth)};
window.calendar=function(){var a=[[15,"bulb-3"],[7,"bulb-2"],[3,"bulb-1"],[1,"bulb-0"]],b={},c={},d=function(b){for(var c=0;c!==a.length;++c)if(b>a[c][0])return a[c][1];return""},e=function(a,e,f){a=new Date(a);var l=a.getMonth(),m=a.getDate(),p=app.monthArray[l]+" "+m;a=$("#month-"+l+" .day-"+m);e&&a.addClass("article");a.addClass(d(f)).css({article:e,bulb:f}).prepend("<div class='bubble'>"+p+"<p class='article-no'>"+e+"</p><p class='bulb-no'>"+f+"</p></div>");b[l]=(b[l]||0)+(e||0);c[l]=(c[l]||0)+
(f||0);(e||f)&&a.attr("href","javascript:;").off("click").click(function(){calendar.shrink(p);var a;a="@"+(9>l?"0"+(l+1):l+1);a+=10>m?"0"+m:m;a+=app.year%100;app.addLoadDataWithFilter(a)})},f=function(){for(var a=0;12!=a;++a){var d=b[a]||0,e=c[a]||0;$("#month-"+a).prepend("<div class='bubble'><p class='article-no'>"+d+"</p><p class='bulb-no'>"+e+"</p></div>").find(".month-title").off("click").click(function(){var a=parseInt($(this).parent().prop("id").substr(6));calendar.shrink(app.monthArray[a]);
app.addLoadDataWithFilter("@"+(9>a?"0"+(a+1):a+1)+app.year%100)})}};return{viewTemplate:void 0,initView:function(){var a=new Date,b=[];a.setMonth(0,0);for(var c=[],d=0;d<(a.getDay()+1)%7;++d)c.push(0);a.setFullYear(a.getFullYear()+1);for(var e=1;12>=e;++e){a.setMonth(e,0);for(d=1;d<=a.getDate();++d)c.push(d);for(;42>c.length;)c.push(0);b.push(c);c=[];for(d=0;d<(a.getDay()+1)%7;++d)c.push(0)}a=$(calendar.viewTemplate({days:b,monthName:app.monthArray}));$("#data-calendar").html(a)},showContent:function(a){this.clear();
a=journal.archive.data[app.year];for(var b=a.length,c=(new Date(app.year,0,1)).getTime(),d=0,m=0,p=0;p!==b;++p){var q=a[p],n=q.time.start||q.time.created;if(864E5<=n-c||0>n-c)e(c,d,m),m=d=0,c=new Date(n),c=(new Date(app.year,c.getMonth(),c.getDate())).getTime();q.contentType===app.contentType.BULB?++m:++d}f();a=new Date;if(app.year===a.getFullYear())for(a=a.getMonth()+1;12>a;++a)$("#month-"+a).addClass("hidden");a=new Date;app.year===a.getFullYear()&&$("#month-"+a.getMonth()+" .day-"+a.getDate()).addClass("today")},
clear:function(){$(".calendar-table .day").removeClass("article bulb-0 bulb-1 bulb-2 bulb-3 bulb-4 bulb-5 bulb-6 bulb-7");b={};c={};$(".calendar-table").find(".bubble").remove();$(".month-cell").removeClass("hidden");$(".today").removeClass("today")},shrink:function(a){a=a||"";$("#calendar-thumbnail").text(a);$("#data-calendar").addClass("minimized");$("#list-tab").addClass("extended")},expand:function(){$("#data-calendar").removeClass("minimized");$("#list-tab").removeClass("extended")}}}();
window.map=function(){var a={path:"M 0,0 0,0 z",fillOpacity:.8,scale:1,strokeColor:"red",strokeWeight:10},b=!1,c,d,e,f=0,g=[],h=[],k=-1,l=function(){for(var b=[],k=new google.maps.LatLngBounds,l=0,t=journal.archive.data[app.year].length;l<t;++l){var r=journal.archive.data[app.year][l];app.qualifiedEntry[l]&&r.contentType===app.contentType.BULB&&r.place&&function(e,l){var n={lat:parseFloat(e.place.latitude),lng:parseFloat(e.place.longitude)};b.push(n);k.extend(n);n=new google.maps.Marker({position:n,
icon:a,map:c,title:(new Date(e.time.created)).toString()});if(e.images){var r=journal.archive.map[e.images[0].fileName];e.image=r?r.url:""}else e.image="";e.place.title=e.place.title||"";var r=$(app.bulbView(e))[0].outerHTML,t=g.length;n.addListener("mouseover",function(){m(t)});n.addListener("mouseout",function(){clearTimeout(f);f=setTimeout(function(){d.close()},5E3)});n.addListener("click",function(){for(;l>=app.lastLoaded;)$(".loadmore").click();var a=app.$list.find("li:nth-child("+(l+1)+")"),
b=a.find("a"),c=a.position().top;b.click();for(app.$list.scrollTop(0).scrollTop(c);$(".loadmore").length&&1<a.position().top;)$(".loadmore").click(),app.$list.scrollTop(0).scrollTop(a.position().top)});g.push(n);h.push(r)}($.extend({},r),l)}e=new google.maps.Polyline({path:b,geodesic:!0,strokeColor:"black",strokeOpacity:.7,strokeWeight:1});e.setMap(c);c.fitBounds(k)},m=function(a){"undefined"===typeof a&&(a=k);clearTimeout(f);k=a;d.setContent(h[a]);d.open(c,g[a]);c.setZoom(15);c.getBounds().contains(g[a].position)||
c.setCenter(g[a].position)};return{init:function(){c=new google.maps.Map(document.getElementById("map"),{zoom:4,center:{lat:-25.363,lng:131.044}});d=new google.maps.InfoWindow;b=!0;map.show()},show:function(){$("#list-tab").removeClass("list-only");b?(map.reset(),l()):map.init()},showOlderBulb:function(){++k>=g.length&&(k=g.length-1);m()},showLaterBulb:function(){0>--k&&(k=0);m()},hide:function(){$("#list-tab").addClass("list-only")},reset:function(a){a&&($("#map").empty(),map.init());e&&e.setMap(null);
for(a=0;a<g.length;++a)g[a].setMap(null);g=[];h=[];k=-1},getMarker:function(a){return _.find(g,function(b){return b.title===(new Date(a)).toString()})}}}();
