/*v4.3.0 Build 090515_1533 Minified 101015.201941*/
window.journal={};window.app={};journal.archive={};journal.archive.data={};journal.archive.media=0;journal.archive.map={};app.name="Guest";app.monthArray=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];app.weekArray=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];app.year=new Date().getFullYear();app.years=[];app.yearQueue={};app.yearChange={};app.resource="resource/";app.lastLoaded=0;app.currentDisplayed=-1;app.displayedNum=0;app.displayedLines=0;app.displayedChars=0;app.displayedTime=0.0;app.lastQualified=-1;app.pageLoaded=1;app.preloadedTags=[];app.command="";app.isFunction=true;app.lostMedia=[];app.dataLoaded={};app.lastUpdated={};app.version={data:2};app.init=function(){ var thisApp=this; showLoginButton(); app.preloadedTags.push("%photo","%video","%music","%voice","%book","%movie","%place","%weblink");var tagsArray=app.tag().getIconsInName();for(var key=0;key!=tagsArray.length;++key){app.preloadedTags.push("#"+tagsArray[key]);} $("#query").keyup(function(n){if(n.keyCode==13){app.command=$("#query").val();$("#query").effect("highlight",{color:"#dddddd"});thisApp.load(app.command,true);}}).bind("keydown",function(event){ if(event.keyCode===$.ui.keyCode.TAB&&$(this).autocomplete("instance").menu.active){event.preventDefault();}}).autocomplete({minLength:1,autoFocus:true,source:function(request,response){ var terms=$("#query").val().split(" "),availableTags=app.preloadedTags.sort();for(var i=0;i<availableTags.length;++i){for(var j=0;j<terms.length;++j){if(availableTags[i]==terms[j]){ terms.splice(j,1);availableTags.splice(i,1);break;}}} response($.ui.autocomplete.filter(availableTags,request.term.split(/ \s*/).pop()));},focus:function(){ return false;},select:function(event,ui){var terms=this.value.split(/ \s*/); terms.pop(); terms.push(ui.item.value); terms.push("");this.value=terms.join(" ");return false;}}); $(document).delegate("#search-result:not(.stats)","mouseover mouseleave",function(e){if(e.type==="mouseover"){$("#search-result").hide();$("#total-time").text(Math.floor(app.displayedTime/60)+":"+app.displayedTime%60);$("#search-result").fadeIn(500);}else{$("#search-result").hide();$("#total-time").text(app.displayedTime);$("#search-result").fadeIn(500);}}); $("#header-info").mouseover(function(){ app.readLastUpdated(); var expiration=parseInt(localStorage["expiration"]),expiresIn;if(expiration){ var now=new Date().getTime();if(expiration>now){ expiresIn=archive.list.prototype.date(now-(expiration-now));}}expiresIn=expiresIn||"Expired";$("#token-expires-in").html(expiresIn);}); $("#year").effect("slide",{direction:"up"});app.getYears(); $.ajaxSetup({timeout:network.timeOut}); $(document).ajaxStart(function(){network.isAjaxActive=true; network.init();});$(document).ajaxStop(function(){network.isAjaxActive=false;if(network.breakpoint===0){ network.destroy();}}); animation.testCacheIcons();animation.testAllSubs();};app.refresh=function(){addLoadDataWithFilter("");}addLoadDataWithFilter=function(filter,newContent){if(newContent==""){animation.error(log.LOAD_DATA_FAIL+log.NO_CONTENT);animation.deny("#refresh-media");return;}else if(newContent==undefined){if(!journal.archive.data[app.year]){journal.archive.data[app.year]=[];} if(app.yearQueue[app.year]){app.yearChange[app.year]=true; journal.archive.data[app.year].push.apply(journal.archive.data[app.year],app.yearQueue[app.year]); edit.sortArchive();edit.removeDuplicate(); delete app.yearQueue[app.year];}var queuedYears=[]; journal.archive.data[app.year]=journal.archive.data[app.year].filter(function(entry){if(entry==undefined){app.yearChange[app.year]=true; return false;}var time=entry["time"],createdYear=new Date(time["created"]).getFullYear(),startYear=new Date(time["created"]).getFullYear(); if(createdYear==app.year||startYear==app.year){return true;}else{ if(!app.yearQueue[createdYear]){app.yearQueue[createdYear]=[];} app.yearQueue[createdYear].push(entry);app.yearChange[createdYear]=true; app.yearChange[app.year]=true;$("#year").addClass("change");$("#last-updated").addClass("change"); if(queuedYears.indexOf(createdYear)===-1){queuedYears.push(createdYear);}return false;}});if(queuedYears.length>0){animation.log(log.DATA_MOVED_TO_OTHER_YEAR+queuedYears.join(", ")+log.DATA_MOVED_TO_OTHER_YEAR_END);for(var i=0;i!==queuedYears.length;++i){if(app.years.indexOf(queuedYears[i])===-1){app.years.push(queuedYears[i]);}} app.years.sort();}if(journal.archive.data[app.year].length===0){animation.warn(log.LOAD_DATA_FAIL+log.NO_ARCHIVE);animation.deny("#refresh-media");return;}}  $("#search-result").hide(); app.detail.prototype.hideDetail(); animation.testAllSubs();var loadFunction=function(){$("#total-entry").text(journal.archive.data[app.year].length);new app.list(filter);app.dataLoaded[app.year]=true;};if(!app.dataLoaded[app.year]){if(newContent){ animation.debug(log.CONTENTS_NEW+newContent.length+log.CONTENTS_NEW_END);console.log("addLoadDataWithFilter(): data.length = "+newContent.length);app.loadScript(newContent,loadFunction,false);edit.saveDataCache();}} animation.indent=0; animation.debug(log.CONTENTS_RELOADED);animation.testAllSubs();console.log("==================Force loaded==================");$("#list").empty();app.lastLoaded=0;app.lastQualified=-1;app.displayedChars=0;app.displayedLines=0;app.displayedNum=0;app.displayedTime=0;app.currentDisplayed=-1;app.command=filter;$("#query").val(filter);$("#total-displayed").text(app.displayedNum);$("#total-char").text(app.displayedChars);$("#total-line").text(app.displayedLines);$("#total-time").text(app.displayedTime);$("#year").effect("slide",{direction:"up"}).html(app.year); if(app.yearChange[app.year]){$("#year").addClass("change");$("#last-updated").addClass("change");}else{$("#year").removeClass("change");} for(var key=0,len=journal.archive.data[app.year].length;key!=len;++key){journal.archive.data[app.year][key]["processed"]=0;}loadFunction(); $("#search-result").fadeIn(500);if(filter==undefined){filter="";}};app.loadScript=function(data,func,isScript){if(isScript){var newScript=document.createElement("script"),newFunction=function(){func();};newScript.src=data;newScript.charset="utf-8";newScript.onload=newFunction; newScript.onreadystatechange=function(){if(this.readyState=="complete"||this.readyState=="loaded"){newFunction();}};document.getElementsByTagName("head")[0].appendChild(newScript);}else{ console.log("app.loadScript(): data.length = "+data.length); var version="",i;for(var i=0;i!==data.length&&data[i]!="[";++i){version+=data[i];}version=parseInt(version);if(version){app.version[app.year]=version;}journal.archive.data[app.year]=app.updateData(JSON.parse(data.substr(i)));func();}};app.updateData=function(data){if(!app.version[app.year]){app.version[app.year]=1;}if(app.version[app.year]!==app.version.data){ animation.debug(log.CONTENTS_UPGRADING);switch(app.version[app.year]){case 1: for(var i=0;i!==data.length;++i){var iconTags=data[i]["iconTags"],textTags=data[i]["textTags"];if(iconTags){ iconTags=app.tag().getIconsInNameByVal(iconTags).join("|"); if(textTags){textTags+="|"+iconTags;}else{textTags+=iconTags;}}textTags=textTags||"";var tags;if(data[i]["tags"]){ tags+="|"+textTags;}else{tags=textTags;} delete data[i]["icontags"];delete data[i]["textTags"];}app.version[app.year]=2;}} if(app.version[app.year]>app.version.data){app.version[app.year]=app.version.data;}return data;};app.getYears=function(){animation.log(log.GET_YEARS_START);getTokenCallback(function(token){$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core:/children?select=name,createdBy&orderby=name&access_token="+token}).done(function(data){var itemList=data["value"];app.years=[];for(var i=0;i!==itemList.length;++i){var name=itemList[i]["name"]; if(parseInt(name)==name){name=parseInt(name);app.years.push(name);network.yearFolders.push(name);}}app.user=itemList[0]["createdBy"]["user"]["displayName"];$("#username").html(app.user);if(app.years.indexOf(new Date().getFullYear())===-1){ app.years.push(new Date().getFullYear());}backupAll();animation.testYearButton();animation.log(log.GET_YEARS_END);}).fail(function(xhr,status,error){animation.error(log.GET_YEARS_FAIL,error);app.getYears();});});}app.yearUpdateTry=function(year){app.year=year;if(app.years.length===0){app.years.push(app.year);}if(!journal.archive.data[year]){ downloadFile(undefined,true);}else{app.yearUpdate(year);}}app.yearUpdate=function(){app.refresh(); animation.testYearButton();animation.debug(log.YEAR_SWITCHED_TO+app.year);}app.prev=function(isToEnd){if(network.isAjaxActive){ animation.warn(log.NETWORK_WORKING);return;}var index=app.years.indexOf(app.year);if(index===-1){ app.yearUpdateTry(new Date().getFullYear());return;}if(isToEnd){index=0;}else{--index;}app.yearUpdateTry(app.years[index]);}app.next=function(isToEnd){if(network.isAjaxActive){ animation.warn(log.NETWORK_WORKING);return;}var index=app.years.indexOf(app.year);if(index===-1){ app.yearUpdateTry(new Date().getFullYear());return;}if(isToEnd){index=app.years.length-1;}else{++index;}app.yearUpdateTry(app.years[index]);}app.updateLastUpdated=function(time){time=parseInt(time)||new Date().getTime();app.lastUpdated[app.year]=time;if(app.year===new Date().getFullYear()){ localStorage["lastUpdated"]=new Date().getTime();}app.readLastUpdated();}app.readLastUpdated=function(){var lastUpdated=app.lastUpdated[app.year];if(!lastUpdated){ if(app.year===new Date().getFullYear()){ if(localStorage["lastUpdated"]){lastUpdated=parseInt(localStorage["lastUpdated"]);app.lastUpdated[app.year]=lastUpdated;lastUpdated=archive.list.prototype.date(lastUpdated);}else{lastUpdated="N/A";}}else{lastUpdated="N/A";}}else{ lastUpdated=archive.list.prototype.date(lastUpdated);}$("#last-updated").html(lastUpdated);}app.list=function(filter){var f=this,data=journal.archive.data[app.year];journal.total=data.length;var d=app.cList,c=d.children("ul"); if(!this.contents&&c.length<1){d.html("<ul></ul><div class=\"loadmore\"></div>");this.contents=d.children("ul");this.loadmore=d.children("div.loadmore");this.loadmore.on("click",function(){f.load(filter);});this.load(filter); d.off("scroll").on("scroll",function(){if($(this).scrollTop()>(f.contents.height()-d.height())){if($(".loadmore").length!=0){f.load(app.command);}}});}};app.list.prototype={load:function(filter){var currentList=this,contents=journal.archive.data[app.year],currentLoaded=app.lastLoaded,lastQualifiedLoaded=app.lastQualified; if(app.lastLoaded>=journal.archive.data[app.year].length){currentLoaded=app.lastLoaded=journal.archive.data[app.year].length-1;}contents[currentLoaded].index=currentLoaded; while(true){if(this.qualify(contents[currentLoaded],filter)){var lastTime; if(lastQualifiedLoaded==-1){lastTime=0;}else{lastTime=contents[lastQualifiedLoaded].time.start||contents[lastQualifiedLoaded].time.created;} currentList.html(journal.archive.data[app.year][currentLoaded],lastTime); lastQualifiedLoaded=currentLoaded;++app.displayedNum;app.displayedChars+=contents[currentLoaded].text.chars;app.displayedLines+=contents[currentLoaded].text.lines;if(contents[currentLoaded].time.end){ var timeDelta=parseInt((contents[currentLoaded].time.end-contents[currentLoaded].time.start)/60000);if(!isNaN(timeDelta)){app.displayedTime+=timeDelta;}}$("#search-result").hide().fadeIn(500);$("#total-displayed").text(app.displayedNum);$("#total-char").text(app.displayedChars);$("#total-line").text(app.displayedLines);$("#total-time").text(app.displayedTime); if($("#list").get(0).scrollHeight==$("#list").height()&&++currentLoaded!=journal.total){continue;}break;}else{ this.htmlEmpty(); if(++currentLoaded==journal.total){ break;}}} if(++currentLoaded>=journal.total){ $(".loadmore").remove(); $("#list").append("<li><p class=\"separator\"><span>EOF</span></p></li>");}app.lastQualified=lastQualifiedLoaded;app.lastLoaded=currentLoaded;},qualify:function(data,filter){ if(!filter){return true;} while(filter.search("  ")!=-1){filter=filter.replace("  "," ");}var elements=filter.toLowerCase().split(" "); for(var key=0,len=elements.length;key<len;++key){var element=elements[key].split("|"),found=false;console.log("\t\t> Testing "+element); for(var subkey in element){if(element.hasOwnProperty(subkey)){ var subfound;if(element[subkey].charAt(0)==="#"){if(data["tags"]){subfound=false;var textTagArray=data["tags"].split("|"),index=textTagArray.indexOf(element[subkey].substr(1));if(index!==-1){subfound=true;}if(subfound){ found=true;break;}}}else if(element[subkey].charAt(0)==="%"){ subfound=false;var typeArray=app.tag().content(data["attachments"]),type=element[subkey].substr(1);for(var i=0;i!==typeArray.length;++i){if(type==typeArray[i]){subfound=true;break;}}if(subfound){ found=true;break;}}else if(element[subkey].charAt(0)==="@"){ var timeStr=element[subkey].substr(1);if(this.isInRange(timeStr,data["time"]["created"])){console.log("\t- Time match!"); found=true;break;}}else if(element[subkey].charAt(0)==="+"){if(data["text"]["body"].match(new RegExp(element[subkey].substr(1),"i"))){ found=true;break;}}else{if(data["title"].match(new RegExp(element[subkey],"i"))){ found=true;break;}} if(found){break;}}} if(found){continue;}console.log("Reach end"); return false;}return true;},date:function(time,timeOnly){var date=new Date(time),hour=date.getHours(),minute=date.getMinutes();minute=minute<10?"0"+minute:minute;hour=hour<10?"0"+hour:hour; if(timeOnly){return hour+":"+minute;}else{ var year=date.getFullYear(),now=new Date(),nowYear=now.getFullYear(),month=date.getMonth(),day=date.getDate(),dateHeader;if(year===nowYear){var firstDay=new Date(year,0,1),yearDay=Math.floor((date-firstDay)/86400000),nowYearDay=Math.floor((now-firstDay)/86400000); if(yearDay===nowYearDay){dateHeader="Today";}else if(yearDay+1===nowYearDay){dateHeader="Yesterday";}else{ var firstWeekDay=firstDay.getDay(),yearWeek=Math.floor((yearDay-firstWeekDay)/7),nowYearWeek=Math.floor((nowYearDay-firstWeekDay)/7);dateHeader="";switch(nowYearWeek-yearWeek){case 1: dateHeader="Last ";case 0: dateHeader+=app.weekArray[date.getDay()];break;default:dateHeader=app.monthArray[month]+" "+day;break;}}}else{dateHeader=app.monthArray[month]+" "+day;}return dateHeader+" "+hour+":"+minute;}},html:function(data,lastTime){ data.summary=data.text.ext; switch(data.coverType){default:data.type="text";data.ext="";break;case 1:data.type="photo";data.ext=this.thumb(data,"images");break;case 2:data.type="video";data.ext=this.thumb(data,"video");break;case 3:data.type="music";data.ext=this.thumb(data,"music");break;case 4:data.type="voice";data.ext=this.thumb("dummy");break;case 5:data.type="book";data.ext=this.thumb(data,"book");break;case 6:data.type="movie";data.ext=this.thumb(data,"movie");break;case 7:data.type="place";data.ext=this.thumb("dummy");break;case 8:data.type="weblink";data.ext=this.thumb(data,"weblink");break;} var createTime=data.time.start||data.time.created;data.datetime=this.date(createTime);data.endtime="";if(data.time.end){data.datetime+=" - "+this.date(data.time.end,1);} data.month=this.isInSameMonth(createTime,lastTime); data.attached=this.attached(data.attachments);var item=$(app.itemView(data)); item.find(" > a").on("click",function(j){j.preventDefault(); animation.showMenuOnly("edit"); if(app.photos){app.photos.remove();}$("#list ul li:nth-child("+(app.currentDisplayed+1)+") a").removeClass("display"); $(this).addClass("display"); var flag=(app.currentDisplayed==$(this).parent().index());if(!flag){app.currentDisplayed=$(this).parent().index();$("#detail").hide().fadeIn(500);app.view=new app.detail();}return false;});$(".thumb > img:not([style])",item).on("load",function(){var h=this.naturalWidth||this.width,f=this.naturalHeight||this.height,g=app.util.crop(h,f,160);$(this).css(g);});$(".thumb > canvas",item).each(function(){var h=$(this).data("src"),g=new Image(),f=this.getContext("2d");g.src=h;g.onload=function(){var croppedPhoto=app.util.crop(this.width,this.height,160),x=croppedPhoto.marginLeft||0,y=croppedPhoto.marginTop||0,width=croppedPhoto.width||160,height=croppedPhoto.height||160;f.drawImage(g,x,y,width,height);};});var $newClass=item.addClass(data.type).hide();this.contents.append($newClass.fadeIn(500));},htmlEmpty:function(){console.log("not show!");return $("#list ul").append("<li></li>");},thumb:function(data,type){var typeContents=data[type],returnHtml;if(!!typeContents&&typeContents.length>0){ var first=typeContents[0],g=""; if(!first.fileName){return"<div class=\"dummy\"></div>";}if(type!="images"&&type!="video"){ if(!!first.thumb){first=first.thumb;}else{return"<div class=\"dummy\"></div>";}}          var thumbProperties=app.util.crop(1024,720,80),thumbPropertiesHtml=app.util.style(thumbProperties); var fileName;if(type=="images"){if(journal.archive.map[first.fileName]){fileName=journal.archive.map[first.fileName]["url"];}if(fileName==undefined){return"<div class=\"dummy\"></div>";}}if(type=="video"){if(journal.archive.map[first.fileName+"_thumb.jpg"]){fileName=journal.archive.map[first.fileName+"_thumb.jpg"]["url"];}if(fileName==undefined){return"<div class=\"dummy\"></div>";}}     if(thumbPropertiesHtml){thumbPropertiesHtml=" style=\""+thumbPropertiesHtml+"\"";}var j="<img src=\""+fileName+"\""+thumbPropertiesHtml+">";if(Modernizr.canvas){j="<canvas width=\"160\" height=\"160\" data-src=\""+fileName+"\"></canvas>";}if(first.urlType>1&&type=="weblink"){g="<span class=\"weblink-video\"></span>";}if(type=="video"){g="<span class=\"video-play\"></span>";}returnHtml="<div class=\"thumb\">"+j+""+g+"</div>";}return returnHtml||"<div class=\"dummy\"></div>";},attached:function(contentFlag){var retArray=[],typeArray=app.tag().content(contentFlag); for(var i=0,len=typeArray.length;i<len;++i){ retArray.push("<span class=\""+typeArray[i]+"\"></span>");}return retArray.join("");},isInRange:function(timeStr,timeNum){console.log("Call addLoadDataWithFilter.isInRange("+timeStr+","+timeNum+")");var timeArray=timeStr.split(":"),date=new Date(timeNum);if(timeArray.length==1){ var singleTime=timeArray[0];if(singleTime.length==4){ var month=parseInt(singleTime.substr(0,2)),year=parseInt(singleTime.substr(2,2));if(isNaN(month)||isNaN(year)){ return false;} return(date.getYear()%100==year&&date.getMonth()+1==month);}else if(singleTime.length==6){ var month=parseInt(singleTime.substr(0,2)),day=parseInt(singleTime.substr(2,2)),year=parseInt(singleTime.substr(4,2));if(isNaN(month)||isNaN(day)||isNaN(year)){ return false;} return(date.getYear()%100==year&&date.getMonth()+1==month&&date.getDate()==day);}else{ return false;}}else if(timeArray.length==2){ var startTime=timeArray[0],endTime=timeArray[1];if(startTime.length==4){ var startMonth=parseInt(startTime.substr(0,2)),startYear=parseInt(startTime.substr(2,2)),endMonth=parseInt(endTime.substr(0,2)),endYear; if(endTime.length==2){endYear=startYear;}else if(endTime.length==4){endYear=parseInt(endTime.substr(2,2));}else{ return false;}if(isNaN(startMonth)||isNaN(startYear)||isNaN(endMonth)||isNaN(endYear)){ return false;}var month=date.getMonth()+1,year=date.getYear()%100; if(month>=startMonth&&month<=endMonth&&year>=startYear&&year<=endYear){return true;}else{return false;}}else if(startTime.length==6){ var startMonth=parseInt(startTime.substr(0,2)),startDay=parseInt(startTime.substr(2,2)),startYear=parseInt(startTime.substr(4,2)),endMonth=startMonth,endDay=startDay,endYear=startYear;if(endTime.length==2){endDay=parseInt(endTime);}else if(endTime.length==4){endMonth=parseInt(endTime.substr(0,2));endDay=parseInt(endTime.substr(2,2));}else if(endTime.length==6){endMonth=parseInt(endTime.substr(0,2));endDay=parseInt(endTime.substr(2,2));endYear=parseInt(endTime.substr(4,2));}else{ return false;}if(isNaN(startMonth)||isNaN(startDay)||isNaN(startYear)||isNaN(endMonth)||isNaN(endDay)||isNaN(endTime)){ return false;}var startDate=new Date(2000+startYear,startMonth-1,startDay),endDate=new Date(2000+endYear,endMonth-1,endDay,23,59,59); return startDate<timeNum&&endDate>timeNum;}else{ return false;}}},isInSameMonth:function(newTime,oldTime){var newDate=new Date(newTime),newMonth=newDate.getMonth(); if(oldTime===0){return app.monthArray[newMonth];}var oldDate=new Date(oldTime),oldMonth=oldDate.getMonth();return oldMonth===newMonth?-1:app.monthArray[newMonth];}};app.detail=function(){var dataClip=journal.archive.data[app.year][app.currentDisplayed];if(!dataClip.processed){dataClip.chars=dataClip.text.chars+" Chars";dataClip.lines=dataClip.text.lines+" Lines";dataClip.contents=this.text(dataClip.text.body);if(dataClip.weblink){this.thumb(dataClip,"weblink",50,50);}if(dataClip.book){this.thumb(dataClip,"book",50,70);for(var i=0;i!==dataClip["book"].length;++i){getCoverPhoto("#detail .book:eq("+i+") ",dataClip.book[i].author+" "+dataClip.book[i].title,false,"book");}}if(dataClip.music){this.thumb(dataClip,"music",50,50);for(var i=0;i!==dataClip["music"].length;++i){getCoverPhoto("#detail .music:eq("+i+") ",dataClip.music[i].author+" "+dataClip.music[i].title);}}if(dataClip.movie){this.thumb(dataClip,"movie",50,70);for(var i=0;i!==dataClip["movie"].length;++i){getCoverPhoto("#detail .movie:eq("+i+") ",dataClip.movie[i].author+" "+dataClip.movie[i].title,false,"movie");}}if(dataClip.tags){ var tags=app.tag().separate(dataClip.tags);dataClip.iconTags=tags.iconTags||[];dataClip.textTags=tags.textTags||[];}else{dataClip.iconTags=[];dataClip.textTags=[];} var elements="video weblink book music movie images voice place textTags iconTags".split(" ");for(var i=0,len=elements.length;i<len;++i){if(dataClip[elements[i]]==undefined){dataClip[elements[i]]=undefined;}} dataClip.processed=1;}var l=$(app.detailView(dataClip));app.cDetail.css("display","inline-block").html(l);app.app.addClass("detail-view");$(".content.loading").removeClass("loading"); if(dataClip["images"]){$("#menu-show-images").removeClass("hidden");}else{$("#menu-show-images").addClass("hidden");} $(".btn-back",app.cDetail).on("click",function(){this.hideDetail();}); $(".icontags > span").on("click",function(){var tag=app.tag().getNameByHtml(this.className);if(tag!=""){addLoadDataWithFilter("#"+tag);}}); var eachOp=function(){var className=$(this).attr("class");if(journal.archive.map[className]){$(this).attr("href",journal.archive.map[className]["url"]).removeAttr("class");}};$(".lower .video a").each(function(n){ app.videoPlayer.quit();var className=$(this).attr("class");if(journal.archive.map[className]){var funcName="app.videoPlayer(\"#app #video-preview\",\""+journal.archive.map[className]["url"]+"\")";$(this).attr("onclick",funcName).removeAttr("class");}else{animation.error(log.FILE_NOT_LOADED+className+log.DOWNLOAD_PROMPT);}});$(".lower .voice a").each(function(n){ app.audioPlayer.quit();var className=$(this).attr("class");if(journal.archive.map[className]){var funcName="app.audioPlayer(\"#detail .content .voice:eq("+n+") a\",\""+journal.archive.map[className]["url"]+"\")";$(this).attr("onclick",funcName).removeAttr("class");}else{animation.error(log.FILE_NOT_LOADED+className+log.DOWNLOAD_PROMPT);}}); $("#edit-this, #delete").removeClass("hidden");animation.testAllSubs();return dataClip;};app.detail.prototype={text:function(rawText){ rawText=this.htmlSpacialChars(rawText); rawText=rawText.replace(/\t\t[*]\t[*]\t[*]/g,"<hr>"); rawText=rawText.replace(/\r\n/g,"\n"); rawText=rawText.replace(/\n\t\t/g,"</p><p class=\"t2\">");rawText=rawText.replace(/\n\t/g,"</p><p class=\"t1\">"); rawText=rawText.replace(/\n\n/ig,"</p></br><p>"); rawText=rawText.replace(/\n/ig,"</p><p>");return"<p>"+rawText+"</p>";}, htmlSpacialChars:function(rawText){return rawText.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;");},thumb:function(dataClip,thumbType,width,height){ var thumbClip=dataClip[thumbType];if(thumbClip&&thumbClip.length>0){thumbClip=thumbClip[0]; if(!thumbClip){return false;} var styleArray=app.util.crop(1024,720,width,height),styleHtml=app.util.style(styleArray), fileDir=app.resource+thumbClip.thumb;if(!fileDir.match(/.(jpg|png)$/)){fileDir=fileDir+".jpg";}if(styleHtml){styleHtml=" style=\""+styleHtml+"\"";}if(!(thumbClip.thumb===undefined)){thumbClip.thumb="<img src=\""+fileDir+"\""+styleHtml+">";}}},hideDetail:function(){$("#edit-this, #delete").addClass("hidden");animation.testAllSubs();app.cDetail.css("display","none").empty();app.cList.css("display","inline-block");app.app.removeClass("detail-view"); if(app.photos){app.photos.remove();}}};app.layout=function(){var activeWindow=$(window), changeWindowSize=function(){var newHeight=activeWindow.height()<750?activeWindow.height():activeWindow.height()-200; app.app.height(newHeight);app.contents.height(newHeight);};changeWindowSize(); activeWindow.on("resize",changeWindowSize);};app.util={fit:function(width,height,newWidth,newHeight){var l=(newWidth<width)?newWidth:width,g=(newHeight<height)?newHeight:height;var j=Math.ceil((width/height)*g),d=Math.ceil(l/(width/height));var retArray={};if(width>height){if(newHeight>d){retArray.width=l;retArray.height=d;}else{retArray.width=j;retArray.height=g;}}else{if(newWidth>j){retArray.width=j;retArray.height=g;}else{retArray.width=l;retArray.height=d;}}return retArray;}, crop:function(width,height,newWidth,newHeight){newHeight=newHeight||newWidth;var e=Math.ceil((width/height)*newHeight),j=Math.ceil(newWidth/(width/height));var retArray={};if(width>height){if(newHeight>j){retArray.width=e;retArray.height=newHeight;retArray.marginLeft=-((e-newWidth)/2);}else{retArray.width=newWidth;retArray.height=j;retArray.marginTop=-((j-newHeight)/2);}}else{if(width<height){if(newWidth>e){retArray.width=newWidth;retArray.height=j;retArray.marginTop=-((j-newHeight)/2);}else{retArray.width=e;retArray.height=newHeight;retArray.marginLeft=-((e-newWidth)/2);}}}return retArray;}, style:function(styleArray){var c=[];for(i in styleArray){if(styleArray.hasOwnProperty(i)){c.push(i.replace(/([A-Z])/,"-$1").toLowerCase()+":"+(typeof styleArray[i]=="number"?styleArray[i]+"px":styleArray[i]));}}return c.join(";");}, runTime:function(second){if(second&&second>0){second=second/1000;var e="0",c="";if(second>=60){e=second/60;c=second-(e*60);c=c>=10?Math.ceil(c):"0"+Math.ceil(c);}else{c=second>=10?Math.ceil(second):"0"+Math.ceil(second);}return e+":"+c;}}};app.tag=function(){var icons=[{name:"clear",value:1,html:"w01"},{name:"overcast",value:2,html:"w02"},{name:"raining",value:4,html:"w03"},{name:"snowing",value:8,html:"w04"},{name:"thundering",value:16,html:"w05"},{name:"windy",value:32,html:"w06"},{name:"happy",value:1024,html:"e01"},{name:"notbad",value:2048,html:"e02"},{name:"surprised",value:4096,html:"e03"},{name:"sad",value:8192,html:"e04"},{name:"angry",value:16384,html:"e05"},{name:"journal",value:32768,html:"c01"},{name:"thoughts",value:65536,html:"c02"},{name:"ingress",value:131072,html:"c03"},{name:"minecraft",value:262144,html:"c04"},{name:"dream",value:524288,html:"c05"},{name:"code",value:1048576,html:"c06"},{name:"letter",value:2097152,html:"c07"},{name:"handwriting",value:4194304,html:"c08"},{name:"wechat",value:8388608,html:"c09"},{name:"friendship",value:16777216,html:"c10"},{name:"snooker",value:-1,html:"c11"},{name:"skateboard",value:-1,html:"c12"},{name:"relationship",value:33554432,html:"s01"},{name:"star",value:67108864,html:"s02"},{name:"food",value:134217728,html:"s03"},{name:"leisure",value:268435456,html:"s04"},{name:"info",value:536870912,html:"s05"},{name:"baby",value:1073741824,html:"s06"},{name:"fun",value:2147483648,html:"s07"},{name:"travel",value:4294967296,html:"s08"},{name:"health",value:8589934592,html:"s09"},{name:"outfit",value:17179869184,html:"s10"},{name:"shopping",value:34359738368,html:"s11"},{name:"pets",value:68719476736,html:"s12"},{name:"work",value:137438953472,html:"s13"},{name:"sports",value:274877906944,html:"s14"},{name:"cook",value:549755813888,html:"s15"},{name:"makeup",value:1099511627776,html:"s16"},{name:"home",value:2199023255552,html:"s17"},{name:"car",value:4398046511104,html:"s18"}],photoVal=1,videoVal=2,musicVal=4,voiceVal=8,bookVal=16,movieVal=32,placeVal=64,weblinkVal=128,binaryString="000000000000000000000000000000000000000000000000000000000000000";return{content:function(contentFlag){var retArray=[];if(this.is(contentFlag,photoVal)){retArray.push("photo");}if(this.is(contentFlag,videoVal)){retArray.push("video");}if(this.is(contentFlag,musicVal)){retArray.push("music");}if(this.is(contentFlag,voiceVal)){retArray.push("voice");}if(this.is(contentFlag,bookVal)){retArray.push("book");}if(this.is(contentFlag,movieVal)){retArray.push("movie");}if(this.is(contentFlag,placeVal)){retArray.push("place");}if(this.is(contentFlag,weblinkVal)){retArray.push("weblink");}return retArray;},getIconsInHtmlByVal:function(typeVal){var retArray=[];for(var i=0;i!==icons.length;++i){if(this.is(typeVal,icons[i]["value"])){retArray.push(icons[i]["html"]);}}return retArray;},getIconsInNameByVal:function(typeVal){var retArray=[];for(var i=0;i!==icons.length;++i){if(this.is(typeVal,icons[i]["value"])){retArray.push(icons[i]["name"]);}}return retArray;},getValueByName:function(name){return this.translate(name.toLowerCase(),"name","value");},getValueByHtml:function(name){return this.translate(name.toLowerCase(),"html","value");},getHtmlByName:function(name){return this.translate(name.toLowerCase(),"name","html");},getNameByHtml:function(html){return this.translate(html.toLowerCase(),"html","name");},getIconsInHtml:function(){return this.getAll("html");},getIconsInName:function(){return this.getAll("name");},getAll:function(type){var retArray=[];for(var i=0;i!==icons.length;++i){if(icons[i][type]){retArray.push(icons[i][type]);}}return retArray;},translate:function(data,source,target){for(var i=0;i!==icons.length;++i){if(icons[i][source]&&icons[i][target]){if(icons[i][source]==data){return icons[i][target];}}}return"";}, separate:function(tags){ while(tags.indexOf("||")!==-1){tags=tags.replace(/||/g,"|");}while(tags.length&&tags[0]=="|"){tags=tags.substr(1);}while(tags.length&&tags[tags.length-1]=="|"){tags=tags.substr(0,tags.length-1);}var icontags=[],texttags=tags.split("|"); for(var i=0;i!==icons.length;++i){ var index=texttags.indexOf(icons[i]["name"]);if(index>-1){ icontags.push(icons[i]["html"]); texttags.splice(index,1);}}return{iconTags:icontags,textTags:texttags};},or:function(typesVal,typeVal){var newVal=this.get(typesVal).split("");newVal[this.get(typeVal).indexOf("1")]="1";return parseInt(newVal.join(""),2);},andnot:function(typesVal,typeVal){var newVal=this.get(typesVal).split("");newVal[this.get(typeVal).indexOf("1")]="0";return parseInt(newVal.join(""),2);}, is:function(typesVal,typeVal){return this.get(typesVal).charAt(this.get(typeVal).indexOf("1"))=="1";}, get:function(value){return this.substr(binaryString+value.toString(2));}, substr:function(string){var len=string.length;return string.substr(len-64);}};};app.showEntryImages=function(){var data=journal.archive.data[app.year][app.currentDisplayed];if(data["images"]){for(var key=0;key!=data["images"].length;++key){var file=data["images"][key].fileName;if(journal.archive.map[file]){$(".upper").append("<a href=\""+journal.archive.map[file]["url"]+"\"><span></span><img src=\""+journal.archive.map[file]["url"]+"\"></a>");}else{animation.error(log.FILE_NOT_LOADED+file+log.DOWNLOAD_PROMPT);}}}$("#menu-show-images").addClass("hidden");$(".upper").addClass("expand").mousewheel(function(event,delta){ this.scrollLeft-=(delta*50);event.preventDefault();});;var photos=$(".upper > a",app.cDetail); if(photos.length>0){app.photos=new app.PhotoViewer(photos.find(" > img").clone());photos.on("click",function(o){o.preventDefault();var n=$(this).index();app.photos.open(n);return false;});}}app.PhotoViewer=function(c,d){if(!c&&typeof c!="object"){return false;}this.list=c;this.callback=d||function(){};this.make();this.init();};app.PhotoViewer.prototype={make:function(){var f=this.list;if(f.length>1){var c=$("<ul>");}var d=$("<ul class=\"swipe-wrap\">");f.each(function(j){$("<li>").html(this).appendTo(d);if(!!c){$("<li>").html("<a href=\"#"+j+"\">"+j+"</a>").appendTo(c);}});var e=$("<div class=\"wrap swipe\">").html(d);var g=$("<div class=\"control\">");g.append("<input type=\"button\" value=\"Close\" class=\"btn-close\"/>");if(!!c){c.css("width",f.length*17).wrap("<div class=\"pagination\"/>").parent().appendTo(g);}e.append(g);e.append("<div class=\"background\"></div>");var h=$("<div id=\"photoviewer\">").html(e);h.appendTo("body");},init:function(){var c=this;this.viewer=$("body > div#photoviewer");},bind:function(){if(!!this._bind){this.swipe.setup();return false;}var j=this;var g=this.viewer=$("body > div#photoviewer");this.pagination=$("div.pagination>ul>li",this.viewer);var c=g.find(" > div.swipe");this.swipe=new Swipe(c[0],{continuous:false,callback:j.callback,transitionEnd:function(k){j.paging(k);}});$("input.btn-close",g).on("click",function(){j.close();});var h=c.find(" > ul > li > img");function d(n){var k=$(window),m=k.width(),l=k.height();h.each(function(){var r=$(this),q=r.context.naturalWidth||r.context.width,o=r.context.naturalHeight||r.context.height,p=j.fit(q,o,m,l);r.css(p);});}d();$(window).on("resize",d);var f=$("div.control",g);h.on("click",function(){f.fadeToggle(200);});var e=c.find(" > ul > li");e.on("click",function(k){if(k,this==k.toElement){j.close();}});this._bind=1;},fit:function(g,f,e,d){var c=app.util.fit(g,f,e,d);if(!$.browser.msie){c.marginLeft=-((c.width/2)+10);c.marginTop=-((c.height/2)+10);}else{c.marginLeft=-(c.width/2);c.marginTop=-(c.height/2);}return c;},open:function(c){var c=c||0,e=this,d=this.viewer;d.css({display:"block",opacity:0});this.bind();this.go(c);this.paging(c);d.css({opacity:1},200);$(window).on("keyup.photoviewer",function(f){if(f.keyCode==27){e.close();}else{if(f.keyCode==37){e.prev();}else{if(f.keyCode==39){e.next();}}}});},close:function(){this.viewer.fadeOut(200);$(window).off("keyup.photoviewer");},prev:function(){this.swipe.prev();},next:function(){this.swipe.next();},go:function(c){var c=c||0;this.swipe.slide(c,1);},paging:function(c){this.pagination.filter(".active").removeClass("active");this.pagination.eq(c).addClass("active");},remove:function(){this.viewer.remove();}};app.audioPlayer=function(selector,source){if(app.isFunction){app.isFunction=false;}else{ animation.warn(log.MEDIA_ALREADY_DISPLAYED);return;}animation.log(log.AUDIO_DOWNLOAD_START,1);$("#play-media").html("&#xf04b").removeClass("play").attr("onclick","app.audioPlayer.play()");$("#stop-media").attr("onclick","app.audioPlayer.quit()");var element="<div id=\"audioplayer\">"+"<audio id=\"music\" preload=\"true\"><source src=\""+source+"\"></audio>"+"<div id=\"music-position\">00:00</div><div id=\"timeline\"><div id=\"playhead\"></div></div><div id=\"music-length\">--:--</div></div>"; $(element).appendTo(selector); $(selector+" p").css("padding-top","3px");app.audioPlayer.music=document.getElementById("music");app.audioPlayer.playhead=document.getElementById("playhead");app.audioPlayer.timeline=document.getElementById("timeline");var duration,timelineWidth=timeline.offsetWidth-playhead.offsetWidth,onplayhead=false;app.audioPlayer.formatTime=function(timeNum){var minute=parseInt(timeNum/60),second=parseInt(timeNum%60);minute=minute<10?"0"+minute:minute;second=second<10?"0"+second:second;return minute+":"+second;}; app.audioPlayer.timeUpdate=function(){var playPercent=timelineWidth*(music.currentTime/duration);playhead.style.marginLeft=playPercent+"px";if(music.currentTime===duration){ $("#play-media").html("&#xf04b").removeClass("play");}else{$("#music-position").html(app.audioPlayer.formatTime(music.currentTime));}};app.audioPlayer.moveplayHead=function(e){var newMargLeft=e.pageX-timeline.getBoundingClientRect().left;if(newMargLeft>=0&&newMargLeft<=timelineWidth){playhead.style.marginLeft=newMargLeft+"px";}if(newMargLeft<0){playhead.style.marginLeft="0px";}if(newMargLeft>timelineWidth){playhead.style.marginLeft=timelineWidth+"px";}};app.audioPlayer.click=function(e){app.audioPlayer.moveplayHead(e); var clickPercent=(e.pageX-timeline.getBoundingClientRect().left)/timelineWidth;music.currentTime=duration*clickPercent;};app.audioPlayer.mouseDown=function(){app.audioPlayer.onplayhead=true;window.addEventListener("mousemove",app.audioPlayer.moveplayHead,true);music.removeEventListener("timeupdate",app.audioPlayer.timeUpdate,false);};app.audioPlayer.mouseUp=function(e){if(app.audioPlayer.onplayhead){app.audioPlayer.moveplayHead(e);window.removeEventListener("mousemove",app.audioPlayer.moveplayHead,true); var clickPercent=(e.pageX-timeline.getBoundingClientRect().left)/timelineWidth;music.currentTime=duration*clickPercent;music.addEventListener("timeupdate",app.audioPlayer.timeUpdate,false);}app.audioPlayer.onplayhead=false;};app.audioPlayer.loadedData=function(){animation.log(AUDIO_DOWNLOAD_END,-1); $("#music-length").html(app.audioPlayer.formatTime(music.duration)); $("#toggle-media").addClass("hidden"); animation.showMenu("media");}; app.audioPlayer.music.addEventListener("canplaythrough",function(){duration=app.audioPlayer.music.duration;},false); app.audioPlayer.music.addEventListener("timeupdate",app.audioPlayer.timeUpdate,false);app.audioPlayer.music.addEventListener("loadedmetadata",app.audioPlayer.loadedData); app.audioPlayer.timeline.addEventListener("click",app.audioPlayer.click,false); app.audioPlayer.playhead.addEventListener("mousedown",app.audioPlayer.mouseDown,false);window.addEventListener("mouseup",app.audioPlayer.mouseUp,false);};app.audioPlayer.play=function(){ if($("#play-media").hasClass("play")){ music.pause();$("#play-media").html("&#xf04b").removeClass("play");}else{if(isNaN(music.duration)){ animation.error(log.AUDIO_EXPIRED);return false;} music.play();$("#play-media").html("&#xf04c").addClass("play");}};app.audioPlayer.quit=function(){$("#play-media").html("&#xf04b").removeClass("play"); $("#audioplayer").fadeOut(400,function(){$(this).remove();}); $("#detail .content .voice p").css("padding-top",""); app.isFunction=true; if(app.audioPlayer.music){app.audioPlayer.music.removeEventListener("timeupdate",app.audioPlayer.timeUpdate);app.audioPlayer.music.removeEventListener("loadedmetadata",app.audioPlayer.loadedData);}if(app.audioPlayer.timeline){app.audioPlayer.timeline.removeEventListener("click",app.audioPlayer.click);}if(app.audioPlayer.playhead){app.audioPlayer.playhead.removeEventListener("mousedown",app.audioPlayer.mouseDown);}window.removeEventListener("mouseup",app.audioPlayer.mouseUp);animation.hideMenu("media");};app.videoPlayer=function(selector,source){if(app.isFunction){app.isFunction=false;}else{ animation.warn(log.MEDIA_ALREADY_DISPLAYED);return;}animation.log(log.VIDEO_DOWNLOAD_START,1);$(selector).fadeIn();$("#play-media").html("&#xf04b").removeClass("play").attr("onclick","app.videoPlayer.play()");$("#stop-media").attr("onclick","app.videoPlayer.quit()");var element="<div id=\"videoplayer\">"+"<video id=\"video\" preload=\"true\"><source src=\""+source+"\"></video>"+"<div id=\"video-position\">00:00</div><div id=\"timeline\"><div id=\"playhead\"></div></div><div id=\"video-length\">--:--</div></div>"; $(element).appendTo(selector); app.videoPlayer.video=document.getElementById("video");app.videoPlayer.playhead=document.getElementById("playhead");app.videoPlayer.timeline=document.getElementById("timeline");var duration,timelineWidth,onplayhead=false;app.videoPlayer.formatTime=function(timeNum){var minute=parseInt(timeNum/60),second=parseInt(timeNum%60);minute=minute<10?"0"+minute:minute;second=second<10?"0"+second:second;return minute+":"+second;}; app.videoPlayer.timeUpdate=function(){var playPercent=timelineWidth*(video.currentTime/duration);playhead.style.marginLeft=playPercent+"px";if(video.currentTime===duration){ $("#play-media").html("&#xf04b").removeClass("play");}else{$("#video-position").html(app.videoPlayer.formatTime(video.currentTime));}};app.videoPlayer.moveplayHead=function(e){var newMargLeft=e.pageX-timeline.getBoundingClientRect().left;if(newMargLeft>=0&&newMargLeft<=timelineWidth){playhead.style.marginLeft=newMargLeft+"px";}if(newMargLeft<0){playhead.style.marginLeft="0px";}if(newMargLeft>timelineWidth){playhead.style.marginLeft=timelineWidth+"px";}};app.videoPlayer.click=function(e){app.videoPlayer.moveplayHead(e); var clickPercent=(e.pageX-timeline.getBoundingClientRect().left)/timelineWidth;video.currentTime=duration*clickPercent;};app.videoPlayer.mouseDown=function(){app.videoPlayer.onplayhead=true;window.addEventListener("mousemove",app.videoPlayer.moveplayHead,true);video.removeEventListener("timeupdate",app.videoPlayer.timeUpdate,false);};app.videoPlayer.mouseUp=function(e){if(app.videoPlayer.onplayhead){app.videoPlayer.moveplayHead(e);window.removeEventListener("mousemove",app.videoPlayer.moveplayHead,true); var clickPercent=(e.pageX-timeline.getBoundingClientRect().left)/timelineWidth;video.currentTime=duration*clickPercent;video.addEventListener("timeupdate",app.videoPlayer.timeUpdate,false);}app.videoPlayer.onplayhead=false;};app.videoPlayer.loadedData=function(){animation.log(log.VIDEO_DOWNLOAD_END,-1); if(app.videoPlayer.height!=undefined){$("#videoplayer").css("height",app.videoPlayer.height);}else{$("#videoplayer").css("height","450px");} $("#video-length").html(app.videoPlayer.formatTime(video.duration)); $("#toggle-media").removeClass("hidden"); animation.showMenu("media"); $("#video-position, #video-length, #timeline").fadeIn().css("display","inline-block"); timelineWidth=timeline.offsetWidth-playhead.offsetWidth;if(this.toggle){this.toggle.isFullScreen=false;this.toggle.windowSelector=undefined;}$("#toggle-media").html("&#xf065");}; app.videoPlayer.video.addEventListener("canplaythrough",function(){duration=app.videoPlayer.video.duration;},false); app.videoPlayer.video.addEventListener("timeupdate",app.videoPlayer.timeUpdate,false);app.videoPlayer.video.addEventListener("loadedmetadata",app.videoPlayer.loadedData); app.videoPlayer.timeline.addEventListener("click",app.videoPlayer.click,false); app.videoPlayer.playhead.addEventListener("mousedown",app.videoPlayer.mouseDown,false);window.addEventListener("mouseup",app.videoPlayer.mouseUp,false);};app.videoPlayer.toggle=function(){if(this.toggle.isFullScreen){ if(this.toggle.windowSelector){$("#video-fullscreen").fadeOut(); $(this.toggle.windowSelector).append($("#videoplayer").css("height","450px")); $("#toggle-media").html("&#xf065");}else{ animation.error("Program error: no app.videoPlayer.toggle.windowSelector");}this.toggle.isFullScreen=false;}else{ this.toggle.windowSelector=$("#videoplayer").parent(); $("#video-fullscreen").fadeIn().append($("#videoplayer").css("height","-webkit-calc(100% - 25px)")); $("#toggle-media").html("&#xf066");this.toggle.isFullScreen=true;}};app.videoPlayer.play=function(){ if($("#play-media").hasClass("play")){ video.pause();$("#play-media").html("&#xf04b").removeClass("play");}else{if(isNaN(video.duration)){ animation.error(log.VIDEO_EXPIRED);return false;} video.play();$("#play-media").html("&#xf04c").addClass("play");}};app.videoPlayer.quit=function(){$("#play-media").html("&#xf04b").removeClass("play"); $("#videoplayer").fadeOut(400,function(){$(this).remove();}); app.isFunction=true; if(app.videoPlayer.video){app.videoPlayer.video.removeEventListener("timeupdate",app.videoPlayer.timeUpdate);app.videoPlayer.video.removeEventListener("loadedmetadata",app.videoPlayer.loadedData);}if(app.videoPlayer.timeline){app.videoPlayer.timeline.removeEventListener("click",app.videoPlayer.click);}if(app.videoPlayer.playhead){app.videoPlayer.playhead.removeEventListener("mousedown",app.videoPlayer.mouseDown);}window.removeEventListener("mouseup",app.videoPlayer.mouseUp);animation.hideMenu("media");$("#toggle-media").html("&#xf065");$("#video-fullscreen").fadeOut();this.toggle.isFullScreen=false;this.toggle.windowSelector=undefined;};app.checkResource=function(){ if(Object.keys(journal.archive.map).length===0){animation.error(log.MEDIA_CLEAN_NOT_FOUND+log.DOWNLOAD_PROMPT);return;}var allMedia=Object.keys(journal.archive.map),groups=["images","video","voice"],undefMedia=0; for(var i=0,length=journal.archive.data[app.year].length;i!==length;++i){var dataClip=journal.archive.data[app.year][i]; for(var j=0;j!==groups.length;++j){if(dataClip[groups[j]]){ for(var k=0;k<dataClip[groups[j]].length;++k){var index=allMedia.indexOf(dataClip[groups[j]][k]["fileName"]);if(index===-1){++undefMedia;dataClip[groups[j]].splice(k,1);--k;}else{ allMedia.splice(index,1);}}}}} app.lostMedia=[]; for(var i=0;i!==allMedia.length;++i){app.lostMedia.push(allMedia[i]);} if(app.lostMedia.length===0){animation.log(log.MEDIA_CLEAN_NOT_FOUND);}else{animation.log(app.lostMedia.length+log.MEDIA_CLEAN_FOUND);} if(undefMedia===0){animation.log(log.MEDIA_CLEAN_UNDEFINED_NOT_FOUND);}else{animation.log(undefMedia+log.MEDIA_CLEAN_UNDEFINED_FOUND);app.refresh();} animation.showIcon("#return-lost-media");}app.cleanResource=function(){ if(app.lostMedia.length===0){animation.error(log.MEDIA_CLEAN_NO_DATA);}else{animation.log(log.MEDIA_CLEAN_START); getTokenCallback(function(token){ $.ajax({type:"GET",url:getDataUrlHeader()+":/children?select=name&top=500&access_token="+token}).done(function(data){var itemList=data["value"],folders=[];for(var i=0,len=itemList.length;i!==len;++i){folders.push(itemList[i]["name"]);} var done=0,fail=0;for(var i=0;i!==lostMedia.length;++i){ var path=lostMedia[i].substring(0,6);if(folders.indexOf(path)===-1){ path="queue";}else{path="data/"+path;}path="/drive/root:/Apps/Journal/"+path;var requestJson={parentReference:{path:path}},id=journal.archive.map[lostMedia[i]]["id"],url;if(id){url="https://api.onedrive.com/v1.0/drive/items/"+id+"?select=id,@content.downloadUrl&access_token="+token;}else{url=getResourceUrlHeader(true)+"/"+encodeURI(lostMedia[i])+"/"+"?select=id,@content.downloadUrl&access_token="+token;} $.ajax({type:"PATCH",url:url,contentType:"application/json",data:JSON.stringify(requestJson)}).done(function(){}).fail(function(){++fail;}).always(function(){if(++done===app.lostMedia.length){ if(fail>0){animation.log(fail+log.MEDIA_CLEAN_FAIL);}else{animation.log(log.MEDIA_CLEAN_SUCCESS);} app.lostMedia=[];}});}}).fail(function(xhr,status,error){animation.error(log.MEDIA_CLEAN_GET_FOLDERS_FAIL,error,-1);});});}}$(document).ready(function(){app.app=$("div#app");app.contents=app.app.find(" > #contents");app.cList=app.app.find(" > #contents > #list");app.cDetail=app.app.find(" > #contents > #detail");app.itemView=_.template($("#list-view").html());app.detailView=_.template($("#detail-view").html());app.layout();app.init();archive.itemView=_.template($("#archive-view").html());archive.detailView=_.template($("#archive-detail-view").html());});