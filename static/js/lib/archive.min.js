/*v4.3.0 Build 090515_1533 Minified 101015.201941*/
window.archive={};archive.data=[];archive.displayId="";archive.isDisplayed=false;archive.lastLoaded=0;archive.currentDisplayed=-1;archive.confirmName="";archive.init=function(selector){$(selector).addClass("spinr");archive.contents=undefined;archive.data=[];archive.confirmName=""; getTokenCallback(function(token){animation.log(log.ARCHIVE_START,1);$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:/core/"+app.year+":/children?select=id,name,size,createdDateTime,lastModifiedDateTime,@content.downloadUrl&top=500&orderby=lastModifiedDateTime%20desc&access_token="+token}).done(function(data,status,xhr){if(data["@odata.nextLink"]){animation.warn(log.ARCHIVE_TOO_MANY);}animation.log(log.ARCHIVE_END,-1);var itemList=data["value"];for(var key=0,len=itemList.length;key!==len;++key){var name=itemList[key]["name"]; if((name.substring(0,4)==="data"||name.substring(0,5)==="_data")&&name.substring(name.length-3)===".js"&&name!=="data.js"){var dataElement={name:name,id:itemList[key]["id"],url:itemList[key]["@content.downloadUrl"],size:itemList[key]["size"],created:Date.parse(itemList[key]["createdDateTime"]),modified:Date.parse(itemList[key]["lastModifiedDateTime"]),selected:false,processed:false,protect:false};if(name.substring(0,1)==="_"){ dataElement["protect"]=true;}archive.data.push(dataElement);}}app.audioPlayer.quit(); $("#list").empty();$("#detail").empty(); archive.isDisplayed=true;archive.lastLoaded=0;animation.showMenuOnly("archive"); $("#search-new, #search-result").fadeOut();archive.load();}).fail(function(xhr,status,error){animation.error(log.FILES_NOT_FOUND,error,-1);}).always(function(){$(selector).removeClass("spinr");});});};archive.load=function(){ $("#search-result").hide(); archive.detail.prototype.hideDetail(); $("#list").empty();archive.lastLoaded=0;archive.currentDisplayed=-1; for(var key=0,len=archive.data.length;key!==len;++key){archive.data[key]["processed"]=false;}new archive.list();archive.dataLoaded=true;};archive.list=function(){var f=this,d=app.cList,c=d.children("ul"); if(!this.contents&&c.length<1){d.html("<ul></ul><div class=\"loadmore\"></div>");this.contents=d.children("ul");this.loadmore=d.children("div.loadmore");this.loadmore.on("click",function(){f.load();});this.load(); d.off("scroll").on("scroll",function(){if($(this).scrollTop()>(f.contents.height()-d.height())){if($(".loadmore").length!==0){f.load();}}});}};archive.list.prototype={load:function(){var contents=archive.data,currentLoaded=archive.lastLoaded; if(archive.lastLoaded>=archive.data.length){currentLoaded=archive.lastLoaded=archive.data.length-1;} contents[currentLoaded].index=currentLoaded; while(true){var data=archive.data[currentLoaded];archive.data[currentLoaded]["created"]=this.date(data["created"]);archive.data[currentLoaded]["modified"]=this.date(data["modified"]);this.html(data);++currentLoaded; if($("#list").get(0).scrollHeight==$("#list").height()&&currentLoaded<archive.data.length){continue;}break;} if(++currentLoaded>=archive.data.length){ $(".loadmore").remove(); $("#list").append("<li><p class=\"separator\"><span>EOF</span></p></li>");}archive.lastLoaded=currentLoaded;},date:function(time){if(typeof time!=="number"){return"";}var date=new Date(time),hour=date.getHours(),minute=date.getMinutes(); var year=date.getFullYear(),now=new Date(),nowYear=now.getFullYear(),month=date.getMonth(),day=date.getDate(),dateHeader;if(year===nowYear){var firstDay=new Date(year,0,1),yearDay=Math.floor((date-firstDay)/86400000),nowYearDay=Math.floor((now-firstDay)/86400000); if(yearDay===nowYearDay){ var deltaMinutes=Math.floor((now-date)/60000);if(deltaMinutes===0){return"Just now";}else if(deltaMinutes<60){ return deltaMinutes+" min";}else{ return Math.floor(deltaMinutes/60)+" hr";}}else if(yearDay+1===nowYearDay){dateHeader="Yesterday";}else{ var firstWeekDay=firstDay.getDay(),yearWeek=Math.floor((yearDay-firstWeekDay)/7),nowYearWeek=Math.floor((nowYearDay-firstWeekDay)/7);dateHeader="";switch(nowYearWeek-yearWeek){case 1: dateHeader="Last ";case 0: dateHeader+=app.weekArray[date.getDay()];break;default:dateHeader=app.monthArray[month]+" "+day;break;}}}else{dateHeader=app.monthArray[month]+" "+day;}minute=minute<10?"0"+minute:minute;hour=hour<10?"0"+hour:hour;return dateHeader+" "+hour+":"+minute;},html:function(data){var item=$(archive.itemView(data)); item.find(" > a").on("click",function(j){j.preventDefault(); animation.hideHiddenIcons();$("#list ul li:nth-child("+(archive.currentDisplayed+1)+") a").removeClass("display"); $(this).addClass("display"); var flag=(archive.currentDisplayed==$(this).parent().index());if(!flag){archive.currentDisplayed=$(this).parent().index();$("#detail").hide();archive.view=new archive.detail();}return false;}).on("contextmenu",function(){ $(this).toggleClass("change"); return false;});var $newClass=item.hide();this.contents.append($newClass.fadeIn(500));}};archive.detail=function(){var dataClip=archive.data[archive.currentDisplayed];if(!dataClip.processed){animation.log(log.CONTENTS_DOWNLOAD_START,1); $("#list").addClass("loading");var t=this;$.ajax({type:"GET",url:dataClip["url"]}).done(function(data,status,xhr){animation.log(log.CONTENTS_DOWNLOAD_END,-1); $("#list").removeClass("loading");var contents=JSON.parse(xhr.responseText.substring(xhr.responseText.indexOf("["))).slice(0,50); for(var i=0;i!==contents.length;++i){contents[i]["time"]["created"]=edit.getMyTime(contents[i]["time"]["created"]);contents[i]["time"]["modified"]=edit.getMyTime(contents[i]["time"]["modified"]);}dataClip.contents=contents; dataClip.processed=true;var l=$(archive.detailView(dataClip));app.cDetail.css("display","inline-block").html(l);app.app.addClass("detail-view");$("#detail").fadeIn(500); $(".btn-back",app.cDetail).on("click",function(){t.hideDetail();}); $("#archive-restore").removeClass("hidden");return dataClip;}).fail(function(xhr,status,error){animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,error,-1); t.hideDetail();});}else{try{var l=$(archive.detailView(dataClip));app.cDetail.html(l);app.app.addClass("detail-view"); if(!dataClip["images"]){$(".center").hide();}$("#detail").fadeIn(500); $(".btn-back",app.cDetail).on("click",function(){this.hideDetail();});return dataClip;}catch(e){animation.error(log.ARCHIVE_INVALID_JSON);}}};archive.detail.prototype={ htmlSpacialChars:function(rawText){return rawText.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;");},hideDetail:function(){app.cDetail.css("display","none").empty();app.cList.css("display","inline-block");app.app.removeClass("detail-view");animation.hideHiddenIcons();}};archive.restore=function(){if(archive.currentDisplayed<0){ animation.error(log.ARCHIVE_NO_SELECTED);return false;} archive.quit();downloadFile(archive.data[archive.currentDisplayed]["url"]);}archive.apply=function(){archive.protect(function(){archive.remove(function(){archive.init();});});}archive.protect=function(callback){getTokenCallback(function(token){var list={},processed=0;for(var i=0;i!==archive.data.length;++i){var dataClip=archive.data[i];if(dataClip){if(dataClip["protect"]){if(dataClip["name"].substring(0,1)!=="_"){ list[dataClip["id"]]="_"+dataClip["name"];}}else{if(dataClip["name"].substring(0,1)==="_"){ list[dataClip["id"]]=dataClip["name"].substring(1);}}}}var keys=Object.keys(list);if(keys.length===0){ animation.log(log.ARCHIVE_NO_PROTECT_CHANGE);callback();}else{animation.log(log.ARCHIVE_PROTECT_START,1);for(var i=0,len=keys.length;i!==len;++i){var id=keys[i],url="https://api.onedrive.com/v1.0/drive/items/"+id+"?select=id&access_token="+token,requestJson={name:list[id]};$.ajax({type:"PATCH",url:url,contentType:"application/json",data:JSON.stringify(requestJson)}).done(function(data){ delete list[data["id"]];}).fail(function(xhr,status,error){list[data["id"]]=error;}).always(function(){if(++processed>=len){ if(Object.keys(list).length!==0){ for(var j=0;j!==archive.data.length;++j){if(list[archive.data[j]["id"]]){ animation.error(log.ARCHIVE_PROTECT_FAIL+archive.data[j]["name"]+log.SERVER_RETURNS_END+log.SERVER_RETURNS+list[data["id"]]+log.SERVER_RETURNS_END);}}}animation.log(log.ARCHIVE_PROTECT_END,-1);callback();}});}}});}archive.remove=function(callback){getTokenCallback(function(token){var total=0,fail=0,processed=0;for(var i=0;i!==archive.data.length;++i){if(archive.data[i]["delete"]){if(archive.data[i]["protect"]){ animation.log(log.ARCHIVE_PROTECT_REMOVE+archive.data[i]["name"]+log.ARCHIVE_PROTECT_REMOVE_END);archive.data[i]["delete"]=false;}else{++total;}}}if(total===0){ animation.log(log.ARCHIVE_NO_SELECTED_REMOVE);callback();}else{animation.log(log.ARCHIVE_REMOVE_START,1);for(var i=0;i!==archive.data.length;++i){if(archive.data[i]["delete"]){$.ajax({type:"DELETE",url:"https://api.onedrive.com/v1.0/drive/items/"+archive.data[i]["id"]+"?access_token="+token}).done(function(){}).fail(function(){++fail;}).always(function(){if(++processed>=total){ if(fail>0){ animation.error(log.ARCHIVE_REMOVE_FAIL);}animation.log((total-fail)+log.CONTENTS_DOWNLOAD_MEDIA_OF+total+log.ARCHIVE_REMOVE_END,-1);callback();}});}}}});}archive.toggle=function(type){var changed=false;$("#list .archive").each(function(index){if($(this).children("a").hasClass("change")){changed=true;if($(this).children("a").toggleClass(type).hasClass(type)){archive.data[index][type]=true;}else{archive.data[index][type]=false;}$(this).children("a").removeClass("change");}});if(!changed){animation.warn(log.ARCHIVE_NO_SELECTED);}}archive.selectBelow=function(){var since=archive.currentDisplayed;if(since===-1){ animation.log(log.ARCHIVE_SELECT_ALL);}++since;$("#list .archive").each(function(index){if(index>=since){$(this).children("a").addClass("change");}});}archive.reverse=function(){$("#list .archive").each(function(){$(this).children("a").toggleClass("change");});}archive.clear=function(){$("#list .archive").each(function(){$(this).children("a").removeAttr("class");});}archive.quit=function(){if(archive.isDisplayed){archive.isDisplayed=false;$("#list").empty();$("#detail").empty(); $("#refresh-media").trigger("click");$("#search-new, #search-result").fadeIn();animation.showMenuOnly("menu");}}