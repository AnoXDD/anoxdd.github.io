/*Version4.2.0Build082015.1936ByAnoxic*/window.archive={},archive.data=[],archive.displayId="",archive.isDisplayed=!1,archive.lastLoaded=0,archive.currentDisplayed=-1,archive.confirmName="",archive.init=function(e){$(e).addClass("spinr"),archive.contents=void 0,archive.data=[],archive.confirmName="",getTokenCallback(function(a){animation.log(log.ARCHIVE_START,1),$.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:/core/"+app.year+":/children?select=id,name,size,createdDateTime,lastModifiedDateTime,@content.downloadUrl&top=500&orderby=lastModifiedDateTime%20desc&access_token="+a}).done(function(e){e["@odata.nextLink"]&&animation.warn(log.ARCHIVE_TOO_MANY),animation.log(log.ARCHIVE_END,-1);for(var a=e.value,i=0,t=a.length;i!==t;++i){var r=a[i].name;if(("data"===r.substring(0,4)||"_data"===r.substring(0,5))&&".js"===r.substring(r.length-3)&&"data.js"!==r){var n={name:r,id:a[i].id,url:a[i]["@content.downloadUrl"],size:a[i].size,created:Date.parse(a[i].createdDateTime),modified:Date.parse(a[i].lastModifiedDateTime),selected:!1,processed:!1,protect:!1};"_"===r.substring(0,1)&&(n.protect=!0),archive.data.push(n)}}app.audioPlayer.quit(),$("#list").empty(),$("#detail").empty(),archive.isDisplayed=!0,archive.lastLoaded=0,animation.showMenuOnly("archive"),$("#search-new, #search-result").fadeOut(),archive.load()}).fail(function(e,a,i){animation.error(log.FILES_NOT_FOUND,i,-1)}).always(function(){$(e).removeClass("spinr")})})},archive.load=function(){$("#search-result").hide(),archive.detail.prototype.hideDetail(),$("#list").empty(),archive.lastLoaded=0,archive.currentDisplayed=-1;for(var e=0,a=archive.data.length;e!==a;++e)archive.data[e].processed=!1;new archive.list,archive.dataLoaded=!0},archive.list=function(){var e=this,a=app.cList,i=a.children("ul");!this.contents&&i.length<1&&(a.html('<ul></ul><div class="loadmore"></div>'),this.contents=a.children("ul"),this.loadmore=a.children("div.loadmore"),this.loadmore.on("click",function(){e.load()}),this.load(),a.off("scroll").on("scroll",function(){$(this).scrollTop()>e.contents.height()-a.height()&&0!==$(".loadmore").length&&e.load()}))},archive.list.prototype={load:function(){var e=archive.data,a=archive.lastLoaded;for(archive.lastLoaded>=archive.data.length&&(a=archive.lastLoaded=archive.data.length-1),e[a].index=a;;){var i=archive.data[a];if(archive.data[a].created=this.date(i.created),archive.data[a].modified=this.date(i.modified),this.html(i),++a,!($("#list").get(0).scrollHeight==$("#list").height()&&a<archive.data.length))break}++a>=archive.data.length&&($(".loadmore").remove(),$("#list").append('<li><p class="separator"><span>EOF</span></p></li>')),archive.lastLoaded=a},date:function(e){if("number"!=typeof e)return"";var a,i=new Date(e),t=i.getHours(),r=i.getMinutes(),n=i.getFullYear(),o=new Date,l=o.getFullYear(),c=i.getMonth(),s=i.getDate();if(n===l){var d=new Date(n,0,1),h=Math.floor((i-d)/864e5),v=Math.floor((o-d)/864e5);if(h===v){var p=Math.floor((o-i)/6e4);return 0===p?"Just now":60>p?p+" min":Math.floor(p/60)+" hr"}if(h+1===v)a="Yesterday";else{var g=d.getDay(),u=Math.floor((h-g)/7),f=Math.floor((v-g)/7);switch(a="",f-u){case 1:a="Last ";case 0:a+=app.weekArray[i.getDay()];break;default:a=app.monthArray[c]+" "+s}}}else a=app.monthArray[c]+" "+s;return r=10>r?"0"+r:r,t=10>t?"0"+t:t,a+" "+t+":"+r},html:function(e){var a=$(archive.itemView(e));a.find(" > a").on("click",function(e){e.preventDefault(),animation.hideHiddenIcons(),$("#list ul li:nth-child("+(archive.currentDisplayed+1)+") a").removeClass("display"),$(this).addClass("display");var a=archive.currentDisplayed==$(this).parent().index();return a||(archive.currentDisplayed=$(this).parent().index(),$("#detail").hide(),archive.view=new archive.detail),!1}).on("contextmenu",function(){return $(this).toggleClass("change"),!1});var i=a.hide();this.contents.append(i.fadeIn(500))}},archive.detail=function(){var e=archive.data[archive.currentDisplayed];if(e.processed)try{var a=$(archive.detailView(e));return app.cDetail.html(a),app.app.addClass("detail-view"),e.images||$(".center").hide(),$("#detail").fadeIn(500),$(".btn-back",app.cDetail).on("click",function(){this.hideDetail()}),e}catch(i){animation.error(log.ARCHIVE_INVALID_JSON)}else{animation.log(log.CONTENTS_DOWNLOAD_START,1),$("#list").addClass("loading");var t=this;$.ajax({type:"GET",url:e.url}).done(function(a,i,r){animation.log(log.CONTENTS_DOWNLOAD_END,-1),$("#list").removeClass("loading");for(var n=JSON.parse(r.responseText.substring(r.responseText.indexOf("["))).slice(0,50),o=0;o!==n.length;++o)n[o].time.created=edit.getMyTime(n[o].time.created),n[o].time.modified=edit.getMyTime(n[o].time.modified);e.contents=n,e.processed=!0;var l=$(archive.detailView(e));return app.cDetail.css("display","inline-block").html(l),app.app.addClass("detail-view"),$("#detail").fadeIn(500),$(".btn-back",app.cDetail).on("click",function(){t.hideDetail()}),$("#archive-restore").removeClass("hidden"),e}).fail(function(e,a,i){animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,i,-1),t.hideDetail()})}},archive.detail.prototype={htmlSpacialChars:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},hideDetail:function(){app.cDetail.css("display","none").empty(),app.cList.css("display","inline-block"),app.app.removeClass("detail-view"),animation.hideHiddenIcons()}},archive.restore=function(){return archive.currentDisplayed<0?(animation.error(log.ARCHIVE_NO_SELECTED),!1):(archive.quit(),void downloadFile(archive.data[archive.currentDisplayed].url))},archive.apply=function(){archive.protect(function(){archive.remove(function(){archive.init()})})},archive.protect=function(e){getTokenCallback(function(a){for(var i={},t=0,r=0;r!==archive.data.length;++r){var n=archive.data[r];n&&(n.protect?"_"!==n.name.substring(0,1)&&(i[n.id]="_"+n.name):"_"===n.name.substring(0,1)&&(i[n.id]=n.name.substring(1)))}var o=Object.keys(i);if(0===o.length)animation.log(log.ARCHIVE_NO_PROTECT_CHANGE),e();else{animation.log(log.ARCHIVE_PROTECT_START,1);for(var r=0,l=o.length;r!==l;++r){var c=o[r],s="https://api.onedrive.com/v1.0/drive/items/"+c+"?select=id&access_token="+a,d={name:i[c]};$.ajax({type:"PATCH",url:s,contentType:"application/json",data:JSON.stringify(d)}).done(function(e){delete i[e.id]}).fail(function(e,a,t){i[data.id]=t}).always(function(){if(++t>=l){if(0!==Object.keys(i).length)for(var a=0;a!==archive.data.length;++a)i[archive.data[a].id]&&animation.error(log.ARCHIVE_PROTECT_FAIL+archive.data[a].name+log.SERVER_RETURNS_END+log.SERVER_RETURNS+i[data.id]+log.SERVER_RETURNS_END);animation.log(log.ARCHIVE_PROTECT_END,-1),e()}})}}})},archive.remove=function(e){getTokenCallback(function(a){for(var i=0,t=0,r=0,n=0;n!==archive.data.length;++n)archive.data[n]["delete"]&&(archive.data[n].protect?(animation.log(log.ARCHIVE_PROTECT_REMOVE+archive.data[n].name+log.ARCHIVE_PROTECT_REMOVE_END),archive.data[n]["delete"]=!1):++i);if(0===i)animation.log(log.ARCHIVE_NO_SELECTED_REMOVE),e();else{animation.log(log.ARCHIVE_REMOVE_START,1);for(var n=0;n!==archive.data.length;++n)archive.data[n]["delete"]&&$.ajax({type:"DELETE",url:"https://api.onedrive.com/v1.0/drive/items/"+archive.data[n].id+"?access_token="+a}).done(function(){}).fail(function(){++t}).always(function(){++r>=i&&(t>0&&animation.error(log.ARCHIVE_REMOVE_FAIL),animation.log(i-t+log.CONTENTS_DOWNLOAD_MEDIA_OF+i+log.ARCHIVE_REMOVE_END,-1),e())})}})},archive.toggle=function(e){var a=!1;$("#list .archive").each(function(i){$(this).children("a").hasClass("change")&&(a=!0,archive.data[i][e]=$(this).children("a").toggleClass(e).hasClass(e)?!0:!1,$(this).children("a").removeClass("change"))}),a||animation.warn(log.ARCHIVE_NO_SELECTED)},archive.selectBelow=function(){var e=archive.currentDisplayed;-1===e&&animation.log(log.ARCHIVE_SELECT_ALL),++e,$("#list .archive").each(function(a){a>=e&&$(this).children("a").addClass("change")})},archive.reverse=function(){$("#list .archive").each(function(){$(this).children("a").toggleClass("change")})},archive.clear=function(){$("#list .archive").each(function(){$(this).children("a").removeAttr("class")})},archive.quit=function(){archive.isDisplayed&&(archive.isDisplayed=!1,$("#list").empty(),$("#detail").empty(),$("#refresh-media").trigger("click"),$("#search-new, #search-result").fadeIn(),animation.showMenuOnly("menu"))};