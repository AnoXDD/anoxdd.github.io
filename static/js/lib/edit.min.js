/*v4.3.0 Build 090515_1533 Minified 101015.201941*/
window.edit={};edit.time=0;edit.intervalId=-1;edit.confirmVal="";edit.currentEditing=-1;edit.photos=[];edit.voices=[];edit.videos=[];edit.mediaIndex={};edit.isEditing=-1;edit.isFolder=false;edit.folderDate="";edit.isEditPaneDisplayed=false;edit.autoCorrectTags={"thought":"thoughts","mc":"minecraft","pool":"snooker"};edit.removalList={};edit.localChange=[];edit.isProcessing=false;edit.init=function(overwrite,index){var i; app.audioPlayer.quit();app.videoPlayer.quit(); app.videoPlayer.height="-webkit-calc(100% - 32px)";edit.editView=_.template($("#edit-view").html());var data; if(localStorage["_cache"]){ if(overwrite===true){edit.cleanEditCache();if(index!=undefined&&index!==-1){ data=journal.archive.data[app.year][index];if(data["time"]){if(data["time"]["created"]){localStorage["created"]=data["time"]["created"];}if(data["time"]["start"]){localStorage["start"]=data["time"]["start"];}}}}else if(overwrite===false){ if(localStorage["created"]){index=edit.find(localStorage["created"]);if(index!==-1){data=journal.archive.data[app.year][index];}}else{;}}else if(overwrite==undefined){ animation.warn(log.OVERWRITE_CACHE_WARNING);animation.testAllSubs();return;}}else{if(index!=undefined){data=journal.archive.data[app.year][index];}} data=edit.data=data||edit.newContent();if(localStorage["start"]||localStorage["created"]){localStorage["start"]=localStorage["start"]||localStorage["created"];} localStorage["_cache"]=1;edit.mediaIndex={place:-1,music:-1,book:-1,movie:-1,weblink:-1,video:-1,voice:-1};edit.isEditing=-1;edit.isFolder=false;edit.folderDate=""; data=edit.importCache(data); edit.photos=[];edit.videos=[];edit.voices=[];var processGroup=["video","voice"];for(var h=0;h!==processGroup.length;++h){var dataGroup;if(processGroup[h]==="video"){dataGroup=edit.videos;}else if(processGroup[h]==="voice"){dataGroup=edit.voices;}else{break;}if(data[processGroup[h]]){for(i=0;i!==data[processGroup[h]].length;++i){var name=data[processGroup[h]][i]["fileName"];if(journal.archive.map[name]){dataGroup.push({name:name,title:data[processGroup[h]][i]["title"],size:journal.archive.map[name]["size"],id:journal.archive.map[name]["id"],resource:true,change:false});}}}}console.log(Object.keys(data));var editPane=$(edit.editView(data)); $("#search-new, #search-result").fadeOut(); $("#contents").fadeOut(400,function(){var i;$("#edit-pane").html(editPane).fadeIn();edit.isEditPaneDisplayed=true; $("#photo-preview").hide(); $("#entry-header").bind("keyup","return",function(){edit.saveTitle(); $("#entry-body").focus();}).bind("keyup","ctrl+return",function(){ edit.saveTitle();edit.notAddHeader=true; $("#entry-body").focus();}).blur(function(){ if(edit.notAddHeader){ edit.notAddHeader=false;}else{ var dateStr=$(this).val().substring(0,6),date;if(!isNaN(parseInt(dateStr))){var dateNum=edit.convertTime(dateStr); date=new Date(dateNum);var isMonthMatch=date.getMonth()+1==dateStr.substring(0,2),isDayMatch=date.getDate()==dateStr.substring(2,4),isYearMatch=date.getFullYear()%100==dateStr.substring(4,6)&&date.getFullYear()===app.year;if(isMonthMatch&&isDayMatch&&isYearMatch){ return;}} date=new Date().getTime();date=new Date(date-14400000);$(this).val(edit.format(date.getMonth()+1)+edit.format(date.getDate())+edit.format(date.getFullYear()%100)+" "+$(this).val());}}); $("#entry-tag").keyup(function(n){if(n.keyCode===13){edit.addTag(); $("#entry-tag").val("");}}); $("#attach-area .texttags .other p").click(function(){edit.removeTag($(this).text().substring(1));}); $("#entry-time-wrap").mouseover(function(){var created=parseInt(localStorage["created"])||data["time"]["created"],start=parseInt(localStorage["start"])||data["time"]["start"],end=parseInt(localStorage["end"])||data["time"]["end"],convertTime=function(date){date=new Date(date);if(!isNaN(date.getTime())){return edit.format(date.getMonth()+1)+edit.format(date.getDate())+edit.format(date.getFullYear()%100)+" "+edit.format(date.getHours())+edit.format(date.getMinutes());}else{return"-";}};$("#entry-time-created").html(convertTime(created));$("#entry-time-start").html(convertTime(start));$("#entry-time-end").html(convertTime(end));}); var elem=["music","book","movie"];for(i=0;i!==elem.length;++i){var medium=elem[i];for(var j=0;j!==$("#attach-area ."+medium).length;++j){var selectorHeader=edit.getSelectorHeader(medium,j),term=$(selectorHeader+".title").val()+"%20"+$(selectorHeader+".desc").val();getCoverPhoto(selectorHeader,term,false,medium);}}if(localStorage["title"]){$("#entry-header").val(localStorage["title"]);}if(localStorage["body"]){$("#entry-body").text(localStorage["body"]);} if(localStorage["coverType"]){var cover=-1;switch(parseInt(localStorage["coverType"])){case 128:++cover;case 16:++cover;case 32:++cover;case 4:++cover;case 8:++cover;case 64:++cover;case 2:++cover;case 1:++cover;default:}edit.coverSet(cover);} var tagsHtml=app.tag().getIconsInHtml(),tagsName=app.tag().getIconsInName(),iconTags=app.tag().separate(localStorage["tags"]).iconTags;for(i=0;i!==tagsHtml.length;++i){var parent="#attach-area .icontags";if(tagsHtml[i].charAt(0)==="w"){parent+=" .weather";}else if(tagsHtml[i].charAt(0)==="e"){parent+=" .emotion";}else{parent+=" .unselected";} $(parent).append("<span class='icons "+tagsHtml[i]+"' title="+tagsName[i].capitalize()+" onclick=edit.toggleTag('"+tagsName[i]+"',true)></span>");}for(i=0;i!==tagsHtml.length;++i){if(iconTags.indexOf(tagsHtml[i])!==-1){edit.toggleIcon(tagsName[i]);}} $("#entry-body").bind("keyup","return",function(){ var start=$(this).get(0).selectionStart,end=$(this).get(0).selectionEnd,body=$(this).val(),lastReturn=body.lastIndexOf("\n",start-2),lastTab=body.lastIndexOf("\t",start-2);if(lastReturn<lastTab){ var newBody;if(lastTab===start-2){newBody=body.substring(0,lastReturn+1);start=lastReturn;}else{newBody=body.substring(0,start); for(i=lastReturn+1;i!==lastTab+1&&body[i]==="\t";++i){newBody+="\t";}}newBody+=body.substring(end);$(this).val(newBody); $(this).get(0).selectionStart=$(this).get(0).selectionEnd=start+1;}edit.processBody();}).bind("keyup","space",function(){edit.refreshSummary();}).bind("keydown","tab",function(e){e.preventDefault();var start=$(this).get(0).selectionStart,end=$(this).get(0).selectionEnd; $(this).val($(this).val().substring(0,start)+"\t"+$(this).val().substring(end)); $(this).get(0).selectionStart=$(this).get(0).selectionEnd=start+1;}).bind("keyup","ctrl+shift+f",function(){edit.toggleTag("friendship");}).bind("keyup","alt+ctrl+r",function(){edit.toggleTag("relationship");}).bind("keyup","alt+ctrl+i",function(){edit.toggleTag("ingress");}).bind("keyup","alt+ctrl+t",function(){edit.toggleTag("thoughts");}).bind("keyup","alt+ctrl+j",function(){edit.toggleTag("journal");}).bind("keyup","alt+ctrl+m",function(){edit.toggleTag("minecraft");}); $("#edit-pane #attach-area .icontags .other, #edit-pane #attach-area .texttags .other, #edit-pane #attach-area .images").mousewheel(function(event,delta){ this.scrollLeft-=(delta*50);event.preventDefault();}); edit.playableSetToggle();edit.refreshSummary();});animation.showMenuOnly("add");edit.intervalId=setInterval(edit.refreshTime,1000);};edit.quit=function(selector,save){if(network.isAjaxActive){ animation.warning(log.NETWORK_WORKING);return;}clearInterval(edit.intervalId);edit.time=0;edit.mediaIndex={};edit.localChange=[];if(save){ edit.save(selector);}else{animation.debug(log.EDIT_PANE_QUIT);}edit.photos=[];edit.removalList={}; edit.cleanupMediaEdit(); $("#search-new, #search-result").fadeIn();$("#edit-pane").fadeOut(400,function(){edit.isEditPaneDisplayed=false; $("#edit-pane").html("");$("#contents").fadeIn(); app.refresh();animation.showMenuOnly("edit");}); edit.cleanEditCache(); animation.testCacheIcons(); app.videoPlayer.height=undefined;delete localStorage["_cache"];};edit.save=function(){if(network.isAjaxActive){ animation.warn(log.NETWORK_WORKING);return;}var id;animation.log(log.EDIT_PANE_SAVE_START,1);network.init(3);if(animation.isShown("#action-remove-confirm")){ animation.debug(log.EDIT_PANE_SAVE_PENDING_ATTACHMENTS);edit.confirm();}edit.processRemovalList(); edit.photoSave(function(){network.init();edit.playableSave(1,function(){network.init();edit.playableSave(3,function(){network.init();clearInterval(id);var index=edit.find(localStorage["created"]);edit.saveTitle();edit.processBody();edit.exportCache(index);edit.sortArchive();edit.removeDuplicate();journal.archive.data[app.year]=edit.minData();edit.saveDataCache();$("#add-save-local").html("&#xf0c7").attr({onclick:"edit.save()",href:"#"}); animation.finished("#add-save-local");animation.log(log.EDIT_PANE_SAVE_END,-1);network.destroy(); uploadSingleFile();});});});};edit.processRemovalList=function(){for(var key=0;key<edit.removalList.length;++key){if(localStorage[key]){var data=JSON.parse(localStorage[key]);for(var i=0;i<edit.removalList[key].length;++i){data.splice(edit.removalList[key][i],1);}localStorage[key]=JSON.stringify(data);}}};edit.importCache=function(data){ if(localStorage["title"]){data["title"]=localStorage["title"];}else if(data["title"]){localStorage["title"]=data["title"];} if(localStorage["body"]){if(!data["text"]){data["text"]={};}data["text"]["body"]=localStorage["body"];}else{if(data["text"]){if(data["text"]["body"]){localStorage["body"]=data["text"]["body"];}}} localStorage["created"]=data["time"]["created"]; if(localStorage["tags"]){data["tags"]=localStorage["tags"];}else{localStorage["tags"]=data["tags"]?data["tags"]:"";} var elem=["images","video","voice","place","music","book","movie","weblink"];for(var i=0;i!==elem.length;++i){var medium=elem[i];if(localStorage[medium]){data[medium]=JSON.parse(localStorage[medium]);}else{localStorage[medium]=data[medium]?JSON.stringify(data[medium]):"[]";}} localStorage["coverType"]=data["coverType"]||0; return data;};edit.exportCache=function(index){var data=journal.archive.data[app.year][index]||{}; data=edit.exportCacheBody(data); data["processed"]=0; data["title"]=localStorage["title"]||"Untitled";data["coverType"]=parseInt(localStorage["coverType"]);if(data["coverType"]<=0){data["coverType"]=edit.coverAuto();}if(!data["attachments"]){data["attachments"]=0;}data["tags"]=localStorage["tags"]||"";var media,elem=["images","video","music","voice","book","movie","place","weblink"],attach=0;for(var i=0;i<elem.length;++i){media=localStorage[elem[i]]?JSON.parse(localStorage[elem[i]]):[];for(var j=0;j<media.length;++j){if(!media[j]||media[j]["title"]==""){ media.splice(j--,1);}}data[elem[i]]=media.length==0?undefined:media;if(media.length==0){ data[elem[i]]=undefined;}else{ attach=attach|Math.pow(2,i);data[elem[i]]=media;}}data["attachments"]=attach;if(index<0){ journal.archive.data[app.year].push(data);}else{ journal.archive.data[app.year][index]=data;app.currentDisplayed=-1;}};edit.exportCacheBody=function(data){if(!data["time"]){data["time"]={};}data["time"]["created"]=parseInt(localStorage["created"]); var timeGroup=["cretaed","start","end"];for(var i=0;i!==timeGroup.length;++i){if(localStorage[timeGroup[i]]==="undefined"){delete localStorage[timeGroup[i]];}}if(edit.data&&localStorage){data["time"]["created"]=parseInt(localStorage["created"])||data["time"]["created"];data["time"]["start"]=parseInt(localStorage["start"])||data["time"]["start"];data["time"]["end"]=parseInt(localStorage["end"])||data["time"]["end"];} if(!data["text"]){data["text"]={};}var body=localStorage["body"]; body=body||""; while(body[body.length-1]==="\n"){body=body.substr(0,body.length-1);}data["text"]["body"]=body;data["text"]["chars"]=body.length;data["text"]["lines"]=body.split(/\r*\n/).length;data["text"]["ext"]=body.substring(0,50);return data;};edit.cleanEditCache=function(){delete localStorage["_cache"];var deleteList=["title","body","created","currentEditing","tags","place","music","movie","book","images","weblink","video","voice","start","end"];for(var i=0;i!==deleteList.length;++i){delete localStorage[deleteList[i]];}edit.photos=[];edit.voices=[];edit.videos=[];};edit.saveDataCache=function(){if(app.year===new Date().getFullYear()){ localStorage["archive"]=JSON.stringify(journal.archive.data[app.year]);localStorage["lastUpdated"]=new Date().getTime();}};edit.removeDataCache=function(){delete localStorage["archive"];};edit.tryReadCache=function(){if(localStorage["archive"]){ journal.archive.data[new Date().getFullYear()]=JSON.parse(localStorage["archive"]);app.refresh();}};edit.find=function(created){for(var key=0,len=journal.archive.data[app.year].length;key!=len;++key){if(journal.archive.data[app.year][key]){if(journal.archive.data[app.year][key]["time"]){if(journal.archive.data[app.year][key]["time"]["created"]==created){return key;}}}} return-1;};edit.newContent=function(){var dict={}; dict["time"]={};dict["time"]["created"]=new Date().getTime();dict["tags"]=""; var elem=["images","video","voice","place","music","book","movie","weblink","iconTags","textTags"];for(var i=0;i!==elem.length;++i){dict[elem[i]]=undefined;}return dict;};edit.minData=function(){var tmp=journal.archive.data[app.year].filter(function(key){return key!=undefined;});for(var key=0,len=tmp.length;key!==len;++key){delete tmp[key]["attached"];delete tmp[key]["contents"];delete tmp[key]["chars"];delete tmp[key]["datetime"];delete tmp[key]["endtime"];delete tmp[key]["ext"];delete tmp[key]["index"];delete tmp[key]["iconTags"];delete tmp[key]["lines"];delete tmp[key]["month"];delete tmp[key]["processed"];delete tmp[key]["summary"];delete tmp[key]["textTags"];delete tmp[key]["type"]; var i;for(i=0;i<tmp[key].length;++i){if(tmp[key][i]==undefined||tmp[key][i]=="undefined"){ tmp[key].splice(i--,1);}} var groups=["movie","music"];for(i=0;i!==groups.length;++i){if(tmp[key][groups[i]]){var keys=Object.keys(tmp[key][groups[i]]);for(var j=0;j!==keys.length;++j){delete tmp[key][groups[i]][keys[j]]["thumb"];}}}tmp[key]["text"]["body"]=tmp[key]["text"]["body"].replace(/\r\n/g,"\n");};return tmp;};edit.sortArchive=function(){journal.archive.data[app.year].sort(function(a,b){ return b["time"]["created"]-a["time"]["created"];});};edit.removeDuplicate=function(){for(var i=0;i<Object.keys(journal.archive.data[app.year]).length-1;++i){if(journal.archive.data[app.year][i]["time"]["created"]===journal.archive.data[app.year][i+1]["time"]["created"]){ app.yearChange[app.year]=true;journal.archive.data[app.year].splice(i--,1);}}};edit.undo=function(){};edit.change=function(key,value){};edit.removeEntry=function(){ if(app.currentDisplayed==-1){animation.error(log.NO_ENTRY_SELECTED);animation.deny("#delete");return;} app.yearChange[app.year]=true;$("#year-change").addClass("change");--app.displayedNum;var data=journal.archive.data[app.year][app.currentDisplayed];app.displayedChars-=data["text"]["chars"];app.displayedLines-=data["text"]["lines"];app.displayedTime-=(data["time"]["end"]-data["time"]["start"])/60000; delete journal.archive.data[app.year][app.currentDisplayed]; var $entry=$("#list ul li:nth-child("+(app.currentDisplayed+1)+")");if($entry.next().length===0||$entry.next().has("p.separator").length!==0){$entry.fadeOut(500,function(){$(this).empty();});}else{ $entry.children("a").fadeOut(500,function(){$(this).remove();});}app.detail.prototype.hideDetail();$(".loadmore").trigger("click"); edit.saveDataCache();animation.showMenuOnly("edit");};edit.addMedia=function(typeNum,arg){var selectorHeader="#attach-area ."+edit.mediaName(Math.abs(typeNum)),length=$(selectorHeader).length,htmlContent;switch(typeNum){case 0: edit.photo(); return;case 1: edit.videoSearch();break;case-1: htmlContent="<div class=\"video data change\"><a class='"+arg["fileName"]+"' onclick=\"edit.video("+length+",'"+arg["url"]+"')\" title=\"View\"><div class=\"thumb\"><span></span></div><input disabled class=\"title\" value=\""+arg["title"]+"\" /></a></div>";break;case 2: htmlContent="<div class=\"place\"><a title=\"Edit\" onclick=\"edit.location("+length+")\" href=\"#\"><div class=\"thumb\"></div><input disabled title=\"Place\" class=\"title place-search\" autocomplete=\"off\"/><input disabled title=\"Latitude\" class=\"desc latitude\" autocomplete=\"off\" /><p>,</p><input disabled title=\"Longitude\" class=\"desc longitude\" autocomplete=\"off\" /></a></div>";break;case 3: edit.voiceSearch();break;case-3: htmlContent="<div class=\"voice data change\"><a class='"+arg["fileName"]+"' onclick=\"edit.voice("+length+",'"+arg["url"]+"')\" title=\"View\"><div class=\"thumb\"><span></span></div><input disabled class=\"title\" value=\""+arg["title"]+"\" /></a></div>";break;case 4: htmlContent="<div class=\"music\"><a title=\"Edit\" onclick=\"edit.music("+length+")\" href=\"#\"><img class=\"thumb\"><span></span><input disabled class=\"title\" placeholder=\"Track name\" autocomplete=\"off\" /><input disabled class=\"desc\" placeholder=\"Artist\" autocomplete=\"off\" /></a></div>";break;case 5: htmlContent="<div class=\"movie\"><a title=\"Edit\" onclick=\"edit.movie("+length+")\" href=\"#\"><img class=\"thumb\"><span></span><input disabled class=\"title\" placeholder=\"Movie title\" autocomplete=\"off\" onclick=\"this.select()\" /><input disabled class=\"desc\" placeholder=\"Director\" autocomplete=\"off\" onclick=\"this.select()\" /></a></div>";break;case 6: htmlContent="<div class=\"book\"><a title=\"Edit\" onclick=\"edit.book("+length+")\" href=\"#\"><img class=\"thumb\"><span></span><input disabled class=\"title\" placeholder=\"Book title\" autocomplete=\"off\" onclick=\"this.select()\" /><input disabled class=\"desc\" placeholder=\"Author\" autocomplete=\"off\" onclick=\"this.select()\" /></a></div>";break;case 7: htmlContent="<div class=\"weblink\"><a title=\"Edit\" onclick=\"edit.weblink("+length+")\" href=\"#\"><div class=\"thumb\"><span></span></div><input disabled class=\"title\" placeholder=\"Title\" /><input disabled class=\"desc\" placeholder=\"http://\" /></a></div>";break;default:return;}if(length>0){ $(htmlContent).insertAfter($(selectorHeader+":eq("+(length-1)+")"));}else{ $(htmlContent).appendTo("#attach-area");}if(typeNum>0){ $(selectorHeader+":eq("+length+") a").trigger("click");}};edit.removeMedia=function(typeNum){var type=edit.mediaName(typeNum);edit.coverTest(type); switch(typeNum){case 1: case 3: break;default: edit.addToRemovalList(type);}edit.cleanupMediaEdit();};edit.addMediaFromQueue=function(){ $("#return-lost-media").removeAttr("onclick");animation.log(log.QUEUE_START,1);network.init(1);edit.photo(true,function(){network.next();getTokenCallback(function(token){var url="https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/queue:/children?select=id,name,size,@content.downloadUrl&access_token="+token;$.ajax({type:"GET",url:url}).done(function(data,status,xhr){var i=0;var itemList=data["value"],addedVoice=0,addedVideo=0; for(var key=0,len=itemList.length;key!==len;++key){var id=itemList[key]["id"],size=itemList[key]["size"],name=itemList[key]["name"],contentUrl=itemList[key]["@content.downloadUrl"],suffix=name.substring(name.length-4).toLowerCase(),elementData={id:id,name:name,title:name.substring(0,name.length-4),url:contentUrl,size:size,resource:false,change:true},newContent=true; if(suffix===".mp4"){ for(i=0;i!==edit.videos.length;++i){if(edit.videos[i]["size"]===size){newContent=false;break;}}if(!newContent){continue;}++addedVideo;edit.videos.push(elementData); edit.addMedia(-1,{fileName:name,url:contentUrl,title:name.substring(0,name.length-4)});}else if(suffix===".mp3"||suffix===".wav"){ for(i=0;i!==edit.voices.length;++i){if(edit.voices[i]["size"]===size){newContent=false;break;}}if(!newContent){continue;}++addedVoice;edit.voices.push(elementData); edit.addMedia(-3,{fileName:name,url:contentUrl,title:name.substring(0,name.length-4)});}} edit.playableSetToggle();if(addedVideo>0){animation.debug(addedVideo+log.QUEUE_FOUND_VIDEOS);}if(addedVoice>0){animation.debug(addedVoice+log.QUEUE_FOUND_VOICES);}}).fail(function(xhr,status,error){animation.error(log.QUEUE_FAILED,error);}).always(function(){ $("#return-lost-media").attr("onclick","app.cleanResource()");animation.log(log.QUEUE_END,-1);});});});};edit.addToRemovalList=function(name,index){if(!edit.removalList[name]){edit.removalList[name]=[];}if(index==undefined){index=edit.mediaIndex[name];}var selectorHeader=edit.getSelectorHeader(name,index); $(selectorHeader).fadeOut();if(edit.removalList[name].indexOf(index)!==-1){ edit.removalList[name].push(index);}};edit.mediaName=function(typeNum){switch(typeNum){case 0:return"photo";case 1:return"video";case 2:return"place";case 3:return"voice";case 4:return"music";case 5:return"movie";case 6:return"book";case 7:return"weblink";default:return"";}};edit.mediaValue=function(type){if(type==="photo")return 0;if(type==="video")return 1;if(type==="place")return 2;if(type==="voice")return 3;if(type==="music")return 4;if(type==="movie")return 5;if(type==="book")return 6;if(type==="weblink")return 7;  return-1;}; edit.setRemove=function(typeVal){edit.confirmVal=typeVal;if(typeVal===2){$("#pin-point").removeClass("hidden");}$("#action-remove-confirm").removeClass("hidden");};edit.cleanupMediaEdit=function(){$("#edit-pane").off("keyup");switch(edit.isEditing){case 1:edit.videoHide();break;case 2:edit.locationHide();break;case 3:edit.voiceHide();break;case 4:edit.musicHide();break;case 5:edit.movieHide();break;case 6:edit.bookHide();break;case 7:edit.weblinkHide();}};edit.getSelectorHeader=function(type,index){if(index==undefined){return"#attach-area ."+type+":eq("+edit.mediaIndex[type]+") ";}return"#attach-area ."+type+":eq("+index+") ";};edit.toggleLight=function(){$("#text-area").toggleClass("dark").children().toggleClass("dark");};edit.fullScreen=function(){ edit.cleanupMediaEdit(); $(window).off("resize");$("#app").css("height","inherit"); animation.showMenuOnly("fullscreen"); $(".header").fadeOut(400);$("#attach-area").fadeOut(400);$("body").addClass("fullscreen"); if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}};edit.windowMode=function(){ $("#text-area").removeClass("dark").children().removeClass("dark"); animation.showMenuOnly("add"); $(".header").fadeIn(400,function(){});$("body").removeClass("fullscreen");$("#attach-area").fadeIn(); app.layout(); if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}};edit.saveTitle=function(){localStorage["title"]=$("#entry-header").val();};edit.refreshSummary=function(){var text=$("#entry-body").val(),len=text.length;$("#entry-char").text(len);$("#entry-line").text(text.split(/\r*\n/).length);};edit.refreshTime=function(){++edit.time;var date=new Date();var timeString=edit.format(date.getMonth()+1)+edit.format(date.getDate())+edit.format(date.getFullYear()%100)+" "+edit.format(date.getHours())+edit.format(date.getMinutes());$("#entry-time").text(timeString);$("#entry-elapsed").text(parseInt(edit.time/60)+":"+edit.format(edit.time%60));};edit.format=function(n){return n<10?"0"+n:n;};edit.convertTime=function(time){var month=parseInt(time.substring(0,2)),day=parseInt(time.substring(2,4)),year=parseInt(time.substring(4,6)),hour=0,minute=0;if(time.length>6){hour=parseInt(time.substring(7,9)),minute=parseInt(time.substring(9,11));}date=new Date(2000+year,month-1,day,hour,minute);return date.getTime();};edit.getDate=function(callback){var dateStr; if(localStorage["title"]){ dateStr=parseInt(localStorage["title"]);if(!isNaN(dateStr)){dateStr=dateStr.toString();if(dateStr.length===5){dateStr="0"+dateStr;}if(dateStr.length!==6){ dateStr="";}}}if(!dateStr){var date;if(localStorage["created"]){ date=new Date(parseInt(localStorage["created"]));}else{ date=new Date().getTime();date=new Date(date-14400000);}dateStr=""+edit.format(date.getMonth()+1)+edit.format(date.getDate())+edit.format(date.getFullYear()%100);} if(dateStr!=edit.folderDate){ createDateFolder(dateStr,callback);}else{callback(dateStr);}return dateStr;};edit.getMyTime=function(timeNum){var date=new Date(timeNum);if(isNaN(date.getTime())){return timeNum;}return""+edit.format(date.getMonth()+1)+edit.format(date.getDate())+edit.format(date.getFullYear()%100)+" "+edit.format(date.getHours())+edit.format(date.getMinutes());};edit.processBody=function(){ var lines=$("#entry-body").val().split(/\r*\n/);for(var i=0;i<lines.length;++i){var line=lines[i],flag=false,convertedTime;if(line.substring(0,7)==="Begin @"){convertedTime=edit.convertTime(line.substring(8));if(convertedTime&&new Date(convertedTime).getFullYear()===app.year){ localStorage["start"]=convertedTime;animation.log(log.START_TIME_CHANGED_TO+app.list.prototype.date(convertedTime));}else{ animation.error(log.TIME_NOT_IN_RANGE);}flag=true;}else if(line.substring(0,5)==="End @"){ convertedTime=edit.convertTime(line.substring(6));if(convertedTime){localStorage["end"]=convertedTime;animation.log(log.END_TIME_CHANGED_TO+app.list.prototype.date(convertedTime));}else{ animation.error(log.TIME_INVALID);}flag=true;}else if(line.substring(0,9)==="Created @"){convertedTime=edit.convertTime(line.substring(10));if(new Date(convertedTime).getFullYear()===app.year){ localStorage["created"]=convertedTime;animation.log(log.CREATED_TIME_CHANGED_TO+app.list.prototype.date(convertedTime));}else{ animation.error(log.TIME_NOT_IN_RANGE);}flag=true;}else if(line.length>2&&line.charAt(0)==="#"){ edit.addTag(line.substring(1).toLowerCase());flag=true;}if(flag){ lines.splice(i--,1);}}var newBody=lines.join("\r\n");$("#entry-body").val(newBody); localStorage["body"]=newBody;};edit.addTag=function(tag,mute){ tag=edit.autoCorrectTags[tag]||tag; tag=tag||$("#entry-tag").val().toLowerCase().replace(/\|/g,"");tag=tag.replace(/ /g,""); if(localStorage["tags"].split("|").indexOf(tag)!==-1){ animation.warn(log.TAG_ADD_HEADER+tag+log.TAG_ADDED_ALREADY);$("#entry-tag").effect("highlight",{color:"#000"},400);}else{var found=false,added=false; $("#attach-area .icontags span").each(function(){if($(this).attr("title").toLowerCase()===tag){ found=true;var parent=$(this).parent().attr("class");if(parent==="weather"||parent==="emotion"){ if($(this).hasClass("hidden")){ animation.warn(log.TAG_ICON_ADD_HEADER+tag+log.TAG_ADDED_FAILED); if($("#entry-tag").val()!==""){$("#entry-tag").effect("highlight",{color:"#000"},400);}return;}} if(!$(this).hasClass("highlight")){if(!mute){animation.log(log.TAG_ICON_ADD_HEADER+tag+log.TAG_ADDED);}edit.toggleIcon(tag);added=true;}else{animation.warn(log.TAG_ICON_ADD_HEADER+tag+log.TAG_ADDED_ALREADY); if($("#entry-tag").val()!==""){$("#entry-tag").effect("highlight",{color:"#000"},400);}}}});if(!found){ $("#entry-tag").effect("highlight",{color:"#dadada"},400); var func="onclick=edit.removeTag('"+tag+"')";$("#attach-area .texttags .other").append("<p title='Click to remove' "+func+">#"+tag+"</p>");added=true;} if(added){ if(localStorage["tags"]){ localStorage["tags"]+="|"+tag;}else{ localStorage["tags"]=tag;}}}};edit.removeTag=function(tag,mute){var tagArray=localStorage["tags"].split("|");for(var i=0;i!==tagArray.length;++i){if(tagArray[i]===tag){ var removed=false;$("#attach-area .texttags p").each(function(){if($(this).text()==="#"+tag){$(this).animate({width:"0"},function(){$(this).remove();removed=true;});}});if(!removed){var found=false; $("#attach-area .icontags .highlight").each(function(){if(!found){if($(this).attr("title").toLowerCase()===tag){if(!mute){animation.log(log.TAG_ICON_ADD_HEADER+tag+log.TAG_REMOVED);}edit.toggleIcon(tag);found=true;}}});} tagArray.splice(i,1);localStorage["tags"]=tagArray.join("|");return;}}};edit.toggleTag=function(tag,mute){if(localStorage["tags"].split("|").indexOf(tag)!==-1){ edit.removeTag(tag,mute);}else{ edit.addTag(tag,mute);}};edit.toggleIcon=function(tag){var htmlName=app.tag().getHtmlByName(tag),selector="#attach-area .icontags span."+htmlName,parent=$(selector).parent().attr("class");if($(selector).toggleClass("highlight").hasClass("highlight")){if(parent==="weather"||parent==="emotion"){ $("#attach-area .icontags ."+parent+" span:not(."+htmlName+")").addClass("hidden");}else{$("#attach-area .icontags .selected").append($(selector).addClass("highlight").clone());}}else{if(parent==="weather"||parent==="emotion"){ $("#attach-area .icontags ."+parent+" span").removeClass("hidden");}else{setTimeout(function(){$("#attach-area .icontags .selected ."+htmlName).remove();},400);}}};edit.coverSet=function(type,isToggle){var coverType,typeNum=type;if(typeof(type)=="string"){typeNum=edit.mediaValue(type);}switch(typeNum){case 0:coverType=1;break;case 1:coverType=2;break;case 2:coverType=64;break;case 3:coverType=8;break;case 4:coverType=4;break;case 5:coverType=32;break;case 6:coverType=16;break;case 7:coverType=128;break;default:coverType=0;} $(".types p").removeClass("hidden selected");if(isToggle&&localStorage["coverType"]==coverType){localStorage["coverType"]=coverType=-1;}else{localStorage["coverType"]=coverType;var name=edit.mediaName(typeNum);$(".types p:not(#"+edit.mediaName(typeNum)+"-cover)").addClass("hidden");if(name){$(".types #"+edit.mediaName(typeNum)+"-cover").addClass("selected");}else{ $(".types #no-cover").addClass("selected");}}return coverType;};edit.coverAuto=function(typeList){var priority=["images","music","book","movie","video","voice","weblink","place"];typeList=typeList||edit.coverRefresh();for(var i=0;i!==priority.length;++i){if(typeList.indexOf(priority[i])!==-1){ return edit.coverSet(priority[i]);}} edit.coverSet(-1);animation.log(log.COVERTYPE_AUTO_CHOSEN);};edit.coverRefresh=function(){var elem=["images","video","voice","place","music","book","movie","weblink"],ret=[];for(var i=0;i!==elem.length;++i){ if(elem[i]in localStorage){ if(localStorage[elem[i]].length!==0){ try{if(Object.keys(JSON.parse(localStorage[elem[i]])).length!==0){ ret.push(elem[i]);}}catch(e){}}}}return ret;};edit.coverTest=function(type){var has=false; $("#attach-area ."+type).each(function(){if($(this).css("display")!=="none"){ has=true;}});if(!has){ $("#attach-area .types #"+type+"-cover").trigger("click");}};edit.photo=function(isQueue,callback){ if(typeof callback!="function"){callback=function(){};}if(edit.photos.length!==0&&!isQueue){ animation.error(log.EDIT_PANE_IMAGES_ALREADY_LOADED);return;} var images=JSON.parse(localStorage["images"]);if(images.length){if(Object.keys(journal.archive.map).length===0){ animation.error(log.EDIT_PANE_IMAGES_FAIL+log.DOWNLOAD_PROMPT);animation.deny("#add-photo");return;}} var addQueue=false;if($("#attach-area .images").css("height")!=="100px"&&isQueue){ addQueue=true;isQueue=false;} $("#attach-area .images").css({height:"100px"}).hover(function(){ edit.cleanupMediaEdit();$("#photo-preview").css("opacity","initial").show({effect:"fade",duration:200});},function(){ $("#photo-preview").hide({effect:"fade",duration:200});}).sortable({containment:"#attach-area .images",cursor:"crosshair",revert:true}).disableSelection(); var processFunc=function(dateStr){getTokenCallback(function(token){var url;if(isQueue){url="https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/queue:/children?select=id,name,size,@content.downloadUrl&access_token="+token;}else{url=getDataUrlHeader()+"/"+dateStr+":/children?select=id,name,size,@content.downloadUrl&access_token="+token;}$.ajax({type:"GET",url:url}).done(function(data){if(data["@odata.nextLink"]&&!isQueue){animation.warn(log.EDIT_PANE_TOO_MANY_RESULTS);}var itemList=data["value"],added=0;for(var key=0,len=itemList.length;key!==len;++key){var size=itemList[key]["size"],id=itemList[key]["id"],name=itemList[key]["name"],suffix=name.substring(name.length-4).toLowerCase(),found=false;if(suffix!==".jpg"&&suffix!==".png"){ continue;} for(var i=0,tmp=edit.photos;i!==tmp.length;++i){if(tmp[i]["size"]==size){found=true;break;}}if(found){ continue;}else{var photoData={name:name,id:id,url:itemList[key]["@content.downloadUrl"],size:size,resource:false,change:false};++added;edit.photos.push(photoData);}} var i;if(isQueue){ i=edit.photos.length-added;}else{i=0;}for(;i!==edit.photos.length;++i){var htmlContent;if(isQueue){ htmlContent="<div class=\"queue\">";}else{if(edit.photos[i]["resource"]){ htmlContent="<div class=\"resource\">";}else{htmlContent="<div class=\"data\">";}}htmlContent+="<span></span><img src=\""+edit.photos[i]["url"]+"\"/></div>";$("#attach-area .images").append(htmlContent);} $("#add-photo").html("&#xf03e").attr({onclick:"edit.addMedia(0)",href:"#"}).fadeIn(); $("#attach-area .images div").each(function(){ $(this).off("contextmenu");$(this).on("contextmenu",function(){ $(this).toggleClass("change"); return false;});});$("#attach-area .images img").each(function(){$(this).unbind("mouseenter mouseleave").hover(function(){ $("#photo-preview img").animate({opacity:1},200).attr("src",$(this).attr("src"));},function(){ $("#photo-preview img").animate({opacity:0},0);});});if(isQueue){animation.debug(added+log.QUEUE_FOUND_IMAGES);}else{edit.setRemove(0); if(edit.photos.length===0){animation.log(log.EDIT_PANE_IMAGES_END_NO_RESULT,-1);}else{animation.log(log.EDIT_PANE_IMAGES_END,-1);}animation.finished("#add-photo");}}).fail(function(xhr,status,error){if(!isQueue){$("#add-photo").html("&#xf03e").attr({onclick:"edit.addMedia(0)",href:"#"}); if(error==="Not Found"&&!addQueue){ animation.error(log.EDIT_PANE_IMAGES_FAIL+log.EDIT_PANE_IMAGES_FIND_FAIL+dateStr,error,-1);animation.deny("#add-photo");}else{--animation.indent;}}}).always(function(){ if(addQueue){edit.photo(true,callback);}else{ callback();network.destroy();}});});};if(!isQueue){ $("#add-photo").removeAttr("onclick").removeAttr("href"); edit.photos=[]; for(var i=0;i<images.length;++i){var name=images[i]["fileName"];if(journal.archive.map[name]){var image={name:name,id:journal.archive.map[name]["id"],size:journal.archive.map[name]["size"],url:journal.archive.map[name]["url"],resource:true,change:false};edit.photos.push(image);}else{ images.splice(i--,1);localStorage["images"]=JSON.stringify(images);}}edit.getDate(function(dateStr){ animation.log(log.EDIT_PANE_IMAGES_START+dateStr+log.EDIT_PANE_IMAGES_START_END,1); processFunc(dateStr);});}else{ $("#attach-area .images .queue").each(function(){ for(var i=0;i!==edit.photos.length;++i){var url=$(this).children("img").attr("src");if(edit.photos[i]["url"]===url){ edit.photos.splice(i,1);break;}}$(this).remove();});processFunc();}};edit.photoSave=function(callback){if(edit.photos.length==0){ callback();return;}else{ var photoQueue=[],newImagesData=[];edit.getDate(function(timeHeader){ $("#attach-area .images div").each(function(){for(var i=0;i!==edit.photos.length;++i){if($(this).children("img").attr("src")===edit.photos[i]["url"]){ edit.photos[i]["change"]=$(this).hasClass("change");break;}}}); for(var i=0;i!==edit.photos.length;++i){var name=edit.photos[i]["name"],id=edit.photos[i]["id"],resource=edit.photos[i]["resource"];if(edit.photos[i]["change"]){ edit.photos[i]["change"]=false;photoQueue.push({name:name,id:id, resource:!resource});}} var resourceDir="/drive/root:/Apps/Journal/resource/"+app.year,contentDir="/drive/root:/Apps/Journal/data/"+app.year+"/"+timeHeader,processingPhoto=0;if(photoQueue.length!==0){ getTokenCallback(function(token){animation.log(log.EDIT_PANE_IMAGES_SAVE_START,1);for(var i=0;i!==photoQueue.length;++i){var requestJson,newName,name=photoQueue[i]["name"],id=photoQueue[i]["id"],isToResource=photoQueue[i]["resource"],url="https://api.onedrive.com/v1.0/drive/items/"+id+"?select=id,name,size,@content.downloadUrl&access_token="+token;if(isToResource){ newName=timeHeader+(new Date().getTime()+i)+name.substring(name.length-4);requestJson={ name:newName,parentReference:{path:resourceDir}};}else{ newName=name;requestJson={parentReference:{path:contentDir}};}$.ajax({type:"PATCH",url:url,contentType:"application/json",data:JSON.stringify(requestJson)}).done(function(data,status,xhr){var id=data["id"],name=data["name"];for(var j=0;j!==edit.photos.length;++j){if(edit.photos[j]["id"]==id){edit.photos[j]["success"]=true;edit.photos[j]["name"]=name; journal.archive.map[data["name"]]={url:data["@content.downloadUrl"],size:data["size"],id:data["id"]};}}animation.debug((++processingPhoto)+log.EDIT_PANE_IMAGES_OF+photoQueue.length+log.EDIT_PANE_IMAGES_TRASNFERRED);}).fail(function(xhr,status,error){++processingPhoto;animation.error(log.EDIT_PANE_TRANSFERRED_FAILED+log.SERVER_RETURNS+error+log.SERVER_RETURNS_END);animation.warning("#add-photo");}).always(function(data,status,xhr){var j;if(processingPhoto===photoQueue.length){ $("#attach-area .images div").each(function(){$(this).removeClass("change"); for(j=0;j!==edit.photos.length;++j){if($(this).children("img").attr("src")===edit.photos[j]["url"]){if(edit.photos[j]["success"]){if(edit.photos[j]["resource"]){ $(this).addClass("data").removeClass("resource"); delete journal.archive.map[edit.photos[j]["name"]];}else{ $(this).addClass("resource").removeClass("queue data");}edit.photos[j]["resource"]=!edit.photos[j]["resource"];}break;}}}); for(j=0;j!==edit.photos.length;++j){edit.photos[j]["change"]=false;edit.photos[j]["success"]=false;} $("#attach-area .images img").each(function(){for(j=0;j!==edit.photos.length;++j){if(edit.photos[j]["url"]===$(this).attr("src")){if(edit.photos[j]["resource"]){newImagesData.push({fileName:edit.photos[j]["name"]});}}}});localStorage["images"]=JSON.stringify(newImagesData);animation.log(log.EDIT_PANE_FINISHED_TRANSFER+edit.mediaName(0)+log.EDIT_PANE_FINISHED_TRANSFER_END,-1);callback();}});}});}else{ $("#attach-area .images img").each(function(){for(j=0;j!==edit.photos.length;++j){if(edit.photos[j]["url"]===$(this).attr("src")){if(edit.photos[j]["resource"]){newImagesData.push({fileName:edit.photos[j]["name"]});}}}});localStorage["images"]=JSON.stringify(newImagesData); callback();}});}};edit.photoHide=function(){ $("#attach-area .images").animate({height:"0"}).fadeOut().html("");};edit.video=function(index,link){if(index==edit.mediaIndex["video"]||index==undefined){return;}edit.cleanupMediaEdit();edit.mediaIndex["video"]=index;var selectorHeader=edit.getSelectorHeader("video");edit.setRemove(1);edit.func=$(selectorHeader+"a").attr("onclick");$(selectorHeader+"a").removeAttr("onclick");$(selectorHeader+"input").prop("disabled",false); $("#edit-pane").keyup(function(n){if(n.keyCode===27){edit.videoHide();}});edit.isEditing=1; var source;if(link){source=link;$("#text-area #video-preview").fadeIn();app.videoPlayer("#text-area #video-preview",source);}else{ var fileName=$(selectorHeader+"a").attr("class");if(journal.archive.map[fileName]){source=journal.archive.map[fileName]["url"];if(source==undefined){animation.error(log.FILE_NOT_FOUND+$(selectorHeader+".title").val());return;}$("#text-area #video-preview").fadeIn();app.videoPlayer("#text-area #video-preview",source);}else{animation.error(log.FILE_NOT_LOADED+$(selectorHeader+".title")+log.DOWNLOAD_PROMPT);}}edit.setRemove(1);};edit.videoHide=function(){if(edit.mediaIndex["video"]<0){ return;}$("#text-area #video-preview").fadeOut();app.videoPlayer.quit();var selectorHeader=edit.getSelectorHeader("video"); $(selectorHeader+"input").prop("disabled",true).off("keyup"); if(edit.func){ $(selectorHeader+"a").attr("onclick",edit.func);edit.func=undefined;}else{$(selectorHeader+"a").attr("onclick","edit.video("+edit.mediaIndex["video"]+")");} edit.videoSave(edit.mediaIndex["video"]);$("#edit-pane").off("keyup"); animation.hideHiddenIcons();edit.mediaIndex["video"]=-1;edit.isEditing=-1;};edit.videoSave=function(index){var data=localStorage["video"],selectorHeader=edit.getSelectorHeader("video",index),title=$(selectorHeader+".title").val();data=data?JSON.parse(data):[];var newElem={title:title,fileName:$(selectorHeader+"a").attr("class")};data[index]=newElem;localStorage["video"]=JSON.stringify(data);};edit.videoSearch=function(){edit.playableSearch(1);};edit.location=function(index){if(index==edit.mediaIndex["place"]||index==undefined){return;}edit.cleanupMediaEdit(); edit.setRemove(2); edit.mediaIndex["place"]=index; $("#map-holder").fadeIn(); $("#pin-point").removeClass("hidden");var selectorHeader=edit.getSelectorHeader("place",index); if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){var latitude=parseFloat($(selectorHeader+".latitude").val())||position.coords.latitude,longitude=parseFloat($(selectorHeader+".longitude").val())||position.coords.longitude;pos=new google.maps.LatLng(latitude,longitude);mapOptions={zoom:15,center:pos,};map=new google.maps.Map(document.getElementById("map-selector"),mapOptions);searchBox=new google.maps.places.Autocomplete(document.getElementsByClassName("place-search")[edit.mediaIndex["place"]],{types:["geocode"]});markers=[];google.maps.event.clearListeners(searchBox,"place_changed");google.maps.event.addListener(searchBox,"place_changed",function(){var place=searchBox.getPlace(),bounds=new google.maps.LatLngBounds();if(!place){ animation.invalid(selectorHeader+".place-search");}else{if(markers[0]){markers[0].setMap(null);markers=[];}marker=new google.maps.Marker({map:map,title:place.name,position:place.geometry.location});marker.setMap(map);markers.push(marker);map.setZoom(16);map.setCenter(place.geometry.location);$(selectorHeader+".latitude").val(place.geometry.location.lat());$(selectorHeader+".longitude").val(place.geometry.location.lng());}});google.maps.event.addListener(map,"bounds_changed",function(){var bounds=map.getBounds();searchBox.setBounds(bounds);}); $("#attach-area .place .desc").keyup(function(n){if(n.keyCode==13){var latitude=parseFloat($(selectorHeader+".latitude").val()),longitude=parseFloat($(selectorHeader+".longitude").val());if(isNaN(latitude)){animation.invalid(selectorHeader+".latitude");return;}if(isNaN(longitude)){animation.invalid(selectorHeader+".longitude");return;}pos=new google.maps.LatLng(latitude,longitude);edit.locationGeocode(pos);}});},function(){animation.error(log.LOCATION_PIN_FAIL);});}else{ animation.error(log.LOCATION_PIN_FAIL);}edit.isEditing=2; $(selectorHeader+"input").prop("disabled",false); $(selectorHeader+"a").removeAttr("onclick"); $("#edit-pane").keyup(function(n){if(n.keyCode===27){edit.locationHide();}});};edit.locationHide=function(){if(edit.mediaIndex["place"]<0){ return;}var selectorHeader=edit.getSelectorHeader("place"); $(selectorHeader+"input").prop("disabled",true); $(selectorHeader+"a").attr("onclick","edit.location("+edit.mediaIndex["place"]+")"); edit.locationSave(edit.mediaIndex["place"]); $("#map-holder").fadeOut().html("<div id=\"map-selector\"></div>");$("#pin-point").addClass("hidden");$("#edit-pane").off("keyup"); animation.hideHiddenIcons();edit.mediaIndex["place"]=-1;edit.isEditing="";};edit.locationSave=function(index){var data=localStorage["place"],selectorHeader=edit.getSelectorHeader("place",index),latitude=parseFloat($(selectorHeader+".latitude").val()),longitude=parseFloat($(selectorHeader+".longitude").val()),newElem={};if(!data){data=[];}else{data=JSON.parse(data);}newElem["title"]=$(selectorHeader+".title").val(); if(!isNaN(latitude)&&!isNaN(longitude)){newElem["latitude"]=latitude;newElem["longitude"]=longitude;} data[index]=newElem;localStorage["place"]=JSON.stringify(data);};edit.locationPin=function(){ var selectorHeader=edit.getSelectorHeader("place"); if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(position){var latitude=position.coords.latitude,longitude=position.coords.longitude,pos=new google.maps.LatLng(latitude,longitude); $(selectorHeader+".latitude").val(latitude);$(selectorHeader+".longitude").val(longitude);edit.locationGeocode(pos);edit.locationWeather(pos);},function(){animation.error(log.LOCATION_PIN_FAIL);});}else{ animation.error(log.LOCATION_PIN_FAIL);}};edit.locationGeocode=function(pos){var mapOptions={zoom:16,center:pos},map=new google.maps.Map(document.getElementById("map-selector"),mapOptions),marker=new google.maps.Marker({map:map,position:pos}),selectorHeader=edit.getSelectorHeader("place"); map.setCenter(pos); var geocoder=new google.maps.Geocoder();geocoder.geocode({'latLng':pos},function(results,status){if(status==google.maps.GeocoderStatus.OK){if(results[0]){$(selectorHeader+".title").val(results[0].formatted_address);}else{animation.error(log.LOCATION_NO_RESULTS);}}else{animation.error(log.LOCATION_NO_ADDRESS+log.SERVER_RETURNS+status+log.SERVER_RETURNS_END);}});};edit.locationWeather=function(pos){ var flag=false;$("#attach-area .icontags .weather p").each(function(){if($(this).hasClass("highlight")){flag=true;}});if(flag){ return;}else{animation.debug(log.EDIT_PANE_WEATHER_START,1);}var apiKey="6f1ee423e253fba5e40e3276ff3e6d33",url="https://api.forecast.io/forecast/"+apiKey+"/"+pos.lat()+","+pos.lng()+","+parseInt(new Date().getTime()/1000)+"?units=si";$.ajax({type:"GET",url:url,dataType:"jsonp"}).done(function(data,staus,xhr){var weather=data["currently"],icon=weather["icon"];animation.log(log.EDIT_PANE_WEATHER_RESULT+weather["temperature"]+log.EDIT_PANE_WEATHER_RESULT_END);var selector;if(icon==="clear-day"||icon==="clear-night"){selector="w01";}else if(icon==="cloudy"||icon==="partly-cloudy-day"||icon==="partly-cloudy-night"){selector="w02";}else if(icon==="rain"){selector="w03";}else if(icon==="snow"||icon==="sleet"){selector="w04";}else if(icon==="wind"){selector="w06";}if(selector){ animation.log(log.EDIT_PANE_WEATHER_END,-1);$("#attach-area .icontags ."+selector).trigger("click");}else{ animation.log(log.EDIT_PANE_WEATHER_END_FAIL+data["summary"]+log.EDIT_PANE_WEATHER_END_FAIL_END,-1);}});};edit.voice=function(index,link){if(index==edit.mediaIndex["voice"]||index==undefined){return;}edit.cleanupMediaEdit();edit.mediaIndex["voice"]=index;var selectorHeader=edit.getSelectorHeader("voice");edit.func=$(selectorHeader+"a").attr("onclick");$(selectorHeader+"a").removeAttr("onclick");$(selectorHeader+"input").prop("disabled",false); $("#edit-pane").keyup(function(n){if(n.keyCode===27){edit.voiceHide();}});edit.isEditing=3; var source; if(link){source=link;app.audioPlayer(selectorHeader+"a",source);}else{ var fileName=$(selectorHeader+"a").attr("class");if(journal.archive.map[fileName]){source=journal.archive.map[fileName]["url"];if(source==undefined){animation.error(log.FILE_NOT_FOUND+$(selectorHeader+".title").val());return;}app.audioPlayer(selectorHeader+"a",source);}else{animation.error(log.FILE_NOT_LOADED+$(selectorHeader+".title")+log.DOWNLOAD_PROMPT);}}edit.setRemove(3);};edit.voiceHide=function(){if(edit.mediaIndex["voice"]<0){ return;}app.videoPlayer.quit();var selectorHeader=edit.getSelectorHeader("voice"); $(selectorHeader+"input").prop("disabled",true).off("keyup"); if(edit.func){ $(selectorHeader+"a").attr("onclick",edit.func);edit.func=undefined;}else{$(selectorHeader+"a").attr("onclick","edit.voice("+edit.mediaIndex["voice"]+")");} edit.voiceSave(edit.mediaIndex["voice"]);$("#edit-pane").off("keyup"); animation.hideHiddenIcons();edit.mediaIndex["voice"]=-1;edit.isEditing=-1;};edit.voiceSave=function(index){var data=localStorage["voice"],selectorHeader=edit.getSelectorHeader("voice",index),title=$(selectorHeader+".title").val();data=data?JSON.parse(data):[];var newElem={title:title,fileName:$(selectorHeader+"a").attr("class")};data[index]=newElem;localStorage["voice"]=JSON.stringify(data);};edit.voiceSearch=function(){edit.playableSearch(3);};edit.voiceNew=function(){};edit.music=function(index){edit.itunes(index,4);};edit.musicHide=function(){edit.itunesHide(4);};edit.musicSave=function(index){edit.itunesSave(index,4);};edit.movie=function(index){edit.itunes(index,5);};edit.movieHide=function(){edit.itunesHide(5);};edit.movieSave=function(index){edit.itunesSave(index,5);};edit.book=function(index){edit.itunes(index,6);};edit.bookHide=function(){edit.itunesHide(6);};edit.bookSave=function(index){edit.itunesHide(index,6);};edit.weblink=function(index){if(index==edit.mediaIndex["weblink"]||index==undefined){return;}edit.cleanupMediaEdit();edit.mediaIndex["weblink"]=index;var selectorHeader=edit.getSelectorHeader("weblink");edit.setRemove(7);$(selectorHeader+"a").removeAttr("onclick");$(selectorHeader+"input").prop("disabled",false); $("#edit-pane").keyup(function(n){if(n.keyCode==27){edit.weblinkHide(7);}});edit.isEditing=7;};edit.weblinkHide=function(){if(edit.mediaIndex["weblink"]<0){ return;}var selectorHeader=edit.getSelectorHeader("weblink"); $(selectorHeader+"input").prop("disabled",true).off("keyup"); $(selectorHeader+"a").attr("onclick","edit.weblink("+edit.mediaIndex["weblink"]+")"); edit.weblinkSave(edit.mediaIndex["weblink"],7);$("#edit-pane").off("keyup"); animation.hideHiddenIcons();edit.mediaIndex["weblink"]=-1;edit.isEditing=-1;};edit.weblinkSave=function(index){var data=localStorage["weblink"],selectorHeader=edit.getSelectorHeader("weblink",index),title=$(selectorHeader+".title").val(),url=$(selectorHeader+".desc").val();data=data?JSON.parse(data):[];var newElem={title:title,url:url};data[index]=newElem;localStorage["weblink"]=JSON.stringify(data);};edit.itunes=function(index,typeNum){var type=edit.mediaName(typeNum);if(index==edit.mediaIndex[type]||index==undefined){return;}edit.cleanupMediaEdit();edit.mediaIndex[type]=index;var selectorHeader=edit.getSelectorHeader(type);edit.setRemove(typeNum);$(selectorHeader+"a").removeAttr("onclick");$(selectorHeader+"input").prop("disabled",false).keyup(function(n){ if(n.keyCode==13){var term=$(selectorHeader+".title").val()+"%20"+$(selectorHeader+".desc").val();getCoverPhoto(selectorHeader,term,true,typeNum);}}); $("#edit-pane").keyup(function(n){if(n.keyCode==27){edit.itunesHide(typeNum);}});edit.isEditing=typeNum;};edit.itunesHide=function(typeNum){var type=edit.mediaName(typeNum);if(edit.mediaIndex[type]<0){ return;}var selectorHeader=edit.getSelectorHeader(type); $(selectorHeader+"input").prop("disabled",true).off("keyup"); $(selectorHeader+"a").attr("onclick","edit."+type+"("+edit.mediaIndex[type]+")"); edit.itunesSave(edit.mediaIndex[type],typeNum);$("#edit-pane").off("keyup"); animation.hideHiddenIcons();edit.mediaIndex[type]=-1;edit.isEditing=-1;};edit.itunesSave=function(index,typeNum){var type=edit.mediaName(typeNum),data=localStorage[type],selectorHeader=edit.getSelectorHeader(type,index),title=$(selectorHeader+".title").val(),author=$(selectorHeader+".desc").val();data=data?JSON.parse(data):[];var newElem={title:title,author:author};data[index]=newElem;localStorage[type]=JSON.stringify(data);};edit.playableSearch=function(typeNum){getTokenCallback(function(token){edit.getDate(function(dateStr){var url=getDataUrlHeader()+"/"+dateStr+":/children?select=id,name,size,@content.downloadUrl&access_token="+token;animation.log(log.EDIT_PANE_PLAYABLE_SEARCH_START,1);$.ajax({type:"GET",url:url}).done(function(data,status,xhr){if(data["@odata.nextLink"]){ animation.warn(log.EDIT_PANE_TOO_MANY_RESULTS);}var itemList=data["value"],dataGroup; switch(typeNum){case 1: dataGroup=edit.videos;break;case 3: dataGroup=edit.voices;break;default: console.log("edit.playableSearch()\tInvalid call");return;} for(var key=0,len=itemList.length;key!==len;++key){var id=itemList[key]["id"],size=itemList[key]["size"],name=itemList[key]["name"],contentUrl=itemList[key]["@content.downloadUrl"],suffix=name.substring(name.length-4).toLowerCase(),elementData={id:id,name:name,title:name.substring(0,name.length-4),url:contentUrl,size:size,resource:false,change:true}; switch(typeNum){case 1: if(suffix!==".mp4"){continue;}break;case 3: if(suffix!==".mp3"&&suffix!==".wav"){continue;}break;} var newContent=true;for(var i=0;i!==dataGroup.length;++i){if(dataGroup[i]["size"]===size){ newContent=false;break;}}if(!newContent){ continue;}dataGroup.push(elementData);animation.log(edit.mediaName(typeNum).capitalize()+log.EDIT_PANE_PLAYABLE_FILE+name+log.EDIT_PANE_PLAYABLE_FILE_ADDED); switch(typeNum){case 1: edit.addMedia(-1,{fileName:name,url:contentUrl,title:name.substring(0,name.length-4)});break;case 3: edit.addMedia(-3,{fileName:name,url:contentUrl,title:name.substring(0,name.length-4)});break;}} edit.playableSetToggle();animation.log(log.EDIT_PANE_PLAYABLE_SEARCH_END,-1);}).fail(function(xhr,status,error){animation.error(log.EDIT_PANE_PLAYABLE_SEARCH_FAILED,error,-1);switch(typeNum){case 1: animation.warning("#add-video");break;case 3: animation.warning("#add-voice");break;}});});});};edit.playableSetToggle=function(){$("#edit-pane .video, #edit-pane .voice").each(function(){ $(this).off("contextmenu");$(this).on("contextmenu",function(){ $(this).toggleClass("change"); return false;});});};edit.playableSave=function(typeNum,callback){edit.getDate(function(dateStr){var resourceDir="/drive/root:/Apps/Journal/resource/"+app.year,contentDir="/drive/root:/Apps/Journal/data/"+app.year+"/"+dateStr,dataGroup,localData,pending=0; switch(typeNum){case 1: dataGroup=edit.videos;localData=JSON.parse(localStorage["video"]);break;case 3:dataGroup=edit.voices;localData=JSON.parse(localStorage["voice"]);break;default:return;} $("#attach-area ."+edit.mediaName(typeNum)).each(function(){for(var i=0;i!==dataGroup.length;++i){if($(this).children("a").hasClass(dataGroup[i]["name"])){var match=(dataGroup[i]["resource"]&&$(this).hasClass("resource"))||(!dataGroup[i]["resource"]&&$(this).hasClass("data")); if(match){ dataGroup[i]["change"]=$(this).hasClass("change");break;}}}}); for(var i=0;i!==localData.length;++i){for(var j=0;j!==dataGroup.length;++j){if(localData[i]&&localData[i]["fileName"]===dataGroup[j]["name"]){ dataGroup[j]["title"]=localData[i]["title"];break;}}} for(var i=0;i!==dataGroup.length;++i){if(dataGroup[i]["change"]){++pending;}}if(pending===0){ $("#attach-area ."+edit.mediaName(typeNum)).each(function(){if($(this).hasClass("data")){ $(this).addClass("ignore").empty().fadeOut();}});callback();}else{getTokenCallback(function(token){animation.log(log.EDIT_PANE_PLAYABLE_SAVE_START+edit.mediaName(typeNum)+log.EDIT_PANE_PLAYABLE_SAVE_START_END,1);for(var i=0;i!==dataGroup.length;++i){if(dataGroup[i]["change"]){ var name=dataGroup[i]["name"],title=dataGroup[i]["title"],id=dataGroup[i]["id"],newName=dateStr+(new Date().getTime()+i)+name.substring(name.length-4),path;dataGroup[i]["success"]=false;if(dataGroup[i]["resource"]){ for(var j=0;j!==localData.length;++j){if(localData[j]["fileName"]===name){ newName=title+name.substring(name.length-4);break;}}path=contentDir;}else{ path=resourceDir;}var requestJson={name:newName,parentReference:{path:path}}; var url;if(id){url="https://api.onedrive.com/v1.0/drive/items/"+id+"?select=id,name,size,@content.downloadUrl&access_token="+token;}else{path=path===resourceDir?contentDir:resourceDir;url="https://api.onedrive.com/v1.0"+path+"/"+encodeURI(name)+"?select=name,size,@content.downloadUrl&access_token="+token;}$.ajax({type:"PATCH",url:url,contentType:"application/json",data:JSON.stringify(requestJson)}).done(function(data){--pending;var title="";for(var j=0;j!==dataGroup.length;++j){if(dataGroup[j]["id"]===data["id"]){ title=dataGroup[j]["title"];dataGroup[j]["success"]=true; delete journal.archive.map[dataGroup[j]["name"]];if(!dataGroup[j]["resource"]){ var newName=data["name"];dataGroup[j]["newName"]=newName;journal.archive.map[newName]={id:data["id"],size:data["size"],url:data["@content.downloadUrl"]};}break;}}animation.log(edit.mediaName(typeNum).capitalize()+log.EDIT_PANE_PLAYABLE_FILE+title+log.EDIT_PANE_PLAYABLE_FILE_SAVED);}).fail(function(xhr,status,error){--pending;animation.warn(log.EDIT_PANE_TRANSFERRED_FAILED,error,false);animation.warning("#add-"+edit.mediaName(typeNum));}).always(function(){if(pending<=0){ $("#attach-area ."+edit.mediaName(typeNum)).each(function(){$(this).removeClass("change");for(var j=0;j!==dataGroup.length;++j){if(!$(this).hasClass("ignore")){if($(this).children("a").hasClass(dataGroup[j]["name"])){var match=(dataGroup[j]["resource"]&&$(this).hasClass("resource"))||(!dataGroup[j]["resource"]&&$(this).hasClass("data")); if(match){if(dataGroup[j]["success"]){dataGroup[j]["success"]=false;dataGroup[j]["resource"]=!dataGroup[j]["resource"]; if($(this).hasClass("resource")){$(this).removeClass("resource").addClass("data");}else if($(this).hasClass("data")){$(this).removeClass("data").addClass("resource");} if(dataGroup[j]["newName"]){dataGroup[j]["name"]=dataGroup[j]["newName"];$(this).children("a").attr("class",dataGroup[j]["newName"]); delete dataGroup[j]["newName"];}}break;}}}}if($(this).hasClass("data")){ $(this).addClass("ignore").empty().fadeOut();}}); var cacheData=[];for(var j=0;j!==dataGroup.length;++j){dataGroup[j]["change"]=false;if(dataGroup[j]["resource"]){ cacheData.push({fileName:dataGroup[j]["newName"]||dataGroup[j]["name"],title:dataGroup[j]["title"]});}else{ dataGroup.splice(j,1);--j;}}localStorage[edit.mediaName(typeNum)]=JSON.stringify(cacheData);animation.log(log.EDIT_PANE_FINISHED_TRANSFER+edit.mediaName(typeNum)+log.EDIT_PANE_FINISHED_TRANSFER_END,-1);callback();}});}}});}});};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1);};