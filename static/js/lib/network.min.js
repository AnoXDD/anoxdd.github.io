/*v4.3.0 Build 090515_1533 Minified 101015.201941*/
window.network={};network.percent=0;network.current=0;network.breakpoint=0;network.interval=0;network.yearFolders=[];network.isAjaxActive=false;network.timeOut=15000;network.init=function(breakpoint){ $("#network-bar").remove();$(".header").append("<div id=\"network-bar\" ><div id=\"network-progress\"><div id=\"network-followup\"></div></div></div>");if(!breakpoint||breakpoint<0){breakpoint=0;}network.current=0;network.breakpoint=breakpoint||0;network.setPercent(0); clearInterval(network.interval);var toDestroy=false;network.interval=setInterval(function(){ if(toDestroy){network.destroy();return;} if(network.percent<(network.current+.5)/(network.breakpoint+1)){network.percent+=.05;}if(network.percent>=1){network.percent=1;toDestroy=true;}$("#network-progress").css("width",network.percent*100+"%");},1000);}network.setPercent=function(percent){network.percent=percent;}network.setStatus=function(status){}network.next=function(){network.setPercent(++network.current/(network.breakpoint+1));}network.destroy=function(){if(network.percent<1){ network.percent=2;}else{clearInterval(network.interval);$("#network-bar").remove();}}function getResourceUrlHeader(isAbsolute,year){year=year||app.year;return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource/"+year;}function getDataUrlHeader(isAbsolute,year){year=year||app.year;return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data/"+year;}function getCoreDataUrlHeader(isAbsolute,year){year=year||app.year;return"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core/"+year+"/data.js";}function downloadFile(url,textOnly){animation.log(log.CONTENTS_DOWNLOAD_START,1); getTokenCallback(function(token){if(network.yearFolders.indexOf(app.year)===-1){ createFolders(function(){ app.refresh();},3);}else{$("#download").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"); url=url||getCoreDataUrlHeader(true)+":/content?access_token="+token;$.ajax({type:"GET",url:url}).done(function(data,status,xhr){window.app.dataLoaded[app.year]=false;window.addLoadDataWithFilter("",xhr.responseText);animation.log(log.CONTENTS_DOWNLOAD_TEXT); delete app.yearChange[app.year];$("#year").removeClass("change");app.updateLastUpdated();app.yearUpdate();if(textOnly){ $("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"});animation.finished("#download");}else{ $.ajax({type:"GET",url:getResourceUrlHeader()+":?select=folder&access_token="+token}).done(function(data,status,xhr){ journal.archive.media=data["folder"]["childCount"];app.refresh();animation.log(log.CONTENTS_DOWNLOAD_MEDIA_START,1);network.init(journal.archive.media);downloadMedia();}).fail(function(xhr,status,error){animation.error(log.CONTENTS_DOWNLOAD_MEDIA_FAIL,error,-1);});}}).fail(function(xhr,status,error){ $("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"});animation.finished("#download");if(xhr.status==404){if(app.yearQueue[app.year]){ app.yearUpdate();app.refresh();return;}}animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL,error,-1); app.year=parseInt($("#year").html());}).always(function(){animation.log(log.CONTENTS_DOWNLOAD_END,-1);});}});}function downloadMedia(url){ if(url==undefined){ var token=getTokenFromCookie();journal.archive.map={};url=getResourceUrlHeader()+":/children?select=id,name,size,@content.downloadUrl&top=500&access_token="+token;}$.ajax({type:"GET",url:url}).done(function(data,status,xhr){if(data["@odata.nextLink"]){var nextUrl=data["@odata.nextLink"];var groups=nextUrl.split("&"); for(var i=0;i!==groups.length;++i){if(groups[i].startsWith("$select")){groups[i]="$select=id,name,size,@content.downloadUrl";break;}}nextUrl=groups.join("&");downloadMedia(nextUrl);}var itemList=data["value"];for(var key=0,len=itemList.length;key!=len;++key){var dataElement={id:itemList[key]["id"],url:itemList[key]["@content.downloadUrl"],size:itemList[key]["size"]};journal.archive.map[itemList[key]["name"]]=dataElement;network.next();} var finished=_.size(journal.archive.map);animation.log(log.CONTENTS_DOWNLOAD_MEDIA_LOADED+finished+log.CONTENTS_DOWNLOAD_MEDIA_OF+journal.archive.media);if(finished==journal.archive.media){animation.log(log.CONTENTS_DOWNLOAD_MEDIA_END,-1);network.destroy(); $("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"});animation.finished("#download");}}).fail(function(){network.destroy();});}function backupAll(years){getTokenCallback(function(token){animation.log(log.CONTENTS_BACKUP_START);years=years||app.years;network.init(years.length-1);for(var i=0;i!==years.length;++i){var d=new Date(),month=d.getMonth()+1,day=d.getDate(),year=d.getFullYear()%100,hour=d.getHours(),minute=d.getMinutes(),second=d.getSeconds(),dataYear=years[i];month=month<10?"0"+month:month;day=day<10?"0"+day:day;year=year<10?"0"+year:year;hour=hour<10?"0"+hour:hour;minute=minute<10?"0"+minute:minute;second=second<10?"0"+second:second;var fileName="data_"+month+day+year+"_"+hour+minute+second+".js",data={name:fileName}; $.ajax({type:"POST",url:getCoreDataUrlHeader(false,dataYear)+":/action.copy?access_token="+token,contentType:"application/json",data:JSON.stringify(data),headers:{Prefer:"respond-async"}}).done(function(){animation.debug(log.CONTENTS_UPLOAD_BACKUP);}).fail(function(xhr,status,error){ if(error!=="Bad Request"){animation.error(log.CONTENTS_UPLOAD_BACKUP_FAIL,error,-1);network.destroy();}}).always(function(xhr,status,error){network.next();});}});}function uploadFile(dataYear){dataYear=parseInt(dataYear)||app.year; $("#upload").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href");getTokenCallback(function(token){var upload=function(){ var tmp=app.version[dataYear]||""; tmp+=JSON.stringify(edit.minData());$.ajax({type:"PUT",url:getCoreDataUrlHeader(true,dataYear)+":/content?access_token="+token,contentType:"text/plain",data:tmp}).done(function(){ app.yearChange[app.year]=false;$("#year").removeClass("change");app.updateLastUpdated();animation.log(log.CONTENTS_UPLOAD_END+dataYear,-1);}).fail(function(xhr2,status2,error2){animation.error(log.CONTENTS_UPLOAD_FAIL,error2,-1);}).always(function(){network.next(); $("#upload").html("&#xf0ee").removeClass("spin").css("background","").attr({onclick:"uploadSingleFile()",href:"#"});});};if(network.yearFolders.indexOf(app.year)===-1){ createFolders(upload,5);}else{ upload();}});}function uploadSingleFile(){animation.log(log.CONTENTS_UPLOAD_START,1);uploadFile();}function uploadAllFiles(){animation.log(log.CONTENTS_UPLOAD_START,1);if(app.yearChange.length===0){ uploadFile();}else{var years=Object.keys(app.yearChange);for(var i=0;i!==years.length;++i){var year=years[i];if(app.yearChange[year]){uploadFile(years[i]);}}}}function getCoverPhoto(selectorHeader,term,more,type){var url="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=music&entity=song,album,musicArtist&term=";if(typeof(type)=="number"){type=edit.mediaName(type);}if(type=="movie"){url="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=movie&entity=movieArtist,movie&term=";}else if(type=="book"){url="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=ebook&entity=ebook&term=";}$.ajax({url:url+term,dataType:"jsonp", success:function(response){var result=response.results[0];if(result==undefined){ animation.warn(log.COVER_PHOTO_FAIL);animation.invalid(selectorHeader+"input");}else{ animation.debug(log.COVER_PHOTO_FOUND);var artist=result["artistName"],track=result["trackName"],coverUrl=result["artworkUrl100"];if(more){$(selectorHeader+".title").val(track);$(selectorHeader+".desc").val(artist);}$(selectorHeader+".thumb").attr("src",coverUrl);}}});}function createDateFolder(dateStr,callback){getTokenCallback(function(token){var requestJson={name:dateStr,folder:{}};$.ajax({type:"POST",url:getDataUrlHeader(true)+":/children?access_token="+token,contentType:"application/json",data:JSON.stringify(requestJson),statusCode:{ 409:function(){edit.isFolder=true;edit.folderDate=dateStr;}}}).done(function(){ edit.isFolder=true;edit.folderDate=dateStr;animation.debug(log.FOLDER_CREATED);}).always(function(){ callback(dateStr);});});}function createFolders(callback,breakpoints){getTokenCallback(function(token){var created=0,abort=false,urls=["https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data:/","https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/resource:/"],requestJson={name:app.year.toString(),folder:{}}; network.init(breakpoints);for(var i=0;i!==urls.length;++i){$.ajax({type:"POST",url:urls[i]+"children?access_token="+token,contentType:"application/json",data:JSON.stringify(requestJson)}).done(function(){network.next();if(++created===urls.length){ network.yearFolders.push(app.year); callback(token);}}).fail(function(xhr){if(xhr.status==409){ network.next();if(++created===urls.length){ network.yearFolders.push(app.year); callback(token);}}else{network.destroy();if(!abort){animation.error(log.CONTENTS_UPLOAD_REGISTER_FAIL);} abort=true;}});}})}