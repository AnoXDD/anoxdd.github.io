function odauth(a){ensureHttps();var b=getTokenFromCookie(),c=getRefreshFromCookie();b?onAuthenticated(b):c?removeLoginButton():a?challengeForAuth():showLoginButton()}function ensureHttps(){"https:"!=window.location.protocol&&(window.location.href="https:"+window.location.href.substring(window.location.protocol.length))}
function onAuthCallback(){var a=getAuthInfoFromUrl().code,b=window.opener.getAppInfo();$.ajax({type:"POST",url:"https://login.live.com/oauth20_token.srf",contentType:"application/x-www-form-urlencoded",data:"client_id="+b.clientId+"&redirect_uri="+b.redirectUri+"&client_secret="+b.clientSecret+"&code="+a+"&grant_type=authorization_code"}).done(function(a,b,e){b=a.access_token;e=a.refresh_token;a=parseInt(a.expires_in);window.opener.setCookie(b,a,e);window.opener.onAuthenticated(b,window)}).fail(function(){alert("Cannot get the code. Did you enable CORS?")})}
function getAuthInfoFromUrl(){if(window.location.search){var a=window.location.search.substring(1);return JSON.parse('{"'+a.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(a,c){return""===a?c:decodeURIComponent(c)})}alert("failed to receive auth token")}function getTokenCallback(a){if(getTokenFromCookie()){var b=getTokenFromCookie();a(b)}else getRefreshFromCookie()&&(animation.log(log.AUTH_REFRESH_EXPIRED),refreshToken(a))}function getTokenFromCookie(){return getFromCookie("odauth")}
function getRefreshFromCookie(){return getFromCookie("refresh")}function getFromCookie(a){a+="=";var b=document.cookie,c=b.indexOf(a);return 0<=c?(c+=a.length,a=b.indexOf(";",c),0>a?a=b.length:postCookie=b.substring(a),b.substring(c,a)):""}
function setCookie(a,b,c){var d=new Date;d.setTime(d.getTime()+1E3*b-3E5);localStorage.expiration=d.getTime();a="odauth="+a+"; path=/; expires="+d.toUTCString();console.log("setCookie(): cookie = "+a);"https"==document.location.protocol.toLowerCase()&&(a+=";secure");document.cookie=a;d.setTime(d.getTime()+31536E6);a="refresh="+c+"; path=/; expires="+d.toUTCString();"https"==document.location.protocol.toLowerCase()&&(a+=";secure");document.cookie=a}
function toggleAutoRefreshToken(){var a=function(){refreshToken()};toggleAutoRefreshToken.id?($("#toggle-refresh-token").fadeOut(300,function(){$(this).html("&#xf204")}).fadeIn(300),animation.log(log.AUTH_REFRESH_AUTO_OFF),clearInterval(toggleAutoRefreshToken.id),toggleAutoRefreshToken.id=void 0):($("#toggle-refresh-token").fadeOut(300,function(){$(this).html("&#xf205")}).fadeIn(300),animation.log(log.AUTH_REFRESH_AUTO_ON),toggleAutoRefreshToken.id=setInterval(a,18E5))}
function refreshToken(a){animation.log(log.AUTH_REFRESH_ACCESS_START,1);var b=getRefreshFromCookie(),c=getAppInfo();b?$.ajax({type:"POST",url:"https://login.live.com/oauth20_token.srf",contentType:"application/x-www-form-urlencoded",data:"client_id="+c.clientId+"&redirect_uri="+c.redirectUri+"&client_secret="+c.clientSecret+"&refresh_token="+b+"&grant_type=refresh_token"}).done(function(b,c,f){c=b.access_token;f=b.refresh_token;b=parseInt(b.expires_in);setCookie(c,b,f);animation.log(log.AUTH_REFRESH_ACCESS_END,
-1);"function"===typeof a&&a(c)}).fail(function(a,b,c){animation.error(log.AUTH_REFRESH_ACCESS_FAILED+log.SERVER_RETURNS+b+log.SERVER_RETURNS_END,-1)}):challengeForAuth()}
function getAppInfo(){var a=document.getElementById("odauth");a||alert("the script tag for odauth.js should have its id set to 'odauth'");var b=a.getAttribute("clientId");b||alert("the odauth script tag needs a clientId attribute set to your application id");var c=a.getAttribute("scopes");c||alert("the odauth script tag needs a scopes attribute set to the scopes your app needs");var d=a.getAttribute("redirectUri");d||alert("the odauth script tag needs a redirectUri attribute set to your redirect landing url");
(a=a.getAttribute("clientSecret"))||alert("the odauth script tag needs a clientSecret attribute to refresh the token");return{clientId:b,scopes:c,redirectUri:d,clientSecret:a}}function showLoginButton(){getRefreshFromCookie()?removeLoginButton():(animation.hideAllMenus(),animation.showIcon("#signin"))}
function removeLoginButton(a){a||refreshToken();$("#sign-in-prompt").remove();animation.hideIcon("#signin",function(){animation.showMenuOnly();$("#search-new").fadeIn();$("#search-result").fadeIn();$("#app").fadeIn();$("#drawer").removeClass("hidden");edit.tryReadCache()})}
function challengeForAuth(){var a=getAppInfo(),a="https://login.live.com/oauth20_authorize.srf?client_id="+a.clientId+"&scope="+encodeURIComponent(a.scopes)+"&response_type=code&redirect_uri="+encodeURIComponent(a.redirectUri);popup(a)}
function popup(a){(a=window.open(a,"oauth",["width=525,height=525","top="+(window.screenY+Math.max(window.outerHeight-525,0)/2),"left="+(window.screenX+Math.max(window.outerWidth-525,0)/2),"status=no,resizable=yes,toolbar=no,menubar=no,scrollbars=yes"].join()))||alert("failed to pop up auth window");a.focus()}function onAuthenticated(a,b){a&&(b&&b.close(),removeLoginButton())};
