/*v4.2.7 Build 090515_1533 Minified 101015.201941*/
function downloadFile(url){animation.log(log.CONTENTS_DOWNLOAD_START,1); $("#download").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href"); $("#refresh-media").hover(function(){var percent=parseInt(_.size(journal.archive.map)/journal.archive.media*100);if(isNaN(percent)){percent=0;}$(this).html(percent+"%");},function(){$(this).html("&#xf021");});getTokenCallback(function(token){if(token!=""){ url=url||"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core/data.js:/content?access_token="+token;$.ajax({type:"GET",url:url}).done(function(data,status,xhr){window.app.dataLoaded=false;window.app.load("",true,xhr.responseText);animation.log(log.CONTENTS_DOWNLOAD_TEXT); $.ajax({type:"GET",url:"https://api.onedrive.com/v1.0/drive/special/approot:/resource:?select=folder&access_token="+token}).done(function(data,status,xhr){ journal.archive.media=data["folder"]["childCount"];animation.log(log.CONTENTS_DOWNLOAD_MEDIA_START,1);downloadMedia();}).fail(function(xhr,status,error){animation.error(log.CONTENTS_DOWNLOAD_MEDIA_FAIL+log.SERVER_RETURNS+error+log.SERVER_RETURNS_END,-1);});}).fail(function(xhr,status,error){animation.error(log.CONTENTS_DOWNLOAD_TEXT_FAIL+log.SERVER_RETURNS+error+log.SERVER_RETURNS_END,-1);}).always(function(){ $("#download").html("&#xf0ed").removeClass("spin").attr({onclick:"downloadFile()",href:"#"});animation.finished("#download");animation.log(log.CONTENTS_DOWNLOAD_END,-1);});}});}function downloadMedia(url){ if(url==undefined){ var token=getTokenFromCookie();journal.archive.map={};url="https://api.onedrive.com/v1.0/drive/special/approot:/resource:/children?select=id,name,size,@content.downloadUrl&top=500&access_token="+token;}$("#refresh-media").addClass("spin");$.ajax({type:"GET",url:url}).done(function(data,status,xhr){if(data["@odata.nextLink"]){var nextUrl=data["@odata.nextLink"];var groups=nextUrl.split("&"); for(var i=0;i!==groups.length;++i){if(groups[i].startsWith("$select")){groups[i]="$select=id,name,size,@content.downloadUrl";break;}}nextUrl=groups.join("&");downloadMedia(nextUrl);}var itemList=data["value"];for(var key=0,len=itemList.length;key!=len;++key){var dataElement={id:itemList[key]["id"],url:itemList[key]["@content.downloadUrl"],size:itemList[key]["size"]};journal.archive.map[itemList[key]["name"]]=dataElement;} var finished=_.size(journal.archive.map);animation.log(log.CONTENTS_DOWNLOAD_MEDIA_LOADED+finished+log.CONTENTS_DOWNLOAD_MEDIA_OF+journal.archive.media);$("#refresh-media").css("background","-webkit-linear-gradient(top, #3f3f3f 0%,#3f3f3f "+finished/journal.archive.media*100+"%,#343434 0%,#343434 100%)");if(finished==journal.archive.media){ $("#refresh-media").html("&#xf021").removeClass("spin").css("background","").unbind("mouseenter mouseleave");animation.log(log.CONTENTS_DOWNLOAD_MEDIA_END,-1);animation.finished("#refresh-media");}});}function uploadFile(){animation.log(log.CONTENTS_UPLOAD_START,1); $("#upload").html("&#xf1ce").addClass("spin").removeAttr("onclick").removeAttr("href");getTokenCallback(function(token){var d=new Date(),month=d.getMonth()+1,day=d.getDate(),year=d.getFullYear()%100,hour=d.getHours(),minute=d.getMinutes(),second=d.getSeconds();month=month<10?"0"+month:month;day=day<10?"0"+day:day;year=year<10?"0"+year:year;hour=hour<10?"0"+hour:hour;minute=minute<10?"0"+minute:minute;second=second<10?"0"+second:second;var fileName="data_"+month+day+year+"_"+hour+minute+second+".js",data={name:fileName}; $.ajax({type:"PATCH",url:"https://api.onedrive.com/v1.0/drive/special/approot:/core/data.js?access_token="+token,contentType:"application/json",data:JSON.stringify(data)}).done(function(){$("#upload").css("background","-webkit-linear-gradient(top, #3f3f3f 0%, #3f3f3f 50%, #343434 0%, #343434 100%)");animation.log(log.CONTENTS_UPLOAD_BACKUP); var tmp=edit.minData();$.ajax({type:"PUT",url:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/core/data.js:/content?access_token="+token,contentType:"text/plain",data:JSON.stringify(tmp)}).done(function(data,status,xhr){animation.log(log.CONTENTS_UPLOAD_END,-1);}).fail(function(xhr,status,error){animation.error(log.CONTENTS_UPLOAD_FAIL+log.SERVER_RETURNS+error+log.SERVER_RETURNS_END,-1);});}).fail(function(xhr,status,error){animation.error(log.CONTENTS_UPLOAD_BACKUP_FAIL+log.SERVER_RETURNS+error+log.SERVER_RETURNS_END,-1);}).always(function(){ $("#upload").html("&#xf0ee").removeClass("spin").css("background","").attr({onclick:"uploadFile()",href:"#"});animation.finished("#upload");});});}function getCoverPhoto(selectorHeader,term,more,type){var url="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=music&entity=song,album,musicArtist&term=";if(typeof(type)=="number"){type=edit.mediaName(type);}if(type=="movie"){url="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=movie&entity=movieArtist,movie&term=";}else if(type=="book"){url="https://itunes.apple.com/search?output=json&lang=1&limit=1&media=ebook&entity=ebook&term=";}$.ajax({url:url+term,dataType:"jsonp", success:function(response){var result=response.results[0];if(result==undefined){ animation.warn(log.COVER_PHOTO_FAIL);animation.invalid(selectorHeader+"input");}else{ animation.log(log.COVER_PHOTO_FOUND);var artist=result["artistName"],track=result["trackName"],coverUrl=result["artworkUrl100"];if(more){$(selectorHeader+".title").val(track);$(selectorHeader+".desc").val(artist);}$(selectorHeader+".thumb").attr("src",coverUrl);}}});}function createFolder(dateStr,callback){getTokenCallback(function(token){var requestJson={name:dateStr,folder:{}};$.ajax({type:"POST",url:"https://api.onedrive.com/v1.0/drive/root:/Apps/Journal/data:/children?access_token="+token,contentType:"application/json",data:JSON.stringify(requestJson),statusCode:{ 409:function(){edit.isFolder=true;edit.folderDate=dateStr;}}}).done(function(){ edit.isFolder=true;edit.folderDate=dateStr;animation.log(log.FOLDER_CREATED);}).always(function(){ callback(dateStr);});});}