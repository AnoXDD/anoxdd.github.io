/*v4.3.0 Build 090515_1533 Minified 101015.201941*/
window.stats={};stats.oldValue="";stats.entries={};stats.options={startDay:0,endDay:366, isIncludingTitles:true,isIncludingTags:false,viewAsMonth:false};stats.eachDay=[];stats.monthVal=[];stats.isLeapYear=false;stats.isEditing=-1;stats.isGraphDisplayed=false;stats.init=function(){var i; stats.result=[];stats.isLeapYear=new Date(app.year,1,29).getMonth()===1;stats.isGraphDisplayed=false;stats.oldValue="";if(stats.isLeapYear){ stats.monthVal=[31,29,31,30,31,30,31,31,30,31,30,31];}else{stats.monthVal=[31,28,31,30,31,30,31,31,30,31,30,31];}for(i=1;;++i){var date=new Date(app.year,0,i);if(date.getFullYear()!==app.year){ break;}else{var month=app.monthArray[date.getMonth()],day=date.getDate();stats.eachDay.push(month+" "+day);}} $("#query").fadeOut();$("#stats-query").fadeIn(); $("#stats-query").val("");$("#stats-query").unbind("keyup").bind("keyup","return",function(){var newEntry=$(this).val();newEntry=stats.simplifyEntry(newEntry);if(newEntry.length===0){ $(this).effect("highlight",{color:"#000"});animation.debug(log.STATS_ENTRY_EMPTY_STRING);return;}if(stats.entries[newEntry]){ $(this).effect("highlight",{color:"#000"});animation.debug(log.STATS_ENTRY_ALREADY_EXIST);}else{ $(this).effect("highlight",{color:"#ddd"}); stats.addEntry(newEntry);$(this).val("");$(this).focus();}$(this).select();});stats.initTable();animation.showMenuOnly("stats");$("#stats-options li.checkbox").each(function(){$(this).click(function(){$(this).toggleClass("checked");var name=$(this).attr("encode");stats.options[name]=!stats.options[name];});}); $("#stats-table").delegate("td","mouseover mouseleave contextmenu",function(e){if(e.type==="mouseover"){$(this).parent().addClass("hover");$("tr td:nth-child("+($(this).index()+1)+")").addClass("hover");}else if(e.type==="mouseleave"){$(this).parent().removeClass("hover");$("tr td:nth-child("+($(this).index()+1)+")").removeClass("hover");}else{ var key=stats.oldValue||$(this).parent().children("td").children("input").val();$(this).parent().slideUp(200,function(){$(this).remove();});delete stats.entries[key];return false;}}).delegate("input","focusin focusout keyup",function(e){if(e.type==="focusin"){ stats.oldValue=$(this).val();}else if(e.type==="focusout"){$(this).val(stats.oldValue);stats.oldValue="";}else{if(e.keyCode===13){ var newEntry=$(this).val();newEntry=stats.simplifyEntry(newEntry);if(newEntry.length===0){ $(this).effect("highlight",{color:"#000"});animation.error(log.STATS_ENTRY_EMPTY_STRING);$(this).val(stats.oldValue);return;}if(stats.entries[newEntry]){ $(this).effect("highlight",{color:"#000"});animation.error(log.STATS_ENTRY_ALREADY_EXIST);$(this).val(stats.oldValue);return;}else{ $(this).parent().parent().effect("highlight",{color:"#ddd"}); var index=$(this).parent().parent().index()+1; delete stats.entries[stats.oldValue];stats.addEntry(newEntry,index);} stats.oldValue=newEntry;this.blur();}else if(e.keyCode===27){ this.blur();}}}).delegate("th","click",function(){if($("tbody tr").length!==0){var desc=$(this).hasClass("desc"),index=$(this).index(),map=[]; $("tbody tr").each(function(){var key,value;$(this).children("td").each(function(n){if(n===0){ key=$(this).children("input").val();}if(n===index){ if(n===0){value=key;}else{value=$(this).html();}}});map.push({key:key,value:value});}); stats.initTable(); if(!desc){$("th").eq(index).addClass("desc");if(index===0){ map.sort(function(a,b){return b["value"].localeCompare(a["value"]);});}else{ map.sort(function(a,b){return b["value"]-a["value"];});}}else{$("th").eq(index).addClass("asce");if(index===0){ map.sort(function(a,b){return a["value"].localeCompare(b["value"]);});}else{ map.sort(function(a,b){return a["value"]-b["value"];})}} for(i=0;i!==Object.keys(map).length;++i){stats.addEntry(map[i]["key"]);}}});$("#contents").fadeOut(400,function(){ $("#search-result").addClass("stats");$(".response").addClass("stats");stats.getYearSum();$("#stats-pane").fadeIn();});}stats.initTable=function(){stats.oldValue="";stats.removeAll(); var html="<thead><tr><th>Index</th>"; for(var i=0;i!==app.monthArray.length;++i){html+="<th>"+app.monthArray[i]+"</th>";}html+="<th>Total</th></tr></thead><tbody></tbody>";$("#stats-table").html(html);$("tbody").addClass("fadein");}stats.quit=function(){stats.removeAll(); $("#query").fadeIn();$("#stats-query").fadeOut().unbind("keyup"); $("#stats-options li.checkbox").each(function(){$(this).unbind("click");});$(".stats").removeClass("stats"); $("#stats-table").undelegate("td","mouseover mouseleave contextmenu").undelegate("input","focusin focusout keyup").delegate("th","contextmenu"); $("#stats-pane").fadeOut(400,function(){$("#contents").fadeIn();animation.showMenuOnly();app.refresh();});}stats.addEntry=function(entry,overwriteNum){var i; var result=stats.getResult(entry);stats.entries[entry]=result; var monthCount=new Array(12),day=0,sum=0;for(i=0;i!==stats.monthVal.length;++i){monthCount[i]=0;for(var j=0;j!==stats.monthVal[i];++j,++day){if(result[day]){monthCount[i]+=result[day];}} sum+=monthCount[i];} var htmlContent="<td><input type='text' class='edit' autocomplete='off' onclick='this.select()' value='"+entry+"' /></td>";for(i=0;i!==monthCount.length;++i){htmlContent+="<td>"+monthCount[i]+"</td>";}htmlContent+="<td>"+sum+"</td>";if(overwriteNum){ $("tbody tr:nth-child("+overwriteNum+") input").parent().parent().html(htmlContent).addClass("fadein");}else{htmlContent="<tr>"+htmlContent+"</tr>"; $(htmlContent).appendTo("tbody").addClass("fadein");}stats.hideGraph();}stats.simplifyEntry=function(str){var group=str.split("|"),ret=[];for(var i=0;i!==group.length;++i){if(group[i].length>0){ret.push(group[i]);}}return ret.join("|");}stats.getYearSum=function(){var totalChar=0,totalLine=0,totalTime=0,totalImage=0,totalVideo=0,totalVoice=0;for(var i=0;i!==journal.archive.data[app.year].length;++i){var data=journal.archive.data[app.year][i];if(stats.isInTimeRange(data["time"]["created"])){totalChar+=data["text"]["chars"];totalLine+=data["text"]["lines"];if(data["time"]["end"]){var timeDelta=(data["time"]["end"]-data["time"]["start"])/60000;if(!isNaN(timeDelta)){totalTime+=timeDelta;}}if(data["images"]){totalImage+=data["images"].length;}if(data["video"]){totalVideo+=data["video"].length;}if(data["voice"]){totalVoice+=data["voice"].length;}}} $("#total-char").text(totalChar);$("#total-line").text(totalLine); var minute=totalTime%60;if(minute<10){minute="0"+minute;}$("#total-time").text(Math.floor(totalTime/60)+":"+minute);$("#total-image").text(totalImage);$("#total-video").text(totalVideo);$("#total-voice").text(totalVoice);}stats.getResult=function(entry){var keywords=entry.split("|"),result;if(stats.isLeapYear){ result=new Array(366);}else{result=new Array(365);}for(var i=0;i!==journal.archive.data[app.year].length;++i){ var strings=[],data=journal.archive.data[app.year][i],createdTime=data["time"]["created"];if(stats.isInTimeRange(createdTime)){var day=stats.getDayNumber(createdTime);strings.push(data["text"]["body"]);if(this.options.isIncludingTags){strings.push(data["tags"]);}if(this.options.isIncludingTitles){strings.push(data["title"]);} for(var j=0;j!==strings.length;++j){ var string=strings[j];if(string){for(var k=0;k!==keywords.length;++k){ var keyword=keywords[k];if(!result[day]){result[day]=0;} result[day]+=(string.match(new RegExp(keyword,"gi"))||[]).length;}}}}}return result;}stats.getDayNumber=function(time){var date=new Date(time),firstDay=new Date(app.year,0,1);return Math.floor((new Date(date)-firstDay)/86400000);}stats.isInTimeRange=function(createdTime){var day=stats.getDayNumber(createdTime);return day>=stats.options.startDay&&day<=stats.options.endDay;}stats.removeAll=function(){$("#stats-table").html("").fadeIn().css("display","inline-table");stats.entries={};stats.hideGraph();}stats.toggleGraph=function(){if(!stats.isGraphDisplayed){stats.showGraph();}else{stats.hideGraph();}}stats.showGraph=function(viewAsMonth){var i,j;stats.isGraphDisplayed=true;var series=[],days=[],name; if(viewAsMonth){days=app.monthArray; $("#stats-table tbody tr").each(function(){var monthData=[];$(this).children("td").each(function(n){if(n===0){ name=$(this).children("input").val();}else if(n<13){ monthData.push($(this).html());}});series.push({name:name,data:monthData});});}else{var entries;for(i=0,entries=Object.keys(stats.entries);i!==entries.length;++i){name=entries[i];series.push({name:entries[i],data:stats.entries[name]}); if(i===0){var entry=stats.entries[name]; for(j=0;j!==entry.length;++j){if(entry[j]!=undefined){ days.push(stats.eachDay[j]);}}}}}for(i=0;i!==Object.keys(series).length;++i){var arr=series[i]["data"],newArr=[]; for(j=0;j!==arr.length;++j){if(arr[j]!=undefined){newArr.push(arr[j]);}}series[i]["data"]=newArr;}var data={chart:{backgroundColor:"#f3f3f3"},title:{text:"Stats for this year",x:-20},subtitle:{text:"Collected from "+$("#total-char").html()+" chars in "+$("#total-entry").html()+" entries",x:-20},xAxis:{categories:days},yAxis:{min:0,plotLines:[{value:0,width:1,color:"#808080"}],title:{text:"Times"}},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:0},series:series,exporting:{enabled:false,filename:"Journal Analysis "+app.year}};$("#graph").fadeIn().highcharts(data);$("#action-stats hidden").removeClass("hidden");animation.testAllSubs();};stats.hideGraph=function(){stats.isGraphDisplayed=false;$("#graph").fadeOut(function(){$(this).html("");});$("#action-stats hidden-icon").addClass("hidden");animation.testAllSubs();}stats.toggleYearView=function(){stats.hideGraph();stats.options.viewAsMonth=!stats.options.viewAsMonth;stats.showGraph(stats.options.viewAsMonth);}